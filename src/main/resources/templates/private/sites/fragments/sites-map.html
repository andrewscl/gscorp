<section th:fragment="content">

  <div id="site-map-section">
    <!-- Título del mapa -->
    <h3 th:text="#{site.map.title}">Mapa de Sitios</h3>

    <!-- Contenedor del mapa -->
    <div id="site-map" style="width: 100%; height: 500px; border: 1px solid #ccc;"></div>

    <!-- Acciones del mapa -->
    <div id="site-map-actions">
      <label for="site-select" th:text="#{site.map.select.label}">Seleccione un sitio:</label>
      <select id="site-select" name="siteId">
        <!-- Opción por defecto -->
        <option value="" th:text="#{site.map.select.default}">Seleccionar sitio</option>
      </select>
    </div>

    <!-- Elemento de error -->
    <div id="site-map-error" style="display:none; color:red;" th:text="#{site.map.error}"></div>
  </div>



  <script type="text/javascript">
        const googleMapsConfig = {
            apiKey: '[[${googlecloudapikey}]]',
            mapId: '[[${googlemapid}]]' 
        };
      // Define la función global antes de cargar Google Maps
      globalThis.waitForGoogleMapsAndInit = function waitForGoogleMapsAndInit(retry = 0) {
          console.log('Intento:', retry, '| Google:', !!window.google, '| Maps:', !!window.google?.maps);

          if (window.google && window.google.maps) {
              initMap();
          } else if (retry < 10) {
              setTimeout(() => waitForGoogleMapsAndInit(retry + 1), 300 + 150 * retry);
          } else {
              showMapError("No se pudo cargar Google Maps. Intente más tarde.");
          }
      };
  </script>

  <script th:src="'https://maps.googleapis.com/maps/api/js?key=' +
                ${googlecloudapikey} + '&libraries=marker&map_ids=' +
                ${googlemapid} + '&callback=waitForGoogleMapsAndInit&loading=async'" async defer>
  </script>


  <script type="module" src="/js/private/sites/sites-map.js"></script>



</section>