<section th:fragment="content" class="card forecast-creation">
  <h3>Crear Forecast</h3>

  <!-- Mensajes de estado -->
  <div id="forecast-status" aria-live="polite">Complete los campos para crear un forecast</div>

  <form id="forecast-form"
        data-forecast-endpoint="/api/forecasts"
        autocomplete="off">

    <!-- Compact layout: selects encadenados (client -> project -> site)
         Nota: Los <select> se deben poblar desde el servidor o por JS (fetch). -->
    <div class="row compact">
      <label for="forecast-client">Cliente
        <select id="forecast-client" name="clientId" required>
          <option value="">-- seleccionar --</option>
          <option th:each="c : ${clients}"
                  th:value="${c.id}"
                  th:text="${c.name}"
                  th:selected="${prefill != null and prefill.clientId != null and prefill.clientId == c.id}">
          </option>
        </select>
      </label>

      <label for="forecast-project">Proyecto
        <select id="forecast-project" name="projectId" disabled required
                th:attr="disabled=${projects == null or #lists.isEmpty(projects)}">
          <option value="">-- seleccionar --</option>
          <option th:each="p : ${projects}"
                  th:value="${p.id}"
                  th:text="${p.name}"
                  th:selected="${prefill != null and prefill.projectId != null and prefill.projectId == p.id}">
          </option>
        </select>
      </label>

      <label for="forecast-site">Sitio
        <select id="forecast-site" name="siteId" disabled
                th:attr="disabled=${sites == null or #lists.isEmpty(sites)}">
          <option value="">-- (opcional) --</option>
          <option th:each="s : ${sites}"
                  th:value="${s.id}"
                  th:text="${s.name}"
                  th:selected="${prefill != null and prefill.siteId != null and prefill.siteId == s.id}">
          </option>
        </select>
      </label>
    </div>

    <!-- Fila compacta de métrica / periodicidad / category (scope visual read-only) -->
    <div class="row compact">
      <label for="forecast-metric">Métrica
        <select id="forecast-metric" name="metric" required>
          <option value="VISITS">Visitas</option>
          <option value="ROUNDS">Rondas</option>
          <option value="ATTENDANCE">Asistencia</option>
          <!-- Ajustar opciones a tu enum com.gscorp.dv1.enums.Metric si existe -->
        </select>
      </label>

      <label for="forecast-periodicity">Periodicidad
        <select id="forecast-periodicity" name="periodicity" required>
          <option value="DAILY">Diario</option>
          <option value="WEEKLY">Semanal</option>
          <option value="HOURLY">Horario</option>
        </select>
      </label>

      <label for="forecast-category">Categoría
        <select id="forecast-category" name="forecastCategory" required>
          <option value="">-- seleccionar --</option>
          <!-- Ajusta las opciones al enum ForecastCategory del backend -->
          <option value="BASE">Base</option>
          <option value="ADJUSTMENT">Ajuste</option>
          <option value="PROJECTION">Proyección</option>
        </select>
      </label>

      <!-- Scope visual (read-only inference preferred): site > project > client -->
      <div id="forecast-scope" class="scope-hint" aria-hidden="true">Scope: SITE / PROJECT / CLIENT</div>
    </div>

    <!-- Fechas y valor en una sola fila compacta -->
    <div class="row compact">
      <label for="forecast-start">Desde
        <input id="forecast-start" name="periodStart" type="date" required />
      </label>

      <label for="forecast-end">Hasta
        <input id="forecast-end" name="periodEnd" type="date" />
      </label>

      <label for="forecast-value">Valor
        <input id="forecast-value" name="value" type="number" step="0.001" inputmode="decimal" required />
      </label>
    </div>

    <!-- Hour fields para periodicidad HOURLY (visibles solo si periodicity == HOURLY) -->
    <div class="row compact hour-fields" aria-hidden="true" hidden>
      <label for="forecast-start-hour">Desde hora (0-23)
        <input id="forecast-start-hour" name="periodStartHour" type="number" min="0" max="23" step="1" />
      </label>

      <label for="forecast-end-hour">Hasta hora (0-23)
        <input id="forecast-end-hour" name="periodEndHour" type="number" min="0" max="23" step="1" />
      </label>

      <div class="hint">Usar solo para periodicidad HOURLY</div>
    </div>

    <!-- Units / Confidence / Version small inputs -->
    <div class="row compact">
      <label for="forecast-units">Units
        <input id="forecast-units" name="units" type="text" placeholder="e.g. count" />
      </label>

      <label for="forecast-confidence">Confianza (%)
        <input id="forecast-confidence" name="confidence" type="number" step="0.1" min="0" max="100" />
      </label>

      <!-- Forecast version: debe coincidir con el DTO (forecastVersion) -->
      <input id="forecast-version" name="forecastVersion" type="hidden" value="1" />
    </div>

    <!-- Zona (tz) — oculta pero editable/detectable en cliente -->
    <div class="row compact tz-row" hidden>
      <label for="forecast-tz">Zona (IANA)
        <input id="forecast-tz" name="tz" type="text" placeholder="Europe/Madrid" />
      </label>
      <button type="button" id="detect-tz" class="btn btn-secondary">Detectar zona</button>
    </div>

    <!-- Nota breve -->
    <div class="form-group compact">
      <label for="forecast-note">Nota (opcional)
        <textarea id="forecast-note" name="note" rows="2" placeholder="Observación corta..."></textarea>
      </label>
    </div>

    <!-- Acciones compactas -->
    <div class="modal-footer compact">
      <button type="submit" class="btn btn-primary" id="forecast-save">Guardar</button>
      <button type="button" class="btn btn-secondary" id="forecast-cancel">Cancelar</button>
      <button type="button" class="btn btn-link" id="forecast-bulk" title="Crear forecasts en lote">Cargar CSV</button>
    </div>

  </form>

  <!-- Resumen compacto (preview) -->
  <div id="forecast-preview" aria-live="polite" class="compact-preview" hidden>
    <strong>Preview:</strong> <span id="forecast-preview-text"></span>
  </div>

  <!-- Script module para lógica: carga de selects, cascading, validación compacta y envío -->
  <script type="module" th:src="@{/js/private/forecast/create-forecast.js}" defer></script>
</section>