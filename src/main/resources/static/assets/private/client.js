import{i as st,f as L}from"../chunks/api-Bh71dfFu.js";async function K(u,i,b,I,M,k){const D=u.querySelector(I);if(!D)return console.warn(`[hourly metric] ${I} no existe`),null;const N=Array.from({length:24},(F,S)=>String(S).padStart(2,"0")),C="#3b82f6",T="#60a5fa",f=st(D,void 0,{renderer:"canvas"}),y=N.map(()=>0);f.setOption({tooltip:{trigger:"axis"},legend:{top:6},grid:{left:40,right:16,top:36,bottom:28},xAxis:{type:"category",data:N,axisLabel:{formatter:F=>F+"h"}},yAxis:{type:"value",minInterval:1},series:[{name:`${b} (real)`,type:"bar",data:y,itemStyle:{color:C}},{name:`${b} (forecast)`,type:"line",smooth:!0,data:y,lineStyle:{type:"dashed",color:T},symbol:"circle",symbolSize:6}],graphic:{elements:[{type:"text",left:"center",top:"middle",style:{text:"Cargando...",fill:"#9ca3af",fontSize:14}}]},toolbox:{show:!0,feature:{saveAsImage:{}}}});function m(F){const S=new Map((F||[]).map(c=>[String(c.hour).padStart(2,"0"),c])),O=N.map(c=>Number((S.get(c)&&S.get(c)[i])??0)),E=N.map(c=>Number((S.get(c)&&S.get(c)[i+"Forecast"])??0)),_=O.some(c=>c>0)||E.some(c=>c>0);f.setOption({xAxis:{data:N},series:[{name:`${b} (real)`,type:"bar",data:O,itemStyle:{color:C}},{name:`${b} (forecast)`,type:"line",smooth:!0,data:E,lineStyle:{type:"dashed",color:T},symbol:"circle",symbolSize:6}],graphic:_?{elements:[]}:{elements:[{type:"text",left:"center",top:"middle",style:{text:"Sin datos",fill:"#9ca3af",fontSize:14}}]}})}const d=new ResizeObserver(()=>f.resize());d.observe(D);function h(){try{d.disconnect()}catch{}try{f.dispose()}catch{}try{document.removeEventListener("fragment:will-unload",v)}catch{}}const v=()=>{document.removeEventListener("fragment:will-unload",v),h()};return document.addEventListener("fragment:will-unload",v,{once:!0}),f.__hourly_metric_cleanup=h,{chart:f,refresh:F=>m(F),destroy:h}}async function it(u,i,b){const I=b?.refreshMs,M=await K(u,"attendance","Asistencias","#chart-hourly-attendance"),k=await K(u,"rounds","Rondas","#chart-hourly-rounds"),D=await K(u,"visits","Visitas","#chart-hourly-visits"),N=d=>{M&&M.refresh(d),k&&k.refresh(d),D&&D.refresh(d)};let C="UTC";try{C=Intl.DateTimeFormat().resolvedOptions().timeZone||"UTC"}catch{}async function T(d){const h=d?`?date=${encodeURIComponent(d)}&tz=${encodeURIComponent(C)}`:`?tz=${encodeURIComponent(C)}`,v=`/api/attendance/hourly${h}`,$=`/api/patrols-runs/hourly${h}`,F=`/api/site-supervision-visits/hourly${h}`;try{const[S,O,E]=await Promise.all([L(v),L($),L(F)]),_=S.ok?await S.json().catch(()=>[]):[],c=O.ok?await O.json().catch(()=>[]):[],q=E.ok?await E.json().catch(()=>[]):[],P=new Map(_.map(e=>[String(e.hour).padStart(2,"0"),e])),U=new Map(c.map(e=>[String(e.hour).padStart(2,"0"),e])),V=new Map(q.map(e=>[String(e.hour).padStart(2,"0"),e]));return Array.from({length:24},(e,s)=>String(s).padStart(2,"0")).map(e=>({hour:e,attendance:Number(P.get(e)?.count??P.get(e)?.cnt??0),attendanceForecast:Number(P.get(e)?.forecast??0),rounds:Number(U.get(e)?.count??U.get(e)?.cnt??0),roundsForecast:Number(U.get(e)?.forecast??0),visits:Number(V.get(e)?.count??V.get(e)?.cnt??0),visitsForecast:Number(V.get(e)?.forecast??0)}))}catch(S){return console.warn("[initThreeMetrics] fetchHourlyCombined error",S),Array.from({length:24},(O,E)=>({hour:String(E).padStart(2,"0")}))}}const f=await T(i);f&&f.length&&N(f);let y;y=window.setInterval(async()=>{const d=await T(i);d&&d.length&&N(d)},I);const m=()=>{document.removeEventListener("fragment:will-unload",m);try{y&&window.clearInterval(y)}catch{}[M,k,D].forEach(d=>{if(!d)return;const h=d.chart;if(h&&h.__hourly_metric_cleanup)try{h.__hourly_metric_cleanup()}catch{}else try{d.chart.dispose()}catch{}})};return document.addEventListener("fragment:will-unload",m,{once:!0}),{stop:()=>{try{y&&window.clearInterval(y)}catch{}m()}}}function ct(u=new Date){return`${u.getFullYear()}-${String(u.getMonth()+1).padStart(2,"0")}-01`}function lt(u=new Date){const i=u.getFullYear(),b=u.getMonth()+1,I=new Date(i,b,0).getDate();return`${i}-${String(b).padStart(2,"0")}-${String(I).padStart(2,"0")}`}async function nt({container:u}){const i=u.querySelector("#client-dashboard-root")||u;if(!i||i.dataset.echartsInit==="1")return;i.dataset.echartsInit="1";const b=i.getAttribute("data-client-id")||"1",I=ct(),M=lt(),k=i.querySelector("#chart-att"),D=i.querySelector("#chart-patrol"),N=i.querySelector("#chart-inc"),C=i.querySelector("#chart-visit"),T=i.querySelector("#chart-visit-site");try{const t=Intl.DateTimeFormat().resolvedOptions().timeZone||"UTC",e=`/api/clients/dashboard/kpis?tz=${encodeURIComponent(t)}`,s=await L(e);if(s.ok){const l=await s.json();i.querySelector('[data-kpi="att"]').textContent=String(l.asistenciaHoy??0),i.querySelector('[data-kpi="patrol"]').textContent=String(l.rondasHoy??0),i.querySelector('[data-kpi="visit"]').textContent=String(l.visitasHoy??0)}else console.warn("KPIs fetch no OK",s.status)}catch(t){console.error("Error obteniendo KPIs",t)}const f=[],y=t=>t?st(t,void 0,{renderer:"canvas"}):null,m=(t,e="Sin datos")=>{t&&t.setOption({graphic:{elements:[{type:"text",left:"center",top:"middle",style:{text:e,fill:"#9ca3af",fontSize:14}}]}})};async function d(t,e={},s=15e3,l=!1){const a=new AbortController,w={...e,signal:a.signal},x=setTimeout(()=>a.abort(),s);try{return l?await L(String(t),w):await fetch(t,w)}finally{clearTimeout(x)}}const h=y(k);h&&f.push(h);try{const t=await L(`/api/attendance/series?clientId=${b}&from=${I}&to=${M}&action=IN`);if(t.ok){const e=await t.json().catch(()=>[]),s=e.map(a=>a.x),l=e.map(a=>a.y);h?.setOption({tooltip:{trigger:"axis"},grid:{left:40,right:16,top:24,bottom:32},xAxis:{type:"category",boundaryGap:!1,data:s},yAxis:{type:"value"},series:[{type:"line",smooth:!0,areaStyle:{},data:l}],graphic:l.some(a=>Number(a)>0)?{elements:[]}:void 0}),l.some(a=>Number(a)>0)||m(h)}else m(h,"Error de datos")}catch{m(h,"Error de datos")}const v=y(D);v&&f.push(v);try{const t=Intl.DateTimeFormat().resolvedOptions().timeZone||"UTC",e=`/api/site-patrols/series?clientId=${b}&from=${I}&to=${M}&tz=${encodeURIComponent(t)}`,s=await L(e);if(s.ok){const l=await s.json().catch(()=>[]),a=l.map(x=>x.x),w=l.map(x=>x.y);v?.setOption({tooltip:{trigger:"axis"},grid:{left:40,right:16,top:24,bottom:32},xAxis:{type:"category",boundaryGap:!1,data:a},yAxis:{type:"value"},series:[{type:"line",smooth:!0,areaStyle:{},data:w,color:"#34D399"}],graphic:w.some(x=>Number(x)>0)?{elements:[]}:void 0}),w.some(x=>Number(x)>0)||m(v)}else m(v,"Error de datos")}catch(t){console.error("Error cargando series de rondas",t),m(v,"Error de datos")}window.addEventListener("resize",()=>v?.resize());const $=y(C);$&&f.push($);const F=navigator.language||"es",S=new Intl.DateTimeFormat(F,{day:"2-digit",month:"short"});function O(t){if(!t)return null;const e=t.includes("T")?t:`${t}T00:00:00`,s=new Date(e);return Number.isNaN(s.getTime())?null:s}function E(t){const e=O(t);return e?S.format(e).replace(".","").replace(/\s+/,"-"):t??""}function _(t,e){const s=[],l=new Date;for(let a=t-1;a>=0;a--){const w=new Date(l);w.setDate(l.getDate()-a),s.push(`${w.getFullYear()}-${String(w.getMonth()+1).padStart(2,"0")}-${String(w.getDate()).padStart(2,"0")}`)}return s}try{let t=function(r){if(r==null)return"";const o=String(r).trim();if(!o)return"";if(/^\d{4}-\d{2}-\d{2}$/.test(o)){const[p,z,A]=o.split("-"),B=Number(p),g=Number(z),R=Number(A);if(Number.isFinite(B)&&Number.isFinite(g)&&Number.isFinite(R)){const W=new Date(B,g-1,R);return`${W.getFullYear()}-${String(W.getMonth()+1).padStart(2,"0")}-${String(W.getDate()).padStart(2,"0")}`}return""}const n=new Date(o);return Number.isNaN(n.getTime())?o.split("T")[0]||"":`${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,"0")}-${String(n.getDate()).padStart(2,"0")}`};const e=Intl.DateTimeFormat().resolvedOptions().timeZone||"UTC",s=7,l=`/api/site-supervision-visits/series?days=${s}&tz=${encodeURIComponent(e)}`,a=`/api/forecasts/forecast-series?days=${s}&tz=${encodeURIComponent(e)}`,[w,x]=await Promise.all([d(l,{},15e3,!0).catch(r=>(console.warn("Fetch actual visits failed",r),null)),d(a,{},15e3,!0).catch(r=>(console.warn("Fetch forecast visits failed",r),null))]),X=async(r,o)=>r?r.ok?await r.json().catch(n=>(console.warn(`${o} json parse error`,n),[])):(console.warn(`${o} returned status`,r.status),[]):[],[Z,G]=await Promise.all([X(w,"actual visits"),X(x,"forecast visits")]);if((!Array.isArray(Z)||Z.length===0)&&(!Array.isArray(G)||G.length===0)){m($,"Sin datos");return}const J=r=>Array.isArray(r)?r.map(o=>{let n="";Array.isArray(o)?n=o[0]:n=o?.x??o?.date??o?.day??"";let p=0;Array.isArray(o)&&o.length>1?p=o[1]:p=o?.y??o?.value??0;const z=t(n),A=typeof p=="number"?p:Number(String(p??0));return{x:z,y:Number.isFinite(A)?A:0}}).filter(o=>o.x&&typeof o.x=="string"&&o.x.length>=4):[],Q=J(Z),tt=J(G);let j=_(s,e);const et=r=>{const o=new Map;return r.forEach(n=>{if(!n||!n.x)return;const p=o.get(n.x)??0;o.set(n.x,p+(Number.isFinite(Number(n.y))?Number(n.y):0))}),o},rt=et(Q),ot=et(tt),Y=j.map(r=>rt.has(r)?rt.get(r):0),H=j.map(r=>ot.has(r)?ot.get(r):0),at=i.querySelector("#donut-visit");if(at){const r=y(at);if(r){f.push(r);const o=Y.reduce((g,R)=>g+(Number(R)||0),0),n=H.reduce((g,R)=>g+(Number(R)||0),0),p=n>0,z=p?Math.round(o/n*100):0,A=p?Math.min(100,Math.max(0,z)):100,B=p?[{value:A,name:"Cumplido",itemStyle:{color:"#10B981"}},{value:100-A,name:"Pendiente",itemStyle:{color:"#E5E7EB"}}]:[{value:1,name:"Sin meta",itemStyle:{color:"#E5E7EB"}}];r.setOption({tooltip:{trigger:"item",formatter:g=>p?g&&g.name==="Cumplido"?`${g.marker} ${g.seriesName}: ${o} / ${n} (${z}%)`:g&&g.name==="Pendiente"?`${g.marker} Pendiente: ${Math.max(0,n-o)}`:"":"Meta no definida"},series:[{name:"Cumplimiento Visitas",type:"pie",radius:["62%","82%"],avoidLabelOverlap:!1,hoverAnimation:!1,label:{show:!0,position:"center",formatter:p?`${z}%`:"â€”",fontSize:12,fontWeight:700,color:"#111827"},labelLine:{show:!1},data:B}]})}}if(console.debug("[visits-chart] labels:",j),console.debug("[visits-chart] normActual:",Q),console.debug("[visits-chart] normForecast:",tt),console.debug("[visits-chart] valuesActual:",Y),console.debug("[visits-chart] valuesForecast:",H),!$){m($,"Sin datos");return}$.clear(),$.setOption({legend:{data:["Visitas reales","Forecast (previsto)"],top:6},tooltip:{trigger:"axis",formatter:r=>{if(!Array.isArray(r)||r.length===0)return"";const o=r[0];let n=o.axisValue??(o&&typeof o.dataIndex=="number"?j[o.dataIndex]:void 0);!n&&o.axisValueLabel&&(n=o.axisValueLabel);const p=E(String(n??"")),z=r.map(A=>`${A.marker} ${A.seriesName}: ${A.value??0}`);return`<b>${p}</b><br/>${z.join("<br/>")}`}},grid:{left:40,right:16,top:48,bottom:36},xAxis:{type:"category",boundaryGap:!1,data:j,axisLabel:{rotate:0,formatter:function(r){return E(r)}}},yAxis:{type:"value"},series:[{name:"Visitas reales",type:"line",smooth:!0,areaStyle:{},data:Y,color:"#0ea5e9",showSymbol:!1,lineStyle:{width:2}},{name:"Forecast (previsto)",type:"line",smooth:!0,areaStyle:{opacity:.12},data:H,color:"#f59e0b",showSymbol:!1,lineStyle:{width:2,type:"dashed"}}],graphic:Y.concat(H).some(r=>Number(r)>0)?{elements:[]}:void 0}),Y.some(r=>Number(r)>0)||H.some(r=>Number(r)>0)||m($,"Sin visitas")}catch(t){t?.name==="AbortError"?console.debug("Visits/Forecast fetch aborted (timeout or navigation)",t):console.error("Error obteniendo series de visitas/forecast",t),m($,"Error de datos")}const c=y(T);c&&f.push(c);try{const t=await L(`/api/site-supervision-visits/series-by-site?clientId=${b}&from=${I}&to=${M}`);if(t.ok){const e=await t.json().catch(()=>[]),s=e.map(a=>a.siteName),l=e.map(a=>a.count);c?.setOption({tooltip:{trigger:"axis"},grid:{left:60,right:16,top:24,bottom:32},xAxis:{type:"value"},yAxis:{type:"category",data:s,axisLabel:{interval:0,fontSize:12}},series:[{type:"bar",data:l,itemStyle:{color:"#0ea5e9"}}],graphic:l.some(a=>Number(a)>0)?{elements:[]}:void 0}),l.some(a=>Number(a)>0)||m(c)}else m(c,"Error de datos")}catch{m(c,"Error de datos")}const q=new Date,P=`${q.getFullYear()}-${String(q.getMonth()+1).padStart(2,"0")}-${String(q.getDate()).padStart(2,"0")}`;try{it(i,P,{refreshMs:6e4})}catch(t){console.warn("[client-dashboard] initThreeMetrics failed",t)}const U=new ResizeObserver(()=>f.forEach(t=>t?.resize()));[k,N,C,T].forEach(t=>t&&U.observe(t));const V=()=>{document.removeEventListener("fragment:will-unload",V);try{U.disconnect()}catch{}f.forEach(t=>{try{t.dispose()}catch{}}),i.dataset.echartsInit="0"};document.addEventListener("fragment:will-unload",V,{once:!0})}if(document.readyState==="loading")document.addEventListener("DOMContentLoaded",()=>{const u=document.getElementById("client-dashboard-root");u&&nt({container:u})});else{const u=document.getElementById("client-dashboard-root");u&&nt({container:u})}
