import{i as O,f as I}from"../chunks/api-Bh71dfFu.js";async function C(i,o,u,g,w,E){const S=i.querySelector(g);if(!S)return console.warn(`[hourly metric] ${g} no existe`),null;const v=Array.from({length:24},(b,p)=>String(p).padStart(2,"0")),x="#3b82f6",h="#60a5fa",m=O(S,void 0,{renderer:"canvas"}),s=v.map(()=>0);m.setOption({tooltip:{trigger:"axis"},legend:{top:6},grid:{left:40,right:16,top:36,bottom:28},xAxis:{type:"category",data:v,axisLabel:{formatter:b=>b+"h"}},yAxis:{type:"value",minInterval:1},series:[{name:`${u} (real)`,type:"bar",data:s,itemStyle:{color:x}},{name:`${u} (forecast)`,type:"line",smooth:!0,data:s,lineStyle:{type:"dashed",color:h},symbol:"circle",symbolSize:6}],graphic:{elements:[{type:"text",left:"center",top:"middle",style:{text:"Cargando...",fill:"#9ca3af",fontSize:14}}]},toolbox:{show:!0,feature:{saveAsImage:{}}}});function y(b){const p=new Map((b||[]).map(n=>[String(n.hour).padStart(2,"0"),n])),$=v.map(n=>Number((p.get(n)&&p.get(n)[o])??0)),t=v.map(n=>Number((p.get(n)&&p.get(n)[o+"Forecast"])??0)),r=$.some(n=>n>0)||t.some(n=>n>0);m.setOption({xAxis:{data:v},series:[{name:`${u} (real)`,type:"bar",data:$,itemStyle:{color:x}},{name:`${u} (forecast)`,type:"line",smooth:!0,data:t,lineStyle:{type:"dashed",color:h},symbol:"circle",symbolSize:6}],graphic:r?{elements:[]}:{elements:[{type:"text",left:"center",top:"middle",style:{text:"Sin datos",fill:"#9ca3af",fontSize:14}}]}})}const a=new ResizeObserver(()=>m.resize());a.observe(S);function l(){try{a.disconnect()}catch{}try{m.dispose()}catch{}try{document.removeEventListener("fragment:will-unload",f)}catch{}}const f=()=>{document.removeEventListener("fragment:will-unload",f),l()};return document.addEventListener("fragment:will-unload",f,{once:!0}),m.__hourly_metric_cleanup=l,{chart:m,refresh:b=>y(b),destroy:l}}async function z(i,o,u){const g=u?.refreshMs,w=await C(i,"attendance","Asistencias","#chart-hourly-attendance"),E=await C(i,"rounds","Rondas","#chart-hourly-rounds"),S=await C(i,"visits","Visitas","#chart-hourly-visits"),v=a=>{w&&w.refresh(a),E&&E.refresh(a),S&&S.refresh(a)};let x="UTC";try{x=Intl.DateTimeFormat().resolvedOptions().timeZone||"UTC"}catch{}async function h(a){const l=a?`?date=${encodeURIComponent(a)}&tz=${encodeURIComponent(x)}`:`?tz=${encodeURIComponent(x)}`,f=`/api/attendance/hourly${l}`,A=`/api/patrols-runs/hourly${l}`,b=`/api/site-supervision-visits/hourly${l}`;try{const[p,$,t]=await Promise.all([I(f),I(A),I(b)]),r=p.ok?await p.json().catch(()=>[]):[],n=$.ok?await $.json().catch(()=>[]):[],d=t.ok?await t.json().catch(()=>[]):[],e=new Map(r.map(c=>[String(c.hour).padStart(2,"0"),c])),N=new Map(n.map(c=>[String(c.hour).padStart(2,"0"),c])),k=new Map(d.map(c=>[String(c.hour).padStart(2,"0"),c]));return Array.from({length:24},(c,_)=>String(_).padStart(2,"0")).map(c=>({hour:c,attendance:Number(e.get(c)?.count??e.get(c)?.cnt??0),attendanceForecast:Number(e.get(c)?.forecast??0),rounds:Number(N.get(c)?.count??N.get(c)?.cnt??0),roundsForecast:Number(N.get(c)?.forecast??0),visits:Number(k.get(c)?.count??k.get(c)?.cnt??0),visitsForecast:Number(k.get(c)?.forecast??0)}))}catch(p){return console.warn("[initThreeMetrics] fetchHourlyCombined error",p),Array.from({length:24},($,t)=>({hour:String(t).padStart(2,"0")}))}}const m=await h(o);m&&m.length&&v(m);let s;s=window.setInterval(async()=>{const a=await h(o);a&&a.length&&v(a)},g);const y=()=>{document.removeEventListener("fragment:will-unload",y);try{s&&window.clearInterval(s)}catch{}[w,E,S].forEach(a=>{if(!a)return;const l=a.chart;if(l&&l.__hourly_metric_cleanup)try{l.__hourly_metric_cleanup()}catch{}else try{a.chart.dispose()}catch{}})};return document.addEventListener("fragment:will-unload",y,{once:!0}),{stop:()=>{try{s&&window.clearInterval(s)}catch{}y()}}}function D(i=new Date){return`${i.getFullYear()}-${String(i.getMonth()+1).padStart(2,"0")}-01`}function R(i=new Date){const o=i.getFullYear(),u=i.getMonth()+1,g=new Date(o,u,0).getDate();return`${o}-${String(u).padStart(2,"0")}-${String(g).padStart(2,"0")}`}async function M({container:i}){const o=i.querySelector("#client-dashboard-root")||i;if(!o||o.dataset.echartsInit==="1")return;o.dataset.echartsInit="1";const u=o.getAttribute("data-client-id")||"1",g=D(),w=R(),E=o.querySelector("#chart-att"),S=o.querySelector("#chart-inc"),v=o.querySelector("#chart-visit"),x=o.querySelector("#chart-visit-site");try{const t=await I(`/api/clients/dashboard/kpis?clientId=${u}`);if(t.ok){const r=await t.json();o.querySelector('[data-kpi="att"]').textContent=String(r.asistenciaHoy??0),o.querySelector('[data-kpi="patrol"]').textContent=String(r.rondasHoy??0),o.querySelector('[data-kpi="visit"]').textContent=String(r.visitasHoy??0),o.querySelector('[data-kpi="inc"]').textContent=String(r.incidentesAbiertos??0)}}catch{}const h=[],m=t=>t?O(t,void 0,{renderer:"canvas"}):null,s=(t,r="Sin datos")=>{t&&t.setOption({graphic:{elements:[{type:"text",left:"center",top:"middle",style:{text:r,fill:"#9ca3af",fontSize:14}}]}})},y=m(E);y&&h.push(y);try{const t=await I(`/api/attendance/series?clientId=${u}&from=${g}&to=${w}&action=IN`);if(t.ok){const r=await t.json().catch(()=>[]),n=r.map(e=>e.x),d=r.map(e=>e.y);y?.setOption({tooltip:{trigger:"axis"},grid:{left:40,right:16,top:24,bottom:32},xAxis:{type:"category",boundaryGap:!1,data:n},yAxis:{type:"value"},series:[{type:"line",smooth:!0,areaStyle:{},data:d}],graphic:d.some(e=>Number(e)>0)?{elements:[]}:void 0}),d.some(e=>Number(e)>0)||s(y)}else s(y,"Error de datos")}catch{s(y,"Error de datos")}const a=m(S);a&&h.push(a);try{const t=await I(`/api/incidents/series?clientId=${u}&from=${g}&to=${w}&status=OPEN`);if(t.ok){const r=await t.json().catch(()=>[]),n=r.map(e=>e.x),d=r.map(e=>e.y);a?.setOption({tooltip:{trigger:"axis"},grid:{left:40,right:16,top:24,bottom:32},xAxis:{type:"category",boundaryGap:!1,data:n},yAxis:{type:"value"},series:[{type:"line",smooth:!0,data:d}],graphic:d.some(e=>Number(e)>0)?{elements:[]}:void 0}),d.some(e=>Number(e)>0)||s(a)}else s(a,"Error de datos")}catch{s(a,"Error de datos")}const l=m(v);l&&h.push(l);try{const t=await I(`/api/site-supervision-visits/series?clientId=${u}&from=${g}&to=${w}`);if(t.ok){const r=await t.json().catch(()=>[]),n=r.map(e=>e.x),d=r.map(e=>e.y);l?.setOption({tooltip:{trigger:"axis"},grid:{left:40,right:16,top:24,bottom:32},xAxis:{type:"category",boundaryGap:!1,data:n},yAxis:{type:"value"},series:[{type:"line",smooth:!0,areaStyle:{},data:d,color:"#0ea5e9"}],graphic:d.some(e=>Number(e)>0)?{elements:[]}:void 0}),d.some(e=>Number(e)>0)||s(l)}else s(l,"Error de datos")}catch{s(l,"Error de datos")}const f=m(x);f&&h.push(f);try{const t=await I(`/api/site-supervision-visits/series-by-site?clientId=${u}&from=${g}&to=${w}`);if(t.ok){const r=await t.json().catch(()=>[]),n=r.map(e=>e.siteName),d=r.map(e=>e.count);f?.setOption({tooltip:{trigger:"axis"},grid:{left:60,right:16,top:24,bottom:32},xAxis:{type:"value"},yAxis:{type:"category",data:n,axisLabel:{interval:0,fontSize:12}},series:[{type:"bar",data:d,itemStyle:{color:"#0ea5e9"}}],graphic:d.some(e=>Number(e)>0)?{elements:[]}:void 0}),d.some(e=>Number(e)>0)||s(f)}else s(f,"Error de datos")}catch{s(f,"Error de datos")}const A=new Date,b=`${A.getFullYear()}-${String(A.getMonth()+1).padStart(2,"0")}-${String(A.getDate()).padStart(2,"0")}`;try{z(o,b,{refreshMs:6e4})}catch(t){console.warn("[client-dashboard] initThreeMetrics failed",t)}const p=new ResizeObserver(()=>h.forEach(t=>t?.resize()));[E,S,v,x].forEach(t=>t&&p.observe(t));const $=()=>{document.removeEventListener("fragment:will-unload",$);try{p.disconnect()}catch{}h.forEach(t=>{try{t.dispose()}catch{}}),o.dataset.echartsInit="0"};document.addEventListener("fragment:will-unload",$,{once:!0})}if(document.readyState==="loading")document.addEventListener("DOMContentLoaded",()=>{const i=document.getElementById("client-dashboard-root");i&&M({container:i})});else{const i=document.getElementById("client-dashboard-root");i&&M({container:i})}
