import{i as st,f as U}from"../chunks/api-Bh71dfFu.js";async function X(l,i,p,D,C,L){const M=l.querySelector(D);if(!M)return console.warn(`[hourly metric] ${D} no existe`),null;const F=Array.from({length:24},(g,b)=>String(b).padStart(2,"0")),T=i==="rounds"?"#34D399":"#0ea5e9",O="#f59e0b",m=st(M,void 0,{renderer:"canvas"}),S={tooltip:{trigger:"axis",formatter:g=>{if(!Array.isArray(g)||g.length===0)return"";const $=g[0]?.axisValue,N=typeof $=="string"&&$.length===2?`${$}:00`:String($??""),V=g.map(s=>`${s.marker} ${s.seriesName}: ${s.value??0}`);return`<b>${N}</b><br/>${V.join("<br/>")}`}},legend:{data:[`${p}`,`${p} (forecast)`],top:6},grid:{left:40,right:16,top:48,bottom:36},xAxis:{type:"category",data:F,axisLabel:{formatter:g=>`${g}:00`}},yAxis:{type:"value"},series:[{name:`${p}`,type:"line",smooth:!0,areaStyle:{},data:F.map(()=>0),color:T,showSymbol:!1,lineStyle:{width:2}},{name:`${p} (forecast)`,type:"line",smooth:!0,areaStyle:{opacity:.12},data:F.map(()=>0),color:O,showSymbol:!1,lineStyle:{width:2,type:"dashed"}}],graphic:{elements:[{type:"text",left:"center",top:"middle",style:{text:"Cargando...",fill:"#9ca3af",fontSize:14}}]},toolbox:{show:!0,feature:{saveAsImage:{}}}};m.setOption(S);function d(g){const b=new Map((g||[]).map(s=>[String(s.hour).padStart(2,"0"),s])),$=F.map(s=>Number((b.get(s)&&b.get(s)[i])??0)),N=F.map(s=>Number((b.get(s)&&b.get(s)[i+"Forecast"])??0)),V=$.some(s=>s>0)||N.some(s=>s>0);m.setOption({xAxis:{data:F},series:[{name:`${p}`,data:$},{name:`${p} (forecast)`,data:N}],graphic:V?{elements:[]}:{elements:[{type:"text",left:"center",top:"middle",style:{text:"Sin datos",fill:"#9ca3af",fontSize:14}}]}},{replaceMerge:["series","xAxis.data"]})}const u=new ResizeObserver(()=>m.resize());u.observe(M);function f(){try{u.disconnect()}catch{}try{m.dispose()}catch{}try{document.removeEventListener("fragment:will-unload",w)}catch{}}const w=()=>{document.removeEventListener("fragment:will-unload",w),f()};return document.addEventListener("fragment:will-unload",w,{once:!0}),m.__hourly_metric_cleanup=f,{chart:m,refresh:g=>d(g),destroy:f}}async function it(l,i,p){const D=p?.refreshMs,C=await X(l,"attendance","Asistencias","#chart-hourly-attendance"),L=await X(l,"rounds","Rondas","#chart-hourly-rounds"),M=await X(l,"visits","Visitas","#chart-hourly-visits"),F=u=>{C&&C.refresh(u),L&&L.refresh(u),M&&M.refresh(u)};let T="UTC";try{T=Intl.DateTimeFormat().resolvedOptions().timeZone||"UTC"}catch{}async function O(u){const f=u?`?date=${encodeURIComponent(u)}&tz=${encodeURIComponent(T)}`:`?tz=${encodeURIComponent(T)}`,w=`/api/attendance/hourly${f}`,A=`/api/patrols-runs/hourly${f}`,g=`/api/site-supervision-visits/hourly-aggregated${f}`;try{const[b,$,N]=await Promise.all([U(w),U(A),U(g)]),V=b.ok?await b.json().catch(()=>[]):[],s=$.ok?await $.json().catch(()=>[]):[],j=N.ok?await N.json().catch(()=>[]):[],P=new Map(V.map(e=>[String(e.hour).padStart(2,"0"),e])),_=new Map(s.map(e=>[String(e.hour).padStart(2,"0"),e])),R=new Map(j.map(e=>[String(e.hour).padStart(2,"0"),e]));return Array.from({length:24},(e,c)=>String(c).padStart(2,"0")).map(e=>({hour:e,attendance:Number(P.get(e)?.count??P.get(e)?.cnt??0),attendanceForecast:Number(P.get(e)?.forecast??0),rounds:Number(_.get(e)?.count??_.get(e)?.cnt??0),roundsForecast:Number(_.get(e)?.forecast??0),visits:Number(R.get(e)?.count??R.get(e)?.cnt??0),visitsForecast:Number(R.get(e)?.forecast??0)}))}catch(b){return console.warn("[initThreeMetrics] fetchHourlyCombined error",b),Array.from({length:24},($,N)=>({hour:String(N).padStart(2,"0")}))}}const m=await O(i);m&&m.length&&F(m);let S;S=window.setInterval(async()=>{const u=await O(i);u&&u.length&&F(u)},D);const d=()=>{document.removeEventListener("fragment:will-unload",d);try{S&&window.clearInterval(S)}catch{}[C,L,M].forEach(u=>{if(!u)return;const f=u.chart;if(f&&f.__hourly_metric_cleanup)try{f.__hourly_metric_cleanup()}catch{}else try{u.chart.dispose()}catch{}})};return document.addEventListener("fragment:will-unload",d,{once:!0}),{stop:()=>{try{S&&window.clearInterval(S)}catch{}d()}}}function ct(l=new Date){return`${l.getFullYear()}-${String(l.getMonth()+1).padStart(2,"0")}-01`}function lt(l=new Date){const i=l.getFullYear(),p=l.getMonth()+1,D=new Date(i,p,0).getDate();return`${i}-${String(p).padStart(2,"0")}-${String(D).padStart(2,"0")}`}async function nt({container:l}){const i=l.querySelector("#client-dashboard-root")||l;if(!i||i.dataset.echartsInit==="1")return;i.dataset.echartsInit="1";const p=i.getAttribute("data-client-id")||"1",D=ct(),C=lt(),L=i.querySelector("#chart-att"),M=i.querySelector("#chart-patrol"),F=i.querySelector("#chart-inc"),T=i.querySelector("#chart-visit"),O=i.querySelector("#chart-visit-site"),m=[],S=t=>t?st(t,void 0,{renderer:"canvas"}):null,d=(t,e="Sin datos")=>{t&&t.setOption({graphic:{elements:[{type:"text",left:"center",top:"middle",style:{text:e,fill:"#9ca3af",fontSize:14}}]}})};async function u(t,e={},c=15e3,y=!1){const o=new AbortController,x={...e,signal:o.signal},I=setTimeout(()=>o.abort(),c);try{return y?await U(String(t),x):await fetch(t,x)}finally{clearTimeout(I)}}const f=S(L);f&&m.push(f);try{const t=await U(`/api/attendance/series?clientId=${p}&from=${D}&to=${C}&action=IN`);if(t.ok){const e=await t.json().catch(()=>[]),c=e.map(o=>o.x),y=e.map(o=>o.y);f?.setOption({tooltip:{trigger:"axis"},grid:{left:40,right:16,top:24,bottom:32},xAxis:{type:"category",boundaryGap:!1,data:c},yAxis:{type:"value"},series:[{type:"line",smooth:!0,areaStyle:{},data:y}],graphic:y.some(o=>Number(o)>0)?{elements:[]}:void 0}),y.some(o=>Number(o)>0)||d(f)}else d(f,"Error de datos")}catch{d(f,"Error de datos")}const w=S(M);w&&m.push(w);try{const t=Intl.DateTimeFormat().resolvedOptions().timeZone||"UTC",e=`/api/site-patrols/series?clientId=${p}&from=${D}&to=${C}&tz=${encodeURIComponent(t)}`,c=await U(e);if(c.ok){const y=await c.json().catch(()=>[]),o=y.map(I=>I.x),x=y.map(I=>I.y);w?.setOption({tooltip:{trigger:"axis"},grid:{left:40,right:16,top:24,bottom:32},xAxis:{type:"category",boundaryGap:!1,data:o},yAxis:{type:"value"},series:[{type:"line",smooth:!0,areaStyle:{},data:x,color:"#34D399"}],graphic:x.some(I=>Number(I)>0)?{elements:[]}:void 0}),x.some(I=>Number(I)>0)||d(w)}else d(w,"Error de datos")}catch(t){console.error("Error cargando series de rondas",t),d(w,"Error de datos")}window.addEventListener("resize",()=>w?.resize());const A=S(T);A&&m.push(A);const g=navigator.language||"es",b=new Intl.DateTimeFormat(g,{day:"2-digit",month:"short"});function $(t){if(!t)return null;const e=t.includes("T")?t:`${t}T00:00:00`,c=new Date(e);return Number.isNaN(c.getTime())?null:c}function N(t){const e=$(t);return e?b.format(e).replace(".","").replace(/\s+/,"-"):t??""}function V(t,e){const c=[],y=new Date;for(let o=t-1;o>=0;o--){const x=new Date(y);x.setDate(y.getDate()-o),c.push(`${x.getFullYear()}-${String(x.getMonth()+1).padStart(2,"0")}-${String(x.getDate()).padStart(2,"0")}`)}return c}try{let t=function(r){if(r==null)return"";const a=String(r).trim();if(!a)return"";if(/^\d{4}-\d{2}-\d{2}$/.test(a)){const[h,z,E]=a.split("-"),H=Number(h),v=Number(z),k=Number(E);if(Number.isFinite(H)&&Number.isFinite(v)&&Number.isFinite(k)){const Z=new Date(H,v-1,k);return`${Z.getFullYear()}-${String(Z.getMonth()+1).padStart(2,"0")}-${String(Z.getDate()).padStart(2,"0")}`}return""}const n=new Date(a);return Number.isNaN(n.getTime())?a.split("T")[0]||"":`${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,"0")}-${String(n.getDate()).padStart(2,"0")}`};const e=Intl.DateTimeFormat().resolvedOptions().timeZone||"UTC",c=7,y=`/api/site-supervision-visits/series?days=${c}&tz=${encodeURIComponent(e)}`,o=`/api/forecasts/forecast-series?days=${c}&tz=${encodeURIComponent(e)}`,[x,I]=await Promise.all([u(y,{},15e3,!0).catch(r=>(console.warn("Fetch actual visits failed",r),null)),u(o,{},15e3,!0).catch(r=>(console.warn("Fetch forecast visits failed",r),null))]),J=async(r,a)=>r?r.ok?await r.json().catch(n=>(console.warn(`${a} json parse error`,n),[])):(console.warn(`${a} returned status`,r.status),[]):[],[G,W]=await Promise.all([J(x,"actual visits"),J(I,"forecast visits")]);if((!Array.isArray(G)||G.length===0)&&(!Array.isArray(W)||W.length===0)){d(A,"Sin datos");return}const Q=r=>Array.isArray(r)?r.map(a=>{let n="";Array.isArray(a)?n=a[0]:n=a?.x??a?.date??a?.day??"";let h=0;Array.isArray(a)&&a.length>1?h=a[1]:h=a?.y??a?.value??0;const z=t(n),E=typeof h=="number"?h:Number(String(h??0));return{x:z,y:Number.isFinite(E)?E:0}}).filter(a=>a.x&&typeof a.x=="string"&&a.x.length>=4):[],K=Q(G),tt=Q(W);let q=V(c,e);const et=r=>{const a=new Map;return r.forEach(n=>{if(!n||!n.x)return;const h=a.get(n.x)??0;a.set(n.x,h+(Number.isFinite(Number(n.y))?Number(n.y):0))}),a},rt=et(K),at=et(tt),Y=q.map(r=>rt.has(r)?rt.get(r):0),B=q.map(r=>at.has(r)?at.get(r):0),ot=i.querySelector("#donut-visit");if(ot){const r=S(ot);if(r){m.push(r);const a=Y.reduce((v,k)=>v+(Number(k)||0),0),n=B.reduce((v,k)=>v+(Number(k)||0),0),h=n>0,z=h?Math.round(a/n*100):0,E=h?Math.min(100,Math.max(0,z)):100,H=h?[{value:E,name:"Cumplido",itemStyle:{color:"#10B981"}},{value:100-E,name:"Pendiente",itemStyle:{color:"#E5E7EB"}}]:[{value:1,name:"Sin meta",itemStyle:{color:"#E5E7EB"}}];r.setOption({tooltip:{trigger:"item",formatter:v=>h?v&&v.name==="Cumplido"?`${v.marker} ${v.seriesName}: ${a} / ${n} (${z}%)`:v&&v.name==="Pendiente"?`${v.marker} Pendiente: ${Math.max(0,n-a)}`:"":"Meta no definida"},series:[{name:"Cumplimiento Visitas",type:"pie",radius:["62%","82%"],avoidLabelOverlap:!1,hoverAnimation:!1,label:{show:!0,position:"center",formatter:h?`${z}%`:"â€”",fontSize:12,fontWeight:700,color:"#111827"},labelLine:{show:!1},data:H}]})}}if(console.debug("[visits-chart] labels:",q),console.debug("[visits-chart] normActual:",K),console.debug("[visits-chart] normForecast:",tt),console.debug("[visits-chart] valuesActual:",Y),console.debug("[visits-chart] valuesForecast:",B),!A){d(A,"Sin datos");return}A.clear(),A.setOption({legend:{data:["Visitas reales","Forecast (previsto)"],top:6},tooltip:{trigger:"axis",formatter:r=>{if(!Array.isArray(r)||r.length===0)return"";const a=r[0];let n=a.axisValue??(a&&typeof a.dataIndex=="number"?q[a.dataIndex]:void 0);!n&&a.axisValueLabel&&(n=a.axisValueLabel);const h=N(String(n??"")),z=r.map(E=>`${E.marker} ${E.seriesName}: ${E.value??0}`);return`<b>${h}</b><br/>${z.join("<br/>")}`}},grid:{left:40,right:16,top:48,bottom:36},xAxis:{type:"category",boundaryGap:!1,data:q,axisLabel:{rotate:0,formatter:function(r){return N(r)}}},yAxis:{type:"value"},series:[{name:"Visitas reales",type:"line",smooth:!0,areaStyle:{},data:Y,color:"#0ea5e9",showSymbol:!1,lineStyle:{width:2}},{name:"Forecast (previsto)",type:"line",smooth:!0,areaStyle:{opacity:.12},data:B,color:"#f59e0b",showSymbol:!1,lineStyle:{width:2,type:"dashed"}}],graphic:Y.concat(B).some(r=>Number(r)>0)?{elements:[]}:void 0}),Y.some(r=>Number(r)>0)||B.some(r=>Number(r)>0)||d(A,"Sin visitas")}catch(t){t?.name==="AbortError"?console.debug("Visits/Forecast fetch aborted (timeout or navigation)",t):console.error("Error obteniendo series de visitas/forecast",t),d(A,"Error de datos")}const s=S(O);s&&m.push(s);try{const t=await U(`/api/site-supervision-visits/series-by-site?clientId=${p}&from=${D}&to=${C}`);if(t.ok){const e=await t.json().catch(()=>[]),c=e.map(o=>o.siteName),y=e.map(o=>o.count);s?.setOption({tooltip:{trigger:"axis"},grid:{left:60,right:16,top:24,bottom:32},xAxis:{type:"value"},yAxis:{type:"category",data:c,axisLabel:{interval:0,fontSize:12}},series:[{type:"bar",data:y,itemStyle:{color:"#0ea5e9"}}],graphic:y.some(o=>Number(o)>0)?{elements:[]}:void 0}),y.some(o=>Number(o)>0)||d(s)}else d(s,"Error de datos")}catch{d(s,"Error de datos")}const j=new Date,P=`${j.getFullYear()}-${String(j.getMonth()+1).padStart(2,"0")}-${String(j.getDate()).padStart(2,"0")}`;try{it(i,P,{refreshMs:6e4})}catch(t){console.warn("[client-dashboard] initThreeMetrics failed",t)}const _=new ResizeObserver(()=>m.forEach(t=>t?.resize()));[L,F,T,O].forEach(t=>t&&_.observe(t));const R=()=>{document.removeEventListener("fragment:will-unload",R);try{_.disconnect()}catch{}m.forEach(t=>{try{t.dispose()}catch{}}),i.dataset.echartsInit="0"};document.addEventListener("fragment:will-unload",R,{once:!0})}if(document.readyState==="loading")document.addEventListener("DOMContentLoaded",()=>{const l=document.getElementById("client-dashboard-root");l&&nt({container:l})});else{const l=document.getElementById("client-dashboard-root");l&&nt({container:l})}
