import{i as et,f as C}from"../chunks/api-Bh71dfFu.js";async function Z(l,n,h,$,E,T){const F=l.querySelector($);if(!F)return console.warn(`[hourly metric] ${$} no existe`),null;const x=Array.from({length:24},(I,b)=>String(b).padStart(2,"0")),N="#3b82f6",D="#60a5fa",f=et(F,void 0,{renderer:"canvas"}),y=x.map(()=>0);f.setOption({tooltip:{trigger:"axis"},legend:{top:6},grid:{left:40,right:16,top:36,bottom:28},xAxis:{type:"category",data:x,axisLabel:{formatter:I=>I+"h"}},yAxis:{type:"value",minInterval:1},series:[{name:`${h} (real)`,type:"bar",data:y,itemStyle:{color:N}},{name:`${h} (forecast)`,type:"line",smooth:!0,data:y,lineStyle:{type:"dashed",color:D},symbol:"circle",symbolSize:6}],graphic:{elements:[{type:"text",left:"center",top:"middle",style:{text:"Cargando...",fill:"#9ca3af",fontSize:14}}]},toolbox:{show:!0,feature:{saveAsImage:{}}}});function d(I){const b=new Map((I||[]).map(i=>[String(i.hour).padStart(2,"0"),i])),z=x.map(i=>Number((b.get(i)&&b.get(i)[n])??0)),A=x.map(i=>Number((b.get(i)&&b.get(i)[n+"Forecast"])??0)),U=z.some(i=>i>0)||A.some(i=>i>0);f.setOption({xAxis:{data:x},series:[{name:`${h} (real)`,type:"bar",data:z,itemStyle:{color:N}},{name:`${h} (forecast)`,type:"line",smooth:!0,data:A,lineStyle:{type:"dashed",color:D},symbol:"circle",symbolSize:6}],graphic:U?{elements:[]}:{elements:[{type:"text",left:"center",top:"middle",style:{text:"Sin datos",fill:"#9ca3af",fontSize:14}}]}})}const u=new ResizeObserver(()=>f.resize());u.observe(F);function m(){try{u.disconnect()}catch{}try{f.dispose()}catch{}try{document.removeEventListener("fragment:will-unload",g)}catch{}}const g=()=>{document.removeEventListener("fragment:will-unload",g),m()};return document.addEventListener("fragment:will-unload",g,{once:!0}),f.__hourly_metric_cleanup=m,{chart:f,refresh:I=>d(I),destroy:m}}async function rt(l,n,h){const $=h?.refreshMs,E=await Z(l,"attendance","Asistencias","#chart-hourly-attendance"),T=await Z(l,"rounds","Rondas","#chart-hourly-rounds"),F=await Z(l,"visits","Visitas","#chart-hourly-visits"),x=u=>{E&&E.refresh(u),T&&T.refresh(u),F&&F.refresh(u)};let N="UTC";try{N=Intl.DateTimeFormat().resolvedOptions().timeZone||"UTC"}catch{}async function D(u){const m=u?`?date=${encodeURIComponent(u)}&tz=${encodeURIComponent(N)}`:`?tz=${encodeURIComponent(N)}`,g=`/api/attendance/hourly${m}`,S=`/api/patrols-runs/hourly${m}`,I=`/api/site-supervision-visits/hourly${m}`;try{const[b,z,A]=await Promise.all([C(g),C(S),C(I)]),U=b.ok?await b.json().catch(()=>[]):[],i=z.ok?await z.json().catch(()=>[]):[],k=A.ok?await A.json().catch(()=>[]):[],R=new Map(U.map(e=>[String(e.hour).padStart(2,"0"),e])),O=new Map(i.map(e=>[String(e.hour).padStart(2,"0"),e])),L=new Map(k.map(e=>[String(e.hour).padStart(2,"0"),e]));return Array.from({length:24},(e,a)=>String(a).padStart(2,"0")).map(e=>({hour:e,attendance:Number(R.get(e)?.count??R.get(e)?.cnt??0),attendanceForecast:Number(R.get(e)?.forecast??0),rounds:Number(O.get(e)?.count??O.get(e)?.cnt??0),roundsForecast:Number(O.get(e)?.forecast??0),visits:Number(L.get(e)?.count??L.get(e)?.cnt??0),visitsForecast:Number(L.get(e)?.forecast??0)}))}catch(b){return console.warn("[initThreeMetrics] fetchHourlyCombined error",b),Array.from({length:24},(z,A)=>({hour:String(A).padStart(2,"0")}))}}const f=await D(n);f&&f.length&&x(f);let y;y=window.setInterval(async()=>{const u=await D(n);u&&u.length&&x(u)},$);const d=()=>{document.removeEventListener("fragment:will-unload",d);try{y&&window.clearInterval(y)}catch{}[E,T,F].forEach(u=>{if(!u)return;const m=u.chart;if(m&&m.__hourly_metric_cleanup)try{m.__hourly_metric_cleanup()}catch{}else try{u.chart.dispose()}catch{}})};return document.addEventListener("fragment:will-unload",d,{once:!0}),{stop:()=>{try{y&&window.clearInterval(y)}catch{}d()}}}function ot(l=new Date){return`${l.getFullYear()}-${String(l.getMonth()+1).padStart(2,"0")}-01`}function at(l=new Date){const n=l.getFullYear(),h=l.getMonth()+1,$=new Date(n,h,0).getDate();return`${n}-${String(h).padStart(2,"0")}-${String($).padStart(2,"0")}`}async function tt({container:l}){const n=l.querySelector("#client-dashboard-root")||l;if(!n||n.dataset.echartsInit==="1")return;n.dataset.echartsInit="1";const h=n.getAttribute("data-client-id")||"1",$=ot(),E=at(),T=n.querySelector("#chart-att"),F=n.querySelector("#chart-patrol"),x=n.querySelector("#chart-inc"),N=n.querySelector("#chart-visit"),D=n.querySelector("#chart-visit-site");try{const t=Intl.DateTimeFormat().resolvedOptions().timeZone||"UTC",e=`/api/clients/dashboard/kpis?tz=${encodeURIComponent(t)}`,a=await C(e);if(a.ok){const c=await a.json();n.querySelector('[data-kpi="att"]').textContent=String(c.asistenciaHoy??0),n.querySelector('[data-kpi="patrol"]').textContent=String(c.rondasHoy??0),n.querySelector('[data-kpi="visit"]').textContent=String(c.visitasHoy??0)}else console.warn("KPIs fetch no OK",a.status)}catch(t){console.error("Error obteniendo KPIs",t)}const f=[],y=t=>t?et(t,void 0,{renderer:"canvas"}):null,d=(t,e="Sin datos")=>{t&&t.setOption({graphic:{elements:[{type:"text",left:"center",top:"middle",style:{text:e,fill:"#9ca3af",fontSize:14}}]}})};async function u(t,e={},a=15e3,c=!1){const o=new AbortController,v={...e,signal:o.signal},w=setTimeout(()=>o.abort(),a);try{return c?await C(String(t),v):await fetch(t,v)}finally{clearTimeout(w)}}const m=y(T);m&&f.push(m);try{const t=await C(`/api/attendance/series?clientId=${h}&from=${$}&to=${E}&action=IN`);if(t.ok){const e=await t.json().catch(()=>[]),a=e.map(o=>o.x),c=e.map(o=>o.y);m?.setOption({tooltip:{trigger:"axis"},grid:{left:40,right:16,top:24,bottom:32},xAxis:{type:"category",boundaryGap:!1,data:a},yAxis:{type:"value"},series:[{type:"line",smooth:!0,areaStyle:{},data:c}],graphic:c.some(o=>Number(o)>0)?{elements:[]}:void 0}),c.some(o=>Number(o)>0)||d(m)}else d(m,"Error de datos")}catch{d(m,"Error de datos")}const g=y(F);g&&f.push(g);try{const t=Intl.DateTimeFormat().resolvedOptions().timeZone||"UTC",e=`/api/site-patrols/series?clientId=${h}&from=${$}&to=${E}&tz=${encodeURIComponent(t)}`,a=await C(e);if(a.ok){const c=await a.json().catch(()=>[]),o=c.map(w=>w.x),v=c.map(w=>w.y);g?.setOption({tooltip:{trigger:"axis"},grid:{left:40,right:16,top:24,bottom:32},xAxis:{type:"category",boundaryGap:!1,data:o},yAxis:{type:"value"},series:[{type:"line",smooth:!0,areaStyle:{},data:v,color:"#34D399"}],graphic:v.some(w=>Number(w)>0)?{elements:[]}:void 0}),v.some(w=>Number(w)>0)||d(g)}else d(g,"Error de datos")}catch(t){console.error("Error cargando series de rondas",t),d(g,"Error de datos")}window.addEventListener("resize",()=>g?.resize());const S=y(N);S&&f.push(S);const I=navigator.language||"es",b=new Intl.DateTimeFormat(I,{day:"2-digit",month:"short"});function z(t){if(!t)return null;const e=t.includes("T")?t:`${t}T00:00:00`,a=new Date(e);return Number.isNaN(a.getTime())?null:a}function A(t){const e=z(t);return e?b.format(e).replace(".","").replace(/\s+/,"-"):t??""}function U(t,e){const a=[],c=new Date;for(let o=t-1;o>=0;o--){const v=new Date(c);v.setDate(c.getDate()-o),a.push(`${v.getFullYear()}-${String(v.getMonth()+1).padStart(2,"0")}-${String(v.getDate()).padStart(2,"0")}`)}return a}try{let t=function(r){if(!r)return"";const s=new Date(String(r));return Number.isNaN(s.getTime())?String(r).split("T")[0]||String(r):`${s.getFullYear()}-${String(s.getMonth()+1).padStart(2,"0")}-${String(s.getDate()).padStart(2,"0")}`};const e=Intl.DateTimeFormat().resolvedOptions().timeZone||"UTC",a=7,c=`/api/site-supervision-visits/series?days=${a}&tz=${encodeURIComponent(e)}`,o=`/api/forecasts/forecast-series?days=${a}&tz=${encodeURIComponent(e)}`,[v,w]=await Promise.all([u(c,{},15e3,!0).catch(r=>(console.warn("Fetch actual visits failed",r),null)),u(o,{},15e3,!0).catch(r=>(console.warn("Fetch forecast visits failed",r),null))]),G=async(r,s)=>r?r.ok?await r.json().catch(p=>(console.warn(`${s} json parse error`,p),[])):(console.warn(`${s} returned status`,r.status),[]):[],[H,Y]=await Promise.all([G(v,"actual visits"),G(w,"forecast visits")]);if((!Array.isArray(H)||H.length===0)&&(!Array.isArray(Y)||Y.length===0)){d(S,"Sin datos");return}const B=r=>Array.isArray(r)?r.map(s=>{const p=s?.x??"",V=t(p),q=s?.y,M=typeof q=="number"?q:Number(String(q??0));return{x:V,y:Number.isFinite(M)?M:0}}).filter(s=>s.x):[],K=B(H),W=B(Y);let _=U(a,e);const X=r=>{const s=new Map;return r.forEach(p=>{if(!p||!p.x)return;const V=s.get(p.x)??0;s.set(p.x,V+(Number.isFinite(Number(p.y))?Number(p.y):0))}),s},J=X(K),Q=X(W),j=_.map(r=>J.has(r)?J.get(r):0),P=_.map(r=>Q.has(r)?Q.get(r):0);if(console.debug("[visits-chart] labels:",_),console.debug("[visits-chart] normActual:",K),console.debug("[visits-chart] normForecast:",W),console.debug("[visits-chart] valuesActual:",j),console.debug("[visits-chart] valuesForecast:",P),!S){d(S,"Sin datos");return}S.clear(),S.setOption({legend:{data:["Visitas reales","Forecast (previsto)"],top:6},tooltip:{trigger:"axis",formatter:r=>{if(!Array.isArray(r)||r.length===0)return"";const s=r[0];let p=s.axisValue??(s&&typeof s.dataIndex=="number"?_[s.dataIndex]:void 0);!p&&s.axisValueLabel&&(p=s.axisValueLabel);const V=A(String(p??"")),q=r.map(M=>`${M.marker} ${M.seriesName}: ${M.value??0}`);return`<b>${V}</b><br/>${q.join("<br/>")}`}},grid:{left:40,right:16,top:48,bottom:36},xAxis:{type:"category",boundaryGap:!1,data:_,axisLabel:{rotate:0,formatter:function(r){return A(r)}}},yAxis:{type:"value"},series:[{name:"Visitas reales",type:"line",smooth:!0,areaStyle:{},data:j,color:"#0ea5e9",showSymbol:!1,lineStyle:{width:2}},{name:"Forecast (previsto)",type:"line",smooth:!0,areaStyle:{opacity:.12},data:P,color:"#f59e0b",showSymbol:!1,lineStyle:{width:2,type:"dashed"}}],graphic:j.concat(P).some(r=>Number(r)>0)?{elements:[]}:void 0}),j.some(r=>Number(r)>0)||P.some(r=>Number(r)>0)||d(S,"Sin visitas")}catch(t){t?.name==="AbortError"?console.debug("Visits/Forecast fetch aborted (timeout or navigation)",t):console.error("Error obteniendo series de visitas/forecast",t),d(S,"Error de datos")}const i=y(D);i&&f.push(i);try{const t=await C(`/api/site-supervision-visits/series-by-site?clientId=${h}&from=${$}&to=${E}`);if(t.ok){const e=await t.json().catch(()=>[]),a=e.map(o=>o.siteName),c=e.map(o=>o.count);i?.setOption({tooltip:{trigger:"axis"},grid:{left:60,right:16,top:24,bottom:32},xAxis:{type:"value"},yAxis:{type:"category",data:a,axisLabel:{interval:0,fontSize:12}},series:[{type:"bar",data:c,itemStyle:{color:"#0ea5e9"}}],graphic:c.some(o=>Number(o)>0)?{elements:[]}:void 0}),c.some(o=>Number(o)>0)||d(i)}else d(i,"Error de datos")}catch{d(i,"Error de datos")}const k=new Date,R=`${k.getFullYear()}-${String(k.getMonth()+1).padStart(2,"0")}-${String(k.getDate()).padStart(2,"0")}`;try{rt(n,R,{refreshMs:6e4})}catch(t){console.warn("[client-dashboard] initThreeMetrics failed",t)}const O=new ResizeObserver(()=>f.forEach(t=>t?.resize()));[T,x,N,D].forEach(t=>t&&O.observe(t));const L=()=>{document.removeEventListener("fragment:will-unload",L);try{O.disconnect()}catch{}f.forEach(t=>{try{t.dispose()}catch{}}),n.dataset.echartsInit="0"};document.addEventListener("fragment:will-unload",L,{once:!0})}if(document.readyState==="loading")document.addEventListener("DOMContentLoaded",()=>{const l=document.getElementById("client-dashboard-root");l&&tt({container:l})});else{const l=document.getElementById("client-dashboard-root");l&&tt({container:l})}
