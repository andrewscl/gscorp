import{i as _,f as I}from"../chunks/api-Bh71dfFu.js";async function M(n,a,m,v,x,$){const S=n.querySelector(v);if(!S)return console.warn(`[hourly metric] ${v} no existe`),null;const y=Array.from({length:24},(g,u)=>String(u).padStart(2,"0")),b="#3b82f6",f="#60a5fa",d=_(S,void 0,{renderer:"canvas"}),c=y.map(()=>0);d.setOption({tooltip:{trigger:"axis"},legend:{top:6},grid:{left:40,right:16,top:36,bottom:28},xAxis:{type:"category",data:y,axisLabel:{formatter:g=>g+"h"}},yAxis:{type:"value",minInterval:1},series:[{name:`${m} (real)`,type:"bar",data:c,itemStyle:{color:b}},{name:`${m} (forecast)`,type:"line",smooth:!0,data:c,lineStyle:{type:"dashed",color:f},symbol:"circle",symbolSize:6}],graphic:{elements:[{type:"text",left:"center",top:"middle",style:{text:"Cargando...",fill:"#9ca3af",fontSize:14}}]},toolbox:{show:!0,feature:{saveAsImage:{}}}});function h(g){const u=new Map((g||[]).map(e=>[String(e.hour).padStart(2,"0"),e])),t=y.map(e=>Number((u.get(e)&&u.get(e)[a])??0)),s=y.map(e=>Number((u.get(e)&&u.get(e)[a+"Forecast"])??0)),p=t.some(e=>e>0)||s.some(e=>e>0);d.setOption({xAxis:{data:y},series:[{name:`${m} (real)`,type:"bar",data:t,itemStyle:{color:b}},{name:`${m} (forecast)`,type:"line",smooth:!0,data:s,lineStyle:{type:"dashed",color:f},symbol:"circle",symbolSize:6}],graphic:p?{elements:[]}:{elements:[{type:"text",left:"center",top:"middle",style:{text:"Sin datos",fill:"#9ca3af",fontSize:14}}]}})}const r=new ResizeObserver(()=>d.resize());r.observe(S);function l(){try{r.disconnect()}catch{}try{d.dispose()}catch{}try{document.removeEventListener("fragment:will-unload",w)}catch{}}const w=()=>{document.removeEventListener("fragment:will-unload",w),l()};return document.addEventListener("fragment:will-unload",w,{once:!0}),d.__hourly_metric_cleanup=l,{chart:d,refresh:g=>h(g),destroy:l}}async function N(n,a,m){const v=m?.refreshMs,x=await M(n,"attendance","Asistencias","#chart-hourly-attendance"),$=await M(n,"rounds","Rondas","#chart-hourly-rounds"),S=await M(n,"visits","Visitas","#chart-hourly-visits"),y=r=>{x&&x.refresh(r),$&&$.refresh(r),S&&S.refresh(r)};let b="UTC";try{b=Intl.DateTimeFormat().resolvedOptions().timeZone||"UTC"}catch{}async function f(r){const l=r?`?date=${encodeURIComponent(r)}&tz=${encodeURIComponent(b)}`:`?tz=${encodeURIComponent(b)}`,w=`/api/attendance/hourly${l}`,E=`/api/patrols-runs/hourly${l}`,g=`/api/site-supervision-visits/hourly${l}`;try{const[u,t,s]=await Promise.all([I(w),I(E),I(g)]),p=u.ok?await u.json().catch(()=>[]):[],e=t.ok?await t.json().catch(()=>[]):[],o=s.ok?await s.json().catch(()=>[]):[],A=new Map(p.map(i=>[String(i.hour).padStart(2,"0"),i])),C=new Map(e.map(i=>[String(i.hour).padStart(2,"0"),i])),z=new Map(o.map(i=>[String(i.hour).padStart(2,"0"),i]));return Array.from({length:24},(i,k)=>String(k).padStart(2,"0")).map(i=>({hour:i,attendance:Number(A.get(i)?.count??A.get(i)?.cnt??0),attendanceForecast:Number(A.get(i)?.forecast??0),rounds:Number(C.get(i)?.count??C.get(i)?.cnt??0),roundsForecast:Number(C.get(i)?.forecast??0),visits:Number(z.get(i)?.count??z.get(i)?.cnt??0),visitsForecast:Number(z.get(i)?.forecast??0)}))}catch(u){return console.warn("[initThreeMetrics] fetchHourlyCombined error",u),Array.from({length:24},(t,s)=>({hour:String(s).padStart(2,"0")}))}}const d=await f(a);d&&d.length&&y(d);let c;c=window.setInterval(async()=>{const r=await f(a);r&&r.length&&y(r)},v);const h=()=>{document.removeEventListener("fragment:will-unload",h);try{c&&window.clearInterval(c)}catch{}[x,$,S].forEach(r=>{if(!r)return;const l=r.chart;if(l&&l.__hourly_metric_cleanup)try{l.__hourly_metric_cleanup()}catch{}else try{r.chart.dispose()}catch{}})};return document.addEventListener("fragment:will-unload",h,{once:!0}),{stop:()=>{try{c&&window.clearInterval(c)}catch{}h()}}}function D(n=new Date){return`${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,"0")}-01`}function R(n=new Date){const a=n.getFullYear(),m=n.getMonth()+1,v=new Date(a,m,0).getDate();return`${a}-${String(m).padStart(2,"0")}-${String(v).padStart(2,"0")}`}async function O({container:n}){const a=n.querySelector("#client-dashboard-root")||n;if(!a||a.dataset.echartsInit==="1")return;a.dataset.echartsInit="1";const m=a.getAttribute("data-client-id")||"1",v=D(),x=R(),$=a.querySelector("#chart-att"),S=a.querySelector("#chart-inc"),y=a.querySelector("#chart-visit"),b=a.querySelector("#chart-visit-site");try{const t=Intl.DateTimeFormat().resolvedOptions().timeZone||"UTC",s=`/api/clients/dashboard/kpis?tz=${encodeURIComponent(t)}`,p=await I(s);if(p.ok){const e=await p.json();a.querySelector('[data-kpi="att"]').textContent=String(e.asistenciaHoy??0),a.querySelector('[data-kpi="patrol"]').textContent=String(e.rondasHoy??0),a.querySelector('[data-kpi="visit"]').textContent=String(e.visitasHoy??0)}else console.warn("KPIs fetch no OK",p.status)}catch(t){console.error("Error obteniendo KPIs",t)}const f=[],d=t=>t?_(t,void 0,{renderer:"canvas"}):null,c=(t,s="Sin datos")=>{t&&t.setOption({graphic:{elements:[{type:"text",left:"center",top:"middle",style:{text:s,fill:"#9ca3af",fontSize:14}}]}})},h=d($);h&&f.push(h);try{const t=await I(`/api/attendance/series?clientId=${m}&from=${v}&to=${x}&action=IN`);if(t.ok){const s=await t.json().catch(()=>[]),p=s.map(o=>o.x),e=s.map(o=>o.y);h?.setOption({tooltip:{trigger:"axis"},grid:{left:40,right:16,top:24,bottom:32},xAxis:{type:"category",boundaryGap:!1,data:p},yAxis:{type:"value"},series:[{type:"line",smooth:!0,areaStyle:{},data:e}],graphic:e.some(o=>Number(o)>0)?{elements:[]}:void 0}),e.some(o=>Number(o)>0)||c(h)}else c(h,"Error de datos")}catch{c(h,"Error de datos")}const r=d(y);r&&f.push(r);try{const t=await I(`/api/site-supervision-visits/series?clientId=${m}&from=${v}&to=${x}`);if(t.ok){const s=await t.json().catch(()=>[]),p=s.map(o=>o.x),e=s.map(o=>o.y);r?.setOption({tooltip:{trigger:"axis"},grid:{left:40,right:16,top:24,bottom:32},xAxis:{type:"category",boundaryGap:!1,data:p},yAxis:{type:"value"},series:[{type:"line",smooth:!0,areaStyle:{},data:e,color:"#0ea5e9"}],graphic:e.some(o=>Number(o)>0)?{elements:[]}:void 0}),e.some(o=>Number(o)>0)||c(r)}else c(r,"Error de datos")}catch{c(r,"Error de datos")}const l=d(b);l&&f.push(l);try{const t=await I(`/api/site-supervision-visits/series-by-site?clientId=${m}&from=${v}&to=${x}`);if(t.ok){const s=await t.json().catch(()=>[]),p=s.map(o=>o.siteName),e=s.map(o=>o.count);l?.setOption({tooltip:{trigger:"axis"},grid:{left:60,right:16,top:24,bottom:32},xAxis:{type:"value"},yAxis:{type:"category",data:p,axisLabel:{interval:0,fontSize:12}},series:[{type:"bar",data:e,itemStyle:{color:"#0ea5e9"}}],graphic:e.some(o=>Number(o)>0)?{elements:[]}:void 0}),e.some(o=>Number(o)>0)||c(l)}else c(l,"Error de datos")}catch{c(l,"Error de datos")}const w=new Date,E=`${w.getFullYear()}-${String(w.getMonth()+1).padStart(2,"0")}-${String(w.getDate()).padStart(2,"0")}`;try{N(a,E,{refreshMs:6e4})}catch(t){console.warn("[client-dashboard] initThreeMetrics failed",t)}const g=new ResizeObserver(()=>f.forEach(t=>t?.resize()));[$,S,y,b].forEach(t=>t&&g.observe(t));const u=()=>{document.removeEventListener("fragment:will-unload",u);try{g.disconnect()}catch{}f.forEach(t=>{try{t.dispose()}catch{}}),a.dataset.echartsInit="0"};document.addEventListener("fragment:will-unload",u,{once:!0})}if(document.readyState==="loading")document.addEventListener("DOMContentLoaded",()=>{const n=document.getElementById("client-dashboard-root");n&&O({container:n})});else{const n=document.getElementById("client-dashboard-root");n&&O({container:n})}
