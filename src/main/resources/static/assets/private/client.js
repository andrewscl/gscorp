import{i as R,f as C}from"../chunks/api-Bh71dfFu.js";async function N(s,r,y,v,z,O){const x=s.querySelector(v);if(!x)return console.warn(`[hourly metric] ${v} no existe`),null;const S=Array.from({length:24},(b,l)=>String(l).padStart(2,"0")),$="#3b82f6",A="#60a5fa",d=R(x,void 0,{renderer:"canvas"}),h=S.map(()=>0);d.setOption({tooltip:{trigger:"axis"},legend:{top:6},grid:{left:40,right:16,top:36,bottom:28},xAxis:{type:"category",data:S,axisLabel:{formatter:b=>b+"h"}},yAxis:{type:"value",minInterval:1},series:[{name:`${y} (real)`,type:"bar",data:h,itemStyle:{color:$}},{name:`${y} (forecast)`,type:"line",smooth:!0,data:h,lineStyle:{type:"dashed",color:A},symbol:"circle",symbolSize:6}],graphic:{elements:[{type:"text",left:"center",top:"middle",style:{text:"Cargando...",fill:"#9ca3af",fontSize:14}}]},toolbox:{show:!0,feature:{saveAsImage:{}}}});function c(b){const l=new Map((b||[]).map(u=>[String(u.hour).padStart(2,"0"),u])),w=S.map(u=>Number((l.get(u)&&l.get(u)[r])??0)),I=S.map(u=>Number((l.get(u)&&l.get(u)[r+"Forecast"])??0)),U=w.some(u=>u>0)||I.some(u=>u>0);d.setOption({xAxis:{data:S},series:[{name:`${y} (real)`,type:"bar",data:w,itemStyle:{color:$}},{name:`${y} (forecast)`,type:"line",smooth:!0,data:I,lineStyle:{type:"dashed",color:A},symbol:"circle",symbolSize:6}],graphic:U?{elements:[]}:{elements:[{type:"text",left:"center",top:"middle",style:{text:"Sin datos",fill:"#9ca3af",fontSize:14}}]}})}const o=new ResizeObserver(()=>d.resize());o.observe(x);function i(){try{o.disconnect()}catch{}try{d.dispose()}catch{}try{document.removeEventListener("fragment:will-unload",g)}catch{}}const g=()=>{document.removeEventListener("fragment:will-unload",g),i()};return document.addEventListener("fragment:will-unload",g,{once:!0}),d.__hourly_metric_cleanup=i,{chart:d,refresh:b=>c(b),destroy:i}}async function _(s,r,y){const v=y?.refreshMs,z=await N(s,"attendance","Asistencias","#chart-hourly-attendance"),O=await N(s,"rounds","Rondas","#chart-hourly-rounds"),x=await N(s,"visits","Visitas","#chart-hourly-visits"),S=o=>{z&&z.refresh(o),O&&O.refresh(o),x&&x.refresh(o)};let $="UTC";try{$=Intl.DateTimeFormat().resolvedOptions().timeZone||"UTC"}catch{}async function A(o){const i=o?`?date=${encodeURIComponent(o)}&tz=${encodeURIComponent($)}`:`?tz=${encodeURIComponent($)}`,g=`/api/attendance/hourly${i}`,D=`/api/patrols-runs/hourly${i}`,b=`/api/site-supervision-visits/hourly${i}`;try{const[l,w,I]=await Promise.all([C(g),C(D),C(b)]),U=l.ok?await l.json().catch(()=>[]):[],u=w.ok?await w.json().catch(()=>[]):[],t=I.ok?await I.json().catch(()=>[]):[],m=new Map(U.map(e=>[String(e.hour).padStart(2,"0"),e])),p=new Map(u.map(e=>[String(e.hour).padStart(2,"0"),e])),a=new Map(t.map(e=>[String(e.hour).padStart(2,"0"),e]));return Array.from({length:24},(e,f)=>String(f).padStart(2,"0")).map(e=>({hour:e,attendance:Number(m.get(e)?.count??m.get(e)?.cnt??0),attendanceForecast:Number(m.get(e)?.forecast??0),rounds:Number(p.get(e)?.count??p.get(e)?.cnt??0),roundsForecast:Number(p.get(e)?.forecast??0),visits:Number(a.get(e)?.count??a.get(e)?.cnt??0),visitsForecast:Number(a.get(e)?.forecast??0)}))}catch(l){return console.warn("[initThreeMetrics] fetchHourlyCombined error",l),Array.from({length:24},(w,I)=>({hour:String(I).padStart(2,"0")}))}}const d=await A(r);d&&d.length&&S(d);let h;h=window.setInterval(async()=>{const o=await A(r);o&&o.length&&S(o)},v);const c=()=>{document.removeEventListener("fragment:will-unload",c);try{h&&window.clearInterval(h)}catch{}[z,O,x].forEach(o=>{if(!o)return;const i=o.chart;if(i&&i.__hourly_metric_cleanup)try{i.__hourly_metric_cleanup()}catch{}else try{o.chart.dispose()}catch{}})};return document.addEventListener("fragment:will-unload",c,{once:!0}),{stop:()=>{try{h&&window.clearInterval(h)}catch{}c()}}}function F(s=new Date){return`${s.getFullYear()}-${String(s.getMonth()+1).padStart(2,"0")}-01`}function L(s=new Date){const r=s.getFullYear(),y=s.getMonth()+1,v=new Date(r,y,0).getDate();return`${r}-${String(y).padStart(2,"0")}-${String(v).padStart(2,"0")}`}async function M({container:s}){const r=s.querySelector("#client-dashboard-root")||s;if(!r||r.dataset.echartsInit==="1")return;r.dataset.echartsInit="1";const y=r.getAttribute("data-client-id")||"1",v=F(),z=L(),O=r.querySelector("#chart-att"),x=r.querySelector("#chart-patrol"),S=r.querySelector("#chart-inc"),$=r.querySelector("#chart-visit"),A=r.querySelector("#chart-visit-site");try{const t=Intl.DateTimeFormat().resolvedOptions().timeZone||"UTC",m=`/api/clients/dashboard/kpis?tz=${encodeURIComponent(t)}`,p=await C(m);if(p.ok){const a=await p.json();r.querySelector('[data-kpi="att"]').textContent=String(a.asistenciaHoy??0),r.querySelector('[data-kpi="patrol"]').textContent=String(a.rondasHoy??0),r.querySelector('[data-kpi="visit"]').textContent=String(a.visitasHoy??0)}else console.warn("KPIs fetch no OK",p.status)}catch(t){console.error("Error obteniendo KPIs",t)}const d=[],h=t=>t?R(t,void 0,{renderer:"canvas"}):null,c=(t,m="Sin datos")=>{t&&t.setOption({graphic:{elements:[{type:"text",left:"center",top:"middle",style:{text:m,fill:"#9ca3af",fontSize:14}}]}})},o=h(O);o&&d.push(o);try{const t=await C(`/api/attendance/series?clientId=${y}&from=${v}&to=${z}&action=IN`);if(t.ok){const m=await t.json().catch(()=>[]),p=m.map(n=>n.x),a=m.map(n=>n.y);o?.setOption({tooltip:{trigger:"axis"},grid:{left:40,right:16,top:24,bottom:32},xAxis:{type:"category",boundaryGap:!1,data:p},yAxis:{type:"value"},series:[{type:"line",smooth:!0,areaStyle:{},data:a}],graphic:a.some(n=>Number(n)>0)?{elements:[]}:void 0}),a.some(n=>Number(n)>0)||c(o)}else c(o,"Error de datos")}catch{c(o,"Error de datos")}const i=h(x);i&&d.push(i);try{const t=Intl.DateTimeFormat().resolvedOptions().timeZone||"UTC",m=`/api/site-patrols/series?clientId=${y}&from=${v}&to=${z}&tz=${encodeURIComponent(t)}`,p=await C(m);if(p.ok){const a=await p.json().catch(()=>[]),n=a.map(f=>f.x),e=a.map(f=>f.y);i?.setOption({tooltip:{trigger:"axis"},grid:{left:40,right:16,top:24,bottom:32},xAxis:{type:"category",boundaryGap:!1,data:n},yAxis:{type:"value"},series:[{type:"line",smooth:!0,areaStyle:{},data:e,color:"#34D399"}],graphic:e.some(f=>Number(f)>0)?{elements:[]}:void 0}),e.some(f=>Number(f)>0)||c(i)}else c(i,"Error de datos")}catch(t){console.error("Error cargando series de rondas",t),c(i,"Error de datos")}window.addEventListener("resize",()=>i?.resize());const g=h($);g&&d.push(g);const b=new AbortController().signal;try{const t=Intl.DateTimeFormat().resolvedOptions().timeZone||"UTC",p=`/api/site-supervision-visits/series?days=7&tz=${encodeURIComponent(t)}`,a=await C(p,{signal:b});if(!a.ok){a.status===401&&console.warn("Unauthorized when fetching visits series"),c(g,"Error de datos");return}const n=await a.json().catch(()=>[]),e=n.map(E=>E.x),f=n.map(E=>{if(typeof E.y=="number")return E.y;const k=Number(E.y);return Number.isFinite(k)?k:0});g?.setOption({tooltip:{trigger:"axis"},grid:{left:40,right:16,top:24,bottom:32},xAxis:{type:"category",boundaryGap:!1,data:e},yAxis:{type:"value"},series:[{type:"line",smooth:!0,areaStyle:{},data:f,color:"#0ea5e9"}],graphic:f.some(E=>E>0)?{elements:[]}:void 0}),f.some(E=>E>0)||c(g)}catch(t){t?.name==="AbortError"?console.debug("Visits series fetch aborted"):(console.error("Error obteniendo series de visitas",t),c(g,"Error de datos"))}finally{}const l=h(A);l&&d.push(l);try{const t=await C(`/api/site-supervision-visits/series-by-site?clientId=${y}&from=${v}&to=${z}`);if(t.ok){const m=await t.json().catch(()=>[]),p=m.map(n=>n.siteName),a=m.map(n=>n.count);l?.setOption({tooltip:{trigger:"axis"},grid:{left:60,right:16,top:24,bottom:32},xAxis:{type:"value"},yAxis:{type:"category",data:p,axisLabel:{interval:0,fontSize:12}},series:[{type:"bar",data:a,itemStyle:{color:"#0ea5e9"}}],graphic:a.some(n=>Number(n)>0)?{elements:[]}:void 0}),a.some(n=>Number(n)>0)||c(l)}else c(l,"Error de datos")}catch{c(l,"Error de datos")}const w=new Date,I=`${w.getFullYear()}-${String(w.getMonth()+1).padStart(2,"0")}-${String(w.getDate()).padStart(2,"0")}`;try{_(r,I,{refreshMs:6e4})}catch(t){console.warn("[client-dashboard] initThreeMetrics failed",t)}const U=new ResizeObserver(()=>d.forEach(t=>t?.resize()));[O,S,$,A].forEach(t=>t&&U.observe(t));const u=()=>{document.removeEventListener("fragment:will-unload",u);try{U.disconnect()}catch{}d.forEach(t=>{try{t.dispose()}catch{}}),r.dataset.echartsInit="0"};document.addEventListener("fragment:will-unload",u,{once:!0})}if(document.readyState==="loading")document.addEventListener("DOMContentLoaded",()=>{const s=document.getElementById("client-dashboard-root");s&&M({container:s})});else{const s=document.getElementById("client-dashboard-root");s&&M({container:s})}
