import{i as st,f as V}from"../chunks/api-Bh71dfFu.js";async function X(l,s,b,N,C,O){const D=l.querySelector(N);if(!D)return console.warn(`[hourly metric] ${N} no existe`),null;const F=Array.from({length:24},(I,S)=>String(S).padStart(2,"0")),M="#3b82f6",T="#60a5fa",m=st(D,void 0,{renderer:"canvas"}),p=F.map(()=>0);m.setOption({tooltip:{trigger:"axis"},legend:{top:6},grid:{left:40,right:16,top:36,bottom:28},xAxis:{type:"category",data:F,axisLabel:{formatter:I=>I+"h"}},yAxis:{type:"value",minInterval:1},series:[{name:`${b} (real)`,type:"bar",data:p,itemStyle:{color:M}},{name:`${b} (forecast)`,type:"line",smooth:!0,data:p,lineStyle:{type:"dashed",color:T},symbol:"circle",symbolSize:6}],graphic:{elements:[{type:"text",left:"center",top:"middle",style:{text:"Cargando...",fill:"#9ca3af",fontSize:14}}]},toolbox:{show:!0,feature:{saveAsImage:{}}}});function d(I){const S=new Map((I||[]).map(i=>[String(i.hour).padStart(2,"0"),i])),L=F.map(i=>Number((S.get(i)&&S.get(i)[s])??0)),E=F.map(i=>Number((S.get(i)&&S.get(i)[s+"Forecast"])??0)),k=L.some(i=>i>0)||E.some(i=>i>0);m.setOption({xAxis:{data:F},series:[{name:`${b} (real)`,type:"bar",data:L,itemStyle:{color:M}},{name:`${b} (forecast)`,type:"line",smooth:!0,data:E,lineStyle:{type:"dashed",color:T},symbol:"circle",symbolSize:6}],graphic:k?{elements:[]}:{elements:[{type:"text",left:"center",top:"middle",style:{text:"Sin datos",fill:"#9ca3af",fontSize:14}}]}})}const u=new ResizeObserver(()=>m.resize());u.observe(D);function f(){try{u.disconnect()}catch{}try{m.dispose()}catch{}try{document.removeEventListener("fragment:will-unload",v)}catch{}}const v=()=>{document.removeEventListener("fragment:will-unload",v),f()};return document.addEventListener("fragment:will-unload",v,{once:!0}),m.__hourly_metric_cleanup=f,{chart:m,refresh:I=>d(I),destroy:f}}async function it(l,s,b){const N=b?.refreshMs,C=await X(l,"attendance","Asistencias","#chart-hourly-attendance"),O=await X(l,"rounds","Rondas","#chart-hourly-rounds"),D=await X(l,"visits","Visitas","#chart-hourly-visits"),F=u=>{C&&C.refresh(u),O&&O.refresh(u),D&&D.refresh(u)};let M="UTC";try{M=Intl.DateTimeFormat().resolvedOptions().timeZone||"UTC"}catch{}async function T(u){const f=u?`?date=${encodeURIComponent(u)}&tz=${encodeURIComponent(M)}`:`?tz=${encodeURIComponent(M)}`,v=`/api/attendance/hourly${f}`,$=`/api/patrols-runs/hourly${f}`,I=`/api/site-supervision-visits/hourly${f}`;try{const[S,L,E]=await Promise.all([V(v),V($),V(I)]),k=S.ok?await S.json().catch(()=>[]):[],i=L.ok?await L.json().catch(()=>[]):[],P=E.ok?await E.json().catch(()=>[]):[],j=new Map(k.map(e=>[String(e.hour).padStart(2,"0"),e])),U=new Map(i.map(e=>[String(e.hour).padStart(2,"0"),e])),_=new Map(P.map(e=>[String(e.hour).padStart(2,"0"),e]));return Array.from({length:24},(e,c)=>String(c).padStart(2,"0")).map(e=>({hour:e,attendance:Number(j.get(e)?.count??j.get(e)?.cnt??0),attendanceForecast:Number(j.get(e)?.forecast??0),rounds:Number(U.get(e)?.count??U.get(e)?.cnt??0),roundsForecast:Number(U.get(e)?.forecast??0),visits:Number(_.get(e)?.count??_.get(e)?.cnt??0),visitsForecast:Number(_.get(e)?.forecast??0)}))}catch(S){return console.warn("[initThreeMetrics] fetchHourlyCombined error",S),Array.from({length:24},(L,E)=>({hour:String(E).padStart(2,"0")}))}}const m=await T(s);m&&m.length&&F(m);let p;p=window.setInterval(async()=>{const u=await T(s);u&&u.length&&F(u)},N);const d=()=>{document.removeEventListener("fragment:will-unload",d);try{p&&window.clearInterval(p)}catch{}[C,O,D].forEach(u=>{if(!u)return;const f=u.chart;if(f&&f.__hourly_metric_cleanup)try{f.__hourly_metric_cleanup()}catch{}else try{u.chart.dispose()}catch{}})};return document.addEventListener("fragment:will-unload",d,{once:!0}),{stop:()=>{try{p&&window.clearInterval(p)}catch{}d()}}}function ct(l=new Date){return`${l.getFullYear()}-${String(l.getMonth()+1).padStart(2,"0")}-01`}function lt(l=new Date){const s=l.getFullYear(),b=l.getMonth()+1,N=new Date(s,b,0).getDate();return`${s}-${String(b).padStart(2,"0")}-${String(N).padStart(2,"0")}`}async function nt({container:l}){const s=l.querySelector("#client-dashboard-root")||l;if(!s||s.dataset.echartsInit==="1")return;s.dataset.echartsInit="1";const b=s.getAttribute("data-client-id")||"1",N=ct(),C=lt(),O=s.querySelector("#chart-att"),D=s.querySelector("#chart-patrol"),F=s.querySelector("#chart-inc"),M=s.querySelector("#chart-visit"),T=s.querySelector("#chart-visit-site"),m=[],p=t=>t?st(t,void 0,{renderer:"canvas"}):null,d=(t,e="Sin datos")=>{t&&t.setOption({graphic:{elements:[{type:"text",left:"center",top:"middle",style:{text:e,fill:"#9ca3af",fontSize:14}}]}})};async function u(t,e={},c=15e3,y=!1){const o=new AbortController,w={...e,signal:o.signal},x=setTimeout(()=>o.abort(),c);try{return y?await V(String(t),w):await fetch(t,w)}finally{clearTimeout(x)}}const f=p(O);f&&m.push(f);try{const t=await V(`/api/attendance/series?clientId=${b}&from=${N}&to=${C}&action=IN`);if(t.ok){const e=await t.json().catch(()=>[]),c=e.map(o=>o.x),y=e.map(o=>o.y);f?.setOption({tooltip:{trigger:"axis"},grid:{left:40,right:16,top:24,bottom:32},xAxis:{type:"category",boundaryGap:!1,data:c},yAxis:{type:"value"},series:[{type:"line",smooth:!0,areaStyle:{},data:y}],graphic:y.some(o=>Number(o)>0)?{elements:[]}:void 0}),y.some(o=>Number(o)>0)||d(f)}else d(f,"Error de datos")}catch{d(f,"Error de datos")}const v=p(D);v&&m.push(v);try{const t=Intl.DateTimeFormat().resolvedOptions().timeZone||"UTC",e=`/api/site-patrols/series?clientId=${b}&from=${N}&to=${C}&tz=${encodeURIComponent(t)}`,c=await V(e);if(c.ok){const y=await c.json().catch(()=>[]),o=y.map(x=>x.x),w=y.map(x=>x.y);v?.setOption({tooltip:{trigger:"axis"},grid:{left:40,right:16,top:24,bottom:32},xAxis:{type:"category",boundaryGap:!1,data:o},yAxis:{type:"value"},series:[{type:"line",smooth:!0,areaStyle:{},data:w,color:"#34D399"}],graphic:w.some(x=>Number(x)>0)?{elements:[]}:void 0}),w.some(x=>Number(x)>0)||d(v)}else d(v,"Error de datos")}catch(t){console.error("Error cargando series de rondas",t),d(v,"Error de datos")}window.addEventListener("resize",()=>v?.resize());const $=p(M);$&&m.push($);const I=navigator.language||"es",S=new Intl.DateTimeFormat(I,{day:"2-digit",month:"short"});function L(t){if(!t)return null;const e=t.includes("T")?t:`${t}T00:00:00`,c=new Date(e);return Number.isNaN(c.getTime())?null:c}function E(t){const e=L(t);return e?S.format(e).replace(".","").replace(/\s+/,"-"):t??""}function k(t,e){const c=[],y=new Date;for(let o=t-1;o>=0;o--){const w=new Date(y);w.setDate(y.getDate()-o),c.push(`${w.getFullYear()}-${String(w.getMonth()+1).padStart(2,"0")}-${String(w.getDate()).padStart(2,"0")}`)}return c}try{let t=function(r){if(r==null)return"";const a=String(r).trim();if(!a)return"";if(/^\d{4}-\d{2}-\d{2}$/.test(a)){const[h,z,A]=a.split("-"),G=Number(h),g=Number(z),R=Number(A);if(Number.isFinite(G)&&Number.isFinite(g)&&Number.isFinite(R)){const Z=new Date(G,g-1,R);return`${Z.getFullYear()}-${String(Z.getMonth()+1).padStart(2,"0")}-${String(Z.getDate()).padStart(2,"0")}`}return""}const n=new Date(a);return Number.isNaN(n.getTime())?a.split("T")[0]||"":`${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,"0")}-${String(n.getDate()).padStart(2,"0")}`};const e=Intl.DateTimeFormat().resolvedOptions().timeZone||"UTC",c=7,y=`/api/site-supervision-visits/series?days=${c}&tz=${encodeURIComponent(e)}`,o=`/api/forecasts/forecast-series?days=${c}&tz=${encodeURIComponent(e)}`,[w,x]=await Promise.all([u(y,{},15e3,!0).catch(r=>(console.warn("Fetch actual visits failed",r),null)),u(o,{},15e3,!0).catch(r=>(console.warn("Fetch forecast visits failed",r),null))]),J=async(r,a)=>r?r.ok?await r.json().catch(n=>(console.warn(`${a} json parse error`,n),[])):(console.warn(`${a} returned status`,r.status),[]):[],[H,W]=await Promise.all([J(w,"actual visits"),J(x,"forecast visits")]);if((!Array.isArray(H)||H.length===0)&&(!Array.isArray(W)||W.length===0)){d($,"Sin datos");return}const Q=r=>Array.isArray(r)?r.map(a=>{let n="";Array.isArray(a)?n=a[0]:n=a?.x??a?.date??a?.day??"";let h=0;Array.isArray(a)&&a.length>1?h=a[1]:h=a?.y??a?.value??0;const z=t(n),A=typeof h=="number"?h:Number(String(h??0));return{x:z,y:Number.isFinite(A)?A:0}}).filter(a=>a.x&&typeof a.x=="string"&&a.x.length>=4):[],K=Q(H),tt=Q(W);let q=k(c,e);const et=r=>{const a=new Map;return r.forEach(n=>{if(!n||!n.x)return;const h=a.get(n.x)??0;a.set(n.x,h+(Number.isFinite(Number(n.y))?Number(n.y):0))}),a},rt=et(K),at=et(tt),Y=q.map(r=>rt.has(r)?rt.get(r):0),B=q.map(r=>at.has(r)?at.get(r):0),ot=s.querySelector("#donut-visit");if(ot){const r=p(ot);if(r){m.push(r);const a=Y.reduce((g,R)=>g+(Number(R)||0),0),n=B.reduce((g,R)=>g+(Number(R)||0),0),h=n>0,z=h?Math.round(a/n*100):0,A=h?Math.min(100,Math.max(0,z)):100,G=h?[{value:A,name:"Cumplido",itemStyle:{color:"#10B981"}},{value:100-A,name:"Pendiente",itemStyle:{color:"#E5E7EB"}}]:[{value:1,name:"Sin meta",itemStyle:{color:"#E5E7EB"}}];r.setOption({tooltip:{trigger:"item",formatter:g=>h?g&&g.name==="Cumplido"?`${g.marker} ${g.seriesName}: ${a} / ${n} (${z}%)`:g&&g.name==="Pendiente"?`${g.marker} Pendiente: ${Math.max(0,n-a)}`:"":"Meta no definida"},series:[{name:"Cumplimiento Visitas",type:"pie",radius:["62%","82%"],avoidLabelOverlap:!1,hoverAnimation:!1,label:{show:!0,position:"center",formatter:h?`${z}%`:"â€”",fontSize:12,fontWeight:700,color:"#111827"},labelLine:{show:!1},data:G}]})}}if(console.debug("[visits-chart] labels:",q),console.debug("[visits-chart] normActual:",K),console.debug("[visits-chart] normForecast:",tt),console.debug("[visits-chart] valuesActual:",Y),console.debug("[visits-chart] valuesForecast:",B),!$){d($,"Sin datos");return}$.clear(),$.setOption({legend:{data:["Visitas reales","Forecast (previsto)"],top:6},tooltip:{trigger:"axis",formatter:r=>{if(!Array.isArray(r)||r.length===0)return"";const a=r[0];let n=a.axisValue??(a&&typeof a.dataIndex=="number"?q[a.dataIndex]:void 0);!n&&a.axisValueLabel&&(n=a.axisValueLabel);const h=E(String(n??"")),z=r.map(A=>`${A.marker} ${A.seriesName}: ${A.value??0}`);return`<b>${h}</b><br/>${z.join("<br/>")}`}},grid:{left:40,right:16,top:48,bottom:36},xAxis:{type:"category",boundaryGap:!1,data:q,axisLabel:{rotate:0,formatter:function(r){return E(r)}}},yAxis:{type:"value"},series:[{name:"Visitas reales",type:"line",smooth:!0,areaStyle:{},data:Y,color:"#0ea5e9",showSymbol:!1,lineStyle:{width:2}},{name:"Forecast (previsto)",type:"line",smooth:!0,areaStyle:{opacity:.12},data:B,color:"#f59e0b",showSymbol:!1,lineStyle:{width:2,type:"dashed"}}],graphic:Y.concat(B).some(r=>Number(r)>0)?{elements:[]}:void 0}),Y.some(r=>Number(r)>0)||B.some(r=>Number(r)>0)||d($,"Sin visitas")}catch(t){t?.name==="AbortError"?console.debug("Visits/Forecast fetch aborted (timeout or navigation)",t):console.error("Error obteniendo series de visitas/forecast",t),d($,"Error de datos")}const i=p(T);i&&m.push(i);try{const t=await V(`/api/site-supervision-visits/series-by-site?clientId=${b}&from=${N}&to=${C}`);if(t.ok){const e=await t.json().catch(()=>[]),c=e.map(o=>o.siteName),y=e.map(o=>o.count);i?.setOption({tooltip:{trigger:"axis"},grid:{left:60,right:16,top:24,bottom:32},xAxis:{type:"value"},yAxis:{type:"category",data:c,axisLabel:{interval:0,fontSize:12}},series:[{type:"bar",data:y,itemStyle:{color:"#0ea5e9"}}],graphic:y.some(o=>Number(o)>0)?{elements:[]}:void 0}),y.some(o=>Number(o)>0)||d(i)}else d(i,"Error de datos")}catch{d(i,"Error de datos")}const P=new Date,j=`${P.getFullYear()}-${String(P.getMonth()+1).padStart(2,"0")}-${String(P.getDate()).padStart(2,"0")}`;try{it(s,j,{refreshMs:6e4})}catch(t){console.warn("[client-dashboard] initThreeMetrics failed",t)}const U=new ResizeObserver(()=>m.forEach(t=>t?.resize()));[O,F,M,T].forEach(t=>t&&U.observe(t));const _=()=>{document.removeEventListener("fragment:will-unload",_);try{U.disconnect()}catch{}m.forEach(t=>{try{t.dispose()}catch{}}),s.dataset.echartsInit="0"};document.addEventListener("fragment:will-unload",_,{once:!0})}if(document.readyState==="loading")document.addEventListener("DOMContentLoaded",()=>{const l=document.getElementById("client-dashboard-root");l&&nt({container:l})});else{const l=document.getElementById("client-dashboard-root");l&&nt({container:l})}
