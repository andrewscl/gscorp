import{f as x,i as k}from"../chunks/api-Bh71dfFu.js";async function w(a,o,c,l,d,m){const S=a.querySelector(l);if(!S){console.warn(`[hourly metric] ${l} no existe`);return}let $=[];try{const r=d?`?date=${encodeURIComponent(d)}`:"",t=await x(`/api/dashboard/today/hourly${r}`);t.ok?$=await t.json():console.warn("[hourly metric] API status:",t.status,await t.text().catch(()=>""))}catch(r){console.warn("[hourly metric] fetch error",r)}const I=Array.from({length:24},(r,t)=>String(t).padStart(2,"0")),y=new Map($.map(r=>[r.hour,r])),g=I.map(r=>{const t=y.get(r);return{hour:r,value:t?Number(t[o]??0):0,forecast:t?Number(t[o+"Forecast"]??0):0}}),n=g.map(r=>r.value),u=g.map(r=>r.forecast),h=n.some(r=>r>0)||u.some(r=>r>0),p=m?.color??"#3b82f6",f=m?.forecastColor??"#60a5fa",b=k(S,void 0,{renderer:"canvas"});b.setOption({tooltip:{trigger:"axis"},legend:{top:6},grid:{left:40,right:16,top:36,bottom:28},xAxis:{type:"category",data:I,axisLabel:{formatter:r=>r+"h"}},yAxis:{type:"value",minInterval:1},series:h?[{name:`${c} (real)`,type:"bar",data:n,itemStyle:{color:p}},{name:`${c} (forecast)`,type:"line",smooth:!0,data:u,lineStyle:{type:"dashed",color:f},symbol:"circle",symbolSize:6}]:[],graphic:h?{elements:[]}:{elements:[{type:"text",left:"center",top:"middle",style:{text:"Sin datos",fill:"#9ca3af",fontSize:14}}]},toolbox:{show:!0,feature:{saveAsImage:{}}}});const A=new ResizeObserver(()=>b.resize());A.observe(S);const E=()=>{document.removeEventListener("fragment:will-unload",E);try{A.disconnect()}catch{}try{b.dispose()}catch{}};document.addEventListener("fragment:will-unload",E,{once:!0})}function N(a,o,c){const l=c?.refreshMs;w(a,"attendance","Asistencias","#chart-hourly-attendance",o,{color:"#06b6d4",forecastColor:"#0891b2"}),w(a,"rounds","Rondas","#chart-hourly-rounds",o,{color:"#10b981",forecastColor:"#047857"}),w(a,"visits","Visitas","#chart-hourly-visits",o,{color:"#f59e0b",forecastColor:"#b45309"});let d;d=window.setInterval(()=>{w(a,"attendance","Asistencias","#chart-hourly-attendance",o,{color:"#06b6d4",forecastColor:"#0891b2"}),w(a,"rounds","Rondas","#chart-hourly-rounds",o,{color:"#10b981",forecastColor:"#047857"}),w(a,"visits","Visitas","#chart-hourly-visits",o,{color:"#f59e0b",forecastColor:"#b45309"})},l);const m=()=>{document.removeEventListener("fragment:will-unload",m);try{d&&window.clearInterval(d)}catch{}};document.addEventListener("fragment:will-unload",m,{once:!0})}function O(a=new Date){return`${a.getFullYear()}-${String(a.getMonth()+1).padStart(2,"0")}-01`}function q(a=new Date){const o=a.getFullYear(),c=a.getMonth()+1,l=new Date(o,c,0).getDate();return`${o}-${String(c).padStart(2,"0")}-${String(l).padStart(2,"0")}`}async function C({container:a}){const o=a.querySelector("#client-dashboard-root")||a;if(!o||o.dataset.echartsInit==="1")return;o.dataset.echartsInit="1";const c=o.getAttribute("data-client-id")||"1",l=O(),d=q(),m=o.querySelector("#chart-att"),S=o.querySelector("#chart-inc"),$=o.querySelector("#chart-visit"),I=o.querySelector("#chart-visit-site");try{const t=await x(`/api/clients/dashboard/kpis?clientId=${c}`);if(t.ok){const s=await t.json();o.querySelector('[data-kpi="att"]').textContent=String(s.asistenciaHoy??0),o.querySelector('[data-kpi="patrol"]').textContent=String(s.rondasHoy??0),o.querySelector('[data-kpi="visit"]').textContent=String(s.visitasHoy??0),o.querySelector('[data-kpi="inc"]').textContent=String(s.incidentesAbiertos??0)}}catch{}const y=[],g=t=>t?k(t,void 0,{renderer:"canvas"}):null,n=(t,s="Sin datos")=>{t&&t.setOption({graphic:{elements:[{type:"text",left:"center",top:"middle",style:{text:s,fill:"#9ca3af",fontSize:14}}]}})},u=g(m);u&&y.push(u);try{const t=await x(`/api/attendance/series?clientId=${c}&from=${l}&to=${d}&action=IN`);if(t.ok){const s=await t.json().catch(()=>[]),v=s.map(e=>e.x),i=s.map(e=>e.y);u?.setOption({tooltip:{trigger:"axis"},grid:{left:40,right:16,top:24,bottom:32},xAxis:{type:"category",boundaryGap:!1,data:v},yAxis:{type:"value"},series:[{type:"line",smooth:!0,areaStyle:{},data:i}],graphic:i.some(e=>Number(e)>0)?{elements:[]}:void 0}),i.some(e=>Number(e)>0)||n(u)}else n(u,"Error de datos")}catch{n(u,"Error de datos")}const h=g(S);h&&y.push(h);try{const t=await x(`/api/incidents/series?clientId=${c}&from=${l}&to=${d}&status=OPEN`);if(t.ok){const s=await t.json().catch(()=>[]),v=s.map(e=>e.x),i=s.map(e=>e.y);h?.setOption({tooltip:{trigger:"axis"},grid:{left:40,right:16,top:24,bottom:32},xAxis:{type:"category",boundaryGap:!1,data:v},yAxis:{type:"value"},series:[{type:"line",smooth:!0,data:i}],graphic:i.some(e=>Number(e)>0)?{elements:[]}:void 0}),i.some(e=>Number(e)>0)||n(h)}else n(h,"Error de datos")}catch{n(h,"Error de datos")}const p=g($);p&&y.push(p);try{const t=await x(`/api/site-supervision-visits/series?clientId=${c}&from=${l}&to=${d}`);if(t.ok){const s=await t.json().catch(()=>[]),v=s.map(e=>e.x),i=s.map(e=>e.y);p?.setOption({tooltip:{trigger:"axis"},grid:{left:40,right:16,top:24,bottom:32},xAxis:{type:"category",boundaryGap:!1,data:v},yAxis:{type:"value"},series:[{type:"line",smooth:!0,areaStyle:{},data:i,color:"#0ea5e9"}],graphic:i.some(e=>Number(e)>0)?{elements:[]}:void 0}),i.some(e=>Number(e)>0)||n(p)}else n(p,"Error de datos")}catch{n(p,"Error de datos")}const f=g(I);f&&y.push(f);try{const t=await x(`/api/site-supervision-visits/series-by-site?clientId=${c}&from=${l}&to=${d}`);if(t.ok){const s=await t.json().catch(()=>[]),v=s.map(e=>e.siteName),i=s.map(e=>e.count);f?.setOption({tooltip:{trigger:"axis"},grid:{left:60,right:16,top:24,bottom:32},xAxis:{type:"value"},yAxis:{type:"category",data:v,axisLabel:{interval:0,fontSize:12}},series:[{type:"bar",data:i,itemStyle:{color:"#0ea5e9"}}],graphic:i.some(e=>Number(e)>0)?{elements:[]}:void 0}),i.some(e=>Number(e)>0)||n(f)}else n(f,"Error de datos")}catch{n(f,"Error de datos")}const b=new Date,A=`${b.getFullYear()}-${String(b.getMonth()+1).padStart(2,"0")}-${String(b.getDate()).padStart(2,"0")}`;try{N(o,A,{refreshMs:6e4})}catch(t){console.warn("[client-dashboard] initThreeMetrics failed",t)}const E=new ResizeObserver(()=>y.forEach(t=>t?.resize()));[m,S,$,I].forEach(t=>t&&E.observe(t));const r=()=>{document.removeEventListener("fragment:will-unload",r);try{E.disconnect()}catch{}y.forEach(t=>{try{t.dispose()}catch{}}),o.dataset.echartsInit="0"};document.addEventListener("fragment:will-unload",r,{once:!0})}if(document.readyState==="loading")document.addEventListener("DOMContentLoaded",()=>{const a=document.getElementById("client-dashboard-root");a&&C({container:a})});else{const a=document.getElementById("client-dashboard-root");a&&C({container:a})}
