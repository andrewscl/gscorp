import{i as I}from"../chunks/echarts-setup-BOxioT3i.js";async function y(a,o={}){const n=localStorage.getItem("jwt"),c=new Headers(o.headers||{});n&&c.set("Authorization",`Bearer ${n}`);const d=await fetch(a,{...o,headers:c});return d.status===401&&(localStorage.removeItem("jwt"),window.location.href="/auth/signin"),d}function $(a=new Date){return`${a.getFullYear()}-${String(a.getMonth()+1).padStart(2,"0")}-01`}function E(a=new Date){const o=a.getFullYear(),n=a.getMonth()+1,c=new Date(o,n,0).getDate();return`${o}-${String(n).padStart(2,"0")}-${String(c).padStart(2,"0")}`}async function w({container:a}){const o=a.querySelector("#client-dashboard-root")||a;if(!o||o.dataset.echartsInit==="1")return;o.dataset.echartsInit="1";const n=o.getAttribute("data-client-id")||"1",c=$(),d=E(),g=o.querySelector("#chart-att"),S=o.querySelector("#chart-inc"),b=o.querySelector("#chart-visit");try{const t=await y(`/api/clients/dashboard/kpis?clientId=${n}`);if(t.ok){const s=await t.json();o.querySelector('[data-kpi="att"]').textContent=String(s.asistenciaHoy??0),o.querySelector('[data-kpi="patrol"]').textContent=String(s.rondasHoy??0),o.querySelector('[data-kpi="visit"]').textContent=String(s.visitasHoy??0),o.querySelector('[data-kpi="inc"]').textContent=String(s.incidentesAbiertos??0)}}catch{}const m=[],f=t=>t?I(t,void 0,{renderer:"canvas"}):null,i=(t,s="Sin datos")=>{t&&t.setOption({graphic:{elements:[{type:"text",left:"center",top:"middle",style:{text:s,fill:"#9ca3af",fontSize:14}}]}})},l=f(g);l&&m.push(l);try{const t=await y(`/api/attendance/series?clientId=${n}&from=${c}&to=${d}&action=IN`);if(t.ok){const s=await t.json().catch(()=>[]),h=s.map(e=>e.x),r=s.map(e=>e.y);l?.setOption({tooltip:{trigger:"axis"},grid:{left:40,right:16,top:24,bottom:32},xAxis:{type:"category",boundaryGap:!1,data:h},yAxis:{type:"value"},series:[{type:"line",smooth:!0,areaStyle:{},data:r}],graphic:r.some(e=>Number(e)>0)?{elements:[]}:void 0}),r.some(e=>Number(e)>0)||i(l)}else i(l,"Error de datos")}catch{i(l,"Error de datos")}const u=f(S);u&&m.push(u);try{const t=await y(`/api/incidents/series?clientId=${n}&from=${c}&to=${d}&status=OPEN`);if(t.ok){const s=await t.json().catch(()=>[]),h=s.map(e=>e.x),r=s.map(e=>e.y);u?.setOption({tooltip:{trigger:"axis"},grid:{left:40,right:16,top:24,bottom:32},xAxis:{type:"category",boundaryGap:!1,data:h},yAxis:{type:"value"},series:[{type:"line",smooth:!0,data:r}],graphic:r.some(e=>Number(e)>0)?{elements:[]}:void 0}),r.some(e=>Number(e)>0)||i(u)}else i(u,"Error de datos")}catch{i(u,"Error de datos")}const p=f(b);p&&m.push(p);try{const t=await y(`/api/site-supervision-visits/series?clientId=${n}&from=${c}&to=${d}`);if(t.ok){const s=await t.json().catch(()=>[]),h=s.map(e=>e.x),r=s.map(e=>e.y);p?.setOption({tooltip:{trigger:"axis"},grid:{left:40,right:16,top:24,bottom:32},xAxis:{type:"category",boundaryGap:!1,data:h},yAxis:{type:"value"},series:[{type:"line",smooth:!0,areaStyle:{},data:r,color:"#0ea5e9"}],graphic:r.some(e=>Number(e)>0)?{elements:[]}:void 0}),r.some(e=>Number(e)>0)||i(p)}else i(p,"Error de datos")}catch{i(p,"Error de datos")}const v=new ResizeObserver(()=>m.forEach(t=>t?.resize()));[g,S,b].forEach(t=>t&&v.observe(t));const x=()=>{document.removeEventListener("fragment:will-unload",x);try{v.disconnect()}catch{}m.forEach(t=>{try{t.dispose()}catch{}}),o.dataset.echartsInit="0"};document.addEventListener("fragment:will-unload",x,{once:!0})}if(document.readyState==="loading")document.addEventListener("DOMContentLoaded",()=>{const a=document.getElementById("client-dashboard-root");a&&w({container:a})});else{const a=document.getElementById("client-dashboard-root");a&&w({container:a})}
