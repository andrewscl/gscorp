import{f as p}from"../../auth.js";import{n as f}from"../../navigation-handler.js";const o=e=>document.querySelector(e),E=e=>Array.from(document.querySelectorAll(e));function w(e){const t=e.querySelectorAll("tr");let n=-1;return t.forEach(c=>{const r=parseInt(c.getAttribute("data-index"));!isNaN(r)&&r>n&&(n=r)}),n+1}function S(e=document){E(".remove-schedule").forEach(t=>{t.removeEventListener("click",q),t.addEventListener("click",q)})}function q(e){const t=e.target.closest("tr");t&&t.remove()}function b(e={}){const t=o("#schedulesTbody"),n=w(t),r=o("#scheduleRowTemplate").innerHTML.replace(/__IDX__/g,n),u=document.createElement("tbody");u.innerHTML=r;const s=u.querySelector("tr");s.setAttribute("data-index",n);const i=s.querySelector(".input-dayfrom"),h=s.querySelector(".input-dayto"),m=s.querySelector(".input-start"),a=s.querySelector(".input-end"),d=s.querySelector(".input-lunch");e.dayFrom&&(i.value=e.dayFrom),e.dayTo&&(h.value=e.dayTo),e.startTime&&(m.value=e.startTime.length>=5?e.startTime.substring(0,5):e.startTime),e.endTime&&(a.value=e.endTime.length>=5?e.endTime.substring(0,5):e.endTime),e.lunchTime&&(d.value=e.lunchTime.length>=5?e.lunchTime.substring(0,5):e.lunchTime),o("#schedulesTbody").appendChild(s),S(s)}function g(){const e=o("#schedulesTbody").querySelectorAll("tr"),t=[];return e.forEach(n=>{const c=(n.querySelector(".input-dayfrom")||{}).value||null,r=(n.querySelector(".input-dayto")||{}).value||null,u=(n.querySelector(".input-start")||{}).value||null,s=(n.querySelector(".input-end")||{}).value||null,i=(n.querySelector(".input-lunch")||{}).value||null;(c||r||u||s||i)&&t.push({dayFrom:c,dayTo:r,startTime:u,endTime:s,lunchTime:i})}),t}function T(e){const t=o("#editShiftRequestError");t&&(t.style.display="block",t.textContent=e,o("#editShiftRequestOk").style.display="none")}function k(e){const t=o("#editShiftRequestOk");t&&(t.style.display="block",t.textContent=e,o("#editShiftRequestError").style.display="none")}function R(e){if(e.startDate&&e.endDate){const t=new Date(e.startDate),n=new Date(e.endDate);if(t>n)return"La fecha inicio no puede ser posterior a la fecha término."}for(let t=0;t<e.schedules.length;t++){const n=e.schedules[t];if(n.startTime&&!n.endTime||!n.startTime&&n.endTime)return"Cada tramo debe tener hora inicio Y hora término o ninguno."}return null}async function D(e){const t=document.querySelector('input[name="id"]'),n=t?t.value:null,c=o("#shiftRequestCode")?.value||null,r=o("#shiftRequestType")?.value||null,u=o("#shiftRequestStartDate")?.value||null,s=o("#shiftRequestEndDate")?.value||null,i=o("#shiftRequestStatus")?.value||null,h=o("#shiftRequestDescription")?.value||null,m=g(),a={id:n?Number(n):null,code:c,type:r,startDate:u,endDate:s,status:i,description:h,schedules:m},d=R(a);if(d){T(d);return}try{const l=`/private/shift-requests/${a.id}`,y=await p(l,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(!y.ok){let v="";try{v=await y.text()}catch{}throw new Error(v||`Error ${y.status}`)}k("Cambios guardados ✅"),setTimeout(()=>f("/private/shift-requests/table-view"),800)}catch(l){console.error("save error",l),T(l.message||"Error al guardar")}}function x(e){e.preventDefault(),f("/private/shift-requests/table-view")}function C(){o("#addScheduleBtn")?.addEventListener("click",()=>b({})),o("#saveShiftRequestBtn")?.addEventListener("click",D),o("#cancelEditBtn")?.addEventListener("click",x),S(),document.addEventListener("keydown",e=>{e.key==="Escape"&&f("/private/shift-requests/table-view")})}document.addEventListener("DOMContentLoaded",()=>{try{C()}catch(e){console.error(e)}});
