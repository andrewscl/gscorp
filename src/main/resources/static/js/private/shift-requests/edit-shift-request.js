import{f as S}from"../../auth.js";import{n as m}from"../../navigation-handler.js";const o=e=>document.querySelector(e),w=e=>Array.from(document.querySelectorAll(e));console.log("edit-shift-request.js cargado");function R(e){const t=e.querySelectorAll("tr");let n=-1;return t.forEach(c=>{const i=parseInt(c.getAttribute("data-index"));!isNaN(i)&&i>n&&(n=i)}),n+1}function E(e=document){w(".remove-schedule").forEach(t=>{t.removeEventListener("click",T),t.addEventListener("click",T)})}function T(e){const t=e.target.closest("tr");t&&t.remove()}function b(e={}){const t=o("#schedulesTbody"),n=R(t),i=o("#scheduleRowTemplate").innerHTML.replace(/__IDX__/g,n),s=document.createElement("tbody");s.innerHTML=i;const r=s.querySelector("tr");r.setAttribute("data-index",n);const u=r.querySelector(".input-dayfrom"),f=r.querySelector(".input-dayto"),y=r.querySelector(".input-start"),a=r.querySelector(".input-end"),d=r.querySelector(".input-lunch");e.dayFrom&&(u.value=e.dayFrom),e.dayTo&&(f.value=e.dayTo),e.startTime&&(y.value=e.startTime.length>=5?e.startTime.substring(0,5):e.startTime),e.endTime&&(a.value=e.endTime.length>=5?e.endTime.substring(0,5):e.endTime),e.lunchTime&&(d.value=e.lunchTime.length>=5?e.lunchTime.substring(0,5):e.lunchTime),o("#schedulesTbody").appendChild(r),E(r)}function g(){const e=o("#schedulesTbody").querySelectorAll("tr"),t=[];return e.forEach(n=>{const c=(n.querySelector(".input-dayfrom")||{}).value||null,i=(n.querySelector(".input-dayto")||{}).value||null,s=(n.querySelector(".input-start")||{}).value||null,r=(n.querySelector(".input-end")||{}).value||null,u=(n.querySelector(".input-lunch")||{}).value||null;(c||i||s||r||u)&&t.push({dayFrom:c,dayTo:i,startTime:s,endTime:r,lunchTime:u})}),t}function h(e){const t=o("#editShiftRequestError");t&&(t.style.display="block",t.textContent=e,o("#editShiftRequestOk").style.display="none")}function p(e){const t=o("#editShiftRequestOk");t&&(t.style.display="block",t.textContent=e||"Guardado",o("#editShiftRequestError").style.display="none")}function k(e){if(e.startDate&&e.endDate){const t=new Date(e.startDate),n=new Date(e.endDate);if(t>n)return"La fecha inicio no puede ser posterior a la fecha término."}for(let t=0;t<e.schedules.length;t++){const n=e.schedules[t];if(n.startTime&&!n.endTime||!n.startTime&&n.endTime)return"Cada tramo debe tener hora inicio Y hora término o ninguno."}return null}async function D(e){const t=document.querySelector('input[name="id"]'),n=t?t.value:null,c=o("#shiftRequestCode")?.value||null,i=o("#shiftRequestType")?.value||null,s=o("#shiftRequestStartDate")?.value||null,r=o("#shiftRequestEndDate")?.value||null,u=o("#shiftRequestStatus")?.value||null,f=o("#shiftRequestDescription")?.value||null,y=g(),a={id:n?Number(n):null,code:c,type:i,startDate:s,endDate:r,status:u,description:f,schedules:y},d=k(a);if(d){h(d);return}try{const l=`/api/shift-requests/${a.id}`,v=await S(l,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(!v.ok){let q="";try{q=await v.text()}catch{}throw new Error(q||`Error ${v.status}`)}p("Cambios guardados ✅"),setTimeout(()=>m("/private/shift-requests/table-view"),800)}catch(l){console.error("save error",l),h(l.message||"Error al guardar")}}async function x(){const e=document.querySelector('input[name="id"]'),t=e?e.value:null,n=o("#editShiftRequestError"),c=o("#editShiftRequestOk");if(n&&(n.style.display="none"),c&&(c.style.display="none"),!t){h("No se puede eliminar porque falta el ID de la solicitud.");return}if(confirm("¿Estás seguro de que deseas eliminar esta solicitud de turno? Esta acción no se puede deshacer."))try{const s=`/api/shift-requests/${t}`,r=await S(s,{method:"DELETE"});if(!r.ok){const u=await r.text().catch(()=>`Error ${r.status}`);throw new Error(u)}p("Solicitud de turno eliminada correctamente."),setTimeout(()=>m("/private/shift-requests/table-view"),1e3)}catch(s){console.error("delete error",s),h(s.message||"Error al eliminar la solicitud de turno.")}}function L(e){e.preventDefault(),m("/private/shift-requests/table-view")}function C(){o("#addScheduleBtn")?.addEventListener("click",()=>b({})),o("#saveShiftRequestBtn")?.addEventListener("click",D),o("#cancelEditBtn")?.addEventListener("click",L),o("#deleteShiftRequestBtn")?.addEventListener("click",x),E(),document.addEventListener("keydown",e=>{e.key==="Escape"&&m("/private/shift-requests/table-view")})}document.addEventListener("DOMContentLoaded",()=>{try{C()}catch(e){console.error(e)}});
