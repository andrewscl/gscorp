const p="site-latitude",I="site-longitude",g="site-select",y="site-map",E="site-coordinates-form",L="set-current-location",w="site-coordinates-error",m="site-coordinates-ok";let d,s;function r(t,e){document.getElementById(p).value=t.toFixed(7),document.getElementById(I).value=e.toFixed(7)}function u(t,e){s?(s.setPosition({lat:t,lng:e}),d.setCenter({lat:t,lng:e})):(s=new google.maps.Marker({position:{lat:t,lng:e},map:d,draggable:!0,title:"Punto de referencia",icon:{url:"https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png"}}),s.addListener("dragend",n=>{r(n.latLng.lat(),n.latLng.lng())}))}function a(t){const e=document.getElementById(w);e&&(e.textContent=t||"");const n=document.getElementById(m);n&&(n.style.display="none")}function b(t){const e=document.getElementById(m);e&&(e.textContent=t,e.style.display=""),a("")}function C(t=-33.45,e=-70.65,n=16){const i=document.getElementById(y);!i||!window.google||!google.maps||(d=new google.maps.Map(i,{center:{lat:t,lng:e},zoom:n,mapTypeId:"roadmap",disableDefaultUI:!0}),d.addListener("click",o=>{r(o.latLng.lat(),o.latLng.lng()),u(o.latLng.lat(),o.latLng.lng())}))}function h(){if(!navigator.geolocation){a("Tu navegador no soporta geolocalización.");return}a("Obteniendo ubicación actual..."),navigator.geolocation.getCurrentPosition(t=>{const e=t.coords.latitude,n=t.coords.longitude;r(e,n),u(e,n),d.setCenter({lat:e,lng:n}),a("")},t=>{a("No se pudo obtener la ubicación actual: "+(t.message||t))},{enableHighAccuracy:!0,timeout:1e4})}function D(t){t&&typeof t.latitude=="number"&&typeof t.longitude=="number"&&(r(t.latitude,t.longitude),u(t.latitude,t.longitude),d.setCenter({lat:t.latitude,lng:t.longitude}))}async function v(t,e){const n=new FormData(t),i={siteId:n.get("siteId"),latitude:n.get("latitude"),longitude:n.get("longitude")};if(!i.siteId||!i.latitude||!i.longitude){a("Completa todos los campos requeridos.");return}try{a("Guardando...");const o=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(i),credentials:"same-origin"});if(!o.ok){let c=await o.json().catch(()=>({}));throw new Error(c.error||"Error al guardar coordenadas.")}b("Coordenadas guardadas ✅")}catch(o){a("No se pudo guardar: "+(o.message||o))}}function _(t){const e=document.getElementById(g);e&&e.addEventListener("change",()=>{const n=e.value;if(!n)return;const i=t.find(o=>String(o.id)===String(n));i&&typeof i.latitude=="number"&&typeof i.longitude=="number"&&D(i)})}async function T(){const t=window.siteList||[],e=document.getElementById(g);let n=-33.45,i=-70.65;t.length&&typeof t[0].latitude=="number"&&typeof t[0].longitude=="number"&&(n=t[0].latitude,i=t[0].longitude),C(n,i),document.getElementById(L)?.addEventListener("click",h),t.length&&e&&_(t);const o=document.getElementById(E);o&&o.addEventListener("submit",c=>{c.preventDefault();const f=o.dataset.endpoint||"/api/sites/set-coordinates";v(o,f)})}function l(t=0){window.google&&window.google.maps?T():t<10?setTimeout(()=>l(t+1),300+150*t):a("No se pudo cargar el mapa de Google.")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>l()):l();document.addEventListener("content:loaded",()=>l());
