const f="site-latitude",p="site-longitude",I="site-select",E="site-map",L="site-coordinates-form",C="set-current-location",w="cancel-set-coordinates",b="site-coordinates-error",g="site-coordinates-ok";let d,l;function r(t,e){document.getElementById(f).value=t.toFixed(7),document.getElementById(p).value=e.toFixed(7)}function m(t,e){l?(l.setPosition({lat:t,lng:e}),d.setCenter({lat:t,lng:e})):(l=new google.maps.Marker({position:{lat:t,lng:e},map:d,draggable:!0,title:"Punto de referencia",icon:{url:"https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png"}}),l.addListener("dragend",n=>{r(n.latLng.lat(),n.latLng.lng())}))}function a(t){const e=document.getElementById(b);e&&(e.textContent=t||"");const n=document.getElementById(g);n&&(n.style.display="none")}function v(t){const e=document.getElementById(g);e&&(e.textContent=t,e.style.display=""),a("")}function B(t=-33.45,e=-70.65,n=16){const i=document.getElementById(E);!i||!window.google||!google.maps||(d=new google.maps.Map(i,{center:{lat:t,lng:e},zoom:n,mapTypeId:"roadmap",disableDefaultUI:!0}),d.addListener("click",o=>{r(o.latLng.lat(),o.latLng.lng()),m(o.latLng.lat(),o.latLng.lng())}))}function D(){if(!navigator.geolocation){a("Tu navegador no soporta geolocalización.");return}a("Obteniendo ubicación actual..."),navigator.geolocation.getCurrentPosition(t=>{const e=t.coords.latitude,n=t.coords.longitude;r(e,n),m(e,n),d.setCenter({lat:e,lng:n}),a("")},t=>{a("No se pudo obtener la ubicación actual: "+(t.message||t))},{enableHighAccuracy:!0,timeout:1e4})}function _(t){t&&typeof t.latitude=="number"&&typeof t.longitude=="number"&&(r(t.latitude,t.longitude),m(t.latitude,t.longitude),d.setCenter({lat:t.latitude,lng:t.longitude}))}async function h(t,e){const n=new FormData(t),i={siteId:n.get("siteId"),latitude:n.get("latitude"),longitude:n.get("longitude")};if(!i.siteId||!i.latitude||!i.longitude){a("Completa todos los campos requeridos.");return}try{a("Guardando...");const o=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(i),credentials:"same-origin"});if(!o.ok){let s=await o.json().catch(()=>({}));throw new Error(s.error||"Error al guardar coordenadas.")}v("Coordenadas guardadas ✅")}catch(o){a("No se pudo guardar: "+(o.message||o))}}function T(t){const e=document.getElementById(I);e&&e.addEventListener("change",()=>{const n=e.value;if(!n)return;const i=t.find(o=>String(o.id)===String(n));i&&typeof i.latitude=="number"&&typeof i.longitude=="number"&&_(i)})}function k(){document.getElementById(f).value="",document.getElementById(p).value="",l&&(l.setMap(null),l=null),d&&d.setCenter({lat:-33.45,lng:-70.65}),a("");const t=document.getElementById(g);t&&(t.style.display="none")}async function N(){const t=window.siteList||[],e=document.getElementById(I);let n=-33.45,i=-70.65;t.length&&typeof t[0].latitude=="number"&&typeof t[0].longitude=="number"&&(n=t[0].latitude,i=t[0].longitude),B(n,i),document.getElementById(C)?.addEventListener("click",D),t.length&&e&&T(t);const o=document.getElementById(L);o&&o.addEventListener("submit",u=>{u.preventDefault();const y=o.dataset.endpoint||"/api/sites/set-coordinates";h(o,y)});const s=document.getElementById(w);s&&s.addEventListener("click",u=>{u.preventDefault(),k()})}function c(t=0){window.google&&window.google.maps?N():t<10?setTimeout(()=>c(t+1),300+150*t):a("No se pudo cargar el mapa de Google.")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>c()):c();document.addEventListener("content:loaded",()=>c());
