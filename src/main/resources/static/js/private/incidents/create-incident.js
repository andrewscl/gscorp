import{f as b}from"../../auth.js";import{n as v}from"../../navigation-handler.js";const t=n=>document.querySelector(n),h=5*1024*1024,y=["image/jpeg","image/png","image/webp"];function u(n){if(!n)return;n.querySelectorAll("img[data-preview-url]").forEach(i=>{const o=i.getAttribute("data-preview-url");o&&URL.revokeObjectURL(o)}),n.innerHTML=""}function I(n,e){u(e);const i=URL.createObjectURL(n),o=document.createElement("img");o.className="preview-img",o.src=i,o.setAttribute("data-preview-url",i),e.appendChild(o);const a=document.createElement("div");a.className="preview-actions";const r=document.createElement("button");r.type="button",r.className="btn-remove",r.textContent="Quitar",r.addEventListener("click",()=>{const d=t("#incidentPhoto");d&&(d.value=""),u(e)}),a.appendChild(r),e.appendChild(a)}async function P(n){n.preventDefault();const e=t("#createIncidentError"),i=t("#createIncidentOk");e&&(e.textContent=""),i&&(i.style.display="none");const o=t("#incidentSite")?.value||"",a=t("#incidentType")?.value||"",r=t("#incidentDescription")?.value?.trim()||"",d=t("#incidentPriority")?.value||"",s=t("#incidentPhoto")?.files?.[0]||null;if(!o){e&&(e.textContent="Debes seleccionar un sitio.");return}if(!a){e&&(e.textContent="Debes seleccionar un tipo de incidente.");return}if(!d){e&&(e.textContent="Debes seleccionar una prioridad.");return}if(s){if(!y.includes(s.type)){e&&(e.textContent="Formato de archivo no permitido. Usa JPG/PNG/WebP.");return}if(s.size>h){e&&(e.textContent="El archivo excede el tamaño máximo de 5 MB.");return}}const m=t('#createIncidentForm button[type="submit"]');m&&(m.disabled=!0);try{const c=new FormData;if(c.append("siteId",o),c.append("incidentType",a),c.append("priority",d),c.append("description",r),s){const l=s;c.append("photo",l)}const p=await b("/api/incidents/create",{method:"POST",body:c});if(!p.ok){const l=await p.text().catch(()=>"");throw new Error(l||"No se pudo crear el incidente")}i&&(i.textContent="Incidente creado ✅",i.style.display="block"),t("#createIncidentForm")?.reset(),u(t("#incidentPhotoPreview")),setTimeout(()=>v("/private/incidents/table-view"),600)}catch(c){e&&(e.textContent=c.message||"Error al crear incidente")}finally{m&&(m.disabled=!1)}}function g(){const n=t("#incidentPhoto"),e=t("#incidentPhotoPreview");!n||!e||n.addEventListener("change",()=>{u(e);const i=n.files?.[0];if(i)if(i.type.startsWith("image/"))I(i,e);else{const o=document.createElement("div");o.textContent=i.name,e.appendChild(o)}})}function C(n){n.preventDefault(),t("#createIncidentForm")?.reset(),u(t("#incidentPhotoPreview")),v("/private/incidents/table-view")}function f(){t("#createIncidentForm")?.addEventListener("submit",P),t("#cancelCreateIncident")?.addEventListener("click",C),g()}document.readyState==="complete"||document.readyState==="interactive"?setTimeout(()=>{t("#createIncidentForm")&&f()},50):document.addEventListener("DOMContentLoaded",()=>setTimeout(()=>{t("#createIncidentForm")&&f()},50));
