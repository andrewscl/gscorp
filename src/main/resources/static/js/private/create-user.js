import{f as c}from"../auth.js";import{n as l}from"../router.js";const t=e=>document.querySelector(e),u=e=>Array.from(document.querySelectorAll(e));function p(){const e=t("#createUserModal");e&&(e.classList.remove("hidden"),e.setAttribute("aria-hidden","false"),document.body.classList.add("no-scroll"),setTimeout(()=>t("#newUsername")?.focus(),0))}function a(){const e=t("#createUserModal");e&&(e.classList.add("hidden"),e.setAttribute("aria-hidden","true"),document.body.classList.remove("no-scroll"),t("#createUserForm")?.reset(),t("#createUserError").textContent="",t("#createUserOk").style.display="none",t("#roleChoices")?.replaceChildren())}async function f(){const e=await c("/api/roles/all");if(!e.ok)throw new Error("No se pudieron cargar los roles");return e.json()}function h(e){const n=t("#roleChoices");n.innerHTML="",e.forEach(r=>{const i=`role_${r.id}`,s=document.createElement("label");s.className="role-option",s.innerHTML=`
      <input type="checkbox" name="roleId" value="${r.id}" id="${i}"/>
      <span>${r.name}</span>
    `,n.appendChild(s)})}async function y(){try{p();const e=await f();h(e)}catch(e){t("#createUserError").textContent=e.message}}async function E(e){e.preventDefault();const n=t("#newUsername")?.value.trim(),r=t("#newPassword")?.value,i=u('input[name="roleId"]:checked').map(o=>Number(o.value)),s=t("#createUserError"),d=t("#createUserOk");s.textContent="",d.style.display="none";try{const o=await c("/private/admin/api/users",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:n,password:r,roleIds:i})});if(!o.ok){const m=await o.text();throw new Error(m||"No se pudo crear el usuario")}d.style.display="block",setTimeout(()=>{a(),l("/private/admin/users")},600)}catch(o){s.textContent=o.message}}function v(){u(".btn-danger[data-user-id]").forEach(e=>{e.addEventListener("click",async()=>{const n=e.getAttribute("data-user-id");if(confirm(`Â¿Eliminar usuario ${n}?`))try{if(!(await c(`/private/admin/api/users/${n}`,{method:"DELETE"})).ok)throw new Error("No se pudo eliminar");l("/private/admin/users")}catch(r){alert(r.message)}})})}function w(){t("#createUserBtn")?.addEventListener("click",y),t("#closeCreateUser")?.addEventListener("click",a),t("#cancelCreateUser")?.addEventListener("click",a),t("#createUserForm")?.addEventListener("submit",E),document.addEventListener("keydown",e=>{e.key==="Escape"&&a()})}(function(){w(),v()})();
