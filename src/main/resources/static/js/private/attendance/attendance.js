import{f as L}from"../../auth.js";function m(){const t=document.getElementById("att-widget");if(!t||t.dataset.attInit==="1")return;t.dataset.attInit="1";const e=document.getElementById("att-status"),n=document.getElementById("att-in"),o=document.getElementById("att-out"),i=t.dataset.punchEndpoint||"/api/attendance/punch",r=(s,c=!1)=>{e&&(e.textContent=s,e.style.color=c?"#b00020":"#444")},p=s=>{n&&(n.disabled=s),o&&(o.disabled=s)},E=()=>location.protocol==="https:"||location.hostname==="localhost"||location.hostname==="127.0.0.1",v=()=>new Promise((s,c)=>{if(!navigator.geolocation)return c(new Error("Geolocalización no soportada"));navigator.geolocation.getCurrentPosition(a=>s(a),a=>c(new Error(a.message||"No se pudo obtener ubicación")),{enableHighAccuracy:!0,timeout:15e3,maximumAge:0})});async function y(s){const c=String(s).toUpperCase()==="OUT"?"OUT":"IN";try{if(p(!0),!E()){r("Activa HTTPS (o usa localhost) para solicitar ubicación en móviles.",!0);return}r("Obteniendo ubicación...");const a=await v(),I={action:c,lat:a.coords.latitude,lon:a.coords.longitude,accuracy:a.coords.accuracy};r("Registrando asistencia...");const f=new AbortController,T=setTimeout(()=>f.abort("timeout"),2e4),l=await L(i,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(I),signal:f.signal,credentials:"same-origin"}).finally(()=>clearTimeout(T));if(!l.ok){let u=`Error ${l.status}`;try{const g=await l.json();g?.error&&(u=g.error+(g.details?`: ${g.details}`:""))}catch{try{u=await l.text()||u}catch{}}throw new Error(u)}const d=await l.json().catch(()=>({})),h=d.ts?new Date(d.ts).toLocaleTimeString("es-CL",{hour12:!1}):"",b=typeof d.distanceMeters=="number"?`${d.distanceMeters} metros`:"";r(`Marcación registrada correctamente${h?" a las "+h:""}${b?" a "+b:""}. ✅`),w()}catch(a){r("Error en marcación: "+(a?.message||"desconocido"),!0)}finally{p(!1)}}n?.addEventListener("click",()=>y("IN")),o?.addEventListener("click",()=>y("OUT")),w(),M()}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",m):m();document.addEventListener("content:loaded",m);async function w(){const t=document.getElementById("att-in"),e=document.getElementById("att-out");try{const n=await fetch("/api/attendance/last-punch",{credentials:"same-origin"});if(!n.ok){t.style.display="",e.style.display="none";return}const o=await n.json(),i=o.action?o.action.toUpperCase():null;!i||i==="OUT"?(t.style.display="",e.style.display="none"):i==="IN"&&(t.style.display="none",e.style.display="")}catch{t.style.display="",e.style.display="none"}}function M(){const t=document.getElementById("att-map");if(t){if(t._google_map&&(t._google_map=null,t.innerHTML=""),!navigator.geolocation){t.innerHTML="<div style='padding:1em;text-align:center;color:#888'>Geolocalización no soportada</div>";return}navigator.geolocation.getCurrentPosition(e=>{const n=e.coords.latitude,o=e.coords.longitude;if(window.google&&window.google.maps){const i=new google.maps.Map(t,{center:{lat:n,lng:o},zoom:17,mapTypeId:"roadmap",disableDefaultUI:!0});new google.maps.Marker({position:{lat:n,lng:o},map:i}),t._google_map=i}else t.innerHTML="<div style='padding:1em;text-align:center;color:#888'>Google Maps no cargado</div>"},e=>{t.innerHTML=`<div style='padding:1em;text-align:center;color:#b00020'>No se pudo obtener ubicación.<br>${e.message}</div>`},{enableHighAccuracy:!0,timeout:1e4})}}
