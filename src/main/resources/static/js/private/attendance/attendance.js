import{f as v}from"../../auth.js";function g(){const t=document.getElementById("att-widget");if(!t||t.dataset.attInit==="1")return;t.dataset.attInit="1";const e=document.getElementById("att-status"),o=document.getElementById("att-in"),n=document.getElementById("att-out"),l=t.dataset.punchEndpoint||"/api/attendance/punch",c=(i,s=!1)=>{e&&(e.textContent=i,e.style.color=s?"#b00020":"#444")},m=i=>{o&&(o.disabled=i),n&&(n.disabled=i)},b=()=>location.protocol==="https:"||location.hostname==="localhost"||location.hostname==="127.0.0.1",w=()=>new Promise((i,s)=>{if(!navigator.geolocation)return s(new Error("Geolocalización no soportada"));navigator.geolocation.getCurrentPosition(a=>i(a),a=>s(new Error(a.message||"No se pudo obtener ubicación")),{enableHighAccuracy:!0,timeout:15e3,maximumAge:0})});async function p(i){const s=String(i).toUpperCase()==="OUT"?"OUT":"IN";try{if(m(!0),!b()){c("Activa HTTPS (o usa localhost) para solicitar ubicación en móviles.",!0);return}c("Obteniendo ubicación...");const a=await w(),E={action:s,lat:a.coords.latitude,lon:a.coords.longitude,accuracy:a.coords.accuracy};c("Registrando asistencia...");const y=new AbortController,I=setTimeout(()=>y.abort("timeout"),2e4),r=await v(l,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(E),signal:y.signal,credentials:"same-origin"}).finally(()=>clearTimeout(I));if(!r.ok){let d=`Error ${r.status}`;try{const u=await r.json();u?.error&&(d=u.error+(u.details?`: ${u.details}`:""))}catch{try{d=await r.text()||d}catch{}}throw new Error(d)}const f=await r.json().catch(()=>({})),h=f.ts?new Date(f.ts).toLocaleTimeString("es-CL",{hour12:!1}):"";c(`Marcación ${s==="IN"?"de entrada":"de salida"}${h?" a las "+h:""} ✅`)}catch(a){c("Error en marcación: "+(a?.message||"desconocido"),!0)}finally{m(!1)}}o?.addEventListener("click",()=>p("IN")),n?.addEventListener("click",()=>p("OUT")),T(),L()}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",g):g();document.addEventListener("content:loaded",g);async function T(){const t=document.getElementById("att-in"),e=document.getElementById("att-out");try{const o=await fetch("/api/attendance/last-punch",{credentials:"same-origin"});if(!o.ok){t.style.display="",e.style.display="none";return}const n=await o.json();!n||n.action==="OUT"?(t.style.display="",e.style.display="none"):n.action==="IN"&&(t.style.display="none",e.style.display="")}catch{t.style.display="",e.style.display="none"}}function L(){const t=document.getElementById("att-map");if(t){if(t._google_map&&(t._google_map=null,t.innerHTML=""),!navigator.geolocation){t.innerHTML="<div style='padding:1em;text-align:center;color:#888'>Geolocalización no soportada</div>";return}navigator.geolocation.getCurrentPosition(e=>{const o=e.coords.latitude,n=e.coords.longitude;if(window.google&&window.google.maps){const l=new google.maps.Map(t,{center:{lat:o,lng:n},zoom:17,mapTypeId:"roadmap",disableDefaultUI:!0});new google.maps.Marker({position:{lat:o,lng:n},map:l}),t._google_map=l}else t.innerHTML="<div style='padding:1em;text-align:center;color:#888'>Google Maps no cargado</div>"},e=>{t.innerHTML=`<div style='padding:1em;text-align:center;color:#b00020'>No se pudo obtener ubicación.<br>${e.message}</div>`},{enableHighAccuracy:!0,timeout:1e4})}}
