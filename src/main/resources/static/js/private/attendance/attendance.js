import{f as C}from"../../auth.js";function $(t,e,a){let n=null,i=1/0;for(const o of a){if(typeof o.lat!="number"||typeof o.lon!="number")continue;const s=P(t,e,o.lat,o.lon);s<i&&(i=s,n={...o,distance:s})}return n}let d=[];async function w(){try{const t=await C("/api/attendance/sites",{credentials:"same-origin"});if(!t.ok)throw new Error(`Error cargando sitios: ${t.status}`);d=await t.json()}catch(t){console.error("No se pudo cargar la lista de sitios:",t),d=[]}}async function A(){const t=document.getElementById("att-status"),e=document.getElementById("att-site-info");if(!navigator.geolocation){t.textContent="Geolocalización no soportada",e&&(e.textContent="");return}t.textContent="Detectando sitio más cercano...";try{const a=await new Promise((i,o)=>navigator.geolocation.getCurrentPosition(i,o,{enableHighAccuracy:!0,timeout:15e3}));if(!d.length){e&&(e.textContent="No hay sitios configurados.");return}const n=$(a.coords.latitude,a.coords.longitude,d);n&&n.distance<=35?(t.textContent=`Estás en el sitio "${n.name}". Puedes marcar asistencia aquí.`,e&&(e.textContent=`Sitio detectado: ${n.name}`,e.style.color="#059669")):n?(t.textContent=`El sitio más cercano es "${n.name}" a ${n.distance.toFixed(1)} metros. Acércate para marcar.`,e&&(e.textContent="",e.style.color="#d97706")):(t.textContent="No se encontró ningún sitio cercano.",e&&(e.textContent="",e.style.color="#b00020"))}catch{t.textContent="No se pudo obtener ubicación.",e&&(e.textContent="",e.style.color="#b00020")}}function E(){const t=document.getElementById("att-widget");if(!t||t.dataset.attInit==="1")return;t.dataset.attInit="1";const e=document.getElementById("att-status"),a=document.getElementById("att-in"),n=document.getElementById("att-out"),i=t.dataset.punchEndpoint||"/api/attendance/punch",o=(r,u=!1)=>{e&&(e.textContent=r,e.style.color=u?"#b00020":"#444")},s=r=>{a&&(a.disabled=r),n&&(n.disabled=r)},g=()=>location.protocol==="https:"||location.hostname==="localhost"||location.hostname==="127.0.0.1",p=()=>new Promise((r,u)=>{if(!navigator.geolocation)return u(new Error("Geolocalización no soportada"));navigator.geolocation.getCurrentPosition(c=>r(c),c=>u(new Error(c.message||"No se pudo obtener ubicación")),{enableHighAccuracy:!0,timeout:15e3,maximumAge:0})});async function b(r){const u=String(r).toUpperCase()==="OUT"?"OUT":"IN";try{if(s(!0),!g()){o("Activa HTTPS (o usa localhost) para solicitar ubicación en móviles.",!0);return}o("Obteniendo ubicación...");const c=await p();if(!d.length&&(o("Cargando sitios, por favor espera...",!0),await w(),!d.length)){o("No se pudo cargar la lista de sitios.",!0),s(!1);return}const l=$(c.coords.latitude,c.coords.longitude,d);if(!l||l.distance>35){o(`No puede marcar asistencia: está a ${l?l.distance.toFixed(1):"N/A"} metros del sitio más cercano (máx 35m).`,!0),s(!1),T(l);return}else T(l),o(`Marcando asistencia en el sitio: ${l.name}`);const L={action:u,lat:c.coords.latitude,lon:c.coords.longitude,accuracy:c.coords.accuracy,siteId:l.id};o("Registrando asistencia...");const x=new AbortController,N=setTimeout(()=>x.abort("timeout"),2e4),m=await C(i,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(L),signal:x.signal,credentials:"same-origin"}).finally(()=>clearTimeout(N));if(!m.ok){let y=`Error ${m.status}`;try{const h=await m.json();h?.error&&(y=h.error+(h.details?`: ${h.details}`:""))}catch{try{y=await m.text()||y}catch{}}throw new Error(y)}const f=await m.json().catch(()=>({})),M=f.ts?new Date(f.ts).toLocaleTimeString("es-CL",{hour12:!1}):"",I=typeof f.distanceMeters=="number"?`${f.distanceMeters} metros`:"";o(`Marcación registrada correctamente${M?" a las "+M:""}${I?" a "+I:""}. ✅`),v()}catch(c){o("Error en marcación: "+(c?.message||"desconocido"),!0)}finally{s(!1)}}a?.addEventListener("click",()=>b("IN")),n?.addEventListener("click",()=>b("OUT")),v(),S(),A()}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",async()=>{await w(),E()}):w().then(E);document.addEventListener("content:loaded",async()=>{await w(),E()});async function v(){const t=document.getElementById("att-in"),e=document.getElementById("att-out");try{const a=await C("/api/attendance/last-punch",{credentials:"same-origin"});if(!a.ok){t.style.display="",e.style.display="none";return}const n=await a.json(),i=n.action?n.action.toUpperCase():null;!i||i==="OUT"?(t.style.display="",e.style.display="none"):i==="IN"&&(t.style.display="none",e.style.display="")}catch{t.style.display="",e.style.display="none"}}function S(){const t=document.getElementById("att-map");if(t){if(t._google_map&&(t._google_map=null,t.innerHTML=""),!navigator.geolocation){t.innerHTML="<div style='padding:1em;text-align:center;color:#888'>Geolocalización no soportada</div>";return}navigator.geolocation.getCurrentPosition(e=>{const a=e.coords.latitude,n=e.coords.longitude;if(window.google&&window.google.maps){const i=new google.maps.Map(t,{center:{lat:a,lng:n},zoom:17,mapTypeId:"roadmap",disableDefaultUI:!0});new google.maps.Marker({position:{lat:a,lng:n},map:i}),t._google_map=i}else t.innerHTML="<div style='padding:1em;text-align:center;color:#888'>Google Maps no cargado</div>"},e=>{t.innerHTML=`<div style='padding:1em;text-align:center;color:#b00020'>No se pudo obtener ubicación.<br>${e.message}</div>`},{enableHighAccuracy:!0,timeout:1e4})}}function P(t,e,a,n){const o=r=>r*Math.PI/180,s=o(a-t),g=o(n-e),p=Math.sin(s/2)*Math.sin(s/2)+Math.cos(o(t))*Math.cos(o(a))*Math.sin(g/2)*Math.sin(g/2);return 6371e3*(2*Math.atan2(Math.sqrt(p),Math.sqrt(1-p)))}function T(t){const e=document.getElementById("att-site-info");if(e){if(!t){e.textContent="";return}t.distance<=35?(e.textContent=`Estás en el sitio "${t.name}". Puedes marcar asistencia aquí.`,e.style.color="#059669"):(e.textContent=`El sitio más cercano es "${t.name}" a ${t.distance.toFixed(1)} metros. Acércate para marcar.`,e.style.color="#d97706")}}
