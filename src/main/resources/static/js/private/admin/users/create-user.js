import{f as i}from"../../../auth.js";import{n as m}from"../../../navigation-handler.js";console.log("create-user.js cargado");const t=e=>document.querySelector(e),p=e=>Array.from(document.querySelectorAll(e));function f(){const e=t("#createUserModal");e&&(e.classList.remove("hidden"),e.setAttribute("aria-hidden","false"),document.body.classList.add("no-scroll"),setTimeout(()=>t("#newUsername")?.focus(),0))}function c(){const e=t("#createUserModal");e&&(e.classList.add("hidden"),e.setAttribute("aria-hidden","true"),document.body.classList.remove("no-scroll"),t("#createUserForm")?.reset(),t("#createUserError").textContent="",t("#createUserOk").style.display="none",t("#roleChoices")?.replaceChildren())}async function h(){const e=await i("/api/roles/all");if(!e.ok)throw new Error("No se pudieron cargar los roles");return e.json()}function y(e){const n=t("#roleChoices");n.innerHTML="",e.forEach(r=>{const a=`role_${r.id}`,o=document.createElement("label");o.className="role-option",o.innerHTML=`
      <input type="checkbox" name="roleId" value="${r.id}" id="${a}"/>
      <span>${r.name}</span>
    `,n.appendChild(o)})}async function w(){const e=await i("/api/clients/all");if(!e.ok)throw new Error("No se pudieron cargar los clientes");return e.json()}function b(e){const n=t("#clientChoices");n.innerHTML="",roles.forEach(r=>{const a=`client_${r.id}`,o=document.createElement("label");o.className="client-option",o.innerHTML=`
      <input type="checkbox" name="clientId" value="${r.id}" id="${a}"/>
      <span>${r.name}</span>
    `,n.appendChild(o)})}async function C(){try{f();const e=await h();y(e);const n=await w();b(n)}catch(e){t("#createUserError").textContent=e.message}}async function k(e){e.preventDefault();const n=t("#newUsername")?.value.trim(),r=t("#newMail")?.value.trim(),a=t("#newPassword")?.value,o=p('input[name="roleId"]:checked').map(s=>Number(s.value)),l=t("#createUserError"),d=t("#createUserOk");l.textContent="",d.style.display="none";try{const s=await i("/api/users/create",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:n,mail:r,password:a,roleIds:o})});if(!s.ok){const u=await s.text();throw new Error(u||"No se pudo crear el usuario")}d.style.display="block",setTimeout(()=>{c(),m("/private/admin/users")},600)}catch(s){l.textContent=s.message}}function v(){t("#createUserBtn")?.addEventListener("click",C),t("#closeCreateUser")?.addEventListener("click",c),t("#cancelCreateUser")?.addEventListener("click",c),t("#createUserForm")?.addEventListener("submit",k),document.addEventListener("keydown",e=>{e.key==="Escape"&&c()})}(function(){v()})();
