import{f as T}from"../../auth.js";import{n as v}from"../../navigation-handler.js";const o=(e,i=document)=>i.querySelector(e),E="/private/site-supervision-visits/table-search",g="/private/site-supervision-visits/table-view";function p(e){const i=e||o(".site-visit-table tbody");if(!i)return;const s=i.querySelector(".empty")?0:i.querySelectorAll("tr").length,t=o(".site-visit-header .visits-count");t&&(t.textContent=`${s} registro${s===1?"":"s"}`)}let h=null,m=null;function w(){N();const e=o(".site-visit-table tbody"),i=o(".site-visit-table-container");e&&(p(e),h=new MutationObserver(n=>{let s=!1;for(const t of n)if(t.type==="childList"&&(t.addedNodes.length||t.removedNodes.length)){s=!0;break}s&&p(e)}),h.observe(e,{childList:!0,subtree:!1})),i&&(m=new MutationObserver(n=>{let s=!1;for(const t of n){if(t.type==="childList"&&(t.addedNodes.length||t.removedNodes.length)){for(const r of[...t.addedNodes,...t.removedNodes])if(r.nodeName&&r.nodeName.toLowerCase()==="tbody"){s=!0;break}}if(s)break}s&&setTimeout(()=>w(),50)}),m.observe(i,{childList:!0,subtree:!0}))}function N(){try{h&&(h.disconnect(),h=null),m&&(m.disconnect(),m=null)}catch{}}function _(){const e=o(".site-visit-table-container");!e||e.__siteVisitDeleg||(e.__siteVisitDeleg=!0,e.addEventListener("click",i=>{const n=i.target.closest(".action-btn, a[data-path], button[data-path]");if(!n)return;const s=n.dataset.path||n.getAttribute("href");s&&(i.preventDefault(),v(s,!0))}))}async function A({baseUrl:e,from:i,to:n,clientTz:s,applyBtn:t}){const r=new URLSearchParams;i&&r.set("from",i),n&&r.set("to",n),s&&r.set("clientTz",s);const b=e+(r.toString()?`?${r.toString()}`:"");t&&(t.disabled=!0,t.classList.add("is-loading"));try{const l=await T(b,{method:"GET",credentials:"same-origin",headers:{Accept:"text/html","X-Requested-With":"XMLHttpRequest"}});if(!l.ok){if(l.status===401||l.status===302){v("/login",!0);return}const f=await l.text().catch(()=>"");throw new Error(f||`HTTP ${l.status}`)}const a=await l.text(),c=document.createElement("div");c.innerHTML="<table>"+a.trim()+"</table>";const d=c.querySelector(".header-meta");let u=c.querySelector("tbody");if(!u){const f=c.querySelectorAll("tr");u=document.createElement("tbody"),f.forEach(L=>u.appendChild(L))}const y=o(".site-visit-table tbody");if(!y){v(g,!0);return}if(y.innerHTML=u.innerHTML,d){const f=o(".site-visit-header .header-meta");f&&f.replaceWith(d)}p(y)}finally{t&&(t.disabled=!1,t.classList.remove("is-loading"))}}function S(){const e=o("#applyFiltersBtn"),i=o("#filter-from"),n=o("#filter-to");!e||!i||!n||(e.hasAttribute("type")||e.setAttribute("type","button"),e.addEventListener("click",async s=>{s.preventDefault();let t=i.value||"",r=n.value||"";if(!t&&!r){v(g,!0);return}!t&&r&&(t=r),!r&&t&&(r=t);try{const a=new Date(t),c=new Date(r);!isNaN(a)&&!isNaN(c)&&a>c&&([t,r]=[r,t])}catch{}let b="";try{b=Intl.DateTimeFormat().resolvedOptions().timeZone||""}catch{b=""}const l=e.dataset.ajaxUrl||e.dataset.path||E;try{await A({baseUrl:l,from:t,to:r,clientTz:b,applyBtn:e})}catch(a){console.error("[site-visit] error fetching rows",a);const c=document.getElementById("siteVisitSearchError")||(()=>{const d=document.createElement("div");d.id="siteVisitSearchError",d.className="error";const u=o(".site-visit-header");return u?u.insertAdjacentElement("afterend",d):document.body.prepend(d),d})();c.textContent=a.message||"Error al obtener resultados."}}))}(function(){try{_(),S(),w()}catch(i){console.error("[site-visit] init failed",i)}})();
