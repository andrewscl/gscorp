import{f as y}from"../../auth.js";import{n as h}from"../../navigation-handler.js";const c=(t,i=document)=>i.querySelector(t),g="/private/site-supervision-visits/table-search",p="/private/site-supervision-visits/table-view";function w(t){const i=t||c(".site-visit-table tbody");if(!i)return;const n=i.querySelector(".empty")?0:i.querySelectorAll("tr").length,e=c(".site-visit-header .visits-count");e&&(e.textContent=`${n} registro${n===1?"":"s"}`)}function E(){const t=c(".site-visit-table-container");!t||t.__siteVisitDeleg||(t.__siteVisitDeleg=!0,t.addEventListener("click",i=>{const s=i.target.closest(".action-btn, a[data-path], button[data-path]");if(!s)return;const n=s.dataset.path||s.getAttribute("href");n&&(i.preventDefault(),h(n,!0))}))}async function T({baseUrl:t,from:i,to:s,clientTz:n,applyBtn:e}){const r=new URLSearchParams;i&&r.set("from",i),s&&r.set("to",s),n&&r.set("clientTz",n);const m=t+(r.toString()?`?${r.toString()}`:"");e&&(e.disabled=!0,e.classList.add("is-loading"));try{const l=await y(m,{method:"GET",credentials:"same-origin",headers:{Accept:"text/html","X-Requested-With":"XMLHttpRequest"}});if(!l.ok){if(l.status===401||l.status===302){h("/login",!0);return}const f=await l.text().catch(()=>"");throw new Error(f||`HTTP ${l.status}`)}const a=await l.text(),o=document.createElement("div");o.innerHTML="<table>"+a.trim()+"</table>";const u=o.querySelector(".header-meta");let d=o.querySelector("tbody");if(!d){const f=o.querySelectorAll("tr");d=document.createElement("tbody"),f.forEach(v=>d.appendChild(v))}const b=c(".site-visit-table tbody");if(!b){h(p,!0);return}if(b.innerHTML=d.innerHTML,u){const f=c(".site-visit-header .header-meta");f&&f.replaceWith(u)}else w(b)}finally{e&&(e.disabled=!1,e.classList.remove("is-loading"))}}function L(){const t=c("#applyFiltersBtn"),i=c("#filter-from"),s=c("#filter-to");!t||!i||!s||(t.hasAttribute("type")||t.setAttribute("type","button"),t.addEventListener("click",async n=>{n.preventDefault();let e=i.value||"",r=s.value||"";if(!e&&!r){h(p,!0);return}!e&&r&&(e=r),!r&&e&&(r=e);try{const a=new Date(e),o=new Date(r);!isNaN(a)&&!isNaN(o)&&a>o&&([e,r]=[r,e])}catch{}let m="";try{m=Intl.DateTimeFormat().resolvedOptions().timeZone||""}catch{m=""}const l=t.dataset.ajaxUrl||t.dataset.path||g;try{await T({baseUrl:l,from:e,to:r,clientTz:m,applyBtn:t})}catch(a){console.error("[site-visit] error fetching rows",a);const o=document.getElementById("siteVisitSearchError")||(()=>{const u=document.createElement("div");u.id="siteVisitSearchError",u.className="error";const d=c(".site-visit-header");return d?d.insertAdjacentElement("afterend",u):document.body.prepend(u),u})();o.textContent=a.message||"Error al obtener resultados."}}))}(function(){try{E(),L()}catch(i){console.error("[site-visit] init failed",i)}})();
