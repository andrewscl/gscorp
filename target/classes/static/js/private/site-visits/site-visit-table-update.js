import{f as y}from"../../auth.js";import{n as h}from"../../navigation-handler.js";const l=(t,i=document)=>i.querySelector(t),g="/private/site-supervision-visits/table-search",p="/private/site-supervision-visits/table-view";function w(t){const i=t||l(".site-visit-table tbody");if(!i)return;const n=i.querySelector(".empty")?0:i.querySelectorAll("tr").length,e=l(".site-visit-header .visits-count");e&&(e.textContent=`${n} registro${n===1?"":"s"}`)}function E(){const t=l(".site-visit-table-container");!t||t.__siteVisitDeleg||(t.__siteVisitDeleg=!0,t.addEventListener("click",i=>{const s=i.target.closest(".action-btn, a[data-path], button[data-path]");if(!s)return;const n=s.dataset.path||s.getAttribute("href");n&&(i.preventDefault(),h(n,!0))}))}async function A({baseUrl:t,from:i,to:s,clientTz:n,applyBtn:e}){const r=new URLSearchParams;i&&r.set("from",i),s&&r.set("to",s),n&&r.set("clientTz",n);const m=t+(r.toString()?`?${r.toString()}`:"");e&&(e.disabled=!0,e.classList.add("is-loading"));try{const u=await y(m,{method:"GET",credentials:"same-origin",headers:{Accept:"text/html","X-Requested-With":"XMLHttpRequest"}});if(!u.ok){if(u.status===401||u.status===302){h("/login",!0);return}const f=await u.text().catch(()=>"");throw new Error(f||`HTTP ${u.status}`)}const o=await u.text(),a=document.createElement("div");a.innerHTML=o.trim();const c=a.querySelector(".header-meta");let d=a.querySelector("tbody");if(!d){const f=a.querySelectorAll("tr");d=document.createElement("tbody"),f.forEach(v=>d.appendChild(v))}const b=l(".site-visit-table tbody");if(!b){h(p,!0);return}if(c){const f=l(".site-visit-header .header-meta");f&&f.replaceWith(c)}b.replaceWith(d),c||w(d)}finally{e&&(e.disabled=!1,e.classList.remove("is-loading"))}}function S(){const t=l("#applyFiltersBtn"),i=l("#filter-from"),s=l("#filter-to");if(!t||!i||!s){console.debug("[site-visit] apply button or inputs not found â€” skipping binding");return}t.hasAttribute("type")||t.setAttribute("type","button"),t.addEventListener("click",async n=>{n.preventDefault();let e=i.value||"",r=s.value||"";if(!e&&!r){h(p,!0);return}!e&&r&&(e=r),!r&&e&&(r=e);try{const o=new Date(e),a=new Date(r);!isNaN(o)&&!isNaN(a)&&o>a&&([e,r]=[r,e])}catch{}let m="";try{m=Intl.DateTimeFormat().resolvedOptions().timeZone||""}catch{m=""}const u=t.dataset.ajaxUrl||t.dataset.path||g;try{await A({baseUrl:u,from:e,to:r,clientTz:m,applyBtn:t})}catch(o){console.error("[site-visit] error fetching rows",o);const a=document.getElementById("siteVisitSearchError")||(()=>{const c=document.createElement("div");c.id="siteVisitSearchError",c.className="error";const d=l(".site-visit-header");return d?d.insertAdjacentElement("afterend",c):document.body.prepend(c),c})();a.textContent=o.message||"Error al obtener resultados."}})}(function(){try{console.debug("[site-visit] initializing module"),E(),S(),console.debug("[site-visit] initialized")}catch(i){console.error("[site-visit] init failed",i)}})();
