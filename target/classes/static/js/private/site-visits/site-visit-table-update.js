import{f as y}from"../../auth.js";import{n as m}from"../../navigation-handler.js";const b="/private/site-supervision-visits/table-search",p="/private/site-supervision-visits/table-view";function d(t,s=document){return s.querySelector(t)}async function E({baseUrl:t,from:s,to:o,clientTz:r,applyBtn:e}){const n=new URLSearchParams;s&&n.set("from",s),o&&n.set("to",o),r&&n.set("clientTz",r);const u=t+(n.toString()?`?${n.toString()}`:"");e&&(e.disabled=!0,e.classList.add("is-loading"));try{const i=await y(u,{method:"GET",credentials:"same-origin",headers:{Accept:"text/html","X-Requested-With":"XMLHttpRequest"}});if(!i.ok){if(i.status===401||i.status===302){m("/login",!0);return}const f=await i.text().catch(()=>"");throw new Error(f||`HTTP ${i.status}`)}const l=await i.text(),a=document.createElement("div");a.innerHTML=l.trim();let c=a.querySelector("tbody");if(!c){const f=a.querySelectorAll("tr");c=document.createElement("tbody"),f.forEach(v=>c.appendChild(v))}const h=d(".site-visit-table tbody");if(!h)throw new Error("No se encontrÃ³ tbody en la tabla actual (selector .site-visit-table tbody)");h.replaceWith(c),w(),g()}finally{e&&(e.disabled=!1,e.classList.remove("is-loading"))}}function w(){const t=document.querySelector(".site-visit-table tbody");if(!t)return;const o=t.querySelector(".empty")?0:t.querySelectorAll("tr").length,r=document.querySelector(".site-visit-header .visits-count");r&&(r.textContent=`${o} registro${o===1?"":"s"}`)}function g(){document.querySelectorAll(".site-visit-table .action-btn").forEach(t=>{t.__navBound||(t.__navBound=!0,t.addEventListener("click",s=>{const o=t.getAttribute("data-path");o&&m(o,!0)}))})}document.addEventListener("DOMContentLoaded",()=>{const t=d("#applyFiltersBtn"),s=d("#filter-from"),o=d("#filter-to");!t||!s||!o||t.addEventListener("click",async()=>{let r=s.value||"",e=o.value||"";if(!r&&!e){m(p,!0);return}!r&&e&&(r=e),!e&&r&&(e=r);try{const i=new Date(r),l=new Date(e);!isNaN(i)&&!isNaN(l)&&i>l&&([r,e]=[e,r])}catch{}let n="";try{n=Intl.DateTimeFormat().resolvedOptions().timeZone||""}catch{n=""}const u=t.dataset.ajaxUrl||t.dataset.path||b;try{await E({baseUrl:u,from:r,to:e,clientTz:n,applyBtn:t})}catch(i){console.error("Error al obtener filas:",i);const l=document.getElementById("siteVisitSearchError")||function(){const a=document.createElement("div");a.id="siteVisitSearchError",a.className="error";const c=d(".site-visit-header");return c?c.insertAdjacentElement("afterend",a):document.body.prepend(a),a}();l.textContent=i.message||"Error al obtener resultados."}})});
