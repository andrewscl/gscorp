import{f as T}from"../../auth.js";import{n as m}from"../../navigation-handler.js";const o=e=>document.querySelector(e),w=e=>Array.from(document.querySelectorAll(e));console.log("edit-shift-request.js cargado");function b(e){const t=e.querySelectorAll("tr");let n=-1;return t.forEach(u=>{const i=parseInt(u.getAttribute("data-index"));!isNaN(i)&&i>n&&(n=i)}),n+1}function E(e=document){w(".remove-schedule").forEach(t=>{t.removeEventListener("click",S),t.addEventListener("click",S)})}function S(e){const t=e.target.closest("tr");t&&t.remove()}function R(e={}){const t=o("#schedulesTbody"),n=b(t),i=o("#scheduleRowTemplate").innerHTML.replace(/__IDX__/g,n),r=document.createElement("tbody");r.innerHTML=i;const s=r.querySelector("tr");s.setAttribute("data-index",n);const c=s.querySelector(".input-dayfrom"),f=s.querySelector(".input-dayto"),y=s.querySelector(".input-start"),a=s.querySelector(".input-end"),d=s.querySelector(".input-lunch");e.dayFrom&&(c.value=e.dayFrom),e.dayTo&&(f.value=e.dayTo),e.startTime&&(y.value=e.startTime.length>=5?e.startTime.substring(0,5):e.startTime),e.endTime&&(a.value=e.endTime.length>=5?e.endTime.substring(0,5):e.endTime),e.lunchTime&&(d.value=e.lunchTime.length>=5?e.lunchTime.substring(0,5):e.lunchTime),o("#schedulesTbody").appendChild(s),E(s)}function g(){const e=o("#schedulesTbody").querySelectorAll("tr"),t=[];return e.forEach(n=>{const u=(n.querySelector(".input-dayfrom")||{}).value||null,i=(n.querySelector(".input-dayto")||{}).value||null,r=(n.querySelector(".input-start")||{}).value||null,s=(n.querySelector(".input-end")||{}).value||null,c=(n.querySelector(".input-lunch")||{}).value||null;(u||i||r||s||c)&&t.push({dayFrom:u,dayTo:i,startTime:r,endTime:s,lunchTime:c})}),t}function h(e){const t=o("#editShiftRequestError");t&&(t.style.display="block",t.textContent=e,o("#editShiftRequestOk").style.display="none")}function p(e){const t=o("#editShiftRequestOk");t&&(t.style.display="block",t.textContent=e||"Guardado",o("#editShiftRequestError").style.display="none")}function k(e){if(e.startDate&&e.endDate){const t=new Date(e.startDate),n=new Date(e.endDate);if(t>n)return"La fecha inicio no puede ser posterior a la fecha término."}for(let t=0;t<e.schedules.length;t++){const n=e.schedules[t];if(n.startTime&&!n.endTime||!n.startTime&&n.endTime)return"Cada tramo debe tener hora inicio Y hora término o ninguno."}return null}async function D(e){const t=document.querySelector('input[name="id"]'),n=t?t.value:null,u=o("#shiftRequestCode")?.value||null,i=o("#shiftRequestType")?.value||null,r=o("#shiftRequestStartDate")?.value||null,s=o("#shiftRequestEndDate")?.value||null,c=o("#shiftRequestStatus")?.value||null,f=o("#shiftRequestDescription")?.value||null,y=g(),a={id:n?Number(n):null,code:u,type:i,startDate:r,endDate:s,status:c,description:f,schedules:y},d=k(a);if(d){h(d);return}try{const l=`/api/shift-requests/${a.id}`,q=await T(l,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(!q.ok){let v="";try{v=await q.text()}catch{}throw new Error(v||`Error ${q.status}`)}p("Cambios guardados ✅"),setTimeout(()=>m("/private/shift-requests/table-view"),800)}catch(l){console.error("save error",l),h(l.message||"Error al guardar")}}async function x(){const e=document.querySelector('input[name="id"]'),t=e?e.value:null,n=o("#editShiftRequestError"),u=o("#editShiftRequestOk");if(n&&(n.style.display="none"),u&&(u.style.display="none"),!t){h("No se puede eliminar porque falta el ID de la solicitud.");return}if(confirm("¿Estás seguro de que deseas eliminar esta solicitud de turno? Esta acción no se puede deshacer."))try{const r=`/api/shift-requests/${t}`,s=await T(r,{method:"DELETE"});if(!s.ok){const c=await s.text().catch(()=>`Error ${s.status}`);throw new Error(c)}p("Solicitud de turno eliminada correctamente."),setTimeout(()=>m("/private/shift-requests/table-view"),1e3)}catch(r){console.error("delete error",r),h(r.message||"Error al eliminar la solicitud de turno.")}}function B(e){e.preventDefault(),m("/private/shift-requests/table-view")}function L(){o("#addScheduleBtn")?.addEventListener("click",()=>R({}))}function C(){o("#saveShiftRequestBtn")?.addEventListener("click",D)}function A(){o("#cancelEditBtn")?.addEventListener("click",B)}function I(){o("#deleteShiftRequestBtn")?.addEventListener("click",x)}(function(){L(),C(),A(),I(),E(),document.addEventListener("keydown",t=>{t.key==="Escape"&&m("/private/shift-requests/table-view")})})();
