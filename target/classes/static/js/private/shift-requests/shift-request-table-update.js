import{f as T}from"../../auth.js";import{n as p}from"../../navigation-handler.js";const n=(e,r=document)=>r.querySelector(e),R="/private/shift-requests/table-search",w="/private/shift-requests/table-view";function g(e){const r=e||n(".shift-requests-table tbody");if(!r)return;const s=r.querySelector(".empty")?0:r.querySelectorAll("tr").length,t=n(".shift-requests-header .requests-count");t&&(t.textContent=`${s} registro${s===1?"":"s"}`)}let m=null,y=null;function L(){N();const e=n(".shift-requests-table tbody"),r=n(".shift-requests-table-container");e&&(g(e),m=new MutationObserver(o=>{let s=!1;for(const t of o)if(t.type==="childList"&&(t.addedNodes.length||t.removedNodes.length)){s=!0;break}s&&g(e)}),m.observe(e,{childList:!0,subtree:!1})),r&&(y=new MutationObserver(o=>{let s=!1;for(const t of o){if(t.type==="childList"&&(t.addedNodes.length||t.removedNodes.length)){for(const i of[...t.addedNodes,...t.removedNodes])if(i.nodeName&&i.nodeName.toLowerCase()==="tbody"){s=!0;break}}if(s)break}s&&setTimeout(()=>L(),50)}),y.observe(r,{childList:!0,subtree:!0}))}function N(){try{m&&(m.disconnect(),m=null),y&&(y.disconnect(),y=null)}catch{}}function S(){const e=n(".shift-requests-table-container");!e||e.__shiftRequestsDeleg||(e.__shiftRequestsDeleg=!0,e.addEventListener("click",r=>{const o=r.target.closest(".action-btn, a[data-path], button[data-path]");if(!o)return;const s=o.dataset.path||o.getAttribute("href");s&&(r.preventDefault(),p(s,!0))}))}async function _({baseUrl:e,from:r,to:o,clientTz:s,siteId:t,type:i,applyBtn:a}){const c=new URLSearchParams;r&&c.set("from",r),o&&c.set("to",o),s&&c.set("clientTz",s),t&&c.set("siteId",t),i&&c.set("type",i);const q=e+(c.toString()?`?${c.toString()}`:"");a&&(a.disabled=!0,a.classList.add("is-loading"));try{const u=await T(q,{method:"GET",credentials:"same-origin",headers:{Accept:"text/html","X-Requested-With":"XMLHttpRequest"}});if(!u.ok){if(u.status===401||u.status===302){p("/login",!0);return}const b=await u.text().catch(()=>"");throw new Error(b||`HTTP ${u.status}`)}const l=await u.text(),d=document.createElement("div");d.innerHTML="<table>"+l.trim()+"</table>";const f=d.querySelector(".header-meta");let h=d.querySelector("tbody");if(!h){const b=d.querySelectorAll("tr");h=document.createElement("tbody"),b.forEach(E=>h.appendChild(E))}const v=n(".shift-requests-table tbody");if(!v){p(w,!0);return}if(v.innerHTML=h.innerHTML,f){const b=n(".shift-requests-header .header-meta");b&&b.replaceWith(f)}g(v)}finally{a&&(a.disabled=!1,a.classList.remove("is-loading"))}}function A(){const e=n("#filter-site")||n('[name="siteId"]')||n('[data-filter="siteId"]'),r=n("#filter-type")||n('[name="type"]')||n('[data-filter="type"]'),o=e&&e.value||"",s=r&&r.value||"";return{siteId:o,type:s}}function D(){const e=n("#applyShiftFiltersBtn"),r=n("#filter-from"),o=n("#filter-to");!e||!r||!o||(e.hasAttribute("type")||e.setAttribute("type","button"),e.addEventListener("click",async s=>{s.preventDefault();let t=r.value||"",i=o.value||"";if(!t&&!i){p(w,!0);return}!t&&i&&(t=i),!i&&t&&(i=t);try{const l=new Date(t),d=new Date(i);!isNaN(l)&&!isNaN(d)&&l>d&&([t,i]=[i,t])}catch{}let a="";try{a=Intl.DateTimeFormat().resolvedOptions().timeZone||""}catch{a=""}const{siteId:c,type:q}=A(),u=e.dataset.ajaxUrl||e.dataset.path||R;try{await _({baseUrl:u,from:t,to:i,clientTz:a,siteId:c,type:q,applyBtn:e})}catch(l){console.error("[shift-requests] error fetching rows",l);const d=document.getElementById("shiftRequestSearchError")||(()=>{const f=document.createElement("div");f.id="shiftRequestSearchError",f.className="error";const h=n(".shift-requests-header");return h?h.insertAdjacentElement("afterend",f):document.body.prepend(f),f})();d.textContent=l.message||"Error al obtener resultados."}}))}(function(){try{S(),D(),L()}catch(r){console.error("[shift-requests] init failed",r)}})();
