import{f as u}from"../../../auth.js";import{n as h}from"../../../navigation-handler.js";console.log("create-user.js cargado");const t=e=>document.querySelector(e),p=e=>Array.from(document.querySelectorAll(e));function b(){const e=t("#createUserModal");e&&(e.classList.remove("hidden"),e.setAttribute("aria-hidden","false"),document.body.classList.add("no-scroll"),setTimeout(()=>t("#newUsername")?.focus(),0))}function d(){const e=t("#createUserModal");e&&(e.classList.add("hidden"),e.setAttribute("aria-hidden","true"),document.body.classList.remove("no-scroll"),t("#createUserForm")?.reset(),t("#createUserError").textContent="",t("#createUserOk").style.display="none",t("#roleChoices")?.replaceChildren(),t("#clientChoices")?.replaceChildren())}async function y(){const e=await u("/api/roles/all");if(!e.ok)throw new Error("No se pudieron cargar los roles");return e.json()}function C(e){const n=t("#roleChoices");n.innerHTML="",e.forEach(o=>{const a=`role_${o.id}`,s=document.createElement("label");s.className="role-option",s.innerHTML=`
      <input type="checkbox" name="roleId" value="${o.id}" id="${a}"/>
      <span>${o.name}</span>
    `,n.appendChild(s)})}async function w(){const e=await u("/api/clients/all");if(!e.ok)throw new Error("No se pudieron cargar los clientes");return e.json()}function E(e){const n=t("#clientChoices");n.innerHTML="",e.forEach(o=>{const a=`client_${o.id}`,s=document.createElement("label");s.className="client-option",s.innerHTML=`
      <input type="checkbox" name="clientId" value="${o.id}" id="${a}"/>
      <span>${o.name}</span>
    `,n.appendChild(s)})}async function v(){try{b();const e=await y();C(e);const n=await w();E(n)}catch(e){t("#createUserError").textContent=e.message}}async function k(e){e.preventDefault();const n=t("#newUsername")?.value.trim(),o=t("#newMail")?.value.trim(),a=t("#newPassword")?.value,s=p('input[name="roleId"]:checked').map(r=>Number(r.value)),f=p('input[name="clientId"]:checked').map(r=>Number(r.value)),c=t("#createUserError"),m=t("#createUserOk"),l=e.submitter||t('#createUserForm button[type="submit"]');if(c.textContent="",m.style.display="none",!n){c.textContent="El nombre de usuario es obligatorio.";return}if(!a){c.textContent="La contraseÃ±a es obligatoria.";return}l&&(l.disabled=!0);try{const r=await u("/api/users/create",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:n,mail:o,password:a,roleIds:s,clientIds:f})});if(!r.ok){let i="";try{i=await r.text()}catch{}throw i||(i=`Error ${r.status}`),r.status===409&&(i="El usuario ya existe."),new Error(i)}m.style.display="block",setTimeout(()=>{d(),h("/private/users/table-view")},600)}catch(r){c.textContent=r.message}finally{l&&(l.disabled=!1)}}function U(){t("#createUserBtn")?.addEventListener("click",v),t("#closeCreateUser")?.addEventListener("click",d),t("#cancelCreateUser")?.addEventListener("click",d),t("#createUserForm")?.addEventListener("submit",k),document.addEventListener("keydown",e=>{e.key==="Escape"&&d()})}(function(){U()})();
