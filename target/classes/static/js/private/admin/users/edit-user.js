import{f as v}from"../../../auth.js";import{n as p}from"../../../navigation-handler.js";function o(e,r=document){return r.querySelector(e)}function d(e,{error:r=!1,timeout:n=4e3}={}){const t=document.getElementById("user-status");t&&(t.textContent=e,t.style.color=r?"#b91c1c":"",n>0&&setTimeout(()=>{t.style.color=""},n))}function E(e){const r=o("#user-username",e),n=o("#user-mail",e),t=o("#user-active",e),s=o("#user-roleIds",e),l=o("#user-clientIds",e),u=o("#user-employeeId",e),m=o("#user-timeZone",e),i={};if(r){const a=String(r.value??"").trim();i.username=a===""?null:a}if(n){const a=String(n.value??"").trim();i.mail=a===""?null:a}if(t&&(i.active=!!t.checked),s){const a=Array.from(s.selectedOptions).map(c=>c.value).filter(c=>c!=="").map(Number);i.roleIds=a}if(l){const a=Array.from(l.selectedOptions).map(c=>c.value).filter(c=>c!=="").map(Number);i.clientIds=a}if(u){const a=u.value;i.employeeId=a===""||a==null?null:Number(a)}if(m){const a=String(m.value??"").trim();i.timeZone=a===""?null:a}return i}async function y(e){const r=e.dataset.userEndpoint||e.getAttribute("data-user-endpoint");if(!r){d("Endpoint del usuario no configurado",{error:!0,timeout:0});return}const n=o("#saveUserBtn",e),t=o("#deleteUserBtn",e);n&&(n.disabled=!0),t&&(t.disabled=!0);try{const s=E(e),l=await v(r,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});if(!l.ok){let u;try{u=await l.json()}catch{u={message:await l.text().catch(()=>"")}}const m=u?.message||u?.error||`Error al guardar (HTTP ${l.status})`;throw new Error(m)}d("Usuario actualizado correctamente",{error:!1,timeout:2e3}),setTimeout(()=>p("/private/users/table-view",!0),700)}catch(s){console.error("Error guardando usuario",s),d("No se pudo guardar: "+(s.message||s),{error:!0,timeout:5e3}),n&&(n.disabled=!1),t&&(t.disabled=!1)}}async function h(e){const r=e.getAttribute("data-id")||null;if(!(!r||!window.confirm("¿Eliminar este usuario? Esta acción no se puede deshacer."))){e.disabled=!0;try{const t=await v(`/api/users/${r}`,{method:"DELETE"});if(!t.ok){const s=await t.text().catch(()=>"");throw new Error(s||`Error al eliminar (HTTP ${t.status})`)}p("/private/users/table-view",!0)}catch(t){console.error("Error eliminando usuario",t),alert("No se pudo eliminar: "+(t.message||t)),e.disabled=!1}}}function g(e){const r=o("#detect-user-tz",e),n=o("#user-timeZone",e);!r||!n||r.addEventListener("click",()=>{try{const t=Intl.DateTimeFormat().resolvedOptions().timeZone;t?(n.value=t,d(`Zona detectada: ${t}`,{error:!1,timeout:2e3})):d("No se pudo detectar la zona en este navegador",{error:!0,timeout:4e3})}catch(t){console.warn("Detect TZ failed",t),d("Error detectando zona",{error:!0,timeout:4e3})}})}function b(e){const r=o("#deleteUserBtn",e);r&&r.addEventListener("click",n=>{n.preventDefault(),h(r)})}function f(){const e=document.getElementById("editUserForm");e&&(e.addEventListener("submit",r=>{r.preventDefault(),y(e)}),g(e),b(e))}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",f):f();
