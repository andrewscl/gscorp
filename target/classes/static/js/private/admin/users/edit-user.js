import{f as v}from"../../../auth.js";import{n as p}from"../../../navigation-handler.js";function a(e,r=document){return r.querySelector(e)}function d(e,{error:r=!1,timeout:n=4e3}={}){const t=document.getElementById("user-status");t&&(t.textContent=e,t.style.color=r?"#b91c1c":"",n>0&&setTimeout(()=>{t.style.color=""},n))}function E(e){const r=a("#userusername",e),n=a("#userMail",e),t=a("#userActive",e),s=a("#userRoles",e),l=a("#userClients",e),u=a("#userEmployeeId",e),m=a("#userTimeZone",e),i={};if(r){const o=String(r.value??"").trim();i.username=o===""?null:o}if(n){const o=String(n.value??"").trim();i.mail=o===""?null:o}if(t&&(i.active=!!t.checked),s){const o=Array.from(s.selectedOptions).map(c=>c.value).filter(c=>c!=="").map(Number);i.roleIds=o}if(l){const o=Array.from(l.selectedOptions).map(c=>c.value).filter(c=>c!=="").map(Number);i.clientIds=o}if(u){const o=u.value;i.employeeId=o===""||o==null?null:Number(o)}if(m){const o=String(m.value??"").trim();i.timeZone=o===""?null:o}return i}async function y(e){const r=e.dataset.userEndpoint||e.getAttribute("data-user-endpoint");if(!r){d("Endpoint del usuario no configurado",{error:!0,timeout:0});return}const n=a("#saveUserBtn",e),t=a("#deleteUserBtn",e);n&&(n.disabled=!0),t&&(t.disabled=!0);try{const s=E(e);console.log("Payload generado:",s);const l=await v(r,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});if(!l.ok){let u;try{u=await l.json()}catch{u={message:await l.text().catch(()=>"")}}const m=u?.message||u?.error||`Error al guardar (HTTP ${l.status})`;throw new Error(m)}d("Usuario actualizado correctamente",{error:!1,timeout:2e3}),setTimeout(()=>p("/private/users/table-view",!0),700)}catch(s){console.error("Error guardando usuario",s),d("No se pudo guardar: "+(s.message||s),{error:!0,timeout:5e3}),n&&(n.disabled=!1),t&&(t.disabled=!1)}}async function g(e){const r=e.getAttribute("data-id")||null;if(!(!r||!window.confirm("¿Eliminar este usuario? Esta acción no se puede deshacer."))){e.disabled=!0;try{const t=await v(`/api/users/${r}`,{method:"DELETE"});if(!t.ok){const s=await t.text().catch(()=>"");throw new Error(s||`Error al eliminar (HTTP ${t.status})`)}p("/private/users/table-view",!0)}catch(t){console.error("Error eliminando usuario",t),alert("No se pudo eliminar: "+(t.message||t)),e.disabled=!1}}}function h(e){const r=a("#detect-user-tz",e),n=a("#user-timeZone",e);!r||!n||r.addEventListener("click",()=>{try{const t=Intl.DateTimeFormat().resolvedOptions().timeZone;t?(n.value=t,d(`Zona detectada: ${t}`,{error:!1,timeout:2e3})):d("No se pudo detectar la zona en este navegador",{error:!0,timeout:4e3})}catch(t){console.warn("Detect TZ failed",t),d("Error detectando zona",{error:!0,timeout:4e3})}})}function b(e){const r=a("#deleteUserBtn",e);r&&r.addEventListener("click",n=>{n.preventDefault(),g(r)})}function f(){const e=document.getElementById("editUserForm");e&&(e.addEventListener("submit",r=>{r.preventDefault(),y(e)}),h(e),b(e))}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",f):f();
