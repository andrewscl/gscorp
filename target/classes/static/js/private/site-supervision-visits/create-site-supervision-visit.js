import{f as I}from"../../auth.js";import{n as f}from"../../navigation-handler.js";const x=35;let v=[],m=null;function L(t,e,i,a){const o=r=>r*Math.PI/180,s=o(i-t),c=o(a-e),d=Math.sin(s/2)*Math.sin(s/2)+Math.cos(o(t))*Math.cos(o(i))*Math.sin(c/2)*Math.sin(c/2);return 6371e3*(2*Math.atan2(Math.sqrt(d),Math.sqrt(1-d)))}function C(t,e,i){let a=null,n=1/0;for(const o of i){if(typeof o.lat!="number"||typeof o.lon!="number")continue;const s=L(t,e,o.lat,o.lon);s<n&&(n=s,a={...o,distance:s})}return a}async function T(){try{const t=await I("/api/site-supervision-visits/sites",{credentials:"same-origin"});if(!t.ok)throw new Error(`Error cargando sitios: ${t.status}`);v=await t.json()}catch(t){console.error("No se pudo cargar la lista de sitios:",t),v=[]}}async function y(){const t=document.getElementById("visit-status"),e=document.getElementById("visit-site-info"),i=document.getElementById("save-visit-btn");if(!navigator.geolocation){t.textContent="Geolocalización no soportada",e.textContent="",i.disabled=!0;return}t.textContent="Detectando instalación más cercana...",e.textContent="";try{const a=await new Promise((o,s)=>navigator.geolocation.getCurrentPosition(o,s,{enableHighAccuracy:!0,timeout:15e3}));if(!v.length){t.textContent="No hay sitios configurados.",t.style.color="#b00020",e.textContent="",i.disabled=!0,m&&clearTimeout(m),m=setTimeout(()=>f("/private/supervisors/dashboard"),3e3);return}const n=C(a.coords.latitude,a.coords.longitude,v);m&&(clearTimeout(m),m=null),n&&n.distance<=x?(t.textContent=`Estás en el sitio "${n.name}". Puedes registrar visita aquí.`,t.style.color="#059669",i.disabled=!1,i.dataset.siteId=n.id,i.dataset.latitude=a.coords.latitude,i.dataset.longitude=a.coords.longitude):n?(t.textContent=`El sitio más cercano es "${n.name}" a ${n.distance.toFixed(1)} metros. Acércate para registrar.`,t.style.color="#d97706",e.textContent="",e.style.color="#d97706",i.disabled=!0):(t.textContent="No se encontró ningún sitio cercano.",t.style.color="#b00020",e.textContent="",e.style.color="#b00020",i.disabled=!0,m=setTimeout(()=>f("/private/supervisors/dashboard"),3e3))}catch{const n=document.getElementById("visit-status"),o=document.getElementById("visit-site-info");n.textContent="No se pudo obtener ubicación.",n.style.color="#b00020",o.textContent="",o.style.color="#b00020";const s=document.getElementById("save-visit-btn");s&&(s.disabled=!0)}}function B(){const t=document.getElementById("visit-widget");if(!t||t.dataset.svInit==="1")return;t.dataset.svInit="1";const e=document.getElementById("save-visit-btn"),i=document.getElementById("cancel-visit-btn"),a=document.getElementById("visit-description"),n=document.getElementById("visit-photo"),o=document.getElementById("visit-photo-preview"),s=document.getElementById("visit-video"),c=document.getElementById("visit-video-preview");n?.addEventListener("change",()=>{o.innerHTML="";const d=n.files&&n.files[0];if(d){const l=URL.createObjectURL(d),r=document.createElement("img");r.src=l,r.style.maxWidth="180px",r.style.borderRadius="6px",o.appendChild(r)}}),s?.addEventListener("change",()=>{c.innerHTML="";const d=s.files&&s.files[0];if(d){const l=URL.createObjectURL(d),r=document.createElement("video");r.src=l,r.controls=!0,r.style.maxWidth="220px",r.style.borderRadius="6px",c.appendChild(r)}}),e?.addEventListener("click",async d=>{d.preventDefault();const l=e.dataset.siteId,r=e.dataset.latitude,h=e.dataset.longitude,w=a.value;if(!l||!r||!h){y();return}e.disabled=!0,p("Registrando visita...","#0077b6");const u=new FormData;u.append("siteId",l),u.append("latitude",r),u.append("longitude",h),u.append("description",w),n.files&&n.files[0]&&u.append("photo",n.files[0]),s.files&&s.files[0]&&u.append("video",s.files[0]);try{const g=t.dataset.visitEndpoint||"/api/site-supervision-visits/create",E=await I(g,{method:"POST",body:u,credentials:"same-origin"});if(!E.ok){let M=await E.json().catch(()=>({}));throw new Error(M.error||"Error al registrar visita.")}p("✅ Visita registrada correctamente.","#15803d"),t.reset(),o.innerHTML="",c.innerHTML="",e.disabled=!0}catch(g){p("No se pudo registrar la visita: "+(g.message||g),"#b91c1c"),e.disabled=!1}}),i?.addEventListener("click",d=>{d.preventDefault(),t.reset(),o.innerHTML="",c.innerHTML="",p("Registro cancelado.","#b91c1c"),e.disabled=!0,f("/private/site-supervision-visits/table-view")}),S(),y()}function S(){const t=document.getElementById("visit-map");if(t){if(t._google_map&&(t._google_map=null,t.innerHTML=""),!navigator.geolocation){t.innerHTML="<div style='padding:1em;text-align:center;color:#888'>Geolocalización no soportada</div>";return}navigator.geolocation.getCurrentPosition(e=>{const i=e.coords.latitude,a=e.coords.longitude;if(window.google&&window.google.maps){const n=new google.maps.Map(t,{center:{lat:i,lng:a},zoom:17,mapTypeId:"roadmap",disableDefaultUI:!0});new google.maps.Marker({position:{lat:i,lng:a},map:n}),t._google_map=n}else t.innerHTML="<div style='padding:1em;text-align:center;color:#888'>Google Maps no cargado</div>"},e=>{t.innerHTML=`<div style='padding:1em;text-align:center;color:#b00020'>No se pudo obtener ubicación.<br>${e.message}</div>`},{enableHighAccuracy:!0,timeout:1e4})}}function p(t,e="#444"){const i=document.getElementById("visit-status");i&&(i.textContent=t||"",i.style.color=e)}async function b(){await T(),B(),await y()}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",b):b();document.addEventListener("content:loaded",b);
