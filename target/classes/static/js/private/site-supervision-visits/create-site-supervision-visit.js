import{f as E}from"../../auth.js";import{n as h}from"../../navigation-handler.js";const x=35;let p=[],u=null;function C(t,e,o,s){const i=r=>r*Math.PI/180,a=i(o-t),d=i(s-e),c=Math.sin(a/2)*Math.sin(a/2)+Math.cos(i(t))*Math.cos(i(o))*Math.sin(d/2)*Math.sin(d/2);return 6371e3*(2*Math.atan2(Math.sqrt(c),Math.sqrt(1-c)))}function L(t,e,o){let s=null,n=1/0;for(const i of o){if(typeof i.lat!="number"||typeof i.lon!="number")continue;const a=C(t,e,i.lat,i.lon);a<n&&(n=a,s={...i,distance:a})}return s}async function T(){try{const t=await E("/api/site-supervision-visits/sites",{credentials:"same-origin"});if(!t.ok)throw new Error(`Error cargando sitios: ${t.status}`);p=await t.json()}catch(t){console.error("No se pudo cargar la lista de sitios:",t),p=[]}}async function v(){const t=document.getElementById("visit-status"),e=document.getElementById("visit-site-info"),o=document.getElementById("save-visit-btn");if(!navigator.geolocation){t.textContent="Geolocalización no soportada",e.textContent="",o.disabled=!0;return}t.textContent="Detectando instalación más cercana...",e.textContent="";try{const s=await new Promise((i,a)=>navigator.geolocation.getCurrentPosition(i,a,{enableHighAccuracy:!0,timeout:15e3}));if(!p.length){t.textContent="No hay sitios configurados.",t.style.color="#b00020",e.textContent="",o.disabled=!0,u&&clearTimeout(u),u=setTimeout(()=>h("/private/supervisors/dashboard"),3e3);return}const n=L(s.coords.latitude,s.coords.longitude,p);u&&(clearTimeout(u),u=null),n&&n.distance<=x?(t.textContent=`Estás en el sitio "${n.name}". Puedes registrar visita aquí.`,t.style.color="#059669",e.textContent=`Sitio: ${n.name} (${n.address||""})`,e.style.color="#059669",o.disabled=!1,o.dataset.siteId=n.id,o.dataset.latitude=s.coords.latitude,o.dataset.longitude=s.coords.longitude):n?(t.textContent=`El sitio más cercano es "${n.name}" a ${n.distance.toFixed(1)} metros. Acércate para registrar.`,t.style.color="#d97706",e.textContent="",e.style.color="#d97706",o.disabled=!0):(t.textContent="No se encontró ningún sitio cercano.",t.style.color="#b00020",e.textContent="",e.style.color="#b00020",o.disabled=!0,u=setTimeout(()=>h("/private/supervisors/dashboard"),3e3))}catch{const n=document.getElementById("visit-status"),i=document.getElementById("visit-site-info");n.textContent="No se pudo obtener ubicación.",n.style.color="#b00020",i.textContent="",i.style.color="#b00020";const a=document.getElementById("save-visit-btn");a&&(a.disabled=!0)}}function S(){const t=document.getElementById("visit-widget");if(!t||t.dataset.svInit==="1")return;t.dataset.svInit="1";const e=document.getElementById("save-visit-btn"),o=document.getElementById("cancel-visit-btn"),s=document.getElementById("visit-description"),n=document.getElementById("visit-photo"),i=document.getElementById("visit-photo-preview"),a=document.getElementById("visit-video"),d=document.getElementById("visit-video-preview");n?.addEventListener("change",()=>{i.innerHTML="";const c=n.files&&n.files[0];if(c){const l=URL.createObjectURL(c),r=document.createElement("img");r.src=l,r.style.maxWidth="180px",r.style.borderRadius="6px",i.appendChild(r)}}),a?.addEventListener("change",()=>{d.innerHTML="";const c=a.files&&a.files[0];if(c){const l=URL.createObjectURL(c),r=document.createElement("video");r.src=l,r.controls=!0,r.style.maxWidth="220px",r.style.borderRadius="6px",d.appendChild(r)}}),e?.addEventListener("click",async c=>{c.preventDefault();const l=e.dataset.siteId,r=e.dataset.latitude,y=e.dataset.longitude,I=s.value;if(!l||!r||!y){v();return}e.disabled=!0,m("Registrando visita...","#0077b6");const M={siteId:l,latitude:r,longitude:y,description:I};try{const g=t.dataset.visitEndpoint||"/api/site-supervision-visits/create",b=await E(g,{method:"POST",body:JSON.stringify(M),headers:{"Content-Type":"application/json",Accept:"application/json"},credentials:"same-origin"});if(!b.ok){let w=await b.json().catch(()=>({}));throw new Error(w.error||"Error al registrar visita.")}m("✅ Visita registrada correctamente.","#15803d"),t.reset(),i.innerHTML="",d.innerHTML="",e.disabled=!0}catch(g){m("No se pudo registrar la visita: "+(g.message||g),"#b91c1c"),e.disabled=!1}}),o?.addEventListener("click",c=>{c.preventDefault(),t.reset(),i.innerHTML="",d.innerHTML="",m("Registro cancelado.","#b91c1c"),e.disabled=!0}),B(),v()}function B(){const t=document.getElementById("visit-map");if(t){if(t._google_map&&(t._google_map=null,t.innerHTML=""),!navigator.geolocation){t.innerHTML="<div style='padding:1em;text-align:center;color:#888'>Geolocalización no soportada</div>";return}navigator.geolocation.getCurrentPosition(e=>{const o=e.coords.latitude,s=e.coords.longitude;if(window.google&&window.google.maps){const n=new google.maps.Map(t,{center:{lat:o,lng:s},zoom:17,mapTypeId:"roadmap",disableDefaultUI:!0});new google.maps.Marker({position:{lat:o,lng:s},map:n}),t._google_map=n}else t.innerHTML="<div style='padding:1em;text-align:center;color:#888'>Google Maps no cargado</div>"},e=>{t.innerHTML=`<div style='padding:1em;text-align:center;color:#b00020'>No se pudo obtener ubicación.<br>${e.message}</div>`},{enableHighAccuracy:!0,timeout:1e4})}}function m(t,e="#444"){const o=document.getElementById("visit-status");o&&(o.textContent=t||"",o.style.color=e)}async function f(){await T(),S(),await v()}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",f):f();document.addEventListener("content:loaded",f);
