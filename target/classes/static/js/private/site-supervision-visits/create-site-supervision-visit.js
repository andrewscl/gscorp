import{f as E}from"../../auth.js";import{n as h}from"../../navigation-handler.js";const x=35;function C(t,e,o,s){const i=a=>a*Math.PI/180,r=i(o-t),c=i(s-e),d=Math.sin(r/2)*Math.sin(r/2)+Math.cos(i(t))*Math.cos(i(o))*Math.sin(c/2)*Math.sin(c/2);return 6371e3*(2*Math.atan2(Math.sqrt(d),Math.sqrt(1-d)))}function L(t,e,o){let s=null,n=1/0;for(const i of o){if(typeof i.lat!="number"||typeof i.lon!="number")continue;const r=C(t,e,i.lat,i.lon);r<n&&(n=r,s={...i,distance:r})}return s}let m=[],u=null;async function p(){try{const t=await E("/api/supervisor-visits/sites",{credentials:"same-origin"});if(!t.ok)throw new Error(`Error cargando sitios: ${t.status}`);m=await t.json()}catch(t){console.error("No se pudo cargar la lista de sitios:",t),m=[]}}async function b(){const t=document.getElementById("visit-status"),e=document.getElementById("visit-site-info"),o=document.getElementById("save-visit-btn");if(!navigator.geolocation){t.textContent="Geolocalización no soportada",e.textContent="",o.disabled=!0;return}t.textContent="Detectando instalación más cercana...",e.textContent="";try{const s=await new Promise((i,r)=>navigator.geolocation.getCurrentPosition(i,r,{enableHighAccuracy:!0,timeout:15e3}));if(!m.length){e.textContent="No hay sitios configurados. Redirigiendo al dashboard...",e.style.color="#b00020",t.textContent="No se encontró ningún sitio cercano. Redirigiendo al dashboard...",t.style.color="#b00020",o.disabled=!0,u&&clearTimeout(u),u=setTimeout(()=>h("private/supervisors/dashboard"),3e3);return}const n=L(s.coords.latitude,s.coords.longitude,m);u&&(clearTimeout(u),u=null),n&&n.distance<=x?(t.textContent=`Estás en el sitio "${n.name}". Puedes registrar visita aquí.`,t.style.color="#059669",e.textContent=`Sitio: ${n.name} (${n.address||""})`,e.style.color="#059669",o.disabled=!1,o.dataset.siteId=n.id,o.dataset.latitude=s.coords.latitude,o.dataset.longitude=s.coords.longitude):n?(t.textContent=`El sitio más cercano es "${n.name}" a ${n.distance.toFixed(1)} metros. Acércate para registrar.`,t.style.color="#d97706",e.textContent="",e.style.color="#d97706",o.disabled=!0):(t.textContent="No se encontró ningún sitio cercano. Redirigiendo al dashboard...",t.style.color="#b00020",e.textContent="",e.style.color="#b00020",o.disabled=!0,u=setTimeout(()=>h("private/supervisors/dashboard"),3e3))}catch{t.textContent="No se pudo obtener ubicación.",t.style.color="#b00020",e.textContent="",e.style.color="#b00020",o.disabled=!0}}function v(){const t=document.getElementById("visit-widget");if(!t||t.dataset.svInit==="1")return;t.dataset.svInit="1";const e=document.getElementById("save-visit-btn"),o=document.getElementById("cancel-visit-btn"),s=document.getElementById("visit-description"),n=document.getElementById("visit-photo"),i=document.getElementById("visit-photo-preview"),r=document.getElementById("visit-video"),c=document.getElementById("visit-video-preview");n?.addEventListener("change",()=>{i.innerHTML="";const d=n.files&&n.files[0];if(d){const l=URL.createObjectURL(d),a=document.createElement("img");a.src=l,a.style.maxWidth="180px",a.style.borderRadius="6px",i.appendChild(a)}}),r?.addEventListener("change",()=>{c.innerHTML="";const d=r.files&&r.files[0];if(d){const l=URL.createObjectURL(d),a=document.createElement("video");a.src=l,a.controls=!0,a.style.maxWidth="220px",a.style.borderRadius="6px",c.appendChild(a)}}),e?.addEventListener("click",async d=>{d.preventDefault();const l=e.dataset.siteId,a=e.dataset.latitude,f=e.dataset.longitude,w=s.value;if(!l||!a||!f){b();return}e.disabled=!0,showStatus("Registrando visita...","#0077b6");const M={siteId:l,latitude:a,longitude:f,description:w};try{const g=t.dataset.visitEndpoint||"/api/supervisor-visits/register",y=await E(g,{method:"POST",body:JSON.stringify(M),headers:{"Content-Type":"application/json",Accept:"application/json"},credentials:"same-origin"});if(!y.ok){let I=await y.json().catch(()=>({}));throw new Error(I.error||"Error al registrar visita.")}showStatus("✅ Visita registrada correctamente.","#15803d"),t.reset(),i.innerHTML="",c.innerHTML="",e.disabled=!0}catch(g){showStatus("No se pudo registrar la visita: "+(g.message||g),"#b91c1c"),e.disabled=!1}}),o?.addEventListener("click",d=>{d.preventDefault(),t.reset(),i.innerHTML="",c.innerHTML="",showStatus("Registro cancelado.","#b91c1c"),e.disabled=!0}),T(),b()}function T(){const t=document.getElementById("visit-map");if(t){if(t._google_map&&(t._google_map=null,t.innerHTML=""),!navigator.geolocation){t.innerHTML="<div style='padding:1em;text-align:center;color:#888'>Geolocalización no soportada</div>";return}navigator.geolocation.getCurrentPosition(e=>{const o=e.coords.latitude,s=e.coords.longitude;if(window.google&&window.google.maps){const n=new google.maps.Map(t,{center:{lat:o,lng:s},zoom:17,mapTypeId:"roadmap",disableDefaultUI:!0});new google.maps.Marker({position:{lat:o,lng:s},map:n}),t._google_map=n}else t.innerHTML="<div style='padding:1em;text-align:center;color:#888'>Google Maps no cargado</div>"},e=>{t.innerHTML=`<div style='padding:1em;text-align:center;color:#b00020'>No se pudo obtener ubicación.<br>${e.message}</div>`},{enableHighAccuracy:!0,timeout:1e4})}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",async()=>{await p(),v()}):p().then(v);document.addEventListener("content:loaded",async()=>{await p(),v()});
