import{f as H}from"../../auth.js";import{n as P}from"../../navigation-handler.js";const M=35;function O(e,i,t,s){const a=A=>A*Math.PI/180,u=a(t-e),I=a(s-i),R=Math.sin(u/2)*Math.sin(u/2)+Math.cos(a(e))*Math.cos(a(t))*Math.sin(I/2)*Math.sin(I/2);return 6371e3*(2*Math.atan2(Math.sqrt(R),Math.sqrt(1-R)))}function U(e,i,t){let s=null,p=1/0;for(const a of t){if(typeof a.latitude!="number"||typeof a.longitude!="number")continue;const u=O(e,i,a.latitude,a.longitude);u<p&&(p=u,s={...a,distance:u})}return s}const o=e=>document.querySelector(e),m=o("#visit-widget"),D=o("#visit-status"),C=o("#visit-site-info");o("#visit-map-container");const N=o("#visit-map"),l=o("#save-visit-btn"),$=o("#cancel-visit-btn"),b=o("#visit-photo"),f=o("#visit-photo-preview"),h=o("#visit-video"),v=o("#visit-video-preview"),j=o("#visit-description");let w,y,T=null,r=null,c=null,E=null,d=window.siteList||[],g=null;function n(e,i="#444"){D.textContent=e||"",D.style.color=i}function L(e,i="#0077b6"){C.textContent=e||"",C.style.color=i}b?.addEventListener("change",()=>{f.innerHTML="";const e=b.files&&b.files[0];if(e){const i=URL.createObjectURL(e),t=document.createElement("img");t.src=i,t.style.maxWidth="180px",t.style.borderRadius="6px",f.appendChild(t)}});h?.addEventListener("change",()=>{v.innerHTML="";const e=h.files&&h.files[0];if(e){const i=URL.createObjectURL(e),t=document.createElement("video");t.src=i,t.controls=!0,t.style.maxWidth="220px",t.style.borderRadius="6px",v.appendChild(t)}});function q(e=-33.45,i=-70.65,t=16){!N||!window.google||!google.maps||(w=new google.maps.Map(N,{center:{lat:e,lng:i},zoom:t,mapTypeId:"roadmap",disableDefaultUI:!0}),y=new google.maps.Marker({map:w,position:{lat:e,lng:i},draggable:!0,title:"Tu ubicación"}),y.addListener("dragend",s=>{r=s.latLng.lat(),c=s.latLng.lng(),x()}))}function k(){if(!navigator.geolocation){n("Tu navegador no soporta geolocalización.","#b91c1c");return}n("Obteniendo ubicación actual...","#0077b6"),navigator.geolocation.getCurrentPosition(e=>{r=e.coords.latitude,c=e.coords.longitude,w.setCenter({lat:r,lng:c}),y.setPosition({lat:r,lng:c}),n("Ubicación detectada, buscando sitio más cercano...","#15803d"),x()},e=>{n("No se pudo obtener la ubicación actual: "+(e.message||e),"#b91c1c")},{enableHighAccuracy:!0,timeout:1e4})}function x(){if(!d||!r||!c)return;const e=U(r,c,d);T=e,E=e?e.distance:null,g&&(clearTimeout(g),g=null),e?e.distance<=M?(n(`Estás en el sitio "${e.name}". Puedes registrar visita aquí.`,"#059669"),L(`Sitio: ${e.name} (${e.address||""})`,"#059669"),l.disabled=!1):(n(`El sitio más cercano es "${e.name}" a ${e.distance.toFixed(1)} metros. Acércate para registrar.`,"#d97706"),L("","#d97706"),l.disabled=!0):(n("No se encontró ningún sitio cercano. Redirigiendo...","#b00020"),L("","#b00020"),l.disabled=!0,g=setTimeout(()=>{P("private/supervisors/dashboard")},3e3))}m?.addEventListener("submit",async e=>{if(e.preventDefault(),!r||!c){n("No se ha detectado ubicación válida.","#b91c1c");return}if(!T){n("No se ha detectado sitio cercano.","#b91c1c");return}if(typeof E!="number"||E>M){n(`Debes estar a menos de ${M} metros del sitio para registrar visita.`,"#b91c1c");return}n("Registrando visita...","#0077b6"),l.disabled=!0;const i={siteId:T.id,latitude:r,longitude:c,description:j.value};try{const t=m.dataset.visitEndpoint||"/api/supervisor-visits/register",s=await H(t,{method:"POST",body:JSON.stringify(i),headers:{"Content-Type":"application/json",Accept:"application/json"},credentials:"same-origin"});if(!s.ok){let p=await s.json().catch(()=>({}));throw new Error(p.error||"Error al registrar visita.")}n("✅ Visita registrada correctamente.","#15803d"),m.reset(),f.innerHTML="",v.innerHTML="",l.disabled=!0}catch(t){n("No se pudo registrar la visita: "+(t.message||t),"#b91c1c"),l.disabled=!1}});$?.addEventListener("click",e=>{e.preventDefault(),m.reset(),f.innerHTML="",v.innerHTML="",n("Registro cancelado.","#b91c1c"),l.disabled=!0});function S(e=0){if(window.google&&window.google.maps){let i=-33.45,t=-70.65;d.length&&typeof d[0].latitude=="number"&&typeof d[0].longitude=="number"&&(i=d[0].latitude,t=d[0].longitude),q(i,t),k()}else e<15?setTimeout(()=>S(e+1),250+100*e):n("No se pudo cargar el mapa de Google.","#b91c1c")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",S):S();
