import{f as P}from"../../auth.js";import{n as A}from"../../navigation-handler.js";const M=35;function U(e,t,i,s){const a=H=>H*Math.PI/180,u=a(i-e),I=a(s-t),S=Math.sin(u/2)*Math.sin(u/2)+Math.cos(a(e))*Math.cos(a(i))*Math.sin(I/2)*Math.sin(I/2);return 6371e3*(2*Math.atan2(Math.sqrt(S),Math.sqrt(1-S)))}function $(e,t,i){let s=null,f=1/0;for(const a of i){if(typeof a.latitude!="number"||typeof a.longitude!="number")continue;const u=U(e,t,a.latitude,a.longitude);u<f&&(f=u,s={...a,distance:u})}return s}const o=e=>document.querySelector(e),v=o("#visit-widget"),R=o("#visit-status"),C=o("#visit-site-info");o("#visit-map-container");const x=o("#visit-map"),l=o("#save-visit-btn"),q=o("#cancel-visit-btn"),p=o("#visit-photo"),b=o("#visit-photo-preview"),g=o("#visit-video"),h=o("#visit-video-preview"),O=o("#visit-description");let w,y,T=null,r=null,c=null,E=null,d=window.siteList||[],m=null;function n(e,t="#444"){R.textContent=e||"",R.style.color=t}function L(e,t="#0077b6"){C.textContent=e||"",C.style.color=t}p?.addEventListener("change",()=>{b.innerHTML="";const e=p.files&&p.files[0];if(e){const t=URL.createObjectURL(e),i=document.createElement("img");i.src=t,i.style.maxWidth="180px",i.style.borderRadius="6px",b.appendChild(i)}});g?.addEventListener("change",()=>{h.innerHTML="";const e=g.files&&g.files[0];if(e){const t=URL.createObjectURL(e),i=document.createElement("video");i.src=t,i.controls=!0,i.style.maxWidth="220px",i.style.borderRadius="6px",h.appendChild(i)}});function k(e=-33.45,t=-70.65,i=16){!x||!window.google||!google.maps||(w=new google.maps.Map(x,{center:{lat:e,lng:t},zoom:i,mapTypeId:"roadmap",disableDefaultUI:!0}),y=new google.maps.Marker({map:w,position:{lat:e,lng:t},draggable:!0,title:"Tu ubicación"}),y.addListener("dragend",s=>{r=s.latLng.lat(),c=s.latLng.lng(),N()}))}function j(){if(!navigator.geolocation){n("Tu navegador no soporta geolocalización.","#b91c1c");return}n("Obteniendo ubicación actual...","#0077b6"),navigator.geolocation.getCurrentPosition(e=>{r=e.coords.latitude,c=e.coords.longitude,w.setCenter({lat:r,lng:c}),y.setPosition({lat:r,lng:c}),n("Ubicación detectada, buscando sitio más cercano...","#15803d"),N()},e=>{n("No se pudo obtener la ubicación actual: "+(e.message||e),"#b91c1c")},{enableHighAccuracy:!0,timeout:1e4})}function N(){if(!d||!r||!c)return;const e=$(r,c,d);T=e,E=e?e.distance:null,m&&(clearTimeout(m),m=null),e?e.distance<=M?(n(`Estás en el sitio "${e.name}". Puedes registrar visita aquí.`,"#059669"),L(`Sitio: ${e.name} (${e.address||""})`,"#059669"),l.disabled=!1):(n(`El sitio más cercano es "${e.name}" a ${e.distance.toFixed(1)} metros. Acércate para registrar.`,"#d97706"),L("","#d97706"),l.disabled=!0):(n("No se encontró ningún sitio cercano. Redirigiendo al dashboard...","#b00020"),L("","#b00020"),l.disabled=!0,m=setTimeout(()=>{A("private/supervisors/dashboard")},3e3))}v?.addEventListener("submit",async e=>{if(e.preventDefault(),!r||!c){n("No se ha detectado ubicación válida.","#b91c1c");return}if(!T){n("No se ha detectado sitio cercano.","#b91c1c");return}if(typeof E!="number"||E>M){n(`Debes estar a menos de ${M} metros del sitio para registrar visita.`,"#b91c1c");return}n("Registrando visita...","#0077b6"),l.disabled=!0;const t=new FormData;t.append("siteId",T.id),t.append("latitude",r),t.append("longitude",c),t.append("description",O.value),p.files&&p.files[0]&&t.append("photo",p.files[0]),g.files&&g.files[0]&&t.append("video",g.files[0]);try{const i=v.dataset.visitEndpoint||"/api/supervisor-visits/register",s=await P(i,{method:"POST",body:t,credentials:"same-origin"});if(!s.ok){let f=await s.json().catch(()=>({}));throw new Error(f.error||"Error al registrar visita.")}n("✅ Visita registrada correctamente.","#15803d"),v.reset(),b.innerHTML="",h.innerHTML="",l.disabled=!0}catch(i){n("No se pudo registrar la visita: "+(i.message||i),"#b91c1c"),l.disabled=!1}});q?.addEventListener("click",e=>{e.preventDefault(),v.reset(),b.innerHTML="",h.innerHTML="",n("Registro cancelado.","#b91c1c"),l.disabled=!0});function D(e=0){if(window.google&&window.google.maps){let t=-33.45,i=-70.65;d.length&&typeof d[0].latitude=="number"&&typeof d[0].longitude=="number"&&(t=d[0].latitude,i=d[0].longitude),k(t,i),j()}else e<15?setTimeout(()=>D(e+1),250+100*e):n("No se pudo cargar el mapa de Google.","#b91c1c")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",D):D();
