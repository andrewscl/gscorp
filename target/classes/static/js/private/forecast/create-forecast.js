import{f as m}from"../../auth.js";import{n as S}from"../../navigation-handler.js";console.log("create-forecast.js cargado");const r=(e,t=document)=>t.querySelector(e);function u(e,{error:t=!1,timeout:n=4e3}={}){const i=r("#forecast-status");i&&(i.textContent=e,i.style.color=t?"#b91c1c":"",n>0&&setTimeout(()=>{i&&(i.style.color="")},n))}function b(){const e=r("#forecast-preview"),t=r("#forecast-preview-text");!e||!t||(t.textContent="",e.hidden=!0)}function L(e){const t=r("#forecast-client",e)?.value??"",n=r("#forecast-project",e)?.value??"",i=r("#forecast-site",e)?.value??"",o=r("#forecast-metric",e)?.value??"",c=r("#forecast-periodicity",e)?.value??"",a=r("#forecast-category",e)?.value??"",v=r("#forecast-start",e)?.value??"",l=r("#forecast-end",e)?.value??"",s=(()=>{const f=r("#forecast-start-hour",e);if(!f)return null;const p=String(f.value??"").trim();return p===""?null:Number(p)})(),d=(()=>{const f=r("#forecast-end-hour",e);if(!f)return null;const p=String(f.value??"").trim();return p===""?null:Number(p)})(),h=r("#forecast-value",e)?.value??"",j=h===""?null:Number(h),H=r("#forecast-units",e)?.value??null,E=r("#forecast-confidence",e)?.value??"",N=E===""?null:Number(E),y=r("#forecast-note",e)?.value??null,w=r("#forecast-version",e)?.value??"",C=w===""?null:Number(w),I=r("#forecast-tz",e)?.value??null;return{clientId:t===""?null:Number(t),projectId:n===""?null:Number(n),siteId:i===""?null:Number(i),periodicity:c||null,metric:o||null,forecastCategory:a||null,periodStart:v||null,periodEnd:l||null,periodStartHour:s,periodEndHour:d,value:j,units:H||null,confidence:N,note:y||null,forecastVersion:C,tz:I||null}}function $(e){if(!e.clientId)return"Debes seleccionar un cliente.";if(!e.metric)return"La métrica es requerida.";if(!e.periodicity)return"La periodicidad es requerida.";if(!e.forecastCategory)return"La categoría es requerida.";if(!e.periodStart)return"El periodo inicio es requerido.";if(e.value==null||Number.isNaN(e.value))return"Valor válido es requerido.";if(e.value<0)return"El valor debe ser >= 0.";if(e.confidence!=null&&(Number.isNaN(e.confidence)||e.confidence<0||e.confidence>100))return"Confianza debe estar entre 0 y 100.";if(e.periodicity==="HOURLY"){if(e.periodStartHour==null||e.periodEndHour==null)return"Para HOURLY especifica las horas.";if(!Number.isInteger(e.periodStartHour)||e.periodStartHour<0||e.periodStartHour>23)return"periodStartHour debe ser 0..23";if(!Number.isInteger(e.periodEndHour)||e.periodEndHour<0||e.periodEndHour>23)return"periodEndHour debe ser 0..23"}if(e.periodEnd)try{const t=new Date(e.periodStart),n=new Date(e.periodEnd);if(t>n)return"'Desde' no puede ser posterior a 'Hasta'."}catch{}return null}async function z(e,t){return await m(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})}async function T(e){e.preventDefault();const t=r("#forecast-form");if(!t)return;const n=r("#forecast-status");n&&(n.textContent="");const i=r("#forecast-save",t);i&&(i.disabled=!0);try{const o=L(t),c=$(o);if(c){u(c,{error:!0,timeout:5e3}),i&&(i.disabled=!1);return}const a=r("#forecast-preview");if(a){const s=r("#forecast-preview-text");s&&(s.textContent=[o.clientId?`Cliente: ${o.clientId}`:null,o.projectId?`Proyecto: ${o.projectId}`:null,o.siteId?`Sitio: ${o.siteId}`:null,o.metric?`Métrica: ${o.metric}`:null,o.periodicity?`Periodicidad: ${o.periodicity}`:null,o.periodStart?`Desde: ${o.periodStart}`:null,o.periodEnd?`Hasta: ${o.periodEnd}`:null,o.value!=null?`Valor: ${o.value}${o.units?" "+o.units:""}`:null,o.tz?`Zona: ${o.tz}`:null].filter(Boolean).join(" · ")),a.hidden=!1}u("Enviando...",{error:!1,timeout:0});const v=t.dataset.forecastEndpoint||t.getAttribute("data-forecast-endpoint")||"/api/forecasts",l=await z(v,o);if(!l.ok){let s=`Error ${l.status}`;try{const d=await l.json();s=d?.message||d?.error||JSON.stringify(d)}catch{s=await l.text().catch(()=>s)}throw new Error(s)}u("Forecast creado correctamente",{error:!1,timeout:1500}),t.reset(),b(),setTimeout(()=>{const s=t.dataset.postUrl||"/private/forecast/table-view";S(s,!0)},600)}catch(o){u("No se pudo crear: "+(o.message||o),{error:!0,timeout:6e3})}finally{i&&(i.disabled=!1)}}function P(e){e.preventDefault();const t=r("#forecast-form");if(!t)return;const n=t.dataset.cancelPath||"/private/forecast";S(n,!0)}function x(){const e=r("#detect-tz"),t=r("#forecast-tz");!e||!t||e.addEventListener("click",()=>{try{const n=Intl.DateTimeFormat().resolvedOptions().timeZone;n?(t.value=n,u(`Zona detectada: ${n}`,{error:!1,timeout:2e3})):u("No se pudo detectar la zona",{error:!0,timeout:2e3})}catch(n){console.warn("Detect TZ failed",n),u("Error detectando zona",{error:!0,timeout:2e3})}})}function g(){const e=r("#forecast-periodicity"),t=r(".hour-fields");if(!(!e||!t))if(e.value==="HOURLY")t.hidden=!1,t.setAttribute("aria-hidden","false");else{t.hidden=!0,t.setAttribute("aria-hidden","true");const n=r("#forecast-start-hour"),i=r("#forecast-end-hour");n&&(n.value=""),i&&(i.value="")}}function D(){const e=r("#forecast-periodicity");e&&(e.addEventListener("change",g),g())}async function q(e){const t=r("#forecast-project"),n=r("#forecast-site");if(t){if(t.innerHTML='<option value="">-- seleccionar --</option>',n&&(n.innerHTML='<option value="">-- (opcional) --</option>',n.disabled=!0),!e){t.disabled=!0;return}try{const i=await m(`/api/clients/${e}/projects`);if(!i.ok)throw new Error("no projects");(await i.json()).forEach(c=>{const a=document.createElement("option");a.value=c.id,a.textContent=c.name||c.id,t.appendChild(a)}),t.disabled=!1}catch(i){console.debug("No projects endpoint or failed to load projects",i),t.disabled=!0}}}async function O(e){const t=r("#forecast-site");if(t){if(t.innerHTML='<option value="">-- (opcional) --</option>',!e){t.disabled=!0;return}try{const n=await m(`/api/projects/${e}/sites`);if(!n.ok)throw new Error("no sites");(await n.json()).forEach(o=>{const c=document.createElement("option");c.value=o.id,c.textContent=o.name||o.id,t.appendChild(c)}),t.disabled=!1}catch(n){console.debug("No sites endpoint or failed to load sites",n),t.disabled=!0}}}function A(){const e=r("#forecast-client"),t=r("#forecast-project");e&&e.addEventListener("change",async n=>{const i=n.target.value;await q(i),b()}),t&&t.addEventListener("change",async n=>{const i=n.target.value;await O(i),b()})}function R(){const e=r("#forecast-form");if(!e)return;e.addEventListener("submit",T);const t=r("#forecast-cancel");t&&t.addEventListener("click",P),x(),D(),A()}(function(){R()})();
