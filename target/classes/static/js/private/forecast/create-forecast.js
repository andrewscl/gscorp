import{f as N}from"../../auth.js";import{n as I}from"../../navigation-handler.js";console.log("create-forecast.js cargado (mejorado)");const o=(e,t=document)=>t.querySelector(e);function f(e,{error:t=!1,timeout:n=4e3}={}){const r=o("#forecast-status");r&&(r.textContent=e,r.style.color=t?"#b91c1c":"",n>0&&setTimeout(()=>{r&&(r.style.color="")},n))}function S(){const e=o("#forecast-preview"),t=o("#forecast-preview-text");!e||!t||(t.textContent="",e.hidden=!0)}function L(e){const t=o("#forecast-client",e)?.value??"",n=o("#forecast-project",e)?.value??"",r=o("#forecast-site",e)?.value??"",i=o("#forecast-metric",e)?.value??"",a=o("#forecast-periodicity",e)?.value??"",c=o("#forecast-category",e)?.value??"",l=o("#forecast-start",e)?.value??"",s=o("#forecast-end",e)?.value??"",u=(()=>{const m=o("#forecast-start-hour",e);if(!m)return null;const h=String(m.value??"").trim();return h===""?null:Number(h)})(),p=(()=>{const m=o("#forecast-end-hour",e);if(!m)return null;const h=String(m.value??"").trim();return h===""?null:Number(h)})(),d=o("#forecast-value",e)?.value??"",v=d===""?null:Number(d),T=o("#forecast-units",e)?.value??null,E=o("#forecast-confidence",e)?.value??"",j=E===""?null:Number(E),z=o("#forecast-note",e)?.value??null,w=o("#forecast-version",e)?.value??"",$=w===""?null:Number(w),x=o("#forecast-tz",e)?.value??null;return{clientId:t===""?null:Number(t),projectId:n===""?null:Number(n),siteId:r===""?null:Number(r),periodicity:a||null,metric:i||null,forecastCategory:c||null,periodStart:l||null,periodEnd:s||null,periodStartHour:u,periodEndHour:p,value:v,units:T||null,confidence:j,note:z||null,forecastVersion:$,tz:x||null}}function U(e){if(!e.clientId)return"Debes seleccionar un cliente.";if(!e.metric)return"La métrica es requerida.";if(!e.periodicity)return"La periodicidad es requerida.";if(!e.forecastCategory)return"La categoría es requerida.";if(!e.periodStart)return"El periodo inicio es requerido.";if(e.value==null||Number.isNaN(e.value))return"Valor válido es requerido.";if(e.value<0)return"El valor debe ser >= 0.";if(e.confidence!=null&&(Number.isNaN(e.confidence)||e.confidence<0||e.confidence>100))return"Confianza debe estar entre 0 y 100.";if(e.periodicity==="HOURLY"){if(e.periodStartHour==null||e.periodEndHour==null)return"Para HOURLY especifica las horas.";if(!Number.isInteger(e.periodStartHour)||e.periodStartHour<0||e.periodStartHour>23)return"periodStartHour debe ser 0..23";if(!Number.isInteger(e.periodEndHour)||e.periodEndHour<0||e.periodEndHour>23)return"periodEndHour debe ser 0..23"}if(e.periodEnd)try{const t=new Date(e.periodStart),n=new Date(e.periodEnd);if(t>n)return"'Desde' no puede ser posterior a 'Hasta'."}catch{}return null}async function q(e,t){return await N(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})}async function D(e){e.preventDefault();const t=o("#forecast-form");if(!t)return;const n=o("#forecast-save",t);n&&(n.disabled=!0);try{const r=L(t),i=U(r);if(i){f(i,{error:!0,timeout:5e3}),n&&(n.disabled=!1);return}const a=o("#forecast-preview");if(a){const s=o("#forecast-preview-text");s&&(s.textContent=[r.clientId?`Cliente: ${r.clientId}`:null,r.projectId?`Proyecto: ${r.projectId}`:null,r.siteId?`Sitio: ${r.siteId}`:null,r.metric?`Métrica: ${r.metric}`:null,r.periodicity?`Periodicidad: ${r.periodicity}`:null,r.periodStart?`Desde: ${r.periodStart}`:null,r.periodEnd?`Hasta: ${r.periodEnd}`:null,r.value!=null?`Valor: ${r.value}${r.units?" "+r.units:""}`:null,r.tz?`Zona: ${r.tz}`:null].filter(Boolean).join(" · ")),a.hidden=!1}f("Enviando...",{error:!1,timeout:0});const c=t.dataset.forecastEndpoint||t.getAttribute("data-forecast-endpoint")||"/api/forecasts",l=await q(c,r);if(!l.ok){let s=`Error ${l.status}`;try{const u=await l.json();s=u?.message||u?.error||JSON.stringify(u)}catch{s=await l.text().catch(()=>s)}throw new Error(s)}f("Forecast creado correctamente",{error:!1,timeout:1500}),t.reset(),S(),setTimeout(()=>{const s=t.dataset.postUrl||"/private/forecast/table-view";I(s,!0)},600)}catch(r){f("No se pudo crear: "+(r.message||r),{error:!0,timeout:6e3})}finally{n&&(n.disabled=!1)}}function F(e){e.preventDefault();const t=o("#forecast-form");if(!t)return;const n=t.dataset.cancelPath||"/private/forecast";I(n,!0)}function O(){const e=o("#detect-tz"),t=o("#forecast-tz");!e||!t||e.addEventListener("click",()=>{try{const n=Intl.DateTimeFormat().resolvedOptions().timeZone;n?(t.value=n,f(`Zona detectada: ${n}`,{error:!1,timeout:2e3})):f("No se pudo detectar la zona",{error:!0,timeout:2e3})}catch(n){console.warn("Detect TZ failed",n),f("Error detectando zona",{error:!0,timeout:2e3})}})}function R(){const e=o("#forecast-periodicity");if(!e)return null;const t=e.selectedOptions?.[0]??e.options[e.selectedIndex];if(!t)return null;const n={};for(const a of e.options){const c=String(a.value??"").trim(),l=String(a.textContent??"").trim();c&&(n[c.toUpperCase()]=c.toUpperCase()),l&&(n[l.toUpperCase()]=c?c.toUpperCase():l.toUpperCase());const s=a.dataset?.value;s&&(n[s.toUpperCase()]=s.toUpperCase())}const r=String(t.value??"").trim().toUpperCase(),i=String(t.textContent??"").trim().toUpperCase();return r?n[r]??r:n[i]?n[i]:i||null}function g(){const e=o(".hour-fields");if(!e){console.debug("toggleHourlyFields: .hour-fields no existe");return}const t=R(),n=String(t??"").toUpperCase()==="HOURLY";if(n){e.style.display="",e.hidden=!1,e.setAttribute("aria-hidden","false");const r=o("#forecast-start-hour"),i=o("#forecast-end-hour");r&&(r.required=!0),i&&(i.required=!0)}else{e.style.display="none",e.hidden=!0,e.setAttribute("aria-hidden","true");const r=o("#forecast-start-hour"),i=o("#forecast-end-hour");r&&(r.value="",r.required=!1),i&&(i.value="",i.required=!1)}console.debug("toggleHourlyFields -> normalized:",t,"isHourly:",n)}function B(){const e=o("#forecast-periodicity"),t=o(".hour-fields");if(t&&(t.style.display="none",t.hidden=!0,t.setAttribute("aria-hidden","true")),!e){console.debug("initPeriodicityToggle: #forecast-periodicity no encontrado");return}e.addEventListener("change",g),e.addEventListener("input",g),setTimeout(()=>{try{g()}catch(n){console.error("toggleHourlyFields init error",n)}},10)}async function P(e){const t=await N(e,{method:"GET",headers:{Accept:"application/json"}});if(!t.ok){const n=await t.text().catch(()=>"");throw new Error(`HTTP ${t.status} ${n}`)}return t.json()}function b(e){return e==null?null:e.id??e.projectId??e.siteId??e.value??null}function A(e){return e==null?null:e.name??e.title??e.projectName??e.siteName??String(b(e))}async function C(e){const t=o("#forecast-project"),n=o("#forecast-site");if(!t)return;const i=o("#forecast-form")?.dataset?.initialProject??o("#prefill-project")?.value??null;if(t.innerHTML='<option value="">-- seleccionar --</option>',t.disabled=!0,n&&(n.innerHTML='<option value="">-- (opcional) --</option>',n.disabled=!0),!e){t.disabled=!0;return}try{const a=`/api/clients/${encodeURIComponent(String(e))}/projects`,c=await P(a),l=Array.isArray(c)?c:Array.isArray(c?.data)?c.data:[];if(!Array.isArray(l)||l.length===0){t.disabled=!0,console.debug("fetchAndPopulateProjects: no projects for client",e,c);return}l.forEach(u=>{const p=b(u),d=A(u);if(p==null)return;const v=document.createElement("option");v.value=p,v.textContent=d,t.appendChild(v)}),t.disabled=!1;const s=t.value&&t.value!==""?t.value:i??"";if(s){const u=t.querySelector(`option[value="${s}"]`);u&&(u.selected=!0)}}catch(a){console.error("fetchAndPopulateProjects error",a),t.disabled=!0}}async function y(e){const t=o("#forecast-site");if(!t)return;const r=o("#forecast-form")?.dataset?.initialSite??o("#prefill-site")?.value??null;if(t.innerHTML='<option value="">-- (opcional) --</option>',t.disabled=!0,!e){t.disabled=!0;return}try{const i=`/api/projects/${encodeURIComponent(String(e))}/sites`,a=await P(i),c=Array.isArray(a)?a:Array.isArray(a?.data)?a.data:[];if(!Array.isArray(c)||c.length===0){t.disabled=!0,console.debug("fetchAndPopulateSites: no sites for project",e,a);return}c.forEach(s=>{const u=b(s),p=A(s);if(u==null)return;const d=document.createElement("option");d.value=u,d.textContent=p,t.appendChild(d)}),t.disabled=!1;const l=t.value&&t.value!==""?t.value:r??"";if(l){const s=t.querySelector(`option[value="${l}"]`);s&&(s.selected=!0)}}catch(i){console.error("fetchAndPopulateSites error",i),t.disabled=!0}}function V(){const e=o("#forecast-client"),t=o("#forecast-project");e&&e.addEventListener("change",async r=>{const i=r.target.value;await C(i),S()}),t&&t.addEventListener("change",async r=>{const i=r.target.value;await y(i),S()});const n=o("#forecast-client");n&&n.value&&setTimeout(()=>C(n.value).then(()=>{const r=o("#forecast-project");if(r&&r.value)y(r.value);else{const i=o("#forecast-form")?.dataset?.initialProject;i&&setTimeout(()=>y(i),200)}}).catch(r=>console.debug("init cascading initial load err",r)),50)}function H(){try{return Intl.DateTimeFormat().resolvedOptions().timeZone||null}catch{return null}}function Z(){const e=document.getElementById("forecast-tz"),t=document.getElementById("detect-tz");if(e){if(!e.value||e.value.trim()===""){const n=H();n&&(e.value=n)}t&&t.addEventListener("click",()=>{const n=H();n?e.value=n:console.warn("No se pudo detectar timezone del navegador")})}}function k(){const e=o("#forecast-form");if(!e)return;e.addEventListener("submit",D);const t=o("#forecast-cancel");t&&t.addEventListener("click",F),O(),B(),V();try{Z()}catch(n){console.error(n)}}(function(){k()})();
