import{f as A}from"../../auth.js";import{n as N}from"../../navigation-handler.js";console.log("create-forecast.js cargado (mejorado)");const n=(e,t=document)=>t.querySelector(e);function f(e,{error:t=!1,timeout:o=4e3}={}){const r=n("#forecast-status");r&&(r.textContent=e,r.style.color=t?"#b91c1c":"",o>0&&setTimeout(()=>{r&&(r.style.color="")},o))}function b(){const e=n("#forecast-preview"),t=n("#forecast-preview-text");!e||!t||(t.textContent="",e.hidden=!0)}function z(e){const t=n("#forecast-client",e)?.value??"",o=n("#forecast-project",e)?.value??"",r=n("#forecast-site",e)?.value??"",i=n("#forecast-metric",e)?.value??"",s=n("#forecast-periodicity",e)?.value??"",a=n("#forecast-category",e)?.value??"",l=n("#forecast-start",e)?.value??"",c=n("#forecast-end",e)?.value??"",u=(()=>{const m=n("#forecast-start-hour",e);if(!m)return null;const h=String(m.value??"").trim();return h===""?null:Number(h)})(),p=(()=>{const m=n("#forecast-end-hour",e);if(!m)return null;const h=String(m.value??"").trim();return h===""?null:Number(h)})(),d=n("#forecast-value",e)?.value??"",v=d===""?null:Number(d),I=n("#forecast-units",e)?.value??null,E=n("#forecast-confidence",e)?.value??"",C=E===""?null:Number(E),T=n("#forecast-note",e)?.value??null,w=n("#forecast-version",e)?.value??"",$=w===""?null:Number(w),L=n("#forecast-tz",e)?.value??null;return{clientId:t===""?null:Number(t),projectId:o===""?null:Number(o),siteId:r===""?null:Number(r),periodicity:s||null,metric:i||null,forecastCategory:a||null,periodStart:l||null,periodEnd:c||null,periodStartHour:u,periodEndHour:p,value:v,units:I||null,confidence:C,note:T||null,forecastVersion:$,tz:L||null}}function x(e){if(!e.clientId)return"Debes seleccionar un cliente.";if(!e.metric)return"La métrica es requerida.";if(!e.periodicity)return"La periodicidad es requerida.";if(!e.forecastCategory)return"La categoría es requerida.";if(!e.periodStart)return"El periodo inicio es requerido.";if(e.value==null||Number.isNaN(e.value))return"Valor válido es requerido.";if(e.value<0)return"El valor debe ser >= 0.";if(e.confidence!=null&&(Number.isNaN(e.confidence)||e.confidence<0||e.confidence>100))return"Confianza debe estar entre 0 y 100.";if(e.periodicity==="HOURLY"){if(e.periodStartHour==null||e.periodEndHour==null)return"Para HOURLY especifica las horas.";if(!Number.isInteger(e.periodStartHour)||e.periodStartHour<0||e.periodStartHour>23)return"periodStartHour debe ser 0..23";if(!Number.isInteger(e.periodEndHour)||e.periodEndHour<0||e.periodEndHour>23)return"periodEndHour debe ser 0..23"}if(e.periodEnd)try{const t=new Date(e.periodStart),o=new Date(e.periodEnd);if(t>o)return"'Desde' no puede ser posterior a 'Hasta'."}catch{}return null}async function D(e,t){return await A(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})}async function q(e){e.preventDefault();const t=n("#forecast-form");if(!t)return;const o=n("#forecast-save",t);o&&(o.disabled=!0);try{const r=z(t),i=x(r);if(i){f(i,{error:!0,timeout:5e3}),o&&(o.disabled=!1);return}const s=n("#forecast-preview");if(s){const c=n("#forecast-preview-text");c&&(c.textContent=[r.clientId?`Cliente: ${r.clientId}`:null,r.projectId?`Proyecto: ${r.projectId}`:null,r.siteId?`Sitio: ${r.siteId}`:null,r.metric?`Métrica: ${r.metric}`:null,r.periodicity?`Periodicidad: ${r.periodicity}`:null,r.periodStart?`Desde: ${r.periodStart}`:null,r.periodEnd?`Hasta: ${r.periodEnd}`:null,r.value!=null?`Valor: ${r.value}${r.units?" "+r.units:""}`:null,r.tz?`Zona: ${r.tz}`:null].filter(Boolean).join(" · ")),s.hidden=!1}f("Enviando...",{error:!1,timeout:0});const a=t.dataset.forecastEndpoint||t.getAttribute("data-forecast-endpoint")||"/api/forecasts",l=await D(a,r);if(!l.ok){let c=`Error ${l.status}`;try{const u=await l.json();c=u?.message||u?.error||JSON.stringify(u)}catch{c=await l.text().catch(()=>c)}throw new Error(c)}f("Forecast creado correctamente",{error:!1,timeout:1500}),t.reset(),b(),setTimeout(()=>{const c=t.dataset.postUrl||"/private/forecast/table-view";N(c,!0)},600)}catch(r){f("No se pudo crear: "+(r.message||r),{error:!0,timeout:6e3})}finally{o&&(o.disabled=!1)}}function R(e){e.preventDefault();const t=n("#forecast-form");if(!t)return;const o=t.dataset.cancelPath||"/private/forecast";N(o,!0)}function F(){const e=n("#detect-tz"),t=n("#forecast-tz");!e||!t||e.addEventListener("click",()=>{try{const o=Intl.DateTimeFormat().resolvedOptions().timeZone;o?(t.value=o,f(`Zona detectada: ${o}`,{error:!1,timeout:2e3})):f("No se pudo detectar la zona",{error:!0,timeout:2e3})}catch(o){console.warn("Detect TZ failed",o),f("Error detectando zona",{error:!0,timeout:2e3})}})}function g(){const e=n("#forecast-periodicity"),t=n(".hour-fields");if(!t)return;if(!e){t.hidden=!0,t.setAttribute("aria-hidden","true");return}const o=String(e.value??"").trim(),i=o.toUpperCase()==="HOURLY";if(t.hidden=!i,t.setAttribute("aria-hidden",(!i).toString()),!i){const s=n("#forecast-start-hour"),a=n("#forecast-end-hour");s&&(s.value=""),a&&(a.value="")}console.debug("toggleHourlyFields -> periodicity=",o,"isHourly=",i)}function O(){const e=n("#forecast-periodicity"),t=n(".hour-fields");if(t&&(t.hidden=!0,t.setAttribute("aria-hidden","true")),!e){console.debug("initPeriodicityToggle: #forecast-periodicity no encontrado");return}e.addEventListener("change",g),e.addEventListener("input",g);try{g()}catch(o){console.error("toggleHourlyFields error",o)}}async function P(e){const t=await A(e,{method:"GET",headers:{Accept:"application/json"}});if(!t.ok){const o=await t.text().catch(()=>"");throw new Error(`HTTP ${t.status} ${o}`)}return t.json()}function y(e){return e==null?null:e.id??e.projectId??e.siteId??e.value??null}function j(e){return e==null?null:e.name??e.title??e.projectName??e.siteName??String(y(e))}async function H(e){const t=n("#forecast-project"),o=n("#forecast-site");if(!t)return;const i=n("#forecast-form")?.dataset?.initialProject??n("#prefill-project")?.value??null;if(t.innerHTML='<option value="">-- seleccionar --</option>',t.disabled=!0,o&&(o.innerHTML='<option value="">-- (opcional) --</option>',o.disabled=!0),!e){t.disabled=!0;return}try{const s=`/api/clients/${encodeURIComponent(String(e))}/projects`,a=await P(s),l=Array.isArray(a)?a:Array.isArray(a?.data)?a.data:[];if(!Array.isArray(l)||l.length===0){t.disabled=!0,console.debug("fetchAndPopulateProjects: no projects for client",e,a);return}l.forEach(u=>{const p=y(u),d=j(u);if(p==null)return;const v=document.createElement("option");v.value=p,v.textContent=d,t.appendChild(v)}),t.disabled=!1;const c=t.value&&t.value!==""?t.value:i??"";if(c){const u=t.querySelector(`option[value="${c}"]`);u&&(u.selected=!0)}}catch(s){console.error("fetchAndPopulateProjects error",s),t.disabled=!0}}async function S(e){const t=n("#forecast-site");if(!t)return;const r=n("#forecast-form")?.dataset?.initialSite??n("#prefill-site")?.value??null;if(t.innerHTML='<option value="">-- (opcional) --</option>',t.disabled=!0,!e){t.disabled=!0;return}try{const i=`/api/projects/${encodeURIComponent(String(e))}/sites`,s=await P(i),a=Array.isArray(s)?s:Array.isArray(s?.data)?s.data:[];if(!Array.isArray(a)||a.length===0){t.disabled=!0,console.debug("fetchAndPopulateSites: no sites for project",e,s);return}a.forEach(c=>{const u=y(c),p=j(c);if(u==null)return;const d=document.createElement("option");d.value=u,d.textContent=p,t.appendChild(d)}),t.disabled=!1;const l=t.value&&t.value!==""?t.value:r??"";if(l){const c=t.querySelector(`option[value="${l}"]`);c&&(c.selected=!0)}}catch(i){console.error("fetchAndPopulateSites error",i),t.disabled=!0}}function U(){const e=n("#forecast-client"),t=n("#forecast-project");e&&e.addEventListener("change",async r=>{const i=r.target.value;await H(i),b()}),t&&t.addEventListener("change",async r=>{const i=r.target.value;await S(i),b()});const o=n("#forecast-client");o&&o.value&&setTimeout(()=>H(o.value).then(()=>{const r=n("#forecast-project");if(r&&r.value)S(r.value);else{const i=n("#forecast-form")?.dataset?.initialProject;i&&setTimeout(()=>S(i),200)}}).catch(r=>console.debug("init cascading initial load err",r)),50)}function V(){const e=n("#forecast-form");if(!e)return;e.addEventListener("submit",q);const t=n("#forecast-cancel");t&&t.addEventListener("click",R),F(),O(),U()}(function(){V()})();
