import{f as C}from"../../auth.js";import{n as m}from"../../navigation-handler.js";const c=document.getElementById("editIncidentForm"),r=document.getElementById("photoFile"),i=document.getElementById("photoPreviewImg"),b=document.getElementById("photoPreviewLink"),t=document.getElementById("photoPreviewContainer"),o=document.getElementById("photoPreviewEmpty"),s=document.getElementById("removePhoto"),p=document.getElementById("saveBtn"),h=document.getElementById("cancelBtn"),f=document.getElementById("editIncidentError"),l=document.getElementById("editIncidentOk");let a=null;function u(){a&&(URL.revokeObjectURL(a),a=null)}r&&(i&&!i.dataset.original&&(i.dataset.original=i.src||""),r.addEventListener("change",d=>{const n=d.target.files&&d.target.files[0];if(s&&(s.checked=!1),!n){if(u(),i){const e=i.dataset.original||"";e?(i.src=e,t&&(t.style.display=""),o&&(o.style.display="none")):(t&&(t.style.display="none"),o&&(o.style.display=""))}return}if(u(),a=URL.createObjectURL(n),i)i.src=a,t&&(t.style.display=""),o&&(o.style.display="none"),b&&(b.href=a);else{const e=document.createElement("img");e.id="photoPreviewImg",e.className="incident-photo-thumb",e.src=a,e.alt="Foto incidente",t?(t.appendChild(e),t.style.display=""):o&&o.replaceWith(e)}}));s&&s.addEventListener("change",()=>{s.checked?(t&&(t.style.display="none"),o&&(o.style.display=""),r&&(r.value="",u())):i&&(i.dataset.original||i.src)&&(t&&(t.style.display=""),o&&(o.style.display="none"))});h&&h.addEventListener("click",d=>{d.preventDefault();const n=h.getAttribute("data-path")||"/private/incidents/table-view";if(typeof m=="function")try{m(n)}catch{window.location.href=n}else window.location.href=n});c&&c.addEventListener("submit",async d=>{if(d.preventDefault(),!!c){f&&(f.textContent=""),l&&(l.style.display="none"),p&&(p.disabled=!0);try{const n=c.querySelector('input[name="id"]')?.value||document.querySelector(".meta-id span")?.textContent?.trim();if(!n)throw new Error("ID del incidente no encontrado");const e=new FormData,g=document.getElementById("incidentType"),v=document.getElementById("priority"),E=document.getElementById("status"),w=document.getElementById("slaMinutes"),I=document.getElementById("description");g&&e.append("incidentType",g.value),v&&e.append("priority",v.value),E&&e.append("status",E.value),w&&e.append("slaMinutes",w.value??""),I&&e.append("description",I.value??"");const B=r?.files?.[0];B&&e.append("photo",B),s&&s.checked&&e.append("removePhoto","true");const P=`/api/incidents/${encodeURIComponent(n)}/update`,y=await C(P,{method:"POST",body:e,credentials:"same-origin"});if(!y.ok){const k=await y.text().catch(()=>"");throw new Error(k||`No se pudo guardar (HTTP ${y.status})`)}l&&(l.style.display="",l.textContent="Cambios guardados âœ…"),u(),setTimeout(()=>{typeof m=="function"?m("/private/incidents/table-view",!0):window.location.href="/private/incidents/table-view"},900)}catch(n){f&&(f.textContent=n.message||"Error al guardar los cambios."),console.error("Error al guardar incidente:",n)}finally{p&&(p.disabled=!1)}}});
