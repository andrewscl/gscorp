import{f}from"../../auth.js";let r,i=[],d=[],g=!1;function M(e,o){return new Promise((a,n)=>{if(window.google&&google.maps){console.log("[loadGoogleMapsAPI] Google Maps ya estaba disponible."),a();return}const t=document.createElement("script");t.src=`https://maps.googleapis.com/maps/api/js?key=${e}&libraries=marker&map_ids=${o}`,t.async=!0,t.defer=!0,t.setAttribute("loading","lazy"),t.onload=()=>{console.log("[loadGoogleMapsAPI] Google Maps API cargada correctamente."),a()},t.onerror=()=>{console.error("[loadGoogleMapsAPI] Error cargando Google Maps API."),n(new Error("No se pudo cargar Google Maps API"))},document.head.appendChild(t)})}function m(){if(g){console.log("[initMap] Mapa ya inicializado, no se hace nada.");return}const e=document.getElementById("site-map");if(!e){console.error("[initMap] Contenedor del mapa no encontrado.");return}r=new google.maps.Map(e,{center:{lat:-33.45,lng:-70.65},zoom:8,mapTypeId:"roadmap",mapId:googleMapsConfig.mapId}),document.getElementById("site-select")?.addEventListener("change",I),v(),console.log("[initMap] Mapa inicializado exitosamente."),g=!0}function s(e){const o=document.getElementById("site-map-error");o&&(o.textContent=e,o.style.display="block")}function h(){const e=document.getElementById("site-map-error");e&&(e.style.display="none")}function y(e){i.forEach(n=>n.setMap(null)),i=[],d=e;const o=document.getElementById("site-select");o&&(o.innerHTML='<option value="">Seleccionar sitio</option>');const a=new google.maps.LatLngBounds;e.forEach(n=>{if(typeof n.lat=="number"&&typeof n.lon=="number"){const t={lat:n.lat,lng:n.lon},p=document.createElement("div");p.innerHTML=`
        <div style="background-color: white; border: 1px solid black; padding: 5px; border-radius: 3px;">
          <strong>${n.name}</strong>
        </div>
      `;const l=new google.maps.marker.AdvancedMarkerElement({map:r,position:t,title:n.name,content:p}),u=new google.maps.InfoWindow({content:`<h4>${n.name}</h4><p>Dirección: ${n.address}</p><p>Zona horaria: ${n.timeZone}</p>`});if(l.addListener("click",()=>u.open(r,l)),i.push(l),a.extend(t),o){const c=document.createElement("option");c.value=n.id,c.textContent=n.name,o.appendChild(c)}}}),e.length>0?r.fitBounds(a):(r.setCenter({lat:-33.45,lng:-70.65}),r.setZoom(8),s("No hay sitios para mostrar.")),E()}function I(){const e=document.getElementById("site-select");if(!e)return;const o=e.value,a=d.find(n=>String(n.id)===o);a&&(r.setCenter({lat:a.lat,lng:a.lon}),r.setZoom(15))}async function v(){try{const e=await f("/api/sites/projections-by-user",{method:"GET",headers:{Accept:"application/json"}});if(!e.ok){s("Error al cargar sitios. Intente nuevamente.");return}const o=await e.json();if(h(),!Array.isArray(o)||!o.every(a=>a.id&&a.lat&&a.lon)){s("Datos de sitios inválidos.");return}y(o)}catch(e){console.error("Fallo al obtener sitios:",e),s("Error al cargar sitios. Intente nuevamente.")}}function E(){const e=document.getElementById("site-select");e&&(e.addEventListener("mouseover",o=>{const a=o.target.value;if(!a)return;const n=d.find(t=>String(t.id)===a);n&&i.forEach(t=>{t.title===n.name?t.content.innerHTML=`
            <div style="background-color: #0000FF; color: white; border-radius: 8px; padding: 5px;">
              <strong>${n.name}</strong>
            </div>
          `:t.content.innerHTML=`
            <div style="background-color: #FF0000; color: white; border-radius: 8px; padding: 5px;">
              <strong>${t.title}</strong>
            </div>
          `})}),e.addEventListener("mouseleave",()=>{i.forEach(o=>{o.content.innerHTML=`
        <div style="background-color: #FF0000; color: white; border-radius: 8px; padding: 5px;">
          <strong>${o.title}</strong>
        </div>
      `})}))}(function(){if(window.google&&google.maps){console.log("[init] Google Maps ya estaba cargada anteriormente."),m();return}console.log("Google Maps Config:",googleMapsConfig),console.log("[init] IIFE iniciado"),M(googleMapsConfig.apiKey,googleMapsConfig.mapId).then(()=>{console.log("[init] Google Maps API lista. Inicializando mapa."),m()}).catch(o=>{console.error("[init] Error durante la carga de Google Maps:",o),s("No se pudo cargar Google Maps. Intente más tarde.")})})();
