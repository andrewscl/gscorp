let l,g=[],t=!1;function r(o,e){return new Promise((a,i)=>{if(window.google&&google.maps){console.log("[loadGoogleMapsAPI] Google Maps ya estaba disponible."),a();return}if(document.getElementById("google-maps-script")){console.log("[loadGoogleMapsAPI] Script ya existe en el DOM.");const s=setInterval(()=>{window.google&&google.maps&&(clearInterval(s),a())},200);return}const n=document.createElement("script");n.id="google-maps-script",n.src=`https://maps.googleapis.com/maps/api/js?key=${o}&libraries=core&map_ids=${e}&callback=googleMapsLoaded&loading=async`,n.async=!0,n.defer=!0,window.googleMapsLoaded=()=>{console.log("[googleMapsLoaded] Google Maps cargado exitosamente."),window.google&&google.maps&&google.maps.Map?(console.log("[googleMapsLoaded] google.maps está completamente inicializado."),a()):(console.error("[googleMapsLoaded] google.maps no está completamente definido después de la carga."),i(new Error("Google Maps cargado pero subcomponentes como google.maps.Map no están disponibles.")))},n.onerror=()=>{console.error("[loadGoogleMapsAPI] Error cargando Google Maps API."),i(new Error("No se pudo cargar Google Maps API"))},document.head.appendChild(n)})}function p(){if(console.log("[initMap] Verificando google.maps:",{google:window.google,maps:window.google?.maps,Map:window.google?.maps?.Map}),!google||!google.maps||!google.maps.Map){console.error("[initMap] No se puede inicializar el mapa porque google.maps.Map no está definido.");return}if(t){console.log("[initMap] Mapa ya inicializado, no se hace nada.");return}const o=document.getElementById("site-map");if(console.log("[initMap] Inicializando mapa en el contenedor:",o),!o){console.error("[initMap] Contenedor del mapa no encontrado.");return}l=new google.maps.Map(o,{center:{lat:-33.45,lng:-70.65},zoom:8,mapId:googleMapsConfig.mapId,disableDefaultUI:!0,renderer:"canvas"}),document.getElementById("site-select")?.addEventListener("change",d),console.log("[initMap] Mapa inicializado exitosamente."),t=!0}function c(o){const e=document.getElementById("site-map-error");e&&(e.textContent=o,e.style.display="block")}function d(){const o=document.getElementById("site-select");if(!o)return;const e=o.value,a=g.find(i=>String(i.id)===e);a&&(l.setCenter({lat:a.lat,lng:a.lon}),l.setZoom(15))}(function(){if(console.log("[init] IIFE iniciado"),e){console.log("[init] Ya inicializado, evita doble inicialización.");return}let e=!0;r(googleMapsConfig.apiKey,googleMapsConfig.mapId).then(()=>{console.log("[init] Google Maps API lista. Inicializando mapa."),p()}).catch(a=>{console.error("[init] Error durante la carga de Google Maps:",a),c("No se pudo cargar Google Maps. Intente más tarde.")})})();
