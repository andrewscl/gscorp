let g,p=[],i=!1;function r(o,e){return new Promise((a,l)=>{if(window.google&&google.maps){console.log("[loadGoogleMapsAPI] Google Maps ya estaba disponible."),a();return}if(document.getElementById("google-maps-script")){console.log("[loadGoogleMapsAPI] Script ya existe en el DOM.");const t=setInterval(()=>{window.google&&google.maps&&(clearInterval(t),a())},200);return}const n=document.createElement("script");n.id="google-maps-script",n.src=`https://maps.googleapis.com/maps/api/js?key=${o}&libraries=core&map_ids=${e}&callback=googleMapsLoaded&loading=async`,n.async=!0,n.defer=!0,n.onload=()=>{window.google&&google.maps?(console.log("[loadGoogleMapsAPI] Script cargado y Google Maps disponible."),a()):(console.error("[loadGoogleMapsAPI] Script cargado, pero Google Maps no está disponible."),l(new Error("Google Maps cargado pero no inicializado correctamente.")))},window.googleMapsLoaded=()=>{console.log("[googleMapsLoaded] Google Maps cargado exitosamente."),window.google&&google.maps&&google.maps.Map?(console.log("[googleMapsLoaded] google.maps está completamente inicializado."),a()):(console.error("[googleMapsLoaded] google.maps no está completamente definido después de la carga."),l(new Error("Google Maps cargado pero subcomponentes como google.maps.Map no están disponibles.")))},n.onerror=()=>{console.error("[loadGoogleMapsAPI] Error cargando Google Maps API."),l(new Error("No se pudo cargar Google Maps API"))},document.head.appendChild(n)})}function s(){if(console.log("[initMap] Verificando google.maps:",{google:window.google,maps:window.google?.maps,Map:window.google?.maps?.Map}),!google||!google.maps||!google.maps.Map){console.error("[initMap] No se puede inicializar el mapa porque google.maps.Map no está definido.");return}if(i){console.log("[initMap] Mapa ya inicializado, no se hace nada.");return}const o=document.getElementById("site-map");if(console.log("[initMap] Inicializando mapa en el contenedor:",o),!o){console.error("[initMap] Contenedor del mapa no encontrado.");return}g=new google.maps.Map(o,{center:{lat:-33.45,lng:-70.65},zoom:8,mapId:googleMapsConfig.mapId,disableDefaultUI:!0,renderer:"canvas"}),document.getElementById("site-select")?.addEventListener("change",d),console.log("[initMap] Mapa inicializado exitosamente."),i=!0}function c(o){const e=document.getElementById("site-map-error");e&&(e.textContent=o,e.style.display="block")}function d(){const o=document.getElementById("site-select");if(!o)return;const e=o.value,a=p.find(l=>String(l.id)===e);a&&(g.setCenter({lat:a.lat,lng:a.lon}),g.setZoom(15))}(function(){if(window.google&&google.maps)if(console.log("[init] Verificando google.maps:",{Map:google.maps?.Map,LatLng:google.maps?.LatLng,MapTypeId:google.maps?.MapTypeId}),google.maps.Map&&google.maps.LatLng){console.log("[init] Google Maps ya completamente cargados."),s();return}else console.warn("[init] Google Maps incompleto, recargando...");console.log("Google Maps Config:",googleMapsConfig),console.log("[init] IIFE iniciado"),r(googleMapsConfig.apiKey,googleMapsConfig.mapId).then(()=>{console.log("[init] Google Maps API lista. Inicializando mapa."),s()}).catch(e=>{console.error("[init] Error durante la carga de Google Maps:",e),c("No se pudo cargar Google Maps. Intente más tarde.")})})();
