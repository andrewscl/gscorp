import{f as u}from"../../auth.js";let a,s=[],c=[],p=!1;globalThis.initMap=function o(e=0){if(p){console.log("[initMap] Mapa ya inicializado, no se hace nada.");return}if(console.log(`[initMap] Intento ${e}: google.maps disponible:`,typeof google<"u"&&typeof google.maps<"u"),!window.google||!google.maps){e<10?(console.warn(`[initMap] Google Maps no disponible. Reintentando... (#${e})`),setTimeout(()=>o(e+1),500)):(console.error(`[initMap] No logró cargar Google Maps después de ${e} intentos.`),r("No se pudo cargar Google Maps. Intente más tarde."));return}console.log("[initMap] Google Maps cargado correctamente.");const t=document.getElementById("site-map");if(console.log("mapDiv:",t),console.log("Google Maps Config:",googleMapsConfig),!t||!window.google||!google.maps){console.log("google.maps:",typeof google<"u"&&typeof google.maps<"u"),r("No se pudo cargar Google Maps.");return}a=new google.maps.Map(t,{center:{lat:-33.45,lng:-70.65},zoom:8,mapTypeId:"roadmap",mapId:googleMapsConfig.mapId}),document.getElementById("site-select")?.addEventListener("change",v),h(),console.log("[initMap] Mapa inicializado exitosamente."),p=!0};globalThis.googleMapsLoaded=()=>{console.log("[Google Maps] API cargada correctamente.")};function r(o){const e=document.getElementById("site-map-error");e&&(e.textContent=o,e.style.display="block")}function f(){const o=document.getElementById("site-map-error");o&&(o.style.display="none")}function M(o){s.forEach(n=>n.setMap(null)),s=[],c=o;const e=document.getElementById("site-select");e&&(e.innerHTML='<option value="">Seleccionar sitio</option>');const t=new google.maps.LatLngBounds;o.forEach(n=>{if(typeof n.lat=="number"&&typeof n.lon=="number"){const i={lat:n.lat,lng:n.lon},g=document.createElement("div");g.innerHTML=`
        <div style="background-color: white; border: 1px solid black; padding: 5px; border-radius: 3px;">
          <strong>${n.name}</strong>
        </div>
      `;const l=new google.maps.marker.AdvancedMarkerElement({map:a,position:i,title:n.name,content:g}),m=new google.maps.InfoWindow({content:`<h4>${n.name}</h4><p>Dirección: ${n.address}</p><p>Zona horaria: ${n.timeZone}</p>`});if(l.addListener("click",()=>m.open(a,l)),s.push(l),t.extend(i),e){const d=document.createElement("option");d.value=n.id,d.textContent=n.name,e.appendChild(d)}}}),o.length>0?a.fitBounds(t):(a.setCenter({lat:-33.45,lng:-70.65}),a.setZoom(8),r("No hay sitios para mostrar.")),y()}function v(){const o=document.getElementById("site-select");if(!o)return;const e=o.value,t=c.find(n=>String(n.id)===e);t&&(a.setCenter({lat:t.lat,lng:t.lon}),a.setZoom(15))}async function h(){try{const o=await u("/api/sites/projections-by-user",{method:"GET",headers:{Accept:"application/json"}});if(!o.ok){r("Error al cargar sitios. Intente nuevamente.");return}const e=await o.json();if(f(),!Array.isArray(e)||!e.every(t=>t.id&&t.lat&&t.lon)){r("Datos de sitios inválidos.");return}M(e)}catch(o){console.error("Fallo al obtener sitios:",o),r("Error al cargar sitios. Intente nuevamente.")}}function y(){const o=document.getElementById("site-select");o&&(o.addEventListener("mouseover",e=>{const t=e.target.value;if(!t)return;const n=c.find(i=>String(i.id)===t);n&&s.forEach(i=>{i.title===n.name?i.content.innerHTML=`
            <div style="background-color: #0000FF; color: white; border-radius: 8px; padding: 5px;">
              <strong>${n.name}</strong>
            </div>
          `:i.content.innerHTML=`
            <div style="background-color: #FF0000; color: white; border-radius: 8px; padding: 5px;">
              <strong>${i.title}</strong>
            </div>
          `})}),o.addEventListener("mouseleave",()=>{s.forEach(e=>{e.content.innerHTML=`
        <div style="background-color: #FF0000; color: white; border-radius: 8px; padding: 5px;">
          <strong>${e.title}</strong>
        </div>
      `})}))}
