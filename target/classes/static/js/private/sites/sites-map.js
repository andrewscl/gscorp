import{f}from"../../auth.js";let i,r=[],d=[];function u(){const e=document.getElementById("site-map");if(console.log("Google Maps Config:",googleMapsConfig),!e||!window.google||!google.maps){a("No se pudo cargar Google Maps.");return}i=new google.maps.Map(e,{center:{lat:-33.45,lng:-70.65},zoom:8,mapTypeId:"roadmap",mapId:googleMapsConfig.mapId}),document.getElementById("site-select")?.addEventListener("change",E),I()}function a(e){const o=document.getElementById("site-map-error");o&&(o.textContent=e,o.style.display="block")}function h(){const e=document.getElementById("site-map-error");e&&(e.style.display="none")}function v(e){r.forEach(t=>t.setMap(null)),r=[],d=e;const o=document.getElementById("site-select");o&&(o.innerHTML='<option value="">Seleccionar sitio</option>');const n=new google.maps.LatLngBounds;e.forEach(t=>{if(typeof t.lat=="number"&&typeof t.lon=="number"){const s={lat:t.lat,lng:t.lon},p=document.createElement("div");p.innerHTML=`
        <div style="background-color: white; border: 1px solid black; padding: 5px; border-radius: 3px;">
          <strong>${t.name}</strong>
        </div>
      `;const c=new google.maps.marker.AdvancedMarkerElement({map:i,position:s,title:t.name,content:p}),g=new google.maps.InfoWindow({content:`<h4>${t.name}</h4><p>Dirección: ${t.address}</p><p>Zona horaria: ${t.timeZone}</p>`});if(c.addListener("click",()=>g.open(i,c)),r.push(c),n.extend(s),o){const l=document.createElement("option");l.value=t.id,l.textContent=t.name,o.appendChild(l)}}}),e.length>0?i.fitBounds(n):(i.setCenter({lat:-33.45,lng:-70.65}),i.setZoom(8),a("No hay sitios para mostrar.")),y()}function E(){const e=document.getElementById("site-select");if(!e)return;const o=e.value,n=d.find(t=>String(t.id)===o);n&&(i.setCenter({lat:n.lat,lng:n.lon}),i.setZoom(15))}async function I(){try{const e=await f("/api/sites/projections-by-user",{method:"GET",headers:{Accept:"application/json"}});if(!e.ok){a("Error al cargar sitios. Intente nuevamente.");return}const o=await e.json();if(h(),!Array.isArray(o)||!o.every(n=>n.id&&n.lat&&n.lon)){a("Datos de sitios inválidos.");return}v(o)}catch(e){console.error("Fallo al obtener sitios:",e),a("Error al cargar sitios. Intente nuevamente.")}}function m(e=0){window.google&&window.google.maps?u():e<10?setTimeout(()=>m(e+1),300+150*e):a("No se pudo cargar Google Maps. Intente más tarde.")}globalThis.waitForGoogleMapsAndInit=m;function y(){const e=document.getElementById("site-select");e&&(e.addEventListener("mouseover",o=>{const n=o.target.value;if(!n)return;const t=d.find(s=>String(s.id)===n);t&&r.forEach(s=>{s.getTitle()===t.name?s.setIcon("https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png"):s.setIcon("https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png")})}),e.addEventListener("mouseleave",()=>{r.forEach(o=>{o.setIcon("https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png")})}))}(function(){m()})();
