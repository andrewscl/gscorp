import{f}from"../../auth.js";import{n as h}from"../../navigation-handler.js";const t=e=>document.querySelector(e);function k(){const e=t("#createSiteModal");e&&(e.classList.remove("hidden"),e.setAttribute("aria-hidden","false"),document.body.classList.add("no-scroll"),setTimeout(()=>t("#siteName")?.focus(),0))}function d(){const e=t("#createSiteModal");if(!e)return;e.classList.add("hidden"),e.setAttribute("aria-hidden","true"),document.body.classList.remove("no-scroll"),t("#createSiteForm")?.reset();const n=t("#createSiteError"),o=t("#createSiteOk");n&&(n.textContent=""),o&&(o.style.display="none")}async function C(){const e=t("#siteProjectId");if(!(!e||e.querySelectorAll("option").length>1))try{const o=await f("/api/projects/all");if(!o.ok)return;const a=await o.json();e.innerHTML='<option value="" disabled selected>Selecciona un proyectoâ€¦</option>',a.forEach(i=>{const s=document.createElement("option");s.value=String(i.id),s.textContent=i.name,e.appendChild(s)})}catch{}}async function E(){k(),await C()}async function L(e){e.preventDefault();const n=t("#createSiteError"),o=t("#createSiteOk");n&&(n.textContent=""),o&&(o.style.display="none");const a=Number(t("#siteProjectId")?.value),i=t("#siteName")?.value?.trim(),s=t("#siteCode")?.value?.trim()||null,p=t("#siteAddress")?.value?.trim()||null,u=t("#siteLat")?.value?.trim(),m=t("#siteLon")?.value?.trim(),y=t("#siteTz")?.value?.trim()||null,b=!!t("#siteActive")?.checked,v=u?Number(u):null,S=m?Number(m):null;if(!a){n&&(n.textContent="Debes seleccionar un proyecto.");return}if(!i){n&&(n.textContent="El nombre es obligatorio.");return}const c=e.submitter||t('#createSiteForm button[type="submit"]');c&&(c.disabled=!0);try{const r=await f("/api/sites/create",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({projectId:a,name:i,code:s,address:p,lat:v,lon:S,timeZone:y,active:b})});if(!r.ok){let l="";try{l=await r.text()}catch{}throw l||(l=`Error ${r.status}`),new Error(l)}o&&(o.style.display="block"),setTimeout(()=>{d(),h("/private/sites/table-view")},600)}catch(r){n&&(n.textContent=r.message||"No se pudo crear el sitio")}finally{c&&(c.disabled=!1)}}function w(){t("#createSiteBtn")?.addEventListener("click",E),t("#closeCreateSite")?.addEventListener("click",d),t("#cancelCreateSite")?.addEventListener("click",d),t("#createSiteForm")?.addEventListener("submit",L),document.addEventListener("keydown",e=>{e.key==="Escape"&&d()})}(function(){w()})();
