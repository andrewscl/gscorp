import{f}from"../../auth.js";import{n as h}from"../../navigation-handler.js";const t=e=>document.querySelector(e);function C(){const e=t("#createSiteModal");e&&(e.classList.remove("hidden"),e.setAttribute("aria-hidden","false"),document.body.classList.add("no-scroll"),setTimeout(()=>t("#siteName")?.focus(),0))}function d(){const e=t("#createSiteModal");if(!e)return;e.classList.add("hidden"),e.setAttribute("aria-hidden","true"),document.body.classList.remove("no-scroll"),t("#createSiteForm")?.reset();const n=t("#createSiteError"),i=t("#createSiteOk");n&&(n.textContent=""),i&&(i.style.display="none")}async function k(){const e=t("#siteClientId");if(!(!e||e.querySelectorAll("option").length>1))try{const i=await f("/api/clients/all");if(!i.ok)return;const r=await i.json();e.innerHTML='<option value="" disabled selected>Selecciona un clienteâ€¦</option>',r.forEach(o=>{const s=document.createElement("option");s.value=String(o.id),s.textContent=o.name,e.appendChild(s)})}catch{}}async function E(){C(),await k()}async function L(e){e.preventDefault();const n=t("#createSiteError"),i=t("#createSiteOk");n&&(n.textContent=""),i&&(i.style.display="none");const r=Number(t("#siteClientId")?.value),o=t("#siteName")?.value?.trim(),s=t("#siteCode")?.value?.trim()||null,p=t("#siteAddress")?.value?.trim()||null,u=t("#siteLat")?.value?.trim(),m=t("#siteLon")?.value?.trim(),b=t("#siteTz")?.value?.trim()||null,y=!!t("#siteActive")?.checked,v=u?Number(u):null,S=m?Number(m):null;if(!r){n&&(n.textContent="Debes seleccionar un cliente.");return}if(!o){n&&(n.textContent="El nombre es obligatorio.");return}const c=e.submitter||t('#createSiteForm button[type="submit"]');c&&(c.disabled=!0);try{const a=await f("/api/sites/create",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({clientId:r,name:o,code:s,address:p,lat:v,lon:S,timeZone:b,active:y})});if(!a.ok){let l="";try{l=await a.text()}catch{}throw l||(l=`Error ${a.status}`),new Error(l)}i&&(i.style.display="block"),setTimeout(()=>{d(),h("/private/sites/table-view")},600)}catch(a){n&&(n.textContent=a.message||"No se pudo crear el sitio")}finally{c&&(c.disabled=!1)}}function w(){t("#createSiteBtn")?.addEventListener("click",E),t("#closeCreateSite")?.addEventListener("click",d),t("#cancelCreateSite")?.addEventListener("click",d),t("#createSiteForm")?.addEventListener("submit",L),document.addEventListener("keydown",e=>{e.key==="Escape"&&d()})}(function(){w()})();
