import{f as w}from"../../auth.js";const a=t=>document.querySelector(t),m="site-latitude",L="site-longitude",I="site-select",b="site-map",v="site-coordinates-form",h="set-current-location",D="cancel-set-coordinates",E="site-coordinates-error",f="site-coordinates-ok";let l,d;function u(t,e){a(`#${m}`).value=t.toFixed(7),a(`#${L}`).value=e.toFixed(7)}function p(t,e){d?(d.setPosition({lat:t,lng:e}),l.setCenter({lat:t,lng:e})):(d=new google.maps.Marker({position:{lat:t,lng:e},map:l,draggable:!0,title:"Punto de referencia",icon:{url:"https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png"}}),d.addListener("dragend",n=>{u(n.latLng.lat(),n.latLng.lng())}))}function s(t){const e=a(`#${E}`);e&&(e.textContent=t||"");const n=a(`#${f}`);n&&(n.style.display="none")}function _(t){const e=a(`#${f}`);e&&(e.textContent=t,e.style.display=""),s("")}function T(t=-33.45,e=-70.65,n=16){const i=a(`#${b}`);!i||!window.google||!google.maps||(l=new google.maps.Map(i,{center:{lat:t,lng:e},zoom:n,mapTypeId:"roadmap",disableDefaultUI:!0}),l.addListener("click",o=>{u(o.latLng.lat(),o.latLng.lng()),p(o.latLng.lat(),o.latLng.lng())}))}function $(){if(!navigator.geolocation){s("Tu navegador no soporta geolocalización.");return}s("Obteniendo ubicación actual..."),navigator.geolocation.getCurrentPosition(t=>{const e=t.coords.latitude,n=t.coords.longitude;u(e,n),p(e,n),l.setCenter({lat:e,lng:n}),s("")},t=>{s("No se pudo obtener la ubicación actual: "+(t.message||t))},{enableHighAccuracy:!0,timeout:1e4})}function k(t){t&&typeof t.latitude=="number"&&typeof t.longitude=="number"&&(u(t.latitude,t.longitude),p(t.latitude,t.longitude),l.setCenter({lat:t.latitude,lng:t.longitude}))}async function N(t,e){const n=new FormData(t),i={siteId:n.get("siteId"),latitude:n.get("latitude"),longitude:n.get("longitude")};if(!i.siteId||!i.latitude||!i.longitude){s("Completa todos los campos requeridos.");return}try{s("Guardando...");const o=await w(e,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(i),credentials:"same-origin"});if(!o.ok){let r=await o.json().catch(()=>({}));throw new Error(r.error||"Error al guardar coordenadas.")}_("Coordenadas guardadas ✅"),setTimeout(()=>{y()},800)}catch(o){s("No se pudo guardar: "+(o.message||o))}}function S(t){const e=a(`#${I}`);e&&e.addEventListener("change",()=>{const n=e.value;if(!n)return;const i=t.find(o=>String(o.id)===String(n));i&&typeof i.latitude=="number"&&typeof i.longitude=="number"&&k(i)})}function y(){a(`#${m}`).value="",a(`#${L}`).value="",d&&(d.setMap(null),d=null),l&&l.setCenter({lat:-33.45,lng:-70.65}),s("");const t=a(`#${f}`);t&&(t.style.display="none")}async function M(){const t=window.siteList||[],e=a(`#${I}`);let n=-33.45,i=-70.65;t.length&&typeof t[0].latitude=="number"&&typeof t[0].longitude=="number"&&(n=t[0].latitude,i=t[0].longitude),T(n,i),a(`#${h}`)?.addEventListener("click",$),t.length&&e&&S(t);const o=a(`#${v}`);o&&o.addEventListener("submit",g=>{g.preventDefault();const C=o.dataset.endpoint||"/api/sites/set-coordinates";N(o,C)});const r=a(`#${D}`);r&&r.addEventListener("click",g=>{g.preventDefault(),y()})}function c(t=0){window.google&&window.google.maps?M():t<10?setTimeout(()=>c(t+1),300+150*t):s("No se pudo cargar el mapa de Google.")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>c()):c();document.addEventListener("content:loaded",()=>c());
