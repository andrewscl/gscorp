(function(){const f=a=>document.getElementById(a);function i(a,e=!1){const t=f("att-status");t&&(t.textContent=a,t.style.color=e?"#b00020":"#444")}function s(a){a=a.replace(/-/g,"+").replace(/_/g,"/");const e=a.length%4;e&&(a+="=".repeat(4-e));const t=atob(a),n=new Uint8Array(t.length);for(let r=0;r<t.length;r++)n[r]=t.charCodeAt(r);return n.buffer}async function h(){return new Promise((a,e)=>{if(!navigator.geolocation)return e(new Error("Geolocalización no soportada"));navigator.geolocation.getCurrentPosition(t=>a(t),t=>e(new Error(t.message||"No se pudo obtener ubicación")),{enableHighAccuracy:!0,timeout:15e3,maximumAge:0})})}function c(){const a=localStorage.getItem("jwt");return a?{Authorization:"Bearer "+a}:{}}async function m(a){try{i("Generando challenge de registro...");const e=await fetch(a.registerOptions,{method:"POST",headers:{"Content-Type":"application/json",...c()},credentials:"same-origin"});if(!e.ok){i("No se pudo obtener opciones de registro",!0);return}const t=await e.json();let n;if(window.PublicKeyCredential?.parseCreationOptionsFromJSON?n=await navigator.credentials.create({publicKey:PublicKeyCredential.parseCreationOptionsFromJSON(t)}):(t.challenge=s(t.challenge),t.user&&t.user.id&&(t.user.id=s(t.user.id)),n=await navigator.credentials.create({publicKey:t})),i("Verificando passkey..."),!(await fetch(a.registerVerify,{method:"POST",headers:{"Content-Type":"application/json",...c()},credentials:"same-origin",body:JSON.stringify(n.toJSON())})).ok){i("Registro de passkey rechazado",!0);return}i("Passkey registrada correctamente ✅")}catch(e){i("Error registrando passkey: "+e.message,!0)}}async function w(a,e){try{e&&(e.disabled=!0),i("Obteniendo ubicación...");const t=await h(),n=t.coords.latitude,r=t.coords.longitude,O=t.coords.accuracy;i("Solicitando verificación WebAuthn...");const l=await fetch(a.punchOptions,{method:"POST",headers:{"Content-Type":"application/json",...c()},credentials:"same-origin"});if(l.status===412){i('No tienes passkey registrada. Usa "Registrar passkey" y vuelve a intentar.',!0),e&&(e.disabled=!1);return}if(!l.ok){i("No se pudo iniciar la autenticación",!0),e&&(e.disabled=!1);return}const o=await l.json();let u;window.PublicKeyCredential?.parseRequestOptionsFromJSON?u=await navigator.credentials.get({publicKey:PublicKeyCredential.parseRequestOptionsFromJSON(o)}):(o.challenge=s(o.challenge),Array.isArray(o.allowCredentials)&&(o.allowCredentials=o.allowCredentials.map(d=>({...d,id:s(d.id)}))),u=await navigator.credentials.get({publicKey:o})),i("Verificando y registrando asistencia...");const b={assertionJSON:JSON.stringify(u.toJSON()),lat:n,lon:r,accuracy:O},p=await fetch(a.punchVerify,{method:"POST",headers:{"Content-Type":"application/json",...c()},credentials:"same-origin",body:JSON.stringify(b)});if(!p.ok){const d=await p.text();i("Error en marcación: "+d,!0),e&&(e.disabled=!1);return}const y=await p.json(),S=new Date(y.ts).toLocaleTimeString("es-CL",{hour12:!1});i(`Marcación ${y.action} a las ${S} ✅`),setTimeout(()=>e&&(e.disabled=!1),1200)}catch(t){i("Error: "+t.message,!0),e&&(e.disabled=!1)}}function g(){const a=document.getElementById("att-widget"),e=document.getElementById("att-punch"),t=document.getElementById("att-register");if(!a||!e||!t)return;const n={registerOptions:a.dataset.registerOptions||"/passkeys/register/options",registerVerify:a.dataset.registerVerify||"/passkeys/register/verify",punchOptions:a.dataset.punchOptions||"/api/attendance/punch/options",punchVerify:a.dataset.punchVerify||"/api/attendance/punch/verify"};e.addEventListener("click",()=>w(n,e)),t.addEventListener("click",()=>m(n))}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",g):g()})();
