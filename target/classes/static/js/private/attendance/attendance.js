import{f as E}from"../../auth.js";function N(t,n,o){let a=null,i=1/0;for(const e of o){if(typeof e.lat!="number"||typeof e.lon!="number")continue;const s=A(t,n,e.lat,e.lon);s<i&&(i=s,a={...e,distance:s})}return a}let g=[];async function w(){try{const t=await E("/api/attendance/sites",{credentials:"same-origin"});if(!t.ok)throw new Error(`Error cargando sitios: ${t.status}`);g=await t.json()}catch(t){console.error("No se pudo cargar la lista de sitios:",t),g=[]}}function M(){const t=document.getElementById("att-widget");if(!t||t.dataset.attInit==="1")return;t.dataset.attInit="1";const n=document.getElementById("att-status"),o=document.getElementById("att-in"),a=document.getElementById("att-out"),i=t.dataset.punchEndpoint||"/api/attendance/punch",e=(r,l=!1)=>{n&&(n.textContent=r,n.style.color=l?"#b00020":"#444")},s=r=>{o&&(o.disabled=r),a&&(a.disabled=r)},m=()=>location.protocol==="https:"||location.hostname==="localhost"||location.hostname==="127.0.0.1",p=()=>new Promise((r,l)=>{if(!navigator.geolocation)return l(new Error("Geolocalización no soportada"));navigator.geolocation.getCurrentPosition(c=>r(c),c=>l(new Error(c.message||"No se pudo obtener ubicación")),{enableHighAccuracy:!0,timeout:15e3,maximumAge:0})});async function b(r){const l=String(r).toUpperCase()==="OUT"?"OUT":"IN";try{if(s(!0),!m()){e("Activa HTTPS (o usa localhost) para solicitar ubicación en móviles.",!0);return}e("Obteniendo ubicación...");const c=await p();if(!g.length&&(e("Cargando sitios, por favor espera...",!0),await w(),!g.length)){e("No se pudo cargar la lista de sitios.",!0),s(!1);return}const d=N(c.coords.latitude,c.coords.longitude,g);if(!d||d.distance>35){e(`No puede marcar asistencia: está a ${d?d.distance.toFixed(1):"N/A"} metros del sitio más cercano (máx 35m).`,!0),s(!1);return}e(`Marcando asistencia en el sitio: ${d.name}`);const C={action:l,lat:c.coords.latitude,lon:c.coords.longitude,accuracy:c.coords.accuracy,siteId:d.id};e("Registrando asistencia...");const I=new AbortController,S=setTimeout(()=>I.abort("timeout"),2e4),u=await E(i,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(C),signal:I.signal,credentials:"same-origin"}).finally(()=>clearTimeout(S));if(!u.ok){let f=`Error ${u.status}`;try{const h=await u.json();h?.error&&(f=h.error+(h.details?`: ${h.details}`:""))}catch{try{f=await u.text()||f}catch{}}throw new Error(f)}const y=await u.json().catch(()=>({})),v=y.ts?new Date(y.ts).toLocaleTimeString("es-CL",{hour12:!1}):"",T=typeof y.distanceMeters=="number"?`${y.distanceMeters} metros`:"";e(`Marcación registrada correctamente${v?" a las "+v:""}${T?" a "+T:""}. ✅`),L()}catch(c){e("Error en marcación: "+(c?.message||"desconocido"),!0)}finally{s(!1)}}o?.addEventListener("click",()=>b("IN")),a?.addEventListener("click",()=>b("OUT")),L(),O()}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",async()=>{await w(),M()}):w().then(M);document.addEventListener("content:loaded",async()=>{await w(),M()});async function L(){const t=document.getElementById("att-in"),n=document.getElementById("att-out");try{const o=await E("/api/attendance/last-punch",{credentials:"same-origin"});if(!o.ok){t.style.display="",n.style.display="none";return}const a=await o.json(),i=a.action?a.action.toUpperCase():null;!i||i==="OUT"?(t.style.display="",n.style.display="none"):i==="IN"&&(t.style.display="none",n.style.display="")}catch{t.style.display="",n.style.display="none"}}function O(){const t=document.getElementById("att-map");if(t){if(t._google_map&&(t._google_map=null,t.innerHTML=""),!navigator.geolocation){t.innerHTML="<div style='padding:1em;text-align:center;color:#888'>Geolocalización no soportada</div>";return}navigator.geolocation.getCurrentPosition(n=>{const o=n.coords.latitude,a=n.coords.longitude;if(window.google&&window.google.maps){const i=new google.maps.Map(t,{center:{lat:o,lng:a},zoom:17,mapTypeId:"roadmap",disableDefaultUI:!0});new google.maps.Marker({position:{lat:o,lng:a},map:i}),t._google_map=i}else t.innerHTML="<div style='padding:1em;text-align:center;color:#888'>Google Maps no cargado</div>"},n=>{t.innerHTML=`<div style='padding:1em;text-align:center;color:#b00020'>No se pudo obtener ubicación.<br>${n.message}</div>`},{enableHighAccuracy:!0,timeout:1e4})}}function A(t,n,o,a){const e=r=>r*Math.PI/180,s=e(o-t),m=e(a-n),p=Math.sin(s/2)*Math.sin(s/2)+Math.cos(e(t))*Math.cos(e(o))*Math.sin(m/2)*Math.sin(m/2);return 6371e3*(2*Math.atan2(Math.sqrt(p),Math.sqrt(1-p)))}
