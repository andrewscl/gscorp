import{f as C}from"../../auth.js";function p(){const r=document.getElementById("att-widget");if(!r||r.dataset.attInit==="1")return;r.dataset.attInit="1";const u=document.getElementById("att-status"),o=document.getElementById("att-in"),a=document.getElementById("att-out"),E=r.dataset.punchEndpoint||"/api/attendance/punch",i=document.getElementById("att-map");function m(){if(i){if(!navigator.geolocation){i.innerHTML="<div style='padding:1em;text-align:center;color:#888'>Geolocalización no soportada</div>";return}navigator.geolocation.getCurrentPosition(t=>{const e=t.coords.latitude,n=t.coords.longitude;if(window.google&&window.google.maps){const g=new google.maps.Map(i,{center:{lat:e,lng:n},zoom:17,mapTypeId:"roadmap",disableDefaultUI:!0});new google.maps.Marker({position:{lat:e,lng:n},map:g})}else i.innerHTML="<div style='padding:1em;text-align:center;color:#888'>Google Maps no cargado</div>"},t=>{i.innerHTML=`<div style='padding:1em;text-align:center;color:#b00020'>No se pudo obtener ubicación.<br>${t.message}</div>`},{enableHighAccuracy:!0,timeout:1e4})}}m();const s=(t,e=!1)=>{u&&(u.textContent=t,u.style.color=e?"#b00020":"#444")},y=t=>{o&&(o.disabled=t),a&&(a.disabled=t)},T=()=>location.protocol==="https:"||location.hostname==="localhost"||location.hostname==="127.0.0.1",I=()=>new Promise((t,e)=>{if(!navigator.geolocation)return e(new Error("Geolocalización no soportada"));navigator.geolocation.getCurrentPosition(n=>t(n),n=>e(new Error(n.message||"No se pudo obtener ubicación")),{enableHighAccuracy:!0,timeout:15e3,maximumAge:0})});async function f(t){const e=String(t).toUpperCase()==="OUT"?"OUT":"IN";try{if(y(!0),!T()){s("Activa HTTPS (o usa localhost) para solicitar ubicación en móviles.",!0);return}s("Obteniendo ubicación...");const n=await I(),g={action:e,lat:n.coords.latitude,lon:n.coords.longitude,accuracy:n.coords.accuracy};s("Registrando asistencia...");const w=new AbortController,L=setTimeout(()=>w.abort("timeout"),2e4),c=await C(E,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(g),signal:w.signal,credentials:"same-origin"}).finally(()=>clearTimeout(L));if(!c.ok){let l=`Error ${c.status}`;try{const d=await c.json();d?.error&&(l=d.error+(d.details?`: ${d.details}`:""))}catch{try{l=await c.text()||l}catch{}}throw new Error(l)}const b=await c.json().catch(()=>({})),v=b.ts?new Date(b.ts).toLocaleTimeString("es-CL",{hour12:!1}):"";s(`Marcación ${e==="IN"?"de entrada":"de salida"}${v?" a las "+v:""} ✅`),m(),h()}catch(n){s("Error en marcación: "+(n?.message||"desconocido"),!0)}finally{y(!1)}}async function h(){try{const t=await fetch("/api/attendance/last-punch",{credentials:"same-origin"});if(!t.ok)return;const e=await t.json();!e||e.action==="OUT"?(o.style.display="",a.style.display="none"):e.action==="IN"&&(o.style.display="none",a.style.display="")}catch{o.style.display="",a.style.display=""}}o?.addEventListener("click",()=>f("IN")),a?.addEventListener("click",()=>f("OUT")),h()}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",p):p();document.addEventListener("content:loaded",p);
