import{f as O}from"../../auth.js";function f(){const t=document.getElementById("att-widget");if(!t||t.dataset.attInit==="1")return;t.dataset.attInit="1";const e=document.getElementById("att-status"),n=document.getElementById("att-in"),o=document.getElementById("att-out"),c=t.dataset.punchEndpoint||"/api/attendance/punch",a=(i,l=!1)=>{e&&(e.textContent=i,e.style.color=l?"#b00020":"#444")},r=i=>{n&&(n.disabled=i),o&&(o.disabled=i)},u=()=>location.protocol==="https:"||location.hostname==="localhost"||location.hostname==="127.0.0.1",g=()=>new Promise((i,l)=>{if(!navigator.geolocation)return l(new Error("Geolocalización no soportada"));navigator.geolocation.getCurrentPosition(s=>i(s),s=>l(new Error(s.message||"No se pudo obtener ubicación")),{enableHighAccuracy:!0,timeout:15e3,maximumAge:0})});async function h(i){const l=String(i).toUpperCase()==="OUT"?"OUT":"IN";try{if(r(!0),!u()){a("Activa HTTPS (o usa localhost) para solicitar ubicación en móviles.",!0);return}a("Obteniendo ubicación...");const s=await g(),I=parseFloat(t.dataset.siteLat),v=parseFloat(t.dataset.siteLon),b=A(s.coords.latitude,s.coords.longitude,I,v);if(b>35){a(`No puede marcar asistencia: está a ${b.toFixed(1)} metros del sitio (máx 35m).`,!0),r(!1);return}const T={action:l,lat:s.coords.latitude,lon:s.coords.longitude,accuracy:s.coords.accuracy};a("Registrando asistencia...");const M=new AbortController,C=setTimeout(()=>M.abort("timeout"),2e4),d=await O(c,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(T),signal:M.signal,credentials:"same-origin"}).finally(()=>clearTimeout(C));if(!d.ok){let p=`Error ${d.status}`;try{const y=await d.json();y?.error&&(p=y.error+(y.details?`: ${y.details}`:""))}catch{try{p=await d.text()||p}catch{}}throw new Error(p)}const m=await d.json().catch(()=>({})),w=m.ts?new Date(m.ts).toLocaleTimeString("es-CL",{hour12:!1}):"",E=typeof m.distanceMeters=="number"?`${m.distanceMeters} metros`:"";a(`Marcación registrada correctamente${w?" a las "+w:""}${E?" a "+E:""}. ✅`),L()}catch(s){a("Error en marcación: "+(s?.message||"desconocido"),!0)}finally{r(!1)}}n?.addEventListener("click",()=>h("IN")),o?.addEventListener("click",()=>h("OUT")),L(),x()}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",f):f();document.addEventListener("content:loaded",f);async function L(){const t=document.getElementById("att-in"),e=document.getElementById("att-out");try{const n=await fetch("/api/attendance/last-punch",{credentials:"same-origin"});if(!n.ok){t.style.display="",e.style.display="none";return}const o=await n.json(),c=o.action?o.action.toUpperCase():null;!c||c==="OUT"?(t.style.display="",e.style.display="none"):c==="IN"&&(t.style.display="none",e.style.display="")}catch{t.style.display="",e.style.display="none"}}function x(){const t=document.getElementById("att-map");if(t){if(t._google_map&&(t._google_map=null,t.innerHTML=""),!navigator.geolocation){t.innerHTML="<div style='padding:1em;text-align:center;color:#888'>Geolocalización no soportada</div>";return}navigator.geolocation.getCurrentPosition(e=>{const n=e.coords.latitude,o=e.coords.longitude;if(window.google&&window.google.maps){const c=new google.maps.Map(t,{center:{lat:n,lng:o},zoom:17,mapTypeId:"roadmap",disableDefaultUI:!0});new google.maps.Marker({position:{lat:n,lng:o},map:c}),t._google_map=c}else t.innerHTML="<div style='padding:1em;text-align:center;color:#888'>Google Maps no cargado</div>"},e=>{t.innerHTML=`<div style='padding:1em;text-align:center;color:#b00020'>No se pudo obtener ubicación.<br>${e.message}</div>`},{enableHighAccuracy:!0,timeout:1e4})}}function A(t,e,n,o){const a=i=>i*Math.PI/180,r=a(n-t),u=a(o-e),g=Math.sin(r/2)*Math.sin(r/2)+Math.cos(a(t))*Math.cos(a(n))*Math.sin(u/2)*Math.sin(u/2);return 6371e3*(2*Math.atan2(Math.sqrt(g),Math.sqrt(1-g)))}
