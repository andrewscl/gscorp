import{f as T}from"../../auth.js";function u(){const t=document.getElementById("att-widget");if(!t||t.dataset.attInit==="1")return;t.dataset.attInit="1";const n=document.getElementById("att-status"),i=document.getElementById("att-in"),o=document.getElementById("att-out"),h=t.dataset.punchEndpoint||"/api/attendance/punch",c=(a,s=!1)=>{n&&(n.textContent=a,n.style.color=s?"#b00020":"#444")},y=a=>{i&&(i.disabled=a),o&&(o.disabled=a)},b=()=>location.protocol==="https:"||location.hostname==="localhost"||location.hostname==="127.0.0.1",E=()=>new Promise((a,s)=>{if(!navigator.geolocation)return s(new Error("Geolocalización no soportada"));navigator.geolocation.getCurrentPosition(e=>a(e),e=>s(new Error(e.message||"No se pudo obtener ubicación")),{enableHighAccuracy:!0,timeout:15e3,maximumAge:0})});async function m(a){const s=String(a).toUpperCase()==="OUT"?"OUT":"IN";try{if(y(!0),!b()){c("Activa HTTPS (o usa localhost) para solicitar ubicación en móviles.",!0);return}c("Obteniendo ubicación...");const e=await E(),w={action:s,lat:e.coords.latitude,lon:e.coords.longitude,accuracy:e.coords.accuracy};c("Registrando asistencia...");const p=new AbortController,I=setTimeout(()=>p.abort("timeout"),2e4),r=await T(h,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(w),signal:p.signal,credentials:"same-origin"}).finally(()=>clearTimeout(I));if(!r.ok){let l=`Error ${r.status}`;try{const d=await r.json();d?.error&&(l=d.error+(d.details?`: ${d.details}`:""))}catch{try{l=await r.text()||l}catch{}}throw new Error(l)}const g=await r.json().catch(()=>({})),f=g.ts?new Date(g.ts).toLocaleTimeString("es-CL",{hour12:!1}):"";c(`Marcación ${s==="IN"?"de entrada":"de salida"}${f?" a las "+f:""} ✅`)}catch(e){c("Error en marcación: "+(e?.message||"desconocido"),!0)}finally{y(!1)}}i?.addEventListener("click",()=>m("IN")),o?.addEventListener("click",()=>m("OUT")),O()}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",u):u();document.addEventListener("content:loaded",u);async function O(){const t=document.getElementById("att-in"),n=document.getElementById("att-out");try{const i=await fetch("/api/attendance/last-punch",{credentials:"same-origin"});if(!i.ok){t.style.display="",n.style.display="none";return}const o=await i.json();!o||o.action==="OUT"?(t.style.display="",n.style.display="none"):o.action==="IN"&&(t.style.display="none",n.style.display="")}catch{t.style.display="",n.style.display="none"}}
