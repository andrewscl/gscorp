import{f as T}from"../../auth.js";function u(){const i=document.getElementById("att-widget");if(!i||i.dataset.attInit==="1")return;i.dataset.attInit="1";const r=document.getElementById("att-status"),d=document.getElementById("att-in"),l=document.getElementById("att-out"),y=i.dataset.punchEndpoint||"/api/attendance/punch",n=(e,o=!1)=>{r&&(r.textContent=e,r.style.color=o?"#b00020":"#444")},m=e=>{d&&(d.disabled=e),l&&(l.disabled=e)},b=()=>location.protocol==="https:"||location.hostname==="localhost"||location.hostname==="127.0.0.1",E=()=>new Promise((e,o)=>{if(!navigator.geolocation)return o(new Error("Geolocalización no soportada"));navigator.geolocation.getCurrentPosition(t=>e(t),t=>o(new Error(t.message||"No se pudo obtener ubicación")),{enableHighAccuracy:!0,timeout:15e3,maximumAge:0})});async function g(e){const o=String(e).toUpperCase()==="OUT"?"OUT":"IN";try{if(m(!0),!b()){n("Activa HTTPS (o usa localhost) para solicitar ubicación en móviles.",!0);return}n("Obteniendo ubicación...");const t=await E(),w={action:o,lat:t.coords.latitude,lon:t.coords.longitude,accuracy:t.coords.accuracy};n("Registrando asistencia...");const p=new AbortController,I=setTimeout(()=>p.abort("timeout"),2e4),a=await T(y,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(w),signal:p.signal,credentials:"same-origin"}).finally(()=>clearTimeout(I));if(!a.ok){let c=`Error ${a.status}`;try{const s=await a.json();s?.error&&(c=s.error+(s.details?`: ${s.details}`:""))}catch{try{c=await a.text()||c}catch{}}throw new Error(c)}const h=await a.json().catch(()=>({})),f=h.ts?new Date(h.ts).toLocaleTimeString("es-CL",{hour12:!1}):"";n(`Marcación ${o==="IN"?"de entrada":"de salida"}${f?" a las "+f:""} ✅`)}catch(t){n("Error en marcación: "+(t?.message||"desconocido"),!0)}finally{m(!1)}}d?.addEventListener("click",()=>g("IN")),l?.addEventListener("click",()=>g("OUT"))}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",u):u();document.addEventListener("content:loaded",u);
