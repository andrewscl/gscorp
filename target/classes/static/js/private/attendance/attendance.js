import{f as y}from"../../auth.js";(function(){const i=t=>document.getElementById(t),u=document.getElementById("att-widget");if(!u)return;const c=i("att-status"),s=i("att-in"),r=i("att-out"),m=u.dataset.punchEndpoint||"/api/attendance/punch";function o(t,n=!1){c&&(c.textContent=t,c.style.color=n?"#b00020":"#444")}function d(t){s&&(s.disabled=t),r&&(r.disabled=t)}function h(){return new Promise((t,n)=>{if(!navigator.geolocation)return n(new Error("Geolocalización no soportada"));navigator.geolocation.getCurrentPosition(e=>t(e),e=>n(new Error(e.message||"No se pudo obtener ubicación")),{enableHighAccuracy:!0,timeout:15e3,maximumAge:0})})}async function l(t){try{d(!0),o("Obteniendo ubicación...");const n=await h(),e={action:t,lat:n.coords.latitude,lon:n.coords.longitude,accuracy:n.coords.accuracy};o("Registrando asistencia...");const a=await y(m,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"same-origin",body:JSON.stringify(e)});if(!a.ok){const p=await a.text().catch(()=>"");throw new Error(p||`Error ${a.status}`)}const g=await a.json().catch(()=>({})),f=g.ts?new Date(g.ts).toLocaleTimeString("es-CL",{hour12:!1}):"";o(`Marcación ${t==="IN"?"de entrada":"de salida"} ${f?"a las "+f:""} ✅`)}catch(n){o("Error en marcación: "+n.message,!0)}finally{d(!1)}}s?.addEventListener("click",()=>l("IN")),r?.addEventListener("click",()=>l("OUT"))})();
