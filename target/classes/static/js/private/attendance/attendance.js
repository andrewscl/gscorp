import{f as C}from"../../auth.js";function O(t,e,n){let o=null,i=1/0;for(const s of n){if(typeof s.lat!="number"||typeof s.lon!="number")continue;const a=A(t,e,s.lat,s.lon);a<i&&(i=a,o={...s,distance:a})}return o}function b(){const t=document.getElementById("att-widget");if(!t||t.dataset.attInit==="1")return;t.dataset.attInit="1";const e=document.getElementById("att-status"),n=document.getElementById("att-in"),o=document.getElementById("att-out"),i=t.dataset.punchEndpoint||"/api/attendance/punch",s=window.attendanceSites||[],a=(r,d=!1)=>{e&&(e.textContent=r,e.style.color=d?"#b00020":"#444")},l=r=>{n&&(n.disabled=r),o&&(o.disabled=r)},g=()=>location.protocol==="https:"||location.hostname==="localhost"||location.hostname==="127.0.0.1",w=()=>new Promise((r,d)=>{if(!navigator.geolocation)return d(new Error("Geolocalización no soportada"));navigator.geolocation.getCurrentPosition(c=>r(c),c=>d(new Error(c.message||"No se pudo obtener ubicación")),{enableHighAccuracy:!0,timeout:15e3,maximumAge:0})});async function p(r){const d=String(r).toUpperCase()==="OUT"?"OUT":"IN";try{if(l(!0),!g()){a("Activa HTTPS (o usa localhost) para solicitar ubicación en móviles.",!0);return}a("Obteniendo ubicación...");const c=await w(),u=O(c.coords.latitude,c.coords.longitude,s);if(!u||u.distance>35){a(`No puede marcar asistencia: está a ${u?u.distance.toFixed(1):"N/A"} metros del sitio más cercano (máx 35m).`,!0),l(!1);return}a(`Marcando asistencia en el sitio: ${u.name}`);const T={action:d,lat:c.coords.latitude,lon:c.coords.longitude,accuracy:c.coords.accuracy,siteId:u.id};a("Registrando asistencia...");const M=new AbortController,L=setTimeout(()=>M.abort("timeout"),2e4),m=await C(i,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(T),signal:M.signal,credentials:"same-origin"}).finally(()=>clearTimeout(L));if(!m.ok){let f=`Error ${m.status}`;try{const h=await m.json();h?.error&&(f=h.error+(h.details?`: ${h.details}`:""))}catch{try{f=await m.text()||f}catch{}}throw new Error(f)}const y=await m.json().catch(()=>({})),I=y.ts?new Date(y.ts).toLocaleTimeString("es-CL",{hour12:!1}):"",E=typeof y.distanceMeters=="number"?`${y.distanceMeters} metros`:"";a(`Marcación registrada correctamente${I?" a las "+I:""}${E?" a "+E:""}. ✅`),v()}catch(c){a("Error en marcación: "+(c?.message||"desconocido"),!0)}finally{l(!1)}}n?.addEventListener("click",()=>p("IN")),o?.addEventListener("click",()=>p("OUT")),v(),S()}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",b):b();document.addEventListener("content:loaded",b);async function v(){const t=document.getElementById("att-in"),e=document.getElementById("att-out");try{const n=await fetch("/api/attendance/last-punch",{credentials:"same-origin"});if(!n.ok){t.style.display="",e.style.display="none";return}const o=await n.json(),i=o.action?o.action.toUpperCase():null;!i||i==="OUT"?(t.style.display="",e.style.display="none"):i==="IN"&&(t.style.display="none",e.style.display="")}catch{t.style.display="",e.style.display="none"}}function S(){const t=document.getElementById("att-map");if(t){if(t._google_map&&(t._google_map=null,t.innerHTML=""),!navigator.geolocation){t.innerHTML="<div style='padding:1em;text-align:center;color:#888'>Geolocalización no soportada</div>";return}navigator.geolocation.getCurrentPosition(e=>{const n=e.coords.latitude,o=e.coords.longitude;if(window.google&&window.google.maps){const i=new google.maps.Map(t,{center:{lat:n,lng:o},zoom:17,mapTypeId:"roadmap",disableDefaultUI:!0});new google.maps.Marker({position:{lat:n,lng:o},map:i}),t._google_map=i}else t.innerHTML="<div style='padding:1em;text-align:center;color:#888'>Google Maps no cargado</div>"},e=>{t.innerHTML=`<div style='padding:1em;text-align:center;color:#b00020'>No se pudo obtener ubicación.<br>${e.message}</div>`},{enableHighAccuracy:!0,timeout:1e4})}}function A(t,e,n,o){const s=p=>p*Math.PI/180,a=s(n-t),l=s(o-e),g=Math.sin(a/2)*Math.sin(a/2)+Math.cos(s(t))*Math.cos(s(n))*Math.sin(l/2)*Math.sin(l/2);return 6371e3*(2*Math.atan2(Math.sqrt(g),Math.sqrt(1-g)))}
