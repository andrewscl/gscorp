import{f as T}from"../../auth.js";import{n as y}from"../../navigation-handler.js";const c=(t,n=document)=>n.querySelector(t),E="/private/attendance/table-search",w="/private/attendance/table-view";function p(t){const n=t||c(".attendance-table tbody");if(!n)return;const a=n.querySelector(".empty")?0:n.querySelectorAll("tr").length,e=c(".attendance-header .attendance-count")||c(".attendance-count");e&&(e.textContent=`${a} registro${a===1?"":"s"}`)}let m=null,h=null;function D(){S();const t=c(".attendance-table tbody"),n=c(".attendance-table-container");t&&(p(t),m=new MutationObserver(o=>{let a=!1;for(const e of o)if(e.type==="childList"&&(e.addedNodes.length||e.removedNodes.length)){a=!0;break}a&&p(t)}),m.observe(t,{childList:!0,subtree:!1})),n&&(h=new MutationObserver(o=>{let a=!1;for(const e of o){if(e.type==="childList"&&(e.addedNodes.length||e.removedNodes.length)){for(const r of[...e.addedNodes,...e.removedNodes])if(r.nodeName&&r.nodeName.toLowerCase()==="tbody"){a=!0;break}}if(a)break}a&&setTimeout(()=>D(),50)}),h.observe(n,{childList:!0,subtree:!0}))}function S(){try{m&&(m.disconnect(),m=null),h&&(h.disconnect(),h=null)}catch{}}function A(){const t=c(".attendance-table-container");!t||t.__attendanceDeleg||(t.__attendanceDeleg=!0,t.addEventListener("click",n=>{const o=n.target.closest(".action-btn, a[data-path], button[data-path]");if(!o)return;const a=o.dataset.path||o.getAttribute("href");a&&(n.preventDefault(),y(a,!0))}))}async function N({baseUrl:t,from:n,to:o,clientTz:a,applyBtn:e}){const r=new URLSearchParams;n&&r.set("from",n),o&&r.set("to",o),a&&r.set("clientTz",a);const s=t+(r.toString()?`?${r.toString()}`:"");e&&(e.disabled=!0,e.classList.add("is-loading"));try{const i=await T(s,{method:"GET",credentials:"same-origin",headers:{Accept:"text/html","X-Requested-With":"XMLHttpRequest"}});if(!i.ok){if(i.status===401||i.status===302){y("/login",!0);return}const b=await i.text().catch(()=>"");throw new Error(b||`HTTP ${i.status}`)}const l=await i.text(),d=document.createElement("div");d.innerHTML="<table>"+l.trim()+"</table>";const u=d.querySelector(".header-meta");let f=d.querySelector("tbody");if(!f){const b=d.querySelectorAll("tr");f=document.createElement("tbody"),b.forEach(L=>f.appendChild(L))}const g=c(".attendance-table tbody");if(!g){y(w,!0);return}if(g.innerHTML=f.innerHTML,u){const b=c(".attendance-header .header-meta");b&&b.replaceWith(u)}p(g)}finally{e&&(e.disabled=!1,e.classList.remove("is-loading"))}}function _(){const t=c("#applyFiltersBtn"),n=c("#filter-from"),o=c("#filter-to");!t||!n||!o||(t.hasAttribute("type")||t.setAttribute("type","button"),t.addEventListener("click",async a=>{a.preventDefault();let e=n.value||"",r=o.value||"";if(!e&&!r){y(w,!0);return}!e&&r&&(e=r),!r&&e&&(r=e);try{const l=new Date(e),d=new Date(r);!isNaN(l)&&!isNaN(d)&&l>d&&([e,r]=[r,e])}catch{}let s="";try{s=Intl.DateTimeFormat().resolvedOptions().timeZone||""}catch{s=""}const i=t.dataset.ajaxUrl||t.dataset.path||E;try{await N({baseUrl:i,from:e,to:r,clientTz:s,applyBtn:t})}catch(l){console.error("[attendance] error fetching rows",l);const d=document.getElementById("attendanceSearchError")||(()=>{const u=document.createElement("div");u.id="attendanceSearchError",u.className="error";const f=c(".attendance-header");return f?f.insertAdjacentElement("afterend",u):document.body.prepend(u),u})();d.textContent=l.message||"Error al obtener resultados."}}))}function v(t){const n=t.getFullYear(),o=String(t.getMonth()+1).padStart(2,"0"),a=String(t.getDate()).padStart(2,"0");return`${n}-${o}-${a}`}function k(){const t=c(".quick-range");t&&t.addEventListener("click",n=>{const o=n.target.closest("button[data-range]");if(!o)return;const a=o.dataset.range,e=c("#filter-from"),r=c("#filter-to");if(!e||!r)return;const s=new Date;let i=new Date(s),l=new Date(s);if(a!=="today")if(a==="week"){const u=s.getDay(),f=u===0?-6:1-u;i.setDate(s.getDate()+f)}else a==="month"&&(i=new Date(s.getFullYear(),s.getMonth(),1));e.value=v(i),r.value=v(l);const d=c("#applyFiltersBtn");d&&d.click()})}(function(){try{A(),_(),k(),D()}catch(n){console.error("[attendance] init failed",n)}})();
