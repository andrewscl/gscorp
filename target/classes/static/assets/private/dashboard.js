import{i as f}from"../chunks/echarts-setup-BOxioT3i.js";async function h(a,e={}){const o=localStorage.getItem("jwt"),n=new Headers(e.headers||{});n.has("Accept")||n.set("Accept","application/json"),o&&n.set("Authorization",`Bearer ${o}`);const s={credentials:e.credentials??"same-origin",...e,headers:n},c=await fetch(a,s);if(c.status===401){localStorage.removeItem("jwt");try{sessionStorage.setItem("postLoginTarget",location.pathname+location.search+location.hash)}catch{}return window.location.href="/auth/signin",new Response(null,{status:401})}return c}async function y(a,e,o){const n=a.querySelector("#chart-att");if(!n){console.warn("[attendance chart] #chart-att no existe");return}let s=[];try{const t=await h(`/api/attendance/series?from=${e}&to=${o}&action=IN`);t.ok?s=await t.json():console.warn("[attendance chart] API status:",t.status,await t.text().catch(()=>""))}catch(t){console.warn("[attendance chart] fetch error",t)}const c=s.map(t=>t.x),r=s.map(t=>t.y),l=r.some(t=>Number(t)>0),i=f(n,void 0,{renderer:"canvas"});i.setOption({tooltip:{trigger:"axis"},legend:{show:!0},grid:{left:40,right:16,top:24,bottom:32},xAxis:{type:"category",boundaryGap:!1,data:c},yAxis:{type:"value"},series:[{name:"Entradas",type:"line",smooth:!0,areaStyle:{},data:r,color:"#2563eb"}],graphic:l?{elements:[]}:{elements:[{type:"text",left:"center",top:"middle",style:{text:"Sin datos",fill:"#9ca3af",fontSize:14}}]}});const d=new ResizeObserver(()=>i.resize());d.observe(n);const u=()=>{document.removeEventListener("fragment:will-unload",u);try{d.disconnect()}catch{}try{i.dispose()}catch{}};document.addEventListener("fragment:will-unload",u,{once:!0})}async function w(a,e,o){const n=a.querySelector("#chart-inc");if(!n){console.warn("[incidents chart] #chart-inc no existe");return}let s=[];try{const t=await h(`/api/incidents/series?from=${e}&to=${o}`);t.ok?s=await t.json():console.warn("[incidents chart] API status:",t.status,await t.text().catch(()=>""))}catch(t){console.warn("[incidents chart] fetch error",t)}const c=s.map(t=>t.x),r=s.map(t=>t.y),l=r.some(t=>Number(t)>0),i=f(n,void 0,{renderer:"canvas"});i.setOption({tooltip:{trigger:"axis"},legend:{show:!0},grid:{left:40,right:16,top:24,bottom:32},xAxis:{type:"category",boundaryGap:!1,data:c},yAxis:{type:"value"},series:[{name:"Incidentes",type:"bar",data:r,color:"#f43f5e"}],graphic:l?{elements:[]}:{elements:[{type:"text",left:"center",top:"middle",style:{text:"Sin datos",fill:"#9ca3af",fontSize:14}}]}});const d=new ResizeObserver(()=>i.resize());d.observe(n);const u=()=>{document.removeEventListener("fragment:will-unload",u);try{d.disconnect()}catch{}try{i.dispose()}catch{}};document.addEventListener("fragment:will-unload",u,{once:!0})}async function m(a,e,o){const n={att:`/api/attendance/kpi?from=${e}&to=${o}`,patrol:`/api/patrols/kpi?from=${e}&to=${o}`,visit:`/api/site-supervision-visits/kpi?from=${e}&to=${o}`,inc:`/api/incidents/kpi?from=${e}&to=${o}`};await Promise.all(Object.entries(n).map(async([s,c])=>{const r=a.querySelector(`[data-kpi="${s}"]`);if(r)try{const l=await h(c);if(!l.ok)throw new Error;const i=await l.text();r.textContent=i||"0"}catch{r.textContent="â€“"}}))}function g(a=new Date){return`${a.getFullYear()}-${String(a.getMonth()+1).padStart(2,"0")}`}function v(a){const[e,o]=a.split("-").map(Number),n=new Date(e,o,0);return`${a}-${String(n.getDate()).padStart(2,"0")}`}async function x({container:a}){const e=a.querySelector("#client-dashboard-root")||a;if(e.dataset.echartsInit==="1")return;e.dataset.echartsInit="1";const o=g(),n=`${o}-01`,s=v(o);typeof m=="function"&&await m(e,n,s),await Promise.all([y(e,n,s),w(e,n,s)])}function p(){const a=document.getElementById("client-dashboard-root")||document.body;x({container:a})}document.addEventListener("content:loaded",p);document.readyState==="loading"?document.addEventListener("DOMContentLoaded",p):p();
