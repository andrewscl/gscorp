import{i as N,f as I}from"../chunks/api-Bh71dfFu.js";async function _(s,r,d,g,x,$){const v=s.querySelector(g);if(!v)return console.warn(`[hourly metric] ${g} no existe`),null;const h=Array.from({length:24},(f,m)=>String(m).padStart(2,"0")),S="#3b82f6",y="#60a5fa",u=N(v,void 0,{renderer:"canvas"}),c=h.map(()=>0);u.setOption({tooltip:{trigger:"axis"},legend:{top:6},grid:{left:40,right:16,top:36,bottom:28},xAxis:{type:"category",data:h,axisLabel:{formatter:f=>f+"h"}},yAxis:{type:"value",minInterval:1},series:[{name:`${d} (real)`,type:"bar",data:c,itemStyle:{color:S}},{name:`${d} (forecast)`,type:"line",smooth:!0,data:c,lineStyle:{type:"dashed",color:y},symbol:"circle",symbolSize:6}],graphic:{elements:[{type:"text",left:"center",top:"middle",style:{text:"Cargando...",fill:"#9ca3af",fontSize:14}}]},toolbox:{show:!0,feature:{saveAsImage:{}}}});function p(f){const m=new Map((f||[]).map(e=>[String(e.hour).padStart(2,"0"),e])),t=h.map(e=>Number((m.get(e)&&m.get(e)[r])??0)),n=h.map(e=>Number((m.get(e)&&m.get(e)[r+"Forecast"])??0)),w=t.some(e=>e>0)||n.some(e=>e>0);u.setOption({xAxis:{data:h},series:[{name:`${d} (real)`,type:"bar",data:t,itemStyle:{color:S}},{name:`${d} (forecast)`,type:"line",smooth:!0,data:n,lineStyle:{type:"dashed",color:y},symbol:"circle",symbolSize:6}],graphic:w?{elements:[]}:{elements:[{type:"text",left:"center",top:"middle",style:{text:"Sin datos",fill:"#9ca3af",fontSize:14}}]}})}const o=new ResizeObserver(()=>u.resize());o.observe(v);function l(){try{o.disconnect()}catch{}try{u.dispose()}catch{}try{document.removeEventListener("fragment:will-unload",b)}catch{}}const b=()=>{document.removeEventListener("fragment:will-unload",b),l()};return document.addEventListener("fragment:will-unload",b,{once:!0}),u.__hourly_metric_cleanup=l,{chart:u,refresh:f=>p(f),destroy:l}}async function O(s,r,d){const g=d?.refreshMs,x=await _(s,"attendance","Asistencias","#chart-hourly-attendance"),$=await _(s,"rounds","Rondas","#chart-hourly-rounds"),v=await _(s,"visits","Visitas","#chart-hourly-visits"),h=o=>{x&&x.refresh(o),$&&$.refresh(o),v&&v.refresh(o)};let S="UTC";try{S=Intl.DateTimeFormat().resolvedOptions().timeZone||"UTC"}catch{}async function y(o){const l=o?`?date=${encodeURIComponent(o)}&tz=${encodeURIComponent(S)}`:`?tz=${encodeURIComponent(S)}`,b=`/api/attendance/hourly${l}`,E=`/api/patrols-runs/hourly${l}`,f=`/api/site-supervision-visits/hourly${l}`;try{const[m,t,n]=await Promise.all([I(b),I(E),I(f)]),w=m.ok?await m.json().catch(()=>[]):[],e=t.ok?await t.json().catch(()=>[]):[],a=n.ok?await n.json().catch(()=>[]):[],A=new Map(w.map(i=>[String(i.hour).padStart(2,"0"),i])),C=new Map(e.map(i=>[String(i.hour).padStart(2,"0"),i])),M=new Map(a.map(i=>[String(i.hour).padStart(2,"0"),i]));return Array.from({length:24},(i,z)=>String(z).padStart(2,"0")).map(i=>({hour:i,attendance:Number(A.get(i)?.count??A.get(i)?.cnt??0),attendanceForecast:Number(A.get(i)?.forecast??0),rounds:Number(C.get(i)?.count??C.get(i)?.cnt??0),roundsForecast:Number(C.get(i)?.forecast??0),visits:Number(M.get(i)?.count??M.get(i)?.cnt??0),visitsForecast:Number(M.get(i)?.forecast??0)}))}catch(m){return console.warn("[initThreeMetrics] fetchHourlyCombined error",m),Array.from({length:24},(t,n)=>({hour:String(n).padStart(2,"0")}))}}const u=await y(r);u&&u.length&&h(u);let c;c=window.setInterval(async()=>{const o=await y(r);o&&o.length&&h(o)},g);const p=()=>{document.removeEventListener("fragment:will-unload",p);try{c&&window.clearInterval(c)}catch{}[x,$,v].forEach(o=>{if(!o)return;const l=o.chart;if(l&&l.__hourly_metric_cleanup)try{l.__hourly_metric_cleanup()}catch{}else try{o.chart.dispose()}catch{}})};return document.addEventListener("fragment:will-unload",p,{once:!0}),{stop:()=>{try{c&&window.clearInterval(c)}catch{}p()}}}function D(s=new Date){return`${s.getFullYear()}-${String(s.getMonth()+1).padStart(2,"0")}-01`}function R(s=new Date){const r=s.getFullYear(),d=s.getMonth()+1,g=new Date(r,d,0).getDate();return`${r}-${String(d).padStart(2,"0")}-${String(g).padStart(2,"0")}`}async function k({container:s}){const r=s.querySelector("#client-dashboard-root")||s;if(!r||r.dataset.echartsInit==="1")return;r.dataset.echartsInit="1";const d=r.getAttribute("data-client-id")||"1",g=D(),x=R(),$=r.querySelector("#chart-att"),v=r.querySelector("#chart-inc"),h=r.querySelector("#chart-visit"),S=r.querySelector("#chart-visit-site");try{const t=await I(`/api/clients/dashboard/kpis?clientId=${d}`);if(t.ok){const n=await t.json();r.querySelector('[data-kpi="att"]').textContent=String(n.asistenciaHoy??0),r.querySelector('[data-kpi="patrol"]').textContent=String(n.rondasHoy??0),r.querySelector('[data-kpi="visit"]').textContent=String(n.visitasHoy??0)}}catch{}const y=[],u=t=>t?N(t,void 0,{renderer:"canvas"}):null,c=(t,n="Sin datos")=>{t&&t.setOption({graphic:{elements:[{type:"text",left:"center",top:"middle",style:{text:n,fill:"#9ca3af",fontSize:14}}]}})},p=u($);p&&y.push(p);try{const t=await I(`/api/attendance/series?clientId=${d}&from=${g}&to=${x}&action=IN`);if(t.ok){const n=await t.json().catch(()=>[]),w=n.map(a=>a.x),e=n.map(a=>a.y);p?.setOption({tooltip:{trigger:"axis"},grid:{left:40,right:16,top:24,bottom:32},xAxis:{type:"category",boundaryGap:!1,data:w},yAxis:{type:"value"},series:[{type:"line",smooth:!0,areaStyle:{},data:e}],graphic:e.some(a=>Number(a)>0)?{elements:[]}:void 0}),e.some(a=>Number(a)>0)||c(p)}else c(p,"Error de datos")}catch{c(p,"Error de datos")}const o=u(h);o&&y.push(o);try{const t=await I(`/api/site-supervision-visits/series?clientId=${d}&from=${g}&to=${x}`);if(t.ok){const n=await t.json().catch(()=>[]),w=n.map(a=>a.x),e=n.map(a=>a.y);o?.setOption({tooltip:{trigger:"axis"},grid:{left:40,right:16,top:24,bottom:32},xAxis:{type:"category",boundaryGap:!1,data:w},yAxis:{type:"value"},series:[{type:"line",smooth:!0,areaStyle:{},data:e,color:"#0ea5e9"}],graphic:e.some(a=>Number(a)>0)?{elements:[]}:void 0}),e.some(a=>Number(a)>0)||c(o)}else c(o,"Error de datos")}catch{c(o,"Error de datos")}const l=u(S);l&&y.push(l);try{const t=await I(`/api/site-supervision-visits/series-by-site?clientId=${d}&from=${g}&to=${x}`);if(t.ok){const n=await t.json().catch(()=>[]),w=n.map(a=>a.siteName),e=n.map(a=>a.count);l?.setOption({tooltip:{trigger:"axis"},grid:{left:60,right:16,top:24,bottom:32},xAxis:{type:"value"},yAxis:{type:"category",data:w,axisLabel:{interval:0,fontSize:12}},series:[{type:"bar",data:e,itemStyle:{color:"#0ea5e9"}}],graphic:e.some(a=>Number(a)>0)?{elements:[]}:void 0}),e.some(a=>Number(a)>0)||c(l)}else c(l,"Error de datos")}catch{c(l,"Error de datos")}const b=new Date,E=`${b.getFullYear()}-${String(b.getMonth()+1).padStart(2,"0")}-${String(b.getDate()).padStart(2,"0")}`;try{O(r,E,{refreshMs:6e4})}catch(t){console.warn("[client-dashboard] initThreeMetrics failed",t)}const f=new ResizeObserver(()=>y.forEach(t=>t?.resize()));[$,v,h,S].forEach(t=>t&&f.observe(t));const m=()=>{document.removeEventListener("fragment:will-unload",m);try{f.disconnect()}catch{}y.forEach(t=>{try{t.dispose()}catch{}}),r.dataset.echartsInit="0"};document.addEventListener("fragment:will-unload",m,{once:!0})}if(document.readyState==="loading")document.addEventListener("DOMContentLoaded",()=>{const s=document.getElementById("client-dashboard-root");s&&k({container:s})});else{const s=document.getElementById("client-dashboard-root");s&&k({container:s})}
