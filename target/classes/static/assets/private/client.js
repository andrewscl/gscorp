import{i as B,f as O}from"../chunks/api-Bh71dfFu.js";async function V(i,a,p,w,C,U){const A=i.querySelector(w);if(!A)return console.warn(`[hourly metric] ${w} no existe`),null;const x=Array.from({length:24},(y,h)=>String(h).padStart(2,"0")),I="#3b82f6",z="#60a5fa",m=B(A,void 0,{renderer:"canvas"}),f=x.map(()=>0);m.setOption({tooltip:{trigger:"axis"},legend:{top:6},grid:{left:40,right:16,top:36,bottom:28},xAxis:{type:"category",data:x,axisLabel:{formatter:y=>y+"h"}},yAxis:{type:"value",minInterval:1},series:[{name:`${p} (real)`,type:"bar",data:f,itemStyle:{color:I}},{name:`${p} (forecast)`,type:"line",smooth:!0,data:f,lineStyle:{type:"dashed",color:z},symbol:"circle",symbolSize:6}],graphic:{elements:[{type:"text",left:"center",top:"middle",style:{text:"Cargando...",fill:"#9ca3af",fontSize:14}}]},toolbox:{show:!0,feature:{saveAsImage:{}}}});function l(y){const h=new Map((y||[]).map(t=>[String(t.hour).padStart(2,"0"),t])),N=x.map(t=>Number((h.get(t)&&h.get(t)[a])??0)),$=x.map(t=>Number((h.get(t)&&h.get(t)[a+"Forecast"])??0)),k=N.some(t=>t>0)||$.some(t=>t>0);m.setOption({xAxis:{data:x},series:[{name:`${p} (real)`,type:"bar",data:N,itemStyle:{color:I}},{name:`${p} (forecast)`,type:"line",smooth:!0,data:$,lineStyle:{type:"dashed",color:z},symbol:"circle",symbolSize:6}],graphic:k?{elements:[]}:{elements:[{type:"text",left:"center",top:"middle",style:{text:"Sin datos",fill:"#9ca3af",fontSize:14}}]}})}const c=new ResizeObserver(()=>m.resize());c.observe(A);function d(){try{c.disconnect()}catch{}try{m.dispose()}catch{}try{document.removeEventListener("fragment:will-unload",g)}catch{}}const g=()=>{document.removeEventListener("fragment:will-unload",g),d()};return document.addEventListener("fragment:will-unload",g,{once:!0}),m.__hourly_metric_cleanup=d,{chart:m,refresh:y=>l(y),destroy:d}}async function K(i,a,p){const w=p?.refreshMs,C=await V(i,"attendance","Asistencias","#chart-hourly-attendance"),U=await V(i,"rounds","Rondas","#chart-hourly-rounds"),A=await V(i,"visits","Visitas","#chart-hourly-visits"),x=c=>{C&&C.refresh(c),U&&U.refresh(c),A&&A.refresh(c)};let I="UTC";try{I=Intl.DateTimeFormat().resolvedOptions().timeZone||"UTC"}catch{}async function z(c){const d=c?`?date=${encodeURIComponent(c)}&tz=${encodeURIComponent(I)}`:`?tz=${encodeURIComponent(I)}`,g=`/api/attendance/hourly${d}`,v=`/api/patrols-runs/hourly${d}`,y=`/api/site-supervision-visits/hourly${d}`;try{const[h,N,$]=await Promise.all([O(g),O(v),O(y)]),k=h.ok?await h.json().catch(()=>[]):[],t=N.ok?await N.json().catch(()=>[]):[],s=$.ok?await $.json().catch(()=>[]):[],u=new Map(k.map(r=>[String(r.hour).padStart(2,"0"),r])),n=new Map(t.map(r=>[String(r.hour).padStart(2,"0"),r])),o=new Map(s.map(r=>[String(r.hour).padStart(2,"0"),r]));return Array.from({length:24},(r,D)=>String(D).padStart(2,"0")).map(r=>({hour:r,attendance:Number(u.get(r)?.count??u.get(r)?.cnt??0),attendanceForecast:Number(u.get(r)?.forecast??0),rounds:Number(n.get(r)?.count??n.get(r)?.cnt??0),roundsForecast:Number(n.get(r)?.forecast??0),visits:Number(o.get(r)?.count??o.get(r)?.cnt??0),visitsForecast:Number(o.get(r)?.forecast??0)}))}catch(h){return console.warn("[initThreeMetrics] fetchHourlyCombined error",h),Array.from({length:24},(N,$)=>({hour:String($).padStart(2,"0")}))}}const m=await z(a);m&&m.length&&x(m);let f;f=window.setInterval(async()=>{const c=await z(a);c&&c.length&&x(c)},w);const l=()=>{document.removeEventListener("fragment:will-unload",l);try{f&&window.clearInterval(f)}catch{}[C,U,A].forEach(c=>{if(!c)return;const d=c.chart;if(d&&d.__hourly_metric_cleanup)try{d.__hourly_metric_cleanup()}catch{}else try{c.chart.dispose()}catch{}})};return document.addEventListener("fragment:will-unload",l,{once:!0}),{stop:()=>{try{f&&window.clearInterval(f)}catch{}l()}}}function W(i=new Date){return`${i.getFullYear()}-${String(i.getMonth()+1).padStart(2,"0")}-01`}function J(i=new Date){const a=i.getFullYear(),p=i.getMonth()+1,w=new Date(a,p,0).getDate();return`${a}-${String(p).padStart(2,"0")}-${String(w).padStart(2,"0")}`}async function Y({container:i}){const a=i.querySelector("#client-dashboard-root")||i;if(!a||a.dataset.echartsInit==="1")return;a.dataset.echartsInit="1";const p=a.getAttribute("data-client-id")||"1",w=W(),C=J(),U=a.querySelector("#chart-att"),A=a.querySelector("#chart-patrol"),x=a.querySelector("#chart-inc"),I=a.querySelector("#chart-visit"),z=a.querySelector("#chart-visit-site");try{const t=Intl.DateTimeFormat().resolvedOptions().timeZone||"UTC",s=`/api/clients/dashboard/kpis?tz=${encodeURIComponent(t)}`,u=await O(s);if(u.ok){const n=await u.json();a.querySelector('[data-kpi="att"]').textContent=String(n.asistenciaHoy??0),a.querySelector('[data-kpi="patrol"]').textContent=String(n.rondasHoy??0),a.querySelector('[data-kpi="visit"]').textContent=String(n.visitasHoy??0)}else console.warn("KPIs fetch no OK",u.status)}catch(t){console.error("Error obteniendo KPIs",t)}const m=[],f=t=>t?B(t,void 0,{renderer:"canvas"}):null,l=(t,s="Sin datos")=>{t&&t.setOption({graphic:{elements:[{type:"text",left:"center",top:"middle",style:{text:s,fill:"#9ca3af",fontSize:14}}]}})};async function c(t,s={},u=15e3,n=!1){const o=new AbortController,E={...s,signal:o.signal},r=setTimeout(()=>o.abort(),u);try{return n?await O(String(t),E):await fetch(t,E)}finally{clearTimeout(r)}}const d=f(U);d&&m.push(d);try{const t=await O(`/api/attendance/series?clientId=${p}&from=${w}&to=${C}&action=IN`);if(t.ok){const s=await t.json().catch(()=>[]),u=s.map(o=>o.x),n=s.map(o=>o.y);d?.setOption({tooltip:{trigger:"axis"},grid:{left:40,right:16,top:24,bottom:32},xAxis:{type:"category",boundaryGap:!1,data:u},yAxis:{type:"value"},series:[{type:"line",smooth:!0,areaStyle:{},data:n}],graphic:n.some(o=>Number(o)>0)?{elements:[]}:void 0}),n.some(o=>Number(o)>0)||l(d)}else l(d,"Error de datos")}catch{l(d,"Error de datos")}const g=f(A);g&&m.push(g);try{const t=Intl.DateTimeFormat().resolvedOptions().timeZone||"UTC",s=`/api/site-patrols/series?clientId=${p}&from=${w}&to=${C}&tz=${encodeURIComponent(t)}`,u=await O(s);if(u.ok){const n=await u.json().catch(()=>[]),o=n.map(r=>r.x),E=n.map(r=>r.y);g?.setOption({tooltip:{trigger:"axis"},grid:{left:40,right:16,top:24,bottom:32},xAxis:{type:"category",boundaryGap:!1,data:o},yAxis:{type:"value"},series:[{type:"line",smooth:!0,areaStyle:{},data:E,color:"#34D399"}],graphic:E.some(r=>Number(r)>0)?{elements:[]}:void 0}),E.some(r=>Number(r)>0)||l(g)}else l(g,"Error de datos")}catch(t){console.error("Error cargando series de rondas",t),l(g,"Error de datos")}window.addEventListener("resize",()=>g?.resize());const v=f(I);v&&m.push(v);try{const t=Intl.DateTimeFormat().resolvedOptions().timeZone||"UTC",s=7,u=`/api/site-supervision-visits/series?days=${s}&tz=${encodeURIComponent(t)}`,n=`/api/forecasts/forecast-series?days=${s}&tz=${encodeURIComponent(t)}`,[o,E]=await Promise.all([c(u,{},15e3,!0).catch(e=>(console.warn("Fetch actual visits failed",e),null)),c(n,{},15e3,!0).catch(e=>(console.warn("Fetch forecast visits failed",e),null))]),r=async(e,b)=>e?e.ok?await e.json().catch(F=>(console.warn(`${b} json parse error`,F),[])):(console.warn(`${b} returned status`,e.status),[]):[],[D,T]=await Promise.all([r(o,"actual visits"),r(E,"forecast visits")]);if((!Array.isArray(D)||D.length===0)&&(!Array.isArray(T)||T.length===0)){l(v,"Sin datos");return}const P=e=>Array.isArray(e)?e.map(b=>({x:String(b?.x),y:typeof b?.y=="number"?b.y:Number(b?.y||0)})):[],M=P(D),R=P(T),_=new Set;M.forEach(e=>e.x&&_.add(e.x)),R.forEach(e=>e.x&&_.add(e.x));let S=Array.from(_).sort();S.length>s&&(S=S.slice(S.length-s)),S.length===0&&M.length>0?S=M.map(e=>e.x).slice(-s):S.length===0&&R.length>0&&(S=R.map(e=>e.x).slice(-s));const H=e=>{const b=new Map;return e.forEach(F=>{F&&F.x&&b.set(F.x,Number.isFinite(Number(F.y))?Number(F.y):0)}),b},Z=H(M),G=H(R),L=S.map(e=>Z.has(e)?Z.get(e):0),q=S.map(e=>G.has(e)?G.get(e):0);if(!v){l(v,"Sin datos");return}v.clear(),v.setOption({legend:{data:["Visitas reales","Forecast (previsto)"],top:6},tooltip:{trigger:"axis",formatter:e=>{if(!Array.isArray(e)||e.length===0)return"";const b=e[0].axisValue,F=e.map(j=>`${j.marker} ${j.seriesName}: ${j.value??0}`);return`<b>${b}</b><br/>${F.join("<br/>")}`}},grid:{left:40,right:16,top:48,bottom:32},xAxis:{type:"category",boundaryGap:!1,data:S,axisLabel:{rotate:0}},yAxis:{type:"value"},series:[{name:"Visitas reales",type:"line",smooth:!0,areaStyle:{},data:L,color:"#0ea5e9",showSymbol:!1,lineStyle:{width:2}},{name:"Forecast (previsto)",type:"line",smooth:!0,areaStyle:{opacity:.12},data:q,color:"#f59e0b",showSymbol:!1,lineStyle:{width:2,type:"dashed"}}],graphic:L.concat(q).some(e=>Number(e)>0)?{elements:[]}:void 0}),L.some(e=>Number(e)>0)||q.some(e=>Number(e)>0)||l(v,"Sin visitas")}catch(t){t?.name==="AbortError"?console.debug("Visits/Forecast fetch aborted (timeout or navigation)",t):console.error("Error obteniendo series de visitas/forecast",t),l(v,"Error de datos")}const y=f(z);y&&m.push(y);try{const t=await O(`/api/site-supervision-visits/series-by-site?clientId=${p}&from=${w}&to=${C}`);if(t.ok){const s=await t.json().catch(()=>[]),u=s.map(o=>o.siteName),n=s.map(o=>o.count);y?.setOption({tooltip:{trigger:"axis"},grid:{left:60,right:16,top:24,bottom:32},xAxis:{type:"value"},yAxis:{type:"category",data:u,axisLabel:{interval:0,fontSize:12}},series:[{type:"bar",data:n,itemStyle:{color:"#0ea5e9"}}],graphic:n.some(o=>Number(o)>0)?{elements:[]}:void 0}),n.some(o=>Number(o)>0)||l(y)}else l(y,"Error de datos")}catch{l(y,"Error de datos")}const h=new Date,N=`${h.getFullYear()}-${String(h.getMonth()+1).padStart(2,"0")}-${String(h.getDate()).padStart(2,"0")}`;try{K(a,N,{refreshMs:6e4})}catch(t){console.warn("[client-dashboard] initThreeMetrics failed",t)}const $=new ResizeObserver(()=>m.forEach(t=>t?.resize()));[U,x,I,z].forEach(t=>t&&$.observe(t));const k=()=>{document.removeEventListener("fragment:will-unload",k);try{$.disconnect()}catch{}m.forEach(t=>{try{t.dispose()}catch{}}),a.dataset.echartsInit="0"};document.addEventListener("fragment:will-unload",k,{once:!0})}if(document.readyState==="loading")document.addEventListener("DOMContentLoaded",()=>{const i=document.getElementById("client-dashboard-root");i&&Y({container:i})});else{const i=document.getElementById("client-dashboard-root");i&&Y({container:i})}
