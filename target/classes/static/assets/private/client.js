import{i as st,f as _}from"../chunks/api-Bh71dfFu.js";async function X(u,l,b,z,O,U){const R=u.querySelector(z);if(!R)return console.warn(`[hourly metric] ${z} no existe`),null;const M=Array.from({length:24},(m,I)=>String(I).padStart(2,"0")),E=l==="rounds"?"#34D399":"#0ea5e9",k="#f59e0b",p=st(R,void 0,{renderer:"canvas"}),w={tooltip:{trigger:"axis",formatter:m=>{if(!Array.isArray(m)||m.length===0)return"";const r=m[0]?.axisValue,c=typeof r=="string"&&r.length===2?`${r}:00`:String(r??""),f=m.map(e=>`${e.marker} ${e.seriesName}: ${e.value??0}`);return`<b>${c}</b><br/>${f.join("<br/>")}`}},legend:{data:[`${b}`,`${b} (forecast)`],top:6},grid:{left:40,right:16,top:48,bottom:36},xAxis:{type:"category",data:M,axisLabel:{formatter:m=>`${m}:00`}},yAxis:{type:"value"},series:[{name:`${b}`,type:"line",smooth:!0,areaStyle:{},data:M.map(()=>0),color:E,showSymbol:!1,lineStyle:{width:2}},{name:`${b} (forecast)`,type:"line",smooth:!0,areaStyle:{opacity:.12},data:M.map(()=>0),color:k,showSymbol:!1,lineStyle:{width:2,type:"dashed"}}],graphic:{elements:[{type:"text",left:"center",top:"middle",style:{text:"Cargando...",fill:"#9ca3af",fontSize:14}}]},toolbox:{show:!0,feature:{saveAsImage:{}}}};p.setOption(w);function g(m){const I=new Map((m||[]).map(e=>[String(e.hour).padStart(2,"0"),e])),r=M.map(e=>Number((I.get(e)&&I.get(e)[l])??0)),c=M.map(e=>Number((I.get(e)&&I.get(e)[l+"Forecast"])??0)),f=r.some(e=>e>0)||c.some(e=>e>0);p.setOption({xAxis:{data:M},series:[{name:`${b}`,data:r},{name:`${b} (forecast)`,data:c}],graphic:f?{elements:[]}:{elements:[{type:"text",left:"center",top:"middle",style:{text:"Sin datos",fill:"#9ca3af",fontSize:14}}]}},{replaceMerge:["series","xAxis.data"]})}const q=new ResizeObserver(()=>p.resize());q.observe(R);function N(){try{q.disconnect()}catch{}try{p.dispose()}catch{}try{document.removeEventListener("fragment:will-unload",S)}catch{}}const S=()=>{document.removeEventListener("fragment:will-unload",S),N()};return document.addEventListener("fragment:will-unload",S,{once:!0}),p.__hourly_metric_cleanup=N,{chart:p,refresh:m=>g(m),destroy:N}}async function it(u,l,b){const z=b?.refreshMs,O=await X(u,"attendance","Asistencias","#chart-hourly-attendance"),U=await X(u,"rounds","Rondas","#chart-hourly-rounds"),R=await X(u,"visits","Visitas","#chart-hourly-visits"),M=r=>{O&&O.refresh(r),U&&U.refresh(r),R&&R.refresh(r)};let E="UTC";try{E=Intl.DateTimeFormat().resolvedOptions().timeZone||"UTC"}catch{}const k=Array.from({length:24},(r,c)=>String(c).padStart(2,"0"));function p(r){const c=r?.hour??r?.x??r?.label??r?.h??r?.time??"",f=String(c??"").padStart(2,"0").slice(-2);return/^[0-2]\d$/.test(f)?f:"00"}function w(r,c){for(const f of c){const e=r?.[f];if(e!=null&&e!==""){const d=Number(e);if(!Number.isNaN(d))return d}}return 0}async function g(r){const f=`/api/attendance/hourly${r?`?date=${encodeURIComponent(r)}&tz=${encodeURIComponent(E)}`:`?tz=${encodeURIComponent(E)}`}`;try{const e=await _(f),d=e.ok?await e.json().catch(()=>[]):[],T=new Map;return(d||[]).forEach(x=>{const V=p(x),t=w(x,["count","cnt","y","value","attendance"]),a=w(x,["forecast","f","attendanceForecast"]);T.set(V,{count:t,forecast:a||void 0})}),T}catch(e){return console.warn("[initThreeMetrics] fetchAttendanceMap error",e),new Map}}async function q(r){const f=`/api/patrols-runs/hourly${r?`?date=${encodeURIComponent(r)}&tz=${encodeURIComponent(E)}`:`?tz=${encodeURIComponent(E)}`}`;try{const e=await _(f),d=e.ok?await e.json().catch(()=>[]):[],T=new Map;return(d||[]).forEach(x=>{const V=p(x),t=w(x,["count","cnt","y","value","rounds"]),a=w(x,["forecast","f","roundsForecast"]);T.set(V,{count:t,forecast:a||void 0})}),T}catch(e){return console.warn("[initThreeMetrics] fetchRoundsMap error",e),new Map}}async function N(r){const f=`/api/site-supervision-visits/hourly-aggregated${r?`?date=${encodeURIComponent(r)}&tz=${encodeURIComponent(E)}`:`?tz=${encodeURIComponent(E)}`}`;try{const e=await _(f),d=e.ok?await e.json().catch(()=>[]):[],T=new Map;return(d||[]).forEach(x=>{const V=p(x),t=w(x,["count","cnt","y","value","visits"]),a=w(x,["forecast","f","visitsForecast"]);T.set(V,{count:t,forecast:a||void 0})}),T}catch(e){return console.warn("[initThreeMetrics] fetchVisitsMap error",e),new Map}}async function S(r){const[c,f,e]=await Promise.all([g(r),q(r),N(r)]);return k.map(d=>({hour:d,attendance:c.get(d)?.count??0,attendanceForecast:c.get(d)?.forecast??0,rounds:f.get(d)?.count??0,roundsForecast:f.get(d)?.forecast??0,visits:e.get(d)?.count??0,visitsForecast:e.get(d)?.forecast??0}))}const $=await S(l);$&&$.length&&M($);let m;m=window.setInterval(async()=>{const r=await S(l);r&&r.length&&M(r)},z);const I=()=>{document.removeEventListener("fragment:will-unload",I);try{m&&window.clearInterval(m)}catch{}[O,U,R].forEach(r=>{if(!r)return;const c=r.chart;if(c&&c.__hourly_metric_cleanup)try{c.__hourly_metric_cleanup()}catch{}else try{r.chart.dispose()}catch{}})};return document.addEventListener("fragment:will-unload",I,{once:!0}),{stop:()=>{try{m&&window.clearInterval(m)}catch{}I()}}}function ct(u=new Date){return`${u.getFullYear()}-${String(u.getMonth()+1).padStart(2,"0")}-01`}function lt(u=new Date){const l=u.getFullYear(),b=u.getMonth()+1,z=new Date(l,b,0).getDate();return`${l}-${String(b).padStart(2,"0")}-${String(z).padStart(2,"0")}`}async function at({container:u}){const l=u.querySelector("#client-dashboard-root")||u;if(!l||l.dataset.echartsInit==="1")return;l.dataset.echartsInit="1";const b=l.getAttribute("data-client-id")||"1",z=ct(),O=lt(),U=l.querySelector("#chart-att"),R=l.querySelector("#chart-patrol"),M=l.querySelector("#chart-inc"),E=l.querySelector("#chart-visit"),k=l.querySelector("#chart-visit-site"),p=[],w=t=>t?st(t,void 0,{renderer:"canvas"}):null,g=(t,a="Sin datos")=>{t&&t.setOption({graphic:{elements:[{type:"text",left:"center",top:"middle",style:{text:a,fill:"#9ca3af",fontSize:14}}]}})};async function q(t,a={},h=15e3,v=!1){const s=new AbortController,F={...a,signal:s.signal},D=setTimeout(()=>s.abort(),h);try{return v?await _(String(t),F):await fetch(t,F)}finally{clearTimeout(D)}}const N=w(U);N&&p.push(N);try{const t=await _(`/api/attendance/series?clientId=${b}&from=${z}&to=${O}&action=IN`);if(t.ok){const a=await t.json().catch(()=>[]),h=a.map(s=>s.x),v=a.map(s=>s.y);N?.setOption({tooltip:{trigger:"axis"},grid:{left:40,right:16,top:24,bottom:32},xAxis:{type:"category",boundaryGap:!1,data:h},yAxis:{type:"value"},series:[{type:"line",smooth:!0,areaStyle:{},data:v}],graphic:v.some(s=>Number(s)>0)?{elements:[]}:void 0}),v.some(s=>Number(s)>0)||g(N)}else g(N,"Error de datos")}catch{g(N,"Error de datos")}const S=w(R);S&&p.push(S);try{const t=Intl.DateTimeFormat().resolvedOptions().timeZone||"UTC",a=`/api/site-patrols/series?clientId=${b}&from=${z}&to=${O}&tz=${encodeURIComponent(t)}`,h=await _(a);if(h.ok){const v=await h.json().catch(()=>[]),s=v.map(D=>D.x),F=v.map(D=>D.y);S?.setOption({tooltip:{trigger:"axis"},grid:{left:40,right:16,top:24,bottom:32},xAxis:{type:"category",boundaryGap:!1,data:s},yAxis:{type:"value"},series:[{type:"line",smooth:!0,areaStyle:{},data:F,color:"#34D399"}],graphic:F.some(D=>Number(D)>0)?{elements:[]}:void 0}),F.some(D=>Number(D)>0)||g(S)}else g(S,"Error de datos")}catch(t){console.error("Error cargando series de rondas",t),g(S,"Error de datos")}window.addEventListener("resize",()=>S?.resize());const $=w(E);$&&p.push($);const m=navigator.language||"es",I=new Intl.DateTimeFormat(m,{day:"2-digit",month:"short"});function r(t){if(!t)return null;const a=t.includes("T")?t:`${t}T00:00:00`,h=new Date(a);return Number.isNaN(h.getTime())?null:h}function c(t){const a=r(t);return a?I.format(a).replace(".","").replace(/\s+/,"-"):t??""}function f(t,a){const h=[],v=new Date;for(let s=t-1;s>=0;s--){const F=new Date(v);F.setDate(v.getDate()-s),h.push(`${F.getFullYear()}-${String(F.getMonth()+1).padStart(2,"0")}-${String(F.getDate()).padStart(2,"0")}`)}return h}try{let t=function(o){if(o==null)return"";const n=String(o).trim();if(!n)return"";if(/^\d{4}-\d{2}-\d{2}$/.test(n)){const[y,L,C]=n.split("-"),G=Number(y),A=Number(L),j=Number(C);if(Number.isFinite(G)&&Number.isFinite(A)&&Number.isFinite(j)){const Z=new Date(G,A-1,j);return`${Z.getFullYear()}-${String(Z.getMonth()+1).padStart(2,"0")}-${String(Z.getDate()).padStart(2,"0")}`}return""}const i=new Date(n);return Number.isNaN(i.getTime())?n.split("T")[0]||"":`${i.getFullYear()}-${String(i.getMonth()+1).padStart(2,"0")}-${String(i.getDate()).padStart(2,"0")}`};const a=Intl.DateTimeFormat().resolvedOptions().timeZone||"UTC",h=7,v=`/api/site-supervision-visits/series?days=${h}&tz=${encodeURIComponent(a)}`,s=`/api/forecasts/forecast-series?days=${h}&tz=${encodeURIComponent(a)}`,[F,D]=await Promise.all([q(v,{},15e3,!0).catch(o=>(console.warn("Fetch actual visits failed",o),null)),q(s,{},15e3,!0).catch(o=>(console.warn("Fetch forecast visits failed",o),null))]),J=async(o,n)=>o?o.ok?await o.json().catch(i=>(console.warn(`${n} json parse error`,i),[])):(console.warn(`${n} returned status`,o.status),[]):[],[H,W]=await Promise.all([J(F,"actual visits"),J(D,"forecast visits")]);if((!Array.isArray(H)||H.length===0)&&(!Array.isArray(W)||W.length===0)){g($,"Sin datos");return}const Q=o=>Array.isArray(o)?o.map(n=>{let i="";Array.isArray(n)?i=n[0]:i=n?.x??n?.date??n?.day??"";let y=0;Array.isArray(n)&&n.length>1?y=n[1]:y=n?.y??n?.value??0;const L=t(i),C=typeof y=="number"?y:Number(String(y??0));return{x:L,y:Number.isFinite(C)?C:0}}).filter(n=>n.x&&typeof n.x=="string"&&n.x.length>=4):[],K=Q(H),tt=Q(W);let P=f(h,a);const et=o=>{const n=new Map;return o.forEach(i=>{if(!i||!i.x)return;const y=n.get(i.x)??0;n.set(i.x,y+(Number.isFinite(Number(i.y))?Number(i.y):0))}),n},rt=et(K),ot=et(tt),Y=P.map(o=>rt.has(o)?rt.get(o):0),B=P.map(o=>ot.has(o)?ot.get(o):0),nt=l.querySelector("#donut-visit");if(nt){const o=w(nt);if(o){p.push(o);const n=Y.reduce((A,j)=>A+(Number(j)||0),0),i=B.reduce((A,j)=>A+(Number(j)||0),0),y=i>0,L=y?Math.round(n/i*100):0,C=y?Math.min(100,Math.max(0,L)):100,G=y?[{value:C,name:"Cumplido",itemStyle:{color:"#10B981"}},{value:100-C,name:"Pendiente",itemStyle:{color:"#E5E7EB"}}]:[{value:1,name:"Sin meta",itemStyle:{color:"#E5E7EB"}}];o.setOption({tooltip:{trigger:"item",formatter:A=>y?A&&A.name==="Cumplido"?`${A.marker} ${A.seriesName}: ${n} / ${i} (${L}%)`:A&&A.name==="Pendiente"?`${A.marker} Pendiente: ${Math.max(0,i-n)}`:"":"Meta no definida"},series:[{name:"Cumplimiento Visitas",type:"pie",radius:["62%","82%"],avoidLabelOverlap:!1,hoverAnimation:!1,label:{show:!0,position:"center",formatter:y?`${L}%`:"â€”",fontSize:12,fontWeight:700,color:"#111827"},labelLine:{show:!1},data:G}]})}}if(console.debug("[visits-chart] labels:",P),console.debug("[visits-chart] normActual:",K),console.debug("[visits-chart] normForecast:",tt),console.debug("[visits-chart] valuesActual:",Y),console.debug("[visits-chart] valuesForecast:",B),!$){g($,"Sin datos");return}$.clear(),$.setOption({legend:{data:["Visitas reales","Forecast (previsto)"],top:6},tooltip:{trigger:"axis",formatter:o=>{if(!Array.isArray(o)||o.length===0)return"";const n=o[0];let i=n.axisValue??(n&&typeof n.dataIndex=="number"?P[n.dataIndex]:void 0);!i&&n.axisValueLabel&&(i=n.axisValueLabel);const y=c(String(i??"")),L=o.map(C=>`${C.marker} ${C.seriesName}: ${C.value??0}`);return`<b>${y}</b><br/>${L.join("<br/>")}`}},grid:{left:40,right:16,top:48,bottom:36},xAxis:{type:"category",boundaryGap:!1,data:P,axisLabel:{rotate:0,formatter:function(o){return c(o)}}},yAxis:{type:"value"},series:[{name:"Visitas reales",type:"line",smooth:!0,areaStyle:{},data:Y,color:"#0ea5e9",showSymbol:!1,lineStyle:{width:2}},{name:"Forecast (previsto)",type:"line",smooth:!0,areaStyle:{opacity:.12},data:B,color:"#f59e0b",showSymbol:!1,lineStyle:{width:2,type:"dashed"}}],graphic:Y.concat(B).some(o=>Number(o)>0)?{elements:[]}:void 0}),Y.some(o=>Number(o)>0)||B.some(o=>Number(o)>0)||g($,"Sin visitas")}catch(t){t?.name==="AbortError"?console.debug("Visits/Forecast fetch aborted (timeout or navigation)",t):console.error("Error obteniendo series de visitas/forecast",t),g($,"Error de datos")}const e=w(k);e&&p.push(e);try{const t=await _(`/api/site-supervision-visits/series-by-site?clientId=${b}&from=${z}&to=${O}`);if(t.ok){const a=await t.json().catch(()=>[]),h=a.map(s=>s.siteName),v=a.map(s=>s.count);e?.setOption({tooltip:{trigger:"axis"},grid:{left:60,right:16,top:24,bottom:32},xAxis:{type:"value"},yAxis:{type:"category",data:h,axisLabel:{interval:0,fontSize:12}},series:[{type:"bar",data:v,itemStyle:{color:"#0ea5e9"}}],graphic:v.some(s=>Number(s)>0)?{elements:[]}:void 0}),v.some(s=>Number(s)>0)||g(e)}else g(e,"Error de datos")}catch{g(e,"Error de datos")}const d=new Date,T=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;try{it(l,T,{refreshMs:6e4})}catch(t){console.warn("[client-dashboard] initThreeMetrics failed",t)}const x=new ResizeObserver(()=>p.forEach(t=>t?.resize()));[U,M,E,k].forEach(t=>t&&x.observe(t));const V=()=>{document.removeEventListener("fragment:will-unload",V);try{x.disconnect()}catch{}p.forEach(t=>{try{t.dispose()}catch{}}),l.dataset.echartsInit="0"};document.addEventListener("fragment:will-unload",V,{once:!0})}if(document.readyState==="loading")document.addEventListener("DOMContentLoaded",()=>{const u=document.getElementById("client-dashboard-root");u&&at({container:u})});else{const u=document.getElementById("client-dashboard-root");u&&at({container:u})}
