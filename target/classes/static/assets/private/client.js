import{i as M,f as C}from"../chunks/api-Bh71dfFu.js";async function D(s,a,h,S,E,O){const x=s.querySelector(S);if(!x)return console.warn(`[hourly metric] ${S} no existe`),null;const b=Array.from({length:24},(m,p)=>String(p).padStart(2,"0")),I="#3b82f6",z="#60a5fa",d=M(x,void 0,{renderer:"canvas"}),y=b.map(()=>0);d.setOption({tooltip:{trigger:"axis"},legend:{top:6},grid:{left:40,right:16,top:36,bottom:28},xAxis:{type:"category",data:b,axisLabel:{formatter:m=>m+"h"}},yAxis:{type:"value",minInterval:1},series:[{name:`${h} (real)`,type:"bar",data:y,itemStyle:{color:I}},{name:`${h} (forecast)`,type:"line",smooth:!0,data:y,lineStyle:{type:"dashed",color:z},symbol:"circle",symbolSize:6}],graphic:{elements:[{type:"text",left:"center",top:"middle",style:{text:"Cargando...",fill:"#9ca3af",fontSize:14}}]},toolbox:{show:!0,feature:{saveAsImage:{}}}});function n(m){const p=new Map((m||[]).map(t=>[String(t.hour).padStart(2,"0"),t])),A=b.map(t=>Number((p.get(t)&&p.get(t)[a])??0)),w=b.map(t=>Number((p.get(t)&&p.get(t)[a+"Forecast"])??0)),U=A.some(t=>t>0)||w.some(t=>t>0);d.setOption({xAxis:{data:b},series:[{name:`${h} (real)`,type:"bar",data:A,itemStyle:{color:I}},{name:`${h} (forecast)`,type:"line",smooth:!0,data:w,lineStyle:{type:"dashed",color:z},symbol:"circle",symbolSize:6}],graphic:U?{elements:[]}:{elements:[{type:"text",left:"center",top:"middle",style:{text:"Sin datos",fill:"#9ca3af",fontSize:14}}]}})}const i=new ResizeObserver(()=>d.resize());i.observe(x);function c(){try{i.disconnect()}catch{}try{d.dispose()}catch{}try{document.removeEventListener("fragment:will-unload",f)}catch{}}const f=()=>{document.removeEventListener("fragment:will-unload",f),c()};return document.addEventListener("fragment:will-unload",f,{once:!0}),d.__hourly_metric_cleanup=c,{chart:d,refresh:m=>n(m),destroy:c}}async function R(s,a,h){const S=h?.refreshMs,E=await D(s,"attendance","Asistencias","#chart-hourly-attendance"),O=await D(s,"rounds","Rondas","#chart-hourly-rounds"),x=await D(s,"visits","Visitas","#chart-hourly-visits"),b=i=>{E&&E.refresh(i),O&&O.refresh(i),x&&x.refresh(i)};let I="UTC";try{I=Intl.DateTimeFormat().resolvedOptions().timeZone||"UTC"}catch{}async function z(i){const c=i?`?date=${encodeURIComponent(i)}&tz=${encodeURIComponent(I)}`:`?tz=${encodeURIComponent(I)}`,f=`/api/attendance/hourly${c}`,g=`/api/patrols-runs/hourly${c}`,m=`/api/site-supervision-visits/hourly${c}`;try{const[p,A,w]=await Promise.all([C(f),C(g),C(m)]),U=p.ok?await p.json().catch(()=>[]):[],t=A.ok?await A.json().catch(()=>[]):[],u=w.ok?await w.json().catch(()=>[]):[],l=new Map(U.map(e=>[String(e.hour).padStart(2,"0"),e])),r=new Map(t.map(e=>[String(e.hour).padStart(2,"0"),e])),o=new Map(u.map(e=>[String(e.hour).padStart(2,"0"),e]));return Array.from({length:24},(e,v)=>String(v).padStart(2,"0")).map(e=>({hour:e,attendance:Number(l.get(e)?.count??l.get(e)?.cnt??0),attendanceForecast:Number(l.get(e)?.forecast??0),rounds:Number(r.get(e)?.count??r.get(e)?.cnt??0),roundsForecast:Number(r.get(e)?.forecast??0),visits:Number(o.get(e)?.count??o.get(e)?.cnt??0),visitsForecast:Number(o.get(e)?.forecast??0)}))}catch(p){return console.warn("[initThreeMetrics] fetchHourlyCombined error",p),Array.from({length:24},(A,w)=>({hour:String(w).padStart(2,"0")}))}}const d=await z(a);d&&d.length&&b(d);let y;y=window.setInterval(async()=>{const i=await z(a);i&&i.length&&b(i)},S);const n=()=>{document.removeEventListener("fragment:will-unload",n);try{y&&window.clearInterval(y)}catch{}[E,O,x].forEach(i=>{if(!i)return;const c=i.chart;if(c&&c.__hourly_metric_cleanup)try{c.__hourly_metric_cleanup()}catch{}else try{i.chart.dispose()}catch{}})};return document.addEventListener("fragment:will-unload",n,{once:!0}),{stop:()=>{try{y&&window.clearInterval(y)}catch{}n()}}}function T(s=new Date){return`${s.getFullYear()}-${String(s.getMonth()+1).padStart(2,"0")}-01`}function _(s=new Date){const a=s.getFullYear(),h=s.getMonth()+1,S=new Date(a,h,0).getDate();return`${a}-${String(h).padStart(2,"0")}-${String(S).padStart(2,"0")}`}async function k({container:s}){const a=s.querySelector("#client-dashboard-root")||s;if(!a||a.dataset.echartsInit==="1")return;a.dataset.echartsInit="1";const h=a.getAttribute("data-client-id")||"1",S=T(),E=_(),O=a.querySelector("#chart-att"),x=a.querySelector("#chart-patrol"),b=a.querySelector("#chart-inc"),I=a.querySelector("#chart-visit"),z=a.querySelector("#chart-visit-site");try{const t=Intl.DateTimeFormat().resolvedOptions().timeZone||"UTC",u=`/api/clients/dashboard/kpis?tz=${encodeURIComponent(t)}`,l=await C(u);if(l.ok){const r=await l.json();a.querySelector('[data-kpi="att"]').textContent=String(r.asistenciaHoy??0),a.querySelector('[data-kpi="patrol"]').textContent=String(r.rondasHoy??0),a.querySelector('[data-kpi="visit"]').textContent=String(r.visitasHoy??0)}else console.warn("KPIs fetch no OK",l.status)}catch(t){console.error("Error obteniendo KPIs",t)}const d=[],y=t=>t?M(t,void 0,{renderer:"canvas"}):null,n=(t,u="Sin datos")=>{t&&t.setOption({graphic:{elements:[{type:"text",left:"center",top:"middle",style:{text:u,fill:"#9ca3af",fontSize:14}}]}})};async function i(t,u={},l=15e3,r=!1){const o=new AbortController,$={...u,signal:o.signal},e=setTimeout(()=>o.abort(),l);try{return r?await C(String(t),$):await fetch(t,$)}finally{clearTimeout(e)}}const c=y(O);c&&d.push(c);try{const t=await C(`/api/attendance/series?clientId=${h}&from=${S}&to=${E}&action=IN`);if(t.ok){const u=await t.json().catch(()=>[]),l=u.map(o=>o.x),r=u.map(o=>o.y);c?.setOption({tooltip:{trigger:"axis"},grid:{left:40,right:16,top:24,bottom:32},xAxis:{type:"category",boundaryGap:!1,data:l},yAxis:{type:"value"},series:[{type:"line",smooth:!0,areaStyle:{},data:r}],graphic:r.some(o=>Number(o)>0)?{elements:[]}:void 0}),r.some(o=>Number(o)>0)||n(c)}else n(c,"Error de datos")}catch{n(c,"Error de datos")}const f=y(x);f&&d.push(f);try{const t=Intl.DateTimeFormat().resolvedOptions().timeZone||"UTC",u=`/api/site-patrols/series?clientId=${h}&from=${S}&to=${E}&tz=${encodeURIComponent(t)}`,l=await C(u);if(l.ok){const r=await l.json().catch(()=>[]),o=r.map(e=>e.x),$=r.map(e=>e.y);f?.setOption({tooltip:{trigger:"axis"},grid:{left:40,right:16,top:24,bottom:32},xAxis:{type:"category",boundaryGap:!1,data:o},yAxis:{type:"value"},series:[{type:"line",smooth:!0,areaStyle:{},data:$,color:"#34D399"}],graphic:$.some(e=>Number(e)>0)?{elements:[]}:void 0}),$.some(e=>Number(e)>0)||n(f)}else n(f,"Error de datos")}catch(t){console.error("Error cargando series de rondas",t),n(f,"Error de datos")}window.addEventListener("resize",()=>f?.resize());const g=y(I);g&&d.push(g);try{const t=Intl.DateTimeFormat().resolvedOptions().timeZone||"UTC",l=`/api/site-supervision-visits/series?days=7&tz=${encodeURIComponent(t)}`,r=await i(l,{},15e3,!0);if(!r){n(g,"Error de datos");return}if(!r.ok){r.status===401?console.warn("Unauthorized when fetching visits series"):console.warn("Visits series fetch returned status",r.status),n(g,"Error de datos");return}const o=await r.json().catch(()=>[]),$=o.map(v=>v.x),e=o.map(v=>{const N=typeof v.y=="number"?v.y:Number(v.y);return Number.isFinite(N)?N:0});g?(g.clear(),g.setOption({tooltip:{trigger:"axis"},grid:{left:40,right:16,top:24,bottom:32},xAxis:{type:"category",boundaryGap:!1,data:$},yAxis:{type:"value"},series:[{type:"line",smooth:!0,areaStyle:{},data:e,color:"#0ea5e9"}],graphic:e.some(v=>v>0)?{elements:[]}:void 0})):n(null,"Error de datos"),e.some(v=>v>0)||n(g)}catch(t){t?.name==="AbortError"?console.debug("Visits series fetch aborted (timeout or navigation)",t):(console.error("Error obteniendo series de visitas",t),n(g,"Error de datos"))}const m=y(z);m&&d.push(m);try{const t=await C(`/api/site-supervision-visits/series-by-site?clientId=${h}&from=${S}&to=${E}`);if(t.ok){const u=await t.json().catch(()=>[]),l=u.map(o=>o.siteName),r=u.map(o=>o.count);m?.setOption({tooltip:{trigger:"axis"},grid:{left:60,right:16,top:24,bottom:32},xAxis:{type:"value"},yAxis:{type:"category",data:l,axisLabel:{interval:0,fontSize:12}},series:[{type:"bar",data:r,itemStyle:{color:"#0ea5e9"}}],graphic:r.some(o=>Number(o)>0)?{elements:[]}:void 0}),r.some(o=>Number(o)>0)||n(m)}else n(m,"Error de datos")}catch{n(m,"Error de datos")}const p=new Date,A=`${p.getFullYear()}-${String(p.getMonth()+1).padStart(2,"0")}-${String(p.getDate()).padStart(2,"0")}`;try{R(a,A,{refreshMs:6e4})}catch(t){console.warn("[client-dashboard] initThreeMetrics failed",t)}const w=new ResizeObserver(()=>d.forEach(t=>t?.resize()));[O,b,I,z].forEach(t=>t&&w.observe(t));const U=()=>{document.removeEventListener("fragment:will-unload",U);try{w.disconnect()}catch{}d.forEach(t=>{try{t.dispose()}catch{}}),a.dataset.echartsInit="0"};document.addEventListener("fragment:will-unload",U,{once:!0})}if(document.readyState==="loading")document.addEventListener("DOMContentLoaded",()=>{const s=document.getElementById("client-dashboard-root");s&&k({container:s})});else{const s=document.getElementById("client-dashboard-root");s&&k({container:s})}
