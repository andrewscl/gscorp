import{i as E}from"../chunks/echarts-setup-BOxioT3i.js";async function f(s,o={}){const n=localStorage.getItem("jwt"),c=new Headers(o.headers||{});n&&c.set("Authorization",`Bearer ${n}`);const l=await fetch(s,{...o,headers:c});return l.status===401&&(localStorage.removeItem("jwt"),window.location.href="/auth/signin"),l}function k(s=new Date){return`${s.getFullYear()}-${String(s.getMonth()+1).padStart(2,"0")}-01`}function A(s=new Date){const o=s.getFullYear(),n=s.getMonth()+1,c=new Date(o,n,0).getDate();return`${o}-${String(n).padStart(2,"0")}-${String(c).padStart(2,"0")}`}async function I({container:s}){const o=s.querySelector("#client-dashboard-root")||s;if(!o||o.dataset.echartsInit==="1")return;o.dataset.echartsInit="1";const n=o.getAttribute("data-client-id")||"1",c=k(),l=A(),S=o.querySelector("#chart-att"),b=o.querySelector("#chart-inc"),v=o.querySelector("#chart-visit"),x=o.querySelector("#chart-visit-site");try{const e=await f(`/api/clients/dashboard/kpis?clientId=${n}`);if(e.ok){const a=await e.json();o.querySelector('[data-kpi="att"]').textContent=String(a.asistenciaHoy??0),o.querySelector('[data-kpi="patrol"]').textContent=String(a.rondasHoy??0),o.querySelector('[data-kpi="visit"]').textContent=String(a.visitasHoy??0),o.querySelector('[data-kpi="inc"]').textContent=String(a.incidentesAbiertos??0)}}catch{}const p=[],g=e=>e?E(e,void 0,{renderer:"canvas"}):null,r=(e,a="Sin datos")=>{e&&e.setOption({graphic:{elements:[{type:"text",left:"center",top:"middle",style:{text:a,fill:"#9ca3af",fontSize:14}}]}})},u=g(S);u&&p.push(u);try{const e=await f(`/api/attendance/series?clientId=${n}&from=${c}&to=${l}&action=IN`);if(e.ok){const a=await e.json().catch(()=>[]),d=a.map(t=>t.x),i=a.map(t=>t.y);u?.setOption({tooltip:{trigger:"axis"},grid:{left:40,right:16,top:24,bottom:32},xAxis:{type:"category",boundaryGap:!1,data:d},yAxis:{type:"value"},series:[{type:"line",smooth:!0,areaStyle:{},data:i}],graphic:i.some(t=>Number(t)>0)?{elements:[]}:void 0}),i.some(t=>Number(t)>0)||r(u)}else r(u,"Error de datos")}catch{r(u,"Error de datos")}const m=g(b);m&&p.push(m);try{const e=await f(`/api/incidents/series?clientId=${n}&from=${c}&to=${l}&status=OPEN`);if(e.ok){const a=await e.json().catch(()=>[]),d=a.map(t=>t.x),i=a.map(t=>t.y);m?.setOption({tooltip:{trigger:"axis"},grid:{left:40,right:16,top:24,bottom:32},xAxis:{type:"category",boundaryGap:!1,data:d},yAxis:{type:"value"},series:[{type:"line",smooth:!0,data:i}],graphic:i.some(t=>Number(t)>0)?{elements:[]}:void 0}),i.some(t=>Number(t)>0)||r(m)}else r(m,"Error de datos")}catch{r(m,"Error de datos")}const y=g(v);y&&p.push(y);try{const e=await f(`/api/site-supervision-visits/series?clientId=${n}&from=${c}&to=${l}`);if(e.ok){const a=await e.json().catch(()=>[]),d=a.map(t=>t.x),i=a.map(t=>t.y);y?.setOption({tooltip:{trigger:"axis"},grid:{left:40,right:16,top:24,bottom:32},xAxis:{type:"category",boundaryGap:!1,data:d},yAxis:{type:"value"},series:[{type:"line",smooth:!0,areaStyle:{},data:i,color:"#0ea5e9"}],graphic:i.some(t=>Number(t)>0)?{elements:[]}:void 0}),i.some(t=>Number(t)>0)||r(y)}else r(y,"Error de datos")}catch{r(y,"Error de datos")}const h=g(x);h&&p.push(h);try{const e=await f(`/api/site-supervision-visits/series-by-site?clientId=${n}&from=${c}&to=${l}`);if(e.ok){const a=await e.json().catch(()=>[]),d=a.map(t=>t.siteName),i=a.map(t=>t.count);h?.setOption({tooltip:{trigger:"axis"},grid:{left:60,right:16,top:24,bottom:32},xAxis:{type:"value"},yAxis:{type:"category",data:d,axisLabel:{interval:0,fontSize:12}},series:[{type:"bar",data:i,itemStyle:{color:"#0ea5e9"}}],graphic:i.some(t=>Number(t)>0)?{elements:[]}:void 0}),i.some(t=>Number(t)>0)||r(h)}else r(h,"Error de datos")}catch{r(h,"Error de datos")}const w=new ResizeObserver(()=>p.forEach(e=>e?.resize()));[S,b,v,x].forEach(e=>e&&w.observe(e));const $=()=>{document.removeEventListener("fragment:will-unload",$);try{w.disconnect()}catch{}p.forEach(e=>{try{e.dispose()}catch{}}),o.dataset.echartsInit="0"};document.addEventListener("fragment:will-unload",$,{once:!0})}if(document.readyState==="loading")document.addEventListener("DOMContentLoaded",()=>{const s=document.getElementById("client-dashboard-root");s&&I({container:s})});else{const s=document.getElementById("client-dashboard-root");s&&I({container:s})}
