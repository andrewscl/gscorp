import{i as W,f as C}from"../chunks/api-Bh71dfFu.js";async function H(c,a,p,x,N,T){const E=c.querySelector(x);if(!E)return console.warn(`[hourly metric] ${x} no existe`),null;const $=Array.from({length:24},(I,g)=>String(g).padStart(2,"0")),F="#3b82f6",z="#60a5fa",m=W(E,void 0,{renderer:"canvas"}),f=$.map(()=>0);m.setOption({tooltip:{trigger:"axis"},legend:{top:6},grid:{left:40,right:16,top:36,bottom:28},xAxis:{type:"category",data:$,axisLabel:{formatter:I=>I+"h"}},yAxis:{type:"value",minInterval:1},series:[{name:`${p} (real)`,type:"bar",data:f,itemStyle:{color:F}},{name:`${p} (forecast)`,type:"line",smooth:!0,data:f,lineStyle:{type:"dashed",color:z},symbol:"circle",symbolSize:6}],graphic:{elements:[{type:"text",left:"center",top:"middle",style:{text:"Cargando...",fill:"#9ca3af",fontSize:14}}]},toolbox:{show:!0,feature:{saveAsImage:{}}}});function d(I){const g=new Map((I||[]).map(s=>[String(s.hour).padStart(2,"0"),s])),D=$.map(s=>Number((g.get(s)&&g.get(s)[a])??0)),A=$.map(s=>Number((g.get(s)&&g.get(s)[a+"Forecast"])??0)),L=D.some(s=>s>0)||A.some(s=>s>0);m.setOption({xAxis:{data:$},series:[{name:`${p} (real)`,type:"bar",data:D,itemStyle:{color:F}},{name:`${p} (forecast)`,type:"line",smooth:!0,data:A,lineStyle:{type:"dashed",color:z},symbol:"circle",symbolSize:6}],graphic:L?{elements:[]}:{elements:[{type:"text",left:"center",top:"middle",style:{text:"Sin datos",fill:"#9ca3af",fontSize:14}}]}})}const l=new ResizeObserver(()=>m.resize());l.observe(E);function u(){try{l.disconnect()}catch{}try{m.dispose()}catch{}try{document.removeEventListener("fragment:will-unload",h)}catch{}}const h=()=>{document.removeEventListener("fragment:will-unload",h),u()};return document.addEventListener("fragment:will-unload",h,{once:!0}),m.__hourly_metric_cleanup=u,{chart:m,refresh:I=>d(I),destroy:u}}async function et(c,a,p){const x=p?.refreshMs,N=await H(c,"attendance","Asistencias","#chart-hourly-attendance"),T=await H(c,"rounds","Rondas","#chart-hourly-rounds"),E=await H(c,"visits","Visitas","#chart-hourly-visits"),$=l=>{N&&N.refresh(l),T&&T.refresh(l),E&&E.refresh(l)};let F="UTC";try{F=Intl.DateTimeFormat().resolvedOptions().timeZone||"UTC"}catch{}async function z(l){const u=l?`?date=${encodeURIComponent(l)}&tz=${encodeURIComponent(F)}`:`?tz=${encodeURIComponent(F)}`,h=`/api/attendance/hourly${u}`,v=`/api/patrols-runs/hourly${u}`,I=`/api/site-supervision-visits/hourly${u}`;try{const[g,D,A]=await Promise.all([C(h),C(v),C(I)]),L=g.ok?await g.json().catch(()=>[]):[],s=D.ok?await D.json().catch(()=>[]):[],M=A.ok?await A.json().catch(()=>[]):[],k=new Map(L.map(e=>[String(e.hour).padStart(2,"0"),e])),O=new Map(s.map(e=>[String(e.hour).padStart(2,"0"),e])),U=new Map(M.map(e=>[String(e.hour).padStart(2,"0"),e]));return Array.from({length:24},(e,n)=>String(n).padStart(2,"0")).map(e=>({hour:e,attendance:Number(k.get(e)?.count??k.get(e)?.cnt??0),attendanceForecast:Number(k.get(e)?.forecast??0),rounds:Number(O.get(e)?.count??O.get(e)?.cnt??0),roundsForecast:Number(O.get(e)?.forecast??0),visits:Number(U.get(e)?.count??U.get(e)?.cnt??0),visitsForecast:Number(U.get(e)?.forecast??0)}))}catch(g){return console.warn("[initThreeMetrics] fetchHourlyCombined error",g),Array.from({length:24},(D,A)=>({hour:String(A).padStart(2,"0")}))}}const m=await z(a);m&&m.length&&$(m);let f;f=window.setInterval(async()=>{const l=await z(a);l&&l.length&&$(l)},x);const d=()=>{document.removeEventListener("fragment:will-unload",d);try{f&&window.clearInterval(f)}catch{}[N,T,E].forEach(l=>{if(!l)return;const u=l.chart;if(u&&u.__hourly_metric_cleanup)try{u.__hourly_metric_cleanup()}catch{}else try{l.chart.dispose()}catch{}})};return document.addEventListener("fragment:will-unload",d,{once:!0}),{stop:()=>{try{f&&window.clearInterval(f)}catch{}d()}}}function rt(c=new Date){return`${c.getFullYear()}-${String(c.getMonth()+1).padStart(2,"0")}-01`}function ot(c=new Date){const a=c.getFullYear(),p=c.getMonth()+1,x=new Date(a,p,0).getDate();return`${a}-${String(p).padStart(2,"0")}-${String(x).padStart(2,"0")}`}async function K({container:c}){const a=c.querySelector("#client-dashboard-root")||c;if(!a||a.dataset.echartsInit==="1")return;a.dataset.echartsInit="1";const p=a.getAttribute("data-client-id")||"1",x=rt(),N=ot(),T=a.querySelector("#chart-att"),E=a.querySelector("#chart-patrol"),$=a.querySelector("#chart-inc"),F=a.querySelector("#chart-visit"),z=a.querySelector("#chart-visit-site");try{const t=Intl.DateTimeFormat().resolvedOptions().timeZone||"UTC",e=`/api/clients/dashboard/kpis?tz=${encodeURIComponent(t)}`,n=await C(e);if(n.ok){const i=await n.json();a.querySelector('[data-kpi="att"]').textContent=String(i.asistenciaHoy??0),a.querySelector('[data-kpi="patrol"]').textContent=String(i.rondasHoy??0),a.querySelector('[data-kpi="visit"]').textContent=String(i.visitasHoy??0)}else console.warn("KPIs fetch no OK",n.status)}catch(t){console.error("Error obteniendo KPIs",t)}const m=[],f=t=>t?W(t,void 0,{renderer:"canvas"}):null,d=(t,e="Sin datos")=>{t&&t.setOption({graphic:{elements:[{type:"text",left:"center",top:"middle",style:{text:e,fill:"#9ca3af",fontSize:14}}]}})};async function l(t,e={},n=15e3,i=!1){const o=new AbortController,b={...e,signal:o.signal},S=setTimeout(()=>o.abort(),n);try{return i?await C(String(t),b):await fetch(t,b)}finally{clearTimeout(S)}}const u=f(T);u&&m.push(u);try{const t=await C(`/api/attendance/series?clientId=${p}&from=${x}&to=${N}&action=IN`);if(t.ok){const e=await t.json().catch(()=>[]),n=e.map(o=>o.x),i=e.map(o=>o.y);u?.setOption({tooltip:{trigger:"axis"},grid:{left:40,right:16,top:24,bottom:32},xAxis:{type:"category",boundaryGap:!1,data:n},yAxis:{type:"value"},series:[{type:"line",smooth:!0,areaStyle:{},data:i}],graphic:i.some(o=>Number(o)>0)?{elements:[]}:void 0}),i.some(o=>Number(o)>0)||d(u)}else d(u,"Error de datos")}catch{d(u,"Error de datos")}const h=f(E);h&&m.push(h);try{const t=Intl.DateTimeFormat().resolvedOptions().timeZone||"UTC",e=`/api/site-patrols/series?clientId=${p}&from=${x}&to=${N}&tz=${encodeURIComponent(t)}`,n=await C(e);if(n.ok){const i=await n.json().catch(()=>[]),o=i.map(S=>S.x),b=i.map(S=>S.y);h?.setOption({tooltip:{trigger:"axis"},grid:{left:40,right:16,top:24,bottom:32},xAxis:{type:"category",boundaryGap:!1,data:o},yAxis:{type:"value"},series:[{type:"line",smooth:!0,areaStyle:{},data:b,color:"#34D399"}],graphic:b.some(S=>Number(S)>0)?{elements:[]}:void 0}),b.some(S=>Number(S)>0)||d(h)}else d(h,"Error de datos")}catch(t){console.error("Error cargando series de rondas",t),d(h,"Error de datos")}window.addEventListener("resize",()=>h?.resize());const v=f(F);v&&m.push(v);const I=navigator.language||"es",g=new Intl.DateTimeFormat(I,{day:"2-digit",month:"short"});function D(t){if(!t)return null;const e=t.includes("T")?t:`${t}T00:00:00`,n=new Date(e);return Number.isNaN(n.getTime())?null:n}function A(t){const e=D(t);return e?g.format(e).replace(".","").replace(/\s+/,"-"):t??""}function L(t,e){const n=[],i=new Date;for(let o=t-1;o>=0;o--){const b=new Date(i);b.setDate(i.getDate()-o),n.push(`${b.getFullYear()}-${String(b.getMonth()+1).padStart(2,"0")}-${String(b.getDate()).padStart(2,"0")}`)}return n}try{const t=Intl.DateTimeFormat().resolvedOptions().timeZone||"UTC",e=7,n=`/api/site-supervision-visits/series?days=${e}&tz=${encodeURIComponent(t)}`,i=`/api/forecasts/forecast-series?days=${e}&tz=${encodeURIComponent(t)}`,[o,b]=await Promise.all([l(n,{},15e3,!0).catch(r=>(console.warn("Fetch actual visits failed",r),null)),l(i,{},15e3,!0).catch(r=>(console.warn("Fetch forecast visits failed",r),null))]),S=async(r,y)=>r?r.ok?await r.json().catch(w=>(console.warn(`${y} json parse error`,w),[])):(console.warn(`${y} returned status`,r.status),[]):[],[_,V]=await Promise.all([S(o,"actual visits"),S(b,"forecast visits")]);if((!Array.isArray(_)||_.length===0)&&(!Array.isArray(V)||V.length===0)){d(v,"Sin datos");return}const Y=r=>Array.isArray(r)?r.map(y=>({x:String(y?.x),y:typeof y?.y=="number"?y.y:Number(y?.y||0)})):[],J=Y(_),Q=Y(V);let R=L(e,t);const Z=r=>{const y=new Map;return r.forEach(w=>{w&&w.x&&y.set(w.x,Number.isFinite(Number(w.y))?Number(w.y):0)}),y},G=Z(J),B=Z(Q),q=R.map(r=>G.has(r)?G.get(r):0),j=R.map(r=>B.has(r)?B.get(r):0);if(!v){d(v,"Sin datos");return}v.clear(),v.setOption({legend:{data:["Visitas reales","Forecast (previsto)"],top:6},tooltip:{trigger:"axis",formatter:r=>{if(!Array.isArray(r)||r.length===0)return"";const y=r[0];let w=y.axisValue??(y&&typeof y.dataIndex=="number"?R[y.dataIndex]:void 0);!w&&y.axisValueLabel&&(w=y.axisValueLabel);const X=A(String(w??"")),tt=r.map(P=>`${P.marker} ${P.seriesName}: ${P.value??0}`);return`<b>${X}</b><br/>${tt.join("<br/>")}`}},grid:{left:40,right:16,top:48,bottom:36},xAxis:{type:"category",boundaryGap:!1,data:R,axisLabel:{rotate:0,formatter:function(r){return A(r)}}},yAxis:{type:"value"},series:[{name:"Visitas reales",type:"line",smooth:!0,areaStyle:{},data:q,color:"#0ea5e9",showSymbol:!1,lineStyle:{width:2}},{name:"Forecast (previsto)",type:"line",smooth:!0,areaStyle:{opacity:.12},data:j,color:"#f59e0b",showSymbol:!1,lineStyle:{width:2,type:"dashed"}}],graphic:q.concat(j).some(r=>Number(r)>0)?{elements:[]}:void 0}),q.some(r=>Number(r)>0)||j.some(r=>Number(r)>0)||d(v,"Sin visitas")}catch(t){t?.name==="AbortError"?console.debug("Visits/Forecast fetch aborted (timeout or navigation)",t):console.error("Error obteniendo series de visitas/forecast",t),d(v,"Error de datos")}const s=f(z);s&&m.push(s);try{const t=await C(`/api/site-supervision-visits/series-by-site?clientId=${p}&from=${x}&to=${N}`);if(t.ok){const e=await t.json().catch(()=>[]),n=e.map(o=>o.siteName),i=e.map(o=>o.count);s?.setOption({tooltip:{trigger:"axis"},grid:{left:60,right:16,top:24,bottom:32},xAxis:{type:"value"},yAxis:{type:"category",data:n,axisLabel:{interval:0,fontSize:12}},series:[{type:"bar",data:i,itemStyle:{color:"#0ea5e9"}}],graphic:i.some(o=>Number(o)>0)?{elements:[]}:void 0}),i.some(o=>Number(o)>0)||d(s)}else d(s,"Error de datos")}catch{d(s,"Error de datos")}const M=new Date,k=`${M.getFullYear()}-${String(M.getMonth()+1).padStart(2,"0")}-${String(M.getDate()).padStart(2,"0")}`;try{et(a,k,{refreshMs:6e4})}catch(t){console.warn("[client-dashboard] initThreeMetrics failed",t)}const O=new ResizeObserver(()=>m.forEach(t=>t?.resize()));[T,$,F,z].forEach(t=>t&&O.observe(t));const U=()=>{document.removeEventListener("fragment:will-unload",U);try{O.disconnect()}catch{}m.forEach(t=>{try{t.dispose()}catch{}}),a.dataset.echartsInit="0"};document.addEventListener("fragment:will-unload",U,{once:!0})}if(document.readyState==="loading")document.addEventListener("DOMContentLoaded",()=>{const c=document.getElementById("client-dashboard-root");c&&K({container:c})});else{const c=document.getElementById("client-dashboard-root");c&&K({container:c})}
