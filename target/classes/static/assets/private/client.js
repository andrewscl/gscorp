import{i as Q,f as T}from"../chunks/api-Bh71dfFu.js";async function G(s,a,h,w,C,U){const I=s.querySelector(w);if(!I)return console.warn(`[hourly metric] ${w} no existe`),null;const x=Array.from({length:24},($,p)=>String(p).padStart(2,"0")),E="#3b82f6",z="#60a5fa",m=Q(I,void 0,{renderer:"canvas"}),y=x.map(()=>0);m.setOption({tooltip:{trigger:"axis"},legend:{top:6},grid:{left:40,right:16,top:36,bottom:28},xAxis:{type:"category",data:x,axisLabel:{formatter:$=>$+"h"}},yAxis:{type:"value",minInterval:1},series:[{name:`${h} (real)`,type:"bar",data:y,itemStyle:{color:E}},{name:`${h} (forecast)`,type:"line",smooth:!0,data:y,lineStyle:{type:"dashed",color:z},symbol:"circle",symbolSize:6}],graphic:{elements:[{type:"text",left:"center",top:"middle",style:{text:"Cargando...",fill:"#9ca3af",fontSize:14}}]},toolbox:{show:!0,feature:{saveAsImage:{}}}});function l($){const p=new Map(($||[]).map(u=>[String(u.hour).padStart(2,"0"),u])),O=x.map(u=>Number((p.get(u)&&p.get(u)[a])??0)),F=x.map(u=>Number((p.get(u)&&p.get(u)[a+"Forecast"])??0)),A=O.some(u=>u>0)||F.some(u=>u>0);m.setOption({xAxis:{data:x},series:[{name:`${h} (real)`,type:"bar",data:O,itemStyle:{color:E}},{name:`${h} (forecast)`,type:"line",smooth:!0,data:F,lineStyle:{type:"dashed",color:z},symbol:"circle",symbolSize:6}],graphic:A?{elements:[]}:{elements:[{type:"text",left:"center",top:"middle",style:{text:"Sin datos",fill:"#9ca3af",fontSize:14}}]}})}const i=new ResizeObserver(()=>m.resize());i.observe(I);function d(){try{i.disconnect()}catch{}try{m.dispose()}catch{}try{document.removeEventListener("fragment:will-unload",f)}catch{}}const f=()=>{document.removeEventListener("fragment:will-unload",f),d()};return document.addEventListener("fragment:will-unload",f,{once:!0}),m.__hourly_metric_cleanup=d,{chart:m,refresh:$=>l($),destroy:d}}async function X(s,a,h){const w=h?.refreshMs,C=await G(s,"attendance","Asistencias","#chart-hourly-attendance"),U=await G(s,"rounds","Rondas","#chart-hourly-rounds"),I=await G(s,"visits","Visitas","#chart-hourly-visits"),x=i=>{C&&C.refresh(i),U&&U.refresh(i),I&&I.refresh(i)};let E="UTC";try{E=Intl.DateTimeFormat().resolvedOptions().timeZone||"UTC"}catch{}async function z(i){const d=i?`?date=${encodeURIComponent(i)}&tz=${encodeURIComponent(E)}`:`?tz=${encodeURIComponent(E)}`,f=`/api/attendance/hourly${d}`,g=`/api/patrols-runs/hourly${d}`,$=`/api/site-supervision-visits/hourly${d}`;try{const[p,O,F]=await Promise.all([T(f),T(g),T($)]),A=p.ok?await p.json().catch(()=>[]):[],u=O.ok?await O.json().catch(()=>[]):[],L=F.ok?await F.json().catch(()=>[]):[],k=new Map(A.map(r=>[String(r.hour).padStart(2,"0"),r])),M=new Map(u.map(r=>[String(r.hour).padStart(2,"0"),r])),t=new Map(L.map(r=>[String(r.hour).padStart(2,"0"),r]));return Array.from({length:24},(r,c)=>String(c).padStart(2,"0")).map(r=>({hour:r,attendance:Number(k.get(r)?.count??k.get(r)?.cnt??0),attendanceForecast:Number(k.get(r)?.forecast??0),rounds:Number(M.get(r)?.count??M.get(r)?.cnt??0),roundsForecast:Number(M.get(r)?.forecast??0),visits:Number(t.get(r)?.count??t.get(r)?.cnt??0),visitsForecast:Number(t.get(r)?.forecast??0)}))}catch(p){return console.warn("[initThreeMetrics] fetchHourlyCombined error",p),Array.from({length:24},(O,F)=>({hour:String(F).padStart(2,"0")}))}}const m=await z(a);m&&m.length&&x(m);let y;y=window.setInterval(async()=>{const i=await z(a);i&&i.length&&x(i)},w);const l=()=>{document.removeEventListener("fragment:will-unload",l);try{y&&window.clearInterval(y)}catch{}[C,U,I].forEach(i=>{if(!i)return;const d=i.chart;if(d&&d.__hourly_metric_cleanup)try{d.__hourly_metric_cleanup()}catch{}else try{i.chart.dispose()}catch{}})};return document.addEventListener("fragment:will-unload",l,{once:!0}),{stop:()=>{try{y&&window.clearInterval(y)}catch{}l()}}}function tt(s=new Date){return`${s.getFullYear()}-${String(s.getMonth()+1).padStart(2,"0")}-01`}function et(s=new Date){const a=s.getFullYear(),h=s.getMonth()+1,w=new Date(a,h,0).getDate();return`${a}-${String(h).padStart(2,"0")}-${String(w).padStart(2,"0")}`}async function J({container:s}){const a=s.querySelector("#client-dashboard-root")||s;if(!a||a.dataset.echartsInit==="1")return;a.dataset.echartsInit="1";const h=a.getAttribute("data-client-id")||"1",w=tt(),C=et(),U=a.querySelector("#chart-att"),I=a.querySelector("#chart-patrol"),x=a.querySelector("#chart-inc"),E=a.querySelector("#chart-visit"),z=a.querySelector("#chart-visit-site");try{const t=Intl.DateTimeFormat().resolvedOptions().timeZone||"UTC",o=`/api/clients/dashboard/kpis?tz=${encodeURIComponent(t)}`,r=await T(o);if(r.ok){const c=await r.json();a.querySelector('[data-kpi="att"]').textContent=String(c.asistenciaHoy??0),a.querySelector('[data-kpi="patrol"]').textContent=String(c.rondasHoy??0),a.querySelector('[data-kpi="visit"]').textContent=String(c.visitasHoy??0)}else console.warn("KPIs fetch no OK",r.status)}catch(t){console.error("Error obteniendo KPIs",t)}const m=[],y=t=>t?Q(t,void 0,{renderer:"canvas"}):null,l=(t,o="Sin datos")=>{t&&t.setOption({graphic:{elements:[{type:"text",left:"center",top:"middle",style:{text:o,fill:"#9ca3af",fontSize:14}}]}})};async function i(t,o={},r=15e3,c=!1){const n=new AbortController,D={...o,signal:n.signal},b=setTimeout(()=>n.abort(),r);try{return c?await T(String(t),D):await fetch(t,D)}finally{clearTimeout(b)}}const d=y(U);d&&m.push(d);try{const t=await T(`/api/attendance/series?clientId=${h}&from=${w}&to=${C}&action=IN`);if(t.ok){const o=await t.json().catch(()=>[]),r=o.map(n=>n.x),c=o.map(n=>n.y);d?.setOption({tooltip:{trigger:"axis"},grid:{left:40,right:16,top:24,bottom:32},xAxis:{type:"category",boundaryGap:!1,data:r},yAxis:{type:"value"},series:[{type:"line",smooth:!0,areaStyle:{},data:c}],graphic:c.some(n=>Number(n)>0)?{elements:[]}:void 0}),c.some(n=>Number(n)>0)||l(d)}else l(d,"Error de datos")}catch{l(d,"Error de datos")}const f=y(I);f&&m.push(f);try{const t=Intl.DateTimeFormat().resolvedOptions().timeZone||"UTC",o=`/api/site-patrols/series?clientId=${h}&from=${w}&to=${C}&tz=${encodeURIComponent(t)}`,r=await T(o);if(r.ok){const c=await r.json().catch(()=>[]),n=c.map(b=>b.x),D=c.map(b=>b.y);f?.setOption({tooltip:{trigger:"axis"},grid:{left:40,right:16,top:24,bottom:32},xAxis:{type:"category",boundaryGap:!1,data:n},yAxis:{type:"value"},series:[{type:"line",smooth:!0,areaStyle:{},data:D,color:"#34D399"}],graphic:D.some(b=>Number(b)>0)?{elements:[]}:void 0}),D.some(b=>Number(b)>0)||l(f)}else l(f,"Error de datos")}catch(t){console.error("Error cargando series de rondas",t),l(f,"Error de datos")}window.addEventListener("resize",()=>f?.resize());const g=y(E);g&&m.push(g);try{const t=Intl.DateTimeFormat().resolvedOptions().timeZone||"UTC",o=7,r=`/api/site-supervision-visits/series?days=${o}&tz=${encodeURIComponent(t)}`,c=`/api/forecasts/forecast-series?days=${o}&tz=${encodeURIComponent(t)}`,[n,D]=await Promise.all([i(r,{},15e3,!0).catch(e=>(console.warn("Fetch actual visits failed",e),null)),i(c,{},15e3,!0).catch(e=>(console.warn("Fetch forecast visits failed",e),null))]),b=async(e,v)=>e?e.ok?await e.json().catch(N=>(console.warn(`${v} json parse error`,N),[])):(console.warn(`${v} returned status`,e.status),[]):[],[q,j]=await Promise.all([b(n,"actual visits"),b(D,"forecast visits")]);if((!Array.isArray(q)||q.length===0)&&(!Array.isArray(j)||j.length===0)){l(g,"Sin datos");return}const Y=e=>Array.isArray(e)?e.map(v=>({x:String(v?.x),y:typeof v?.y=="number"?v.y:Number(v?.y||0)})):[],R=Y(q),_=Y(j),V=new Set;R.forEach(e=>e.x&&V.add(e.x)),_.forEach(e=>e.x&&V.add(e.x));let S=Array.from(V).sort();S.length>o&&(S=S.slice(S.length-o)),S.length===0&&R.length>0?S=R.map(e=>e.x).slice(-o):S.length===0&&_.length>0&&(S=_.map(e=>e.x).slice(-o));const B=e=>{const v=new Map;return e.forEach(N=>{N&&N.x&&v.set(N.x,Number.isFinite(Number(N.y))?Number(N.y):0)}),v},K=B(R),W=B(_),P=S.map(e=>K.has(e)?K.get(e):0),H=S.map(e=>W.has(e)?W.get(e):0);if(!g){l(g,"Sin datos");return}g.clear(),g.setOption({legend:{data:["Visitas","Forecast"],top:6},tooltip:{trigger:"axis",formatter:e=>{if(!Array.isArray(e)||e.length===0)return"";const v=e[0].axisValue,N=e.map(Z=>`${Z.marker} ${Z.seriesName}: ${Z.value??0}`);return`<b>${v}</b><br/>${N.join("<br/>")}`}},grid:{left:40,right:16,top:48,bottom:32},xAxis:{type:"category",boundaryGap:!1,data:S,axisLabel:{rotate:0,formatter:function(e){return F(e)}}},yAxis:{type:"value"},series:[{name:"Visitas reales",type:"line",smooth:!0,areaStyle:{},data:P,color:"#0ea5e9",showSymbol:!1,lineStyle:{width:2}},{name:"Forecast (previsto)",type:"line",smooth:!0,areaStyle:{opacity:.12},data:H,color:"#f59e0b",showSymbol:!1,lineStyle:{width:2,type:"dashed"}}],graphic:P.concat(H).some(e=>Number(e)>0)?{elements:[]}:void 0}),P.some(e=>Number(e)>0)||H.some(e=>Number(e)>0)||l(g,"Sin visitas")}catch(t){t?.name==="AbortError"?console.debug("Visits/Forecast fetch aborted (timeout or navigation)",t):console.error("Error obteniendo series de visitas/forecast",t),l(g,"Error de datos")}const $=navigator.language||"es",p=new Intl.DateTimeFormat($,{day:"2-digit",month:"short"});function O(t){if(!t)return null;const o=new Date(`${t}T00:00:00`);return Number.isNaN(o.getTime())?null:o}function F(t){const o=O(t);return o?p.format(o).replace(".","").replace(/\s+/,"-"):t??""}const A=y(z);A&&m.push(A);try{const t=await T(`/api/site-supervision-visits/series-by-site?clientId=${h}&from=${w}&to=${C}`);if(t.ok){const o=await t.json().catch(()=>[]),r=o.map(n=>n.siteName),c=o.map(n=>n.count);A?.setOption({tooltip:{trigger:"axis"},grid:{left:60,right:16,top:24,bottom:32},xAxis:{type:"value"},yAxis:{type:"category",data:r,axisLabel:{interval:0,fontSize:12}},series:[{type:"bar",data:c,itemStyle:{color:"#0ea5e9"}}],graphic:c.some(n=>Number(n)>0)?{elements:[]}:void 0}),c.some(n=>Number(n)>0)||l(A)}else l(A,"Error de datos")}catch{l(A,"Error de datos")}const u=new Date,L=`${u.getFullYear()}-${String(u.getMonth()+1).padStart(2,"0")}-${String(u.getDate()).padStart(2,"0")}`;try{X(a,L,{refreshMs:6e4})}catch(t){console.warn("[client-dashboard] initThreeMetrics failed",t)}const k=new ResizeObserver(()=>m.forEach(t=>t?.resize()));[U,x,E,z].forEach(t=>t&&k.observe(t));const M=()=>{document.removeEventListener("fragment:will-unload",M);try{k.disconnect()}catch{}m.forEach(t=>{try{t.dispose()}catch{}}),a.dataset.echartsInit="0"};document.addEventListener("fragment:will-unload",M,{once:!0})}if(document.readyState==="loading")document.addEventListener("DOMContentLoaded",()=>{const s=document.getElementById("client-dashboard-root");s&&J({container:s})});else{const s=document.getElementById("client-dashboard-root");s&&J({container:s})}
