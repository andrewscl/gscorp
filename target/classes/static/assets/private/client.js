import{i as $}from"../chunks/echarts-setup-BOxioT3i.js";async function f(a,o={}){const r=localStorage.getItem("jwt"),d=new Headers(o.headers||{});r&&d.set("Authorization",`Bearer ${r}`);const l=await fetch(a,{...o,headers:d});return l.status===401&&(localStorage.removeItem("jwt"),window.location.href="/auth/signin"),l}function E(a=new Date){return`${a.getFullYear()}-${String(a.getMonth()+1).padStart(2,"0")}-01`}function k(a=new Date){const o=a.getFullYear(),r=a.getMonth()+1,d=new Date(o,r,0).getDate();return`${o}-${String(r).padStart(2,"0")}-${String(d).padStart(2,"0")}`}async function I({container:a}){const o=a.querySelector("#client-dashboard-root")||a;if(!o||o.dataset.echartsInit==="1")return;o.dataset.echartsInit="1";const r=o.getAttribute("data-client-id")||"1",d=E(),l=k(),b=o.querySelector("#chart-asistencia"),S=o.querySelector("#chart-rondas"),x=o.querySelector("#chart-incidentes");try{const t=await f(`/api/client/dashboard/kpis?clientId=${r}`);if(t.ok){const n=await t.json();o.querySelector("#kpi-asistencia-hoy").textContent=String(n.asistenciaHoy??0),o.querySelector("#kpi-rondas-hoy").textContent=String(n.rondasHoy??0),o.querySelector("#kpi-incidentes").textContent=String(n.incidentesAbiertos??0)}}catch{}const h=[],g=t=>t?$(t,void 0,{renderer:"canvas"}):null,i=(t,n="Sin datos")=>{t&&t.setOption({graphic:{elements:[{type:"text",left:"center",top:"middle",style:{text:n,fill:"#9ca3af",fontSize:14}}]}})},p=g(b);p&&h.push(p);try{const t=await f(`/api/client/attendance/series?clientId=${r}&from=${d}&to=${l}&action=IN`);if(t.ok){const n=await t.json().catch(()=>[]),y=n.map(e=>e.x),s=n.map(e=>e.y);p?.setOption({tooltip:{trigger:"axis"},grid:{left:40,right:16,top:24,bottom:32},xAxis:{type:"category",boundaryGap:!1,data:y},yAxis:{type:"value"},series:[{type:"line",smooth:!0,areaStyle:{},data:s}],graphic:s.some(e=>Number(e)>0)?{elements:[]}:void 0}),s.some(e=>Number(e)>0)||i(p)}else i(p,"Error de datos")}catch{i(p,"Error de datos")}const m=g(S);m&&h.push(m);try{const t=await f(`/api/client/patrol/compliance?clientId=${r}&from=${d}&to=${l}`);if(t.ok){const n=await t.json().catch(()=>[]),y=n.map(c=>c.x),s=n.map(c=>c.expected),e=n.map(c=>c.completed);m?.setOption({tooltip:{trigger:"axis"},legend:{},grid:{left:40,right:16,top:24,bottom:32},xAxis:{type:"category",data:y},yAxis:{type:"value"},series:[{name:"Completadas",type:"bar",data:e},{name:"Esperadas",type:"bar",data:s}],graphic:e.concat(s).some(c=>Number(c)>0)?{elements:[]}:void 0}),e.concat(s).some(c=>Number(c)>0)||i(m)}else i(m,"Error de datos")}catch{i(m,"Error de datos")}const u=g(x);u&&h.push(u);try{const t=await f(`/api/client/incidents/series?clientId=${r}&from=${d}&to=${l}&status=OPEN`);if(t.ok){const n=await t.json().catch(()=>[]),y=n.map(e=>e.x),s=n.map(e=>e.y);u?.setOption({tooltip:{trigger:"axis"},grid:{left:40,right:16,top:24,bottom:32},xAxis:{type:"category",boundaryGap:!1,data:y},yAxis:{type:"value"},series:[{type:"line",smooth:!0,data:s}],graphic:s.some(e=>Number(e)>0)?{elements:[]}:void 0}),s.some(e=>Number(e)>0)||i(u)}else i(u,"Error de datos")}catch{i(u,"Error de datos")}const w=new ResizeObserver(()=>h.forEach(t=>t?.resize()));[b,S,x].forEach(t=>t&&w.observe(t));const v=()=>{document.removeEventListener("fragment:will-unload",v);try{w.disconnect()}catch{}h.forEach(t=>{try{t.dispose()}catch{}}),o.dataset.echartsInit="0"};document.addEventListener("fragment:will-unload",v,{once:!0})}if(document.readyState==="loading")document.addEventListener("DOMContentLoaded",()=>{const a=document.getElementById("client-dashboard-root");a&&I({container:a})});else{const a=document.getElementById("client-dashboard-root");a&&I({container:a})}
