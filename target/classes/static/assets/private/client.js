import{i as nt,f as M}from"../chunks/api-Bh71dfFu.js";async function G(u,s,y,x,D,O){const N=u.querySelector(x);if(!N)return console.warn(`[hourly metric] ${x} no existe`),null;const A=Array.from({length:24},(I,b)=>String(b).padStart(2,"0")),E="#3b82f6",z="#60a5fa",p=nt(N,void 0,{renderer:"canvas"}),h=A.map(()=>0);p.setOption({tooltip:{trigger:"axis"},legend:{top:6},grid:{left:40,right:16,top:36,bottom:28},xAxis:{type:"category",data:A,axisLabel:{formatter:I=>I+"h"}},yAxis:{type:"value",minInterval:1},series:[{name:`${y} (real)`,type:"bar",data:h,itemStyle:{color:E}},{name:`${y} (forecast)`,type:"line",smooth:!0,data:h,lineStyle:{type:"dashed",color:z},symbol:"circle",symbolSize:6}],graphic:{elements:[{type:"text",left:"center",top:"middle",style:{text:"Cargando...",fill:"#9ca3af",fontSize:14}}]},toolbox:{show:!0,feature:{saveAsImage:{}}}});function m(I){const b=new Map((I||[]).map(i=>[String(i.hour).padStart(2,"0"),i])),C=A.map(i=>Number((b.get(i)&&b.get(i)[s])??0)),F=A.map(i=>Number((b.get(i)&&b.get(i)[s+"Forecast"])??0)),k=C.some(i=>i>0)||F.some(i=>i>0);p.setOption({xAxis:{data:A},series:[{name:`${y} (real)`,type:"bar",data:C,itemStyle:{color:E}},{name:`${y} (forecast)`,type:"line",smooth:!0,data:F,lineStyle:{type:"dashed",color:z},symbol:"circle",symbolSize:6}],graphic:k?{elements:[]}:{elements:[{type:"text",left:"center",top:"middle",style:{text:"Sin datos",fill:"#9ca3af",fontSize:14}}]}})}const d=new ResizeObserver(()=>p.resize());d.observe(N);function f(){try{d.disconnect()}catch{}try{p.dispose()}catch{}try{document.removeEventListener("fragment:will-unload",g)}catch{}}const g=()=>{document.removeEventListener("fragment:will-unload",g),f()};return document.addEventListener("fragment:will-unload",g,{once:!0}),p.__hourly_metric_cleanup=f,{chart:p,refresh:I=>m(I),destroy:f}}async function st(u,s,y){const x=y?.refreshMs,D=await G(u,"attendance","Asistencias","#chart-hourly-attendance"),O=await G(u,"rounds","Rondas","#chart-hourly-rounds"),N=await G(u,"visits","Visitas","#chart-hourly-visits"),A=d=>{D&&D.refresh(d),O&&O.refresh(d),N&&N.refresh(d)};let E="UTC";try{E=Intl.DateTimeFormat().resolvedOptions().timeZone||"UTC"}catch{}async function z(d){const f=d?`?date=${encodeURIComponent(d)}&tz=${encodeURIComponent(E)}`:`?tz=${encodeURIComponent(E)}`,g=`/api/attendance/hourly${f}`,S=`/api/patrols-runs/hourly${f}`,I=`/api/site-supervision-visits/hourly${f}`;try{const[b,C,F]=await Promise.all([M(g),M(S),M(I)]),k=b.ok?await b.json().catch(()=>[]):[],i=C.ok?await C.json().catch(()=>[]):[],R=F.ok?await F.json().catch(()=>[]):[],_=new Map(k.map(e=>[String(e.hour).padStart(2,"0"),e])),L=new Map(i.map(e=>[String(e.hour).padStart(2,"0"),e])),U=new Map(R.map(e=>[String(e.hour).padStart(2,"0"),e]));return Array.from({length:24},(e,n)=>String(n).padStart(2,"0")).map(e=>({hour:e,attendance:Number(_.get(e)?.count??_.get(e)?.cnt??0),attendanceForecast:Number(_.get(e)?.forecast??0),rounds:Number(L.get(e)?.count??L.get(e)?.cnt??0),roundsForecast:Number(L.get(e)?.forecast??0),visits:Number(U.get(e)?.count??U.get(e)?.cnt??0),visitsForecast:Number(U.get(e)?.forecast??0)}))}catch(b){return console.warn("[initThreeMetrics] fetchHourlyCombined error",b),Array.from({length:24},(C,F)=>({hour:String(F).padStart(2,"0")}))}}const p=await z(s);p&&p.length&&A(p);let h;h=window.setInterval(async()=>{const d=await z(s);d&&d.length&&A(d)},x);const m=()=>{document.removeEventListener("fragment:will-unload",m);try{h&&window.clearInterval(h)}catch{}[D,O,N].forEach(d=>{if(!d)return;const f=d.chart;if(f&&f.__hourly_metric_cleanup)try{f.__hourly_metric_cleanup()}catch{}else try{d.chart.dispose()}catch{}})};return document.addEventListener("fragment:will-unload",m,{once:!0}),{stop:()=>{try{h&&window.clearInterval(h)}catch{}m()}}}function it(u=new Date){return`${u.getFullYear()}-${String(u.getMonth()+1).padStart(2,"0")}-01`}function ct(u=new Date){const s=u.getFullYear(),y=u.getMonth()+1,x=new Date(s,y,0).getDate();return`${s}-${String(y).padStart(2,"0")}-${String(x).padStart(2,"0")}`}async function at({container:u}){const s=u.querySelector("#client-dashboard-root")||u;if(!s||s.dataset.echartsInit==="1")return;s.dataset.echartsInit="1";const y=s.getAttribute("data-client-id")||"1",x=it(),D=ct(),O=s.querySelector("#chart-att"),N=s.querySelector("#chart-patrol"),A=s.querySelector("#chart-inc"),E=s.querySelector("#chart-visit"),z=s.querySelector("#chart-visit-site");try{const t=Intl.DateTimeFormat().resolvedOptions().timeZone||"UTC",e=`/api/clients/dashboard/kpis?tz=${encodeURIComponent(t)}`,n=await M(e);if(n.ok){const c=await n.json();s.querySelector('[data-kpi="att"]').textContent=String(c.asistenciaHoy??0),s.querySelector('[data-kpi="patrol"]').textContent=String(c.rondasHoy??0),s.querySelector('[data-kpi="visit"]').textContent=String(c.visitasHoy??0)}else console.warn("KPIs fetch no OK",n.status)}catch(t){console.error("Error obteniendo KPIs",t)}const p=[],h=t=>t?nt(t,void 0,{renderer:"canvas"}):null,m=(t,e="Sin datos")=>{t&&t.setOption({graphic:{elements:[{type:"text",left:"center",top:"middle",style:{text:e,fill:"#9ca3af",fontSize:14}}]}})};async function d(t,e={},n=15e3,c=!1){const a=new AbortController,v={...e,signal:a.signal},$=setTimeout(()=>a.abort(),n);try{return c?await M(String(t),v):await fetch(t,v)}finally{clearTimeout($)}}const f=h(O);f&&p.push(f);try{const t=await M(`/api/attendance/series?clientId=${y}&from=${x}&to=${D}&action=IN`);if(t.ok){const e=await t.json().catch(()=>[]),n=e.map(a=>a.x),c=e.map(a=>a.y);f?.setOption({tooltip:{trigger:"axis"},grid:{left:40,right:16,top:24,bottom:32},xAxis:{type:"category",boundaryGap:!1,data:n},yAxis:{type:"value"},series:[{type:"line",smooth:!0,areaStyle:{},data:c}],graphic:c.some(a=>Number(a)>0)?{elements:[]}:void 0}),c.some(a=>Number(a)>0)||m(f)}else m(f,"Error de datos")}catch{m(f,"Error de datos")}const g=h(N);g&&p.push(g);try{const t=Intl.DateTimeFormat().resolvedOptions().timeZone||"UTC",e=`/api/site-patrols/series?clientId=${y}&from=${x}&to=${D}&tz=${encodeURIComponent(t)}`,n=await M(e);if(n.ok){const c=await n.json().catch(()=>[]),a=c.map($=>$.x),v=c.map($=>$.y);g?.setOption({tooltip:{trigger:"axis"},grid:{left:40,right:16,top:24,bottom:32},xAxis:{type:"category",boundaryGap:!1,data:a},yAxis:{type:"value"},series:[{type:"line",smooth:!0,areaStyle:{},data:v,color:"#34D399"}],graphic:v.some($=>Number($)>0)?{elements:[]}:void 0}),v.some($=>Number($)>0)||m(g)}else m(g,"Error de datos")}catch(t){console.error("Error cargando series de rondas",t),m(g,"Error de datos")}window.addEventListener("resize",()=>g?.resize());const S=h(E);S&&p.push(S);const I=navigator.language||"es",b=new Intl.DateTimeFormat(I,{day:"2-digit",month:"short"});function C(t){if(!t)return null;const e=t.includes("T")?t:`${t}T00:00:00`,n=new Date(e);return Number.isNaN(n.getTime())?null:n}function F(t){const e=C(t);return e?b.format(e).replace(".","").replace(/\s+/,"-"):t??""}function k(t,e){const n=[],c=new Date;for(let a=t-1;a>=0;a--){const v=new Date(c);v.setDate(c.getDate()-a),n.push(`${v.getFullYear()}-${String(v.getMonth()+1).padStart(2,"0")}-${String(v.getDate()).padStart(2,"0")}`)}return n}try{let t=function(r){if(r==null)return"";const o=String(r).trim();if(!o)return"";if(/^\d{4}-\d{2}-\d{2}$/.test(o)){const[w,q,T]=o.split("-"),et=Number(w),rt=Number(q),ot=Number(T);if(Number.isFinite(et)&&Number.isFinite(rt)&&Number.isFinite(ot)){const Z=new Date(et,rt-1,ot);return`${Z.getFullYear()}-${String(Z.getMonth()+1).padStart(2,"0")}-${String(Z.getDate()).padStart(2,"0")}`}return""}const l=new Date(o);return Number.isNaN(l.getTime())?o.split("T")[0]||"":`${l.getFullYear()}-${String(l.getMonth()+1).padStart(2,"0")}-${String(l.getDate()).padStart(2,"0")}`};const e=Intl.DateTimeFormat().resolvedOptions().timeZone||"UTC",n=7,c=`/api/site-supervision-visits/series?days=${n}&tz=${encodeURIComponent(e)}`,a=`/api/forecasts/forecast-series?days=${n}&tz=${encodeURIComponent(e)}`,[v,$]=await Promise.all([d(c,{},15e3,!0).catch(r=>(console.warn("Fetch actual visits failed",r),null)),d(a,{},15e3,!0).catch(r=>(console.warn("Fetch forecast visits failed",r),null))]),B=async(r,o)=>r?r.ok?await r.json().catch(l=>(console.warn(`${o} json parse error`,l),[])):(console.warn(`${o} returned status`,r.status),[]):[],[Y,H]=await Promise.all([B(v,"actual visits"),B($,"forecast visits")]);if((!Array.isArray(Y)||Y.length===0)&&(!Array.isArray(H)||H.length===0)){m(S,"Sin datos");return}const K=r=>Array.isArray(r)?r.map(o=>{let l="";Array.isArray(o)?l=o[0]:l=o?.x??o?.date??o?.day??"";let w=0;Array.isArray(o)&&o.length>1?w=o[1]:w=o?.y??o?.value??0;const q=t(l),T=typeof w=="number"?w:Number(String(w??0));return{x:q,y:Number.isFinite(T)?T:0}}).filter(o=>o.x&&typeof o.x=="string"&&o.x.length>=4):[],W=K(Y),X=K(H);let V=k(n,e);const J=r=>{const o=new Map;return r.forEach(l=>{if(!l||!l.x)return;const w=o.get(l.x)??0;o.set(l.x,w+(Number.isFinite(Number(l.y))?Number(l.y):0))}),o},Q=J(W),tt=J(X),j=V.map(r=>Q.has(r)?Q.get(r):0),P=V.map(r=>tt.has(r)?tt.get(r):0);if(console.debug("[visits-chart] labels:",V),console.debug("[visits-chart] normActual:",W),console.debug("[visits-chart] normForecast:",X),console.debug("[visits-chart] valuesActual:",j),console.debug("[visits-chart] valuesForecast:",P),!S){m(S,"Sin datos");return}S.clear(),S.setOption({legend:{data:["Visitas reales","Forecast (previsto)"],top:6},tooltip:{trigger:"axis",formatter:r=>{if(!Array.isArray(r)||r.length===0)return"";const o=r[0];let l=o.axisValue??(o&&typeof o.dataIndex=="number"?V[o.dataIndex]:void 0);!l&&o.axisValueLabel&&(l=o.axisValueLabel);const w=F(String(l??"")),q=r.map(T=>`${T.marker} ${T.seriesName}: ${T.value??0}`);return`<b>${w}</b><br/>${q.join("<br/>")}`}},grid:{left:40,right:16,top:48,bottom:36},xAxis:{type:"category",boundaryGap:!1,data:V,axisLabel:{rotate:0,formatter:function(r){return F(r)}}},yAxis:{type:"value"},series:[{name:"Visitas reales",type:"line",smooth:!0,areaStyle:{},data:j,color:"#0ea5e9",showSymbol:!1,lineStyle:{width:2}},{name:"Forecast (previsto)",type:"line",smooth:!0,areaStyle:{opacity:.12},data:P,color:"#f59e0b",showSymbol:!1,lineStyle:{width:2,type:"dashed"}}],graphic:j.concat(P).some(r=>Number(r)>0)?{elements:[]}:void 0}),j.some(r=>Number(r)>0)||P.some(r=>Number(r)>0)||m(S,"Sin visitas")}catch(t){t?.name==="AbortError"?console.debug("Visits/Forecast fetch aborted (timeout or navigation)",t):console.error("Error obteniendo series de visitas/forecast",t),m(S,"Error de datos")}const i=h(z);i&&p.push(i);try{const t=await M(`/api/site-supervision-visits/series-by-site?clientId=${y}&from=${x}&to=${D}`);if(t.ok){const e=await t.json().catch(()=>[]),n=e.map(a=>a.siteName),c=e.map(a=>a.count);i?.setOption({tooltip:{trigger:"axis"},grid:{left:60,right:16,top:24,bottom:32},xAxis:{type:"value"},yAxis:{type:"category",data:n,axisLabel:{interval:0,fontSize:12}},series:[{type:"bar",data:c,itemStyle:{color:"#0ea5e9"}}],graphic:c.some(a=>Number(a)>0)?{elements:[]}:void 0}),c.some(a=>Number(a)>0)||m(i)}else m(i,"Error de datos")}catch{m(i,"Error de datos")}const R=new Date,_=`${R.getFullYear()}-${String(R.getMonth()+1).padStart(2,"0")}-${String(R.getDate()).padStart(2,"0")}`;try{st(s,_,{refreshMs:6e4})}catch(t){console.warn("[client-dashboard] initThreeMetrics failed",t)}const L=new ResizeObserver(()=>p.forEach(t=>t?.resize()));[O,A,E,z].forEach(t=>t&&L.observe(t));const U=()=>{document.removeEventListener("fragment:will-unload",U);try{L.disconnect()}catch{}p.forEach(t=>{try{t.dispose()}catch{}}),s.dataset.echartsInit="0"};document.addEventListener("fragment:will-unload",U,{once:!0})}if(document.readyState==="loading")document.addEventListener("DOMContentLoaded",()=>{const u=document.getElementById("client-dashboard-root");u&&at({container:u})});else{const u=document.getElementById("client-dashboard-root");u&&at({container:u})}
