@use '../base/mixins' as *;
@use '../base/variables' as *;
@use '../base/palette' as *;
@use '../base/typography' as *;
@use '../base/mega-menu-backgrounds' as *;
@use '../base/mega-menu-contact' as *;

/* Altura consistente para la barra */
:root { --nav-h: 8vh; }

$background-transparent: transparent;

.navbar {
  position: fixed;
  margin: 0;
  padding: 0;
  top: 0; left: 0; width: 100%;
  height: var(--nav-h);
  z-index: 1000;
  transition: background-color 0.4s, box-shadow 0.4s;

  /* Estado transparente inicial */
  &.transparent {
    background-color: transparent;
    .mega-menu-content {
      .logo-container{
        .texto-logo{
          color: white;
        }
      }
      .nav-links { 
          .nav-item {
            a {
              color: white;
              .arrow-icon { color: $primary-color; }
              &:hover {
                color: $accent-blue;
              }
            }
          }
      }
      .menu-toggle {
        color: white;
        filter: drop-shadow(0 0 1px rgba(0,0,0,.45));
       }
    }
  }

  /* Estado con fondo sólido al hacer scroll */
  &.solid {
    background-color: $background-white;
    .mega-menu-content {
      .logo-container{
        .texto-logo{
          color: $cool-gray-800;
        }
      }
      .nav-links .nav-item a {
        color: $primary-color;
        &:hover { color: $accent-blue; }
      }
      .menu-toggle { color: $primary-color;}
    }
  }

  .mega-menu-content {
    position: relative;
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    align-items: center;
    width: 100%;
    height: var(--nav-h);
    padding: 0 5vw;
    box-sizing: border-box;

    .logo-container {
      height: 100%;
      grid-column: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      justify-self: start;
      .logo {
        transition: opacity 0.3s ease;
        opacity: 1;
        height: auto;
        max-height: var(--nav-h);
        &.hidden { opacity: 0; }
        &:hover{
          cursor: pointer;
        }
      }
      .texto-logo{
        max-height: var(--nav-h);
        @include roboto-font(1.375rem, 600);
        color: white;
      }
    }

    .menu-toggle {
      grid-column: 3;
      display: none;          /* se muestra en móvil (ya lo activas en @media) */
      width: 40px;
      height: 40px;
      padding: 0;
      border: 0;
      background: transparent; /* sin gris del navegador */
      cursor: pointer;
      appearance: none;
      color: white;
      justify-self: end;            /* usa currentColor para las barras */

      span {
        display: block;
        width: 24px;
        height: 2px;
        background: currentColor;
        margin: 5px auto;
        transition: transform .25s ease, opacity .2s ease;
      }

      &.is-open {
        span:nth-child(1) { transform: translateY(7px) rotate(45deg); }
        span:nth-child(2) { opacity: 0; }
        span:nth-child(3) { transform: translateY(-7px) rotate(-45deg); }
      }
    }

    .nav-links {
      margin: 0;
      padding: 0;
      grid-column: 2;
      height: 100%;
      list-style: none;
      display: flex;
      gap: 2rem;
      align-items: center;
      justify-content: center;
      cursor: default;

      .nav-item {
        display: flex;
        height: 100%;
        align-items: center;

        a {
          display: flex;
          @include roboto-font(1.2rem, 500);
          text-decoration: none;
          color: white;
          transition: color 0.2s ease;
          align-items: center;
          height: 100%;

          .arrow-icon {
            transition: transform 0.3s ease;
            color: $accent-blue;
          }
        }

        /* SOLO desktop: abrir mega-menu por hover */
        @media (hover: hover) and (pointer: fine) {
        &:hover {
            > a .arrow-icon { transform: rotate(180deg); }
            > .mega-menu {
              display: flex;
              animation: fadeInDown .3s ease-in-out;
              z-index: 1001; /* sobre el contenido; navbar está en 1000 */
            }
          }
        }

        .mega-menu {
          @include mega-menu-corporate();
          position: fixed;
          top: var(--nav-h);
          left: 0;
          width: 100vw;
          display: none;
          justify-content: left;
          padding: 5vh 0 5vh 10vw;
          min-height: 30vh;

          .mega-column {
            height: 100%;
            display: grid;
            padding: 0 2vw;

            .h2 { @include montserrat-font(1.15rem, 400); color: $heading-color; margin-bottom: 1rem; }
            a   { @include roboto-font(1rem, 300); color: $primary-color; margin-bottom: 0.3rem; }

            .menu-link:hover { color: $hover-color; }
          }

          &.mega-menu-contact { @include mega-menu_contact(); }
        }
      }
    }
  }
}



/* ====== MÓVIL (limpio y sin solapes) ====== */
@media (max-width: 768px) {
  .navbar {
    flex-wrap: wrap;

    .mega-menu-content {
      .menu-toggle { display: block; }

      #nav-links {
        /* Panel fijo bajo el header */
        --panel-pad: clamp(12px, 4vw, 24px);
        --tap-h: 52px;

        position: fixed;
        top: var(--nav-h-px, 64px);
        left: 0; right: 0;
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
        padding-inline: max(var(--panel-pad), env(safe-area-inset-left));
        background: #fff;
        z-index: 1002;

        /* Altura y scroll del panel */
        // max-height: calc(100dvh - var(--nav-h-px, 64px));
        /* Si lo quieres más compacto, usa esta en lugar de la anterior: */
        max-height: min(85dvh, calc(100dvh - var(--nav-h-px, 64px))); 
        overflow-y: auto;
        overflow-x: hidden;
        -webkit-overflow-scrolling: touch;

        display: none;
        flex-direction: column;
        &.open { display: flex; }

        /* Fila (item raíz) */
        > .nav-item {
          position: relative;
          display: block;
          border-bottom: 1px solid rgba(0,0,0,.06);

          > a { /* Título padre (tappable) */
            display: flex; align-items: center; justify-content: space-between;
            min-height: var(--tap-h);
            padding: 10px 0;           /* sin márgenes negativos: NO full-bleed */
            color: $primary-color;
            text-decoration: none;

            .arrow-icon { margin-left: 12px; transition: transform .2s ease; }
          }
          &.open-sub > a .arrow-icon { transform: rotate(180deg); }

          /* Panel del mega (acordeón) */
          > .mega-menu {
            /* Resets contundentes vs desktop */
            position: static !important;
            top: auto !important; left: auto !important; width: 100% !important;
            margin: 6px 0 0 !important; padding: 0 !important;
            min-height: 0 !important; background: transparent !important;
            border: 0 !important; box-shadow: none !important;
            z-index: auto !important;
            display: none; overflow: visible;

            /* Cabecera dentro del panel */
            > .h2, > .h2.menu-link {
              display: block;
              margin: 0 0 .5rem;
              padding: 10px 0;
              border-bottom: 1px solid rgba(0,0,0,.06);
              color: $heading-color;
              text-decoration: none;
            }

            .mega-column {
              display: block; width: 100%;
              padding: 0; margin: 0 0 .5rem;
            }

            /* Opciones internas */
            a {
              display: block; width: 100%;
              min-height: 44px;          /* accesible */
              padding: 10px 0;
              color: $primary-color;
              text-decoration: none;
              border-bottom: 1px solid rgba(0,0,0,.06);

              &:hover  { background: rgba(0,0,0,.03); }
              &:active { background: rgba(0,0,0,.06); }
            }

            img, iframe { max-width: 100%; height: auto; display: block; }
          }

          /* Mostrar panel del item activo */
          &.open-sub > .mega-menu { display: block !important; }
        }
      }
    }
  }

  .navbar .mega-menu-content #nav-links {
    /* el panel en móvil NO tiene altura fija */
    height: auto !important;
    align-items: stretch !important;  /* en vertical, que las filas no “centren” */
  }

  .navbar .mega-menu-content #nav-links > .nav-item {
    height: auto !important;          /* anula height:100% heredado de desktop */
    display: block !important;
  }

  .navbar .mega-menu-content #nav-links > .nav-item > a {
    height: auto !important;          /* clave: el <a> deja de medir 100% del panel */
    min-height: var(--tap-h, 52px);
    padding: 10px 0;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  /* En móvil NO abrir por hover */
  @media (hover: none) {
    .nav-item:hover .mega-menu { display: none !important; }
  }
}

/* === Separación visual del mega en móvil === */
@media (max-width: 768px) {
  .navbar .mega-menu-content #nav-links {

    /* 1) Destaca el título del item abierto */
    > .nav-item.open-sub > a {
      background: linear-gradient(to bottom, rgba(0,0,0,.03), rgba(0,0,0,0));
    }

    /* 2) El panel del mega parece "tarjeta" y no se confunde con el siguiente item */
    > .nav-item > .mega-menu {
      /* ya tienes position:static y resets; aquí el look */
      background: #f8fafc;                           /* tono suave */
      border: 1px solid rgba(0,0,0,.06);
      border-radius: 10px;
      padding: 8px 12px;
      margin: 6px 0 10px;                            /* aire antes del siguiente item */
      box-shadow: 0 1px 2px rgba(0,0,0,.04);
    }

    /* 3) Extra separación con una línea antes del siguiente item */
    > .nav-item.open-sub + .nav-item {
      border-top: 1px solid rgba(0,0,0,.08);
      margin-top: 6px;                                /* pequeño gap entre bloques */
    }

    /* 4) Interior más “anidado” para que se perciba subordinado */
    > .nav-item > .mega-menu .mega-column a {
      padding-left: 14px;                              /* leve indentación */
      border-left: 2px solid rgba(0,0,0,.05);
    }

    /* 5) Asegura que el título del siguiente item NO herede fondo del panel */
    > .nav-item > a {
      background: #fff;
    }
  }
}

@media (max-width: 768px) {
  .navbar .mega-menu-content #nav-links > .nav-item {
    position: relative;                 /* crea stacking context local */
  }

  /* El título SIEMPRE visible y encima */
  .navbar .mega-menu-content #nav-links > .nav-item > a {
    position: relative;
    z-index: 2;                         /* ⬅️ por sobre su .mega-menu */
    background: #fff;                   /* fondo sólido para no “perderse” */
    color: $primary-color;              /* asegura contraste */
  }

  /* El panel queda debajo del título (sin solapar) */
  .navbar .mega-menu-content #nav-links > .nav-item > .mega-menu {
    position: relative !important;
    z-index: 1 !important;              /* ⬅️ por debajo del <a> */
    margin-top: 8px !important;         /* aire bajo el título */
    padding: 8px 12px !important;
    background: #f8fafc !important;
    border: 1px solid rgba(0,0,0,.06) !important;
    border-radius: 10px !important;
    box-shadow: 0 1px 2px rgba(0,0,0,.04);
  }

  /* Separación clara con el siguiente nav-link */
  .navbar .mega-menu-content #nav-links > .nav-item.open-sub {
    margin-bottom: 8px;                 /* empuja al siguiente item */
    border-bottom: 1px solid rgba(0,0,0,.08);
  }
}

/* Animación de entrada para dropdown */
@keyframes fadeInDown {
  from { opacity: 0; transform: translateY(10px); }
  to   { opacity: 1; transform: translateY(0); }
}